<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾…å¯¼å‘˜è°ˆå¿ƒè°ˆè¯ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo h1 {
            font-size: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: #3498db;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: #3498db;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 30px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* æœç´¢é€‰æ‹©æ¡† */
        .search-select-container {
            position: relative;
        }

        .search-select-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-select-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-select-item:hover {
            background: #f5f7fa;
        }

        .search-select-item.selected {
            background: #e3f2fd;
        }

        /* å¤é€‰æ¡†ç»„ */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .signature-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #3498db;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-danger {
            background: #e74c3c;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
position: relative; 
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* å­¦ç”Ÿä¿¡æ¯é¢æ¿ */
        .student-info-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .student-info-item {
            display: flex;
            flex-direction: column;
        }

        .student-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .student-info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* é£é™©ç­‰çº§æ ‡ç­¾ */
        .risk-level {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .risk-level.red {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .risk-level.yellow {
            background: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffcc80;
        }

        .risk-level.green {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 800px;
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: #27ae60;
        }

        .message.error {
            background: #e74c3c;
        }

        .message.info {
            background: #3498db;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* å…¶ä»–æ ·å¼ */
        .other-topic-input {
            display: none;
            margin-top: 10px;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-content, .print-content * {
                visibility: visible;
            }
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 12pt;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            margin: 20px 0;
            font-size: 12pt;
            font-family: "å®‹ä½“", "SimSun", serif;
        }
        
        .print-table th,
        .print-table td {
            border: 1px solid #000;
            padding: 8px 12px;
            vertical-align: top;
        }
        
        .print-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        .doc-header {
            text-align: center;
            margin-bottom: 30px;
            font-family: "é»‘ä½“", "SimHei", sans-serif;
        }
        
        .doc-header h1 {
            font-size: 22pt;
            margin-bottom: 10px;
        }
        
        .doc-header h2 {
            font-size: 16pt;
            margin-bottom: 20px;
            color: #333;
        }
        
        .doc-footer {
            margin-top: 50px;
            text-align: right;
            font-size: 11pt;
            color: #666;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .file-upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .file-upload-area.drag-over {
            border-color: #27ae60;
            background: #e8f5e9;
        }
        
        .file-upload-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-upload-area p {
            margin-bottom: 10px;
            color: #666;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 10px 25px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .file-upload-btn:hover {
            background: #2980b9;
        }
        
        /* å¯¼å…¥é¢„è§ˆè¡¨æ ¼ */
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .preview-table th {
            background: #f0f0f0;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .preview-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .preview-table .valid {
            background-color: #e8f5e9;
        }
        
        .preview-table .invalid {
            background-color: #ffebee;
        }
        
        .import-progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        /* ========== ç®€åŒ–çš„ç»Ÿè®¡å¡ç‰‡æ ·å¼ ========== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 4px solid #3498db;
        }
        
        .stat-card.total {
            border-top-color: #3498db;
        }
        
        .stat-card.red {
            border-top-color: #c62828;
        }
        
        .stat-card.yellow {
            border-top-color: #f57f17;
        }
        
        .stat-card.green {
            border-top-color: #2e7d32;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* è°ˆè¯è¿½è¸ªæ ·å¼ */
        .talk-track-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .talk-count {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .count-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .count-number {
            font-size: 18px;
            font-weight: bold;
        }
        
        .count-label {
            font-size: 12px;
            color: #666;
        }
        
        /* è¿‘æœŸè°ˆè¯å­¦ç”Ÿåˆ—è¡¨ */
        .recent-talks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .student-tag {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .student-tag .talk-count {
            background: #3498db;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        /* è°ˆè¯é¢‘ç‡æ ·å¼ */
        .frequency-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .frequency-high {
            background: #ffebee;
            color: #c62828;
        }
        
        .frequency-medium {
            background: #fff8e1;
            color: #f57f17;
        }
        
        .frequency-low {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* æœˆåº¦ç»Ÿè®¡æ ·å¼ */
        .month-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .month-stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .month-name {
            font-size: 12px;
            color: #666;
        }
        
        .month-count {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* æ—¶é—´ç­›é€‰å™¨æ ·å¼ */
        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .time-filter-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .time-filter-btn.active {
            background: #3498db;
            color: white;
        }
        
        /* æ‰¹é‡æ“ä½œç›¸å…³æ ·å¼ */
        .batch-action-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        /* é€‰ä¸­è¡Œçš„æ ·å¼ */
        .data-table tr.selected {
            background-color: #e3f2fd;
        }
        
        /* æœˆä»½ç»Ÿè®¡é¡¹æ‚¬åœæ•ˆæœ */
        .month-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        /* å½“å‰æœˆä»½çªå‡ºæ˜¾ç¤º */
        .current-month {
            position: relative;
            overflow: hidden;
        }
        
        .current-month::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent #3498db transparent transparent;
        }
        
        .current-month::after {
            content: 'å½“å‰';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: white;
            transform: rotate(45deg);
            transform-origin: right top;
        }
        
        /* ========== æ–°å¢æ ·å¼ ========== */
        
        /* ç…§ç‰‡ä¸Šä¼ æ ·å¼ */
        .photo-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .photo-preview {
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
        
        .photo-placeholder {
            width: 120px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 6px;
            margin: 10px auto;
            color: #666;
        }
        
        /* å¤„åˆ†è®°å½•æ ·å¼ */
        .punishment-record {
            background: #fff8e1;
            border-left: 4px solid #f57f17;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        /* å›°éš¾è®¤å®šæ ‡ç­¾ */
        .hardship-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .hardship-severe {
            background: #ffebee;
            color: #c62828;
        }
        
        .hardship-general {
            background: #fff8e1;
            color: #f57f17;
        }
        
        .hardship-none {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* æ”¿æ²»é¢è²Œæ ‡ç­¾ */
        .political-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            background: #e3f2fd;
            color: #1565c0;
        }
        
        /* ç¼–è¾‘è®°å½•æ ·å¼ */
        .edit-record-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }
        
        .edit-record-btn:hover {
            background: #2980b9;
        }
        
        /* å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† */
        .student-detail-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .student-detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .student-photo-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .student-info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .student-detail-item {
            margin-bottom: 10px;
        }
        
        .student-detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .student-detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        /* ç¼–è¾‘è°ˆè¯è®°å½•æ¨¡æ€æ¡† */
        .edit-talk-modal {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* å¤„åˆ†è®°å½•è¾“å…¥æ ·å¼ */
        .punishment-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .punishment-input-group input {
            flex: 1;
        }
        
        .punishment-list {
            margin-top: 10px;
        }
        
        /* å­¦ç”Ÿç…§ç‰‡æ˜¾ç¤º */
        .student-photo-small {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* æ‰©å±•ä¿¡æ¯æ ‡ç­¾ */
        .info-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-right: 5px;
            margin-bottom: 3px;
        }
        
        .info-tag.punishment {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .info-tag.hardship {
            background: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffcc80;
        }
        
        .info-tag.political {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        /* ========== æ•°æ®åˆ†ææ¨¡å—æ ·å¼ ========== */
        .analysis-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #34495e;
        }
        
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 6px;
            color: #666;
            font-size: 14px;
        }
        
        .simple-bar-chart {
            display: flex;
            align-items: flex-end;
            height: 250px;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            border-left: 1px solid #ddd;
            position: relative;
            margin-top: 20px;
        }
        
        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .bar {
            width: 60%;
            min-height: 2px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            position: relative;
        }
        
        .bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }
        
        .bar-label {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 0;
            font-size: 11px;
            color: #666;
        }
        
        .x-axis {
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            margin-left: 30px;
            font-size: 11px;
            color: #666;
        }
        
        .pie-chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 250px;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background: conic-gradient(
                #3498db 0% 40%,
                #2ecc71 40% 70%,
                #e74c3c 70% 85%,
                #f39c12 85% 95%,
                #9b59b6 95% 100%
            );
        }
        
        .pie-legend {
            margin-left: 30px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }
        
        .trend-line {
            height: 2px;
            background: #3498db;
            position: relative;
            margin: 40px 0 20px 30px;
        }
        
        .trend-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #3498db;
            border-radius: 50%;
            top: -4px;
            transform: translateX(-50%);
        }
        
        .trend-point:hover::after {
            content: attr(data-value);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .analysis-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .analysis-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .analysis-table tr:hover {
            background: #f5f7fa;
        }
        
        .analysis-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .analysis-controls select,
        .analysis-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .analysis-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .highlight-card {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .highlight-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .highlight-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .insight-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .insight-text {
            flex: 1;
            font-size: 13px;
        }
        
        /* ========== æ–°å¢ï¼šå­¦ç±å¼‚åŠ¨æ ·å¼ ========== */
        .status-change-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
            background: #e1f5fe;
            color: #0277bd;
            border: 1px solid #4fc3f7;
        }
        
        .status-change-yes {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffb74d;
        }
        
        .status-change-no {
            background: #f1f8e9;
            color: #558b2f;
            border: 1px solid #9ccc65;
        }
        
        .punishment-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .punishment-yes {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .punishment-no {
            background: #f1f8e9;
            color: #558b2f;
            border: 1px solid #9ccc65;
        }
        
        /* ========== æ–°å¢ï¼šç”¨æˆ·ç®¡ç†æ¨¡å—æ ·å¼ ========== */
        .user-role-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .user-role-admin {
            background: linear-gradient(135deg, #ff6b6b, #c62828);
            color: white;
        }
        
        .user-role-counselor {
            background: linear-gradient(135deg, #4ecdc4, #27ae60);
            color: white;
        }
        
        .user-status-active {
            color: #27ae60;
            font-weight: bold;
        }
        
        .user-status-inactive {
            color: #95a5a6;
        }
        
        /* ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ */
        .user-stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 4px solid #9b59b6;
        }
        
        .user-stat-card.total {
            border-top-color: #9b59b6;
        }
        
        .user-stat-card.admin {
            border-top-color: #c62828;
        }
        
        .user-stat-card.counselor {
            border-top-color: #27ae60;
        }
        
        .user-stat-card.active {
            border-top-color: #3498db;
        }
        
        /* ç”¨æˆ·æ“ä½œæŒ‰é’® */
        .user-action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .user-action-edit {
            background: #3498db;
            color: white;
        }
        
        .user-action-reset {
            background: #f39c12;
            color: white;
        }
        
        .user-action-delete {
            background: #e74c3c;
            color: white;
        }
        
        .user-action-toggle {
            background: #9b59b6;
            color: white;
        }
        
        /* ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡† */
        .user-detail-modal {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .user-detail-item {
            margin-bottom: 15px;
        }
        
        .user-detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .user-detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        /* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */
        .password-strength {
            margin-top: 5px;
            height: 4px;
            border-radius: 2px;
            background: #e0e0e0;
            overflow: hidden;
        }
        
        .password-strength-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .password-strength.weak .password-strength-fill {
            background-color: #e74c3c;
            width: 33%;
        }
        
        .password-strength.medium .password-strength-fill {
            background-color: #f39c12;
            width: 66%;
        }
        
        .password-strength.strong .password-strength-fill {
            background-color: #27ae60;
            width: 100%;
        }
        
        /* ç”¨æˆ·æ‰¹é‡å¯¼å…¥æ ·å¼ */
        .user-import-step {
            margin-bottom: 20px;
        }
        
        .user-import-instruction {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .user-import-instruction h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .user-import-instruction ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .user-import-instruction li {
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }
        
        /* ç”¨æˆ·æƒé™æ ‡ç­¾ */
        .permission-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 3px;
            margin-bottom: 3px;
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form .form-label {
            font-size: 14px;
            color: #34495e;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .login-form .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .login-form .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 13px;
        }
        
        /* è§’è‰²æƒé™è¯´æ˜ */
        .role-permissions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .role-permissions h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .role-permissions ul {
            margin-left: 20px;
        }
        
        .role-permissions li {
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }
        
        /* ç³»ç»Ÿè®¾ç½®æ ·å¼ */
        .system-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .settings-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        .settings-card h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: 14px;
            color: #333;
        }
        
        .settings-value {
            font-size: 14px;
            color: #666;
        }
        
        .settings-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .settings-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .settings-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .settings-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .settings-switch input:checked + .settings-slider {
            background-color: #27ae60;
        }
        
         /* ========== ä¿®å¤è¡¨æ ¼æ˜¾ç¤ºé—®é¢˜ ========== */
    .data-table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }
    
    .data-table td:nth-child(4) {
        white-space: normal;
        min-width: 80px;
        max-width: 120px;
        word-break: keep-all;
    }
    
    .data-table td:nth-child(3) {
        min-width: 100px;
        font-weight: bold;
    }
    
    .data-table td:nth-child(5) {
        min-width: 120px;
    }
    
    /* æœç´¢åŒºåŸŸçš„åˆ é™¤æŒ‰é’®æ ·å¼ */
    .search-select-item button.delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        margin-left: auto;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .search-select-item button.delete-btn:hover {
        background: #c0392b;
    }
    
    /* æœç´¢åŒºåŸŸçš„æ¸…æ™°å¸ƒå±€ */
    .search-select-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }
    
    .search-select-item .student-info {
        flex: 1;
        min-width: 0;
    }
    
    .search-select-item .student-info strong {
        display: inline-block;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: middle;
    }
    
    .settings-switch input:checked + .settings-slider:before {
        transform: translateX(26px);
    }
</style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="logo">
                <h1>ğŸ’¬ è¾…å¯¼å‘˜è°ˆå¿ƒè°ˆè¯ç³»ç»Ÿ</h1>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="switchTab('record')">
                    ğŸ“ æ–°å»ºè°ˆè¯è®°å½•
                </div>
                <div class="nav-item" onclick="switchTab('students')">
                    ğŸ‘¥ å­¦ç”Ÿæ•°æ®åº“
                </div>
                <div class="nav-item" onclick="switchTab('history')">
                    ğŸ“š å†å²è®°å½•æŸ¥è¯¢
                </div>
                <div class="nav-item" onclick="switchTab('analysis')">
                    ğŸ“Š æ•°æ®åˆ†æ
                </div>
                <div class="nav-item" onclick="switchTab('export')">
                    ğŸ“¤ æ•°æ®å¯¼å‡º
                </div>
                <div class="nav-item" id="userManagementTab" style="display: none;" onclick="switchTab('users')">
                    ğŸ‘¤ ç”¨æˆ·ç®¡ç†
                </div>
                <div class="nav-item" id="systemSettingsTab" style="display: none;" onclick="switchTab('settings')">
                    âš™ï¸ ç³»ç»Ÿè®¾ç½®
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">æ–°å»ºè°ˆè¯è®°å½•</h1>
                <div class="user-info">
                    <span id="currentUserInfo">è¾…å¯¼å‘˜ï¼š<span id="counselorName">èµµæ¢¦å©·</span></span>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <!-- ç™»å½•ç•Œé¢ -->
            <div id="loginPage" class="login-container">
                <div class="login-header">
                    <div class="login-logo">ğŸ’¬</div>
                    <h1>è¾…å¯¼å‘˜è°ˆå¿ƒè°ˆè¯ç³»ç»Ÿ</h1>
                    <p>è¾…å¯¼å‘˜å·¥ä½œç®¡ç†ä¸å­¦ç”Ÿè°ˆå¿ƒè°ˆè¯è®°å½•å¹³å°</p>
                </div>
                <div class="login-form">
                    <div class="form-group">
                        <label class="form-label">è´¦å·</label>
                        <input type="text" id="username" class="form-control" placeholder="è¯·è¾“å…¥è´¦å·">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <button class="login-btn" onclick="login()">ç™»å½•</button>
                </div>
                <div class="login-footer">
                    <p>ç³»ç»Ÿç‰ˆæœ¬ï¼šv2.0 | ç®¡ç†å‘˜è´¦å·ï¼šèµµæ¢¦å©·</p>
                </div>
            </div>

            <!-- ä¸»ç³»ç»Ÿç•Œé¢ -->
            <div id="mainSystem" style="display: none;">
                <!-- æ–°å»ºè°ˆè¯è®°å½• -->
                <div id="recordTab" class="content-tab">
                    <div class="card">
                        <h2 class="card-title">ğŸ“ æ–°å»ºè°ˆå¿ƒè°ˆè¯è®°å½•</h2>
                        
                        <!-- è°ˆè¯ç»Ÿè®¡ä¿¡æ¯ -->
                        <div class="talk-track-card" id="recordStatsCard" style="display: none;">
                            <div class="track-header">
                                <h4>ğŸ“Š è¿‘æœŸè°ˆè¯ç»Ÿè®¡</h4>
                                <div class="talk-count">
                                    <div class="count-item">
                                        <span class="count-number" id="todayCount">0</span>
                                        <span class="count-label">ä»Šæ—¥</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="weekCount">0</span>
                                        <span class="count-label">æœ¬å‘¨</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="monthCount">0</span>
                                        <span class="count-label">æœ¬æœˆ</span>
                                    </div>
                                </div>
                            </div>
                            <div id="recentStudentsList" class="recent-talks-list">
                                <!-- è¿‘æœŸè°ˆè¯å­¦ç”Ÿåˆ—è¡¨ -->
                            </div>
                        </div>
                        
                        <form id="talkForm">
                            <input type="hidden" id="editRecordId" value="">
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">é€‰æ‹©å­¦ç”Ÿ *</label>
                                    <div class="search-select-container">
                                        <input type="text" 
                                               id="studentSearch" 
                                               class="search-select-input" 
                                               placeholder="è¾“å…¥å§“åã€å­¦å·æˆ–ç­çº§æœç´¢..."
                                               oninput="searchStudentsForSelect(this.value)">
                                        <div id="studentSearchResults" class="search-select-dropdown"></div>
                                    </div>
                                    <input type="hidden" id="studentId">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ä¸“ä¸šç­çº§ *</label>
                                    <input type="text" id="className" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">å®¿èˆ *</label>
                                    <input type="text" id="dormitory" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">è°ˆè¯æ—¶é—´ *</label>
                                    <input type="datetime-local" id="talkTime" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">è°ˆè¯åœ°ç‚¹ *</label>
                                    <input type="text" id="talkLocation" class="form-control" required>
                                </div>
                            </div>

                            <!-- å­¦ç”Ÿä¿¡æ¯é¢æ¿ -->
                            <div id="studentInfoPanel" class="student-info-panel" style="display: none;">
                                <div class="student-info-grid">
                                    <div class="student-info-item">
                                        <span class="student-info-label">é£é™©ç­‰çº§</span>
                                        <span id="infoRiskLevel" class="student-info-value"></span>
                                    </div>
                                    <div class="student-info-item">
                                        <span class="student-info-label">å†å²è°ˆè¯æ¬¡æ•°</span>
                                        <span class="student-info-value" id="infoTalkCount">0æ¬¡</span>
                                    </div>
                                    <div class="student-info-item">
                                        <span class="student-info-label">æœ€è¿‘è°ˆè¯æ—¶é—´</span>
                                        <span class="student-info-value" id="infoLastTalk">æ— è®°å½•</span>
                                    </div>
                                    <div class="student-info-item">
                                        <span class="student-info-label">å­¦ç±å¼‚åŠ¨</span>
                                        <span class="student-info-value" id="infoStatusChange">æ— </span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">è°ˆè¯ä¸»é¢˜ *</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="é€‚åº”æ€§"> é€‚åº”æ€§
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="äººé™…å…³ç³»"> äººé™…å…³ç³»
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="æƒ…æ„Ÿ"> æƒ…æ„Ÿ
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="å­¦ä¸š"> å­¦ä¸š
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="å°±ä¸š"> å°±ä¸š
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="æƒ…ç»ª/å¥åº·"> æƒ…ç»ª/å¥åº·
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="å®¶åº­"> å®¶åº­
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="è­¦ç¤ºæ•™è‚²"> è­¦ç¤ºæ•™è‚²
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="å…¶ä»–" id="otherTopicCheckbox" onchange="toggleOtherTopicInput()"> å…¶ä»–
                                    </label>
                                </div>
                                <div id="otherTopicInput" class="other-topic-input">
                                    <input type="text" id="otherTopicText" class="form-control" placeholder="è¯·è¾“å…¥å…¶ä»–è°ˆè¯ä¸»é¢˜...">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">å­¦ç”ŸèƒŒæ™¯ *</label>
                                <textarea id="studentBackground" class="form-control" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">è°ˆè¯ç›®çš„ *</label>
                                <textarea id="talkPurpose" class="form-control" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">å­¦ç”Ÿè‡ªè¿° *</label>
                                <textarea id="studentStatement" class="form-control" required></textarea>
                            </div>

                            <div class="form-group" style="display: none;">
    <label class="form-label">è°ˆè¯è¦ç‚¹è®°å½• *</label>
    <textarea id="talkPoints" class="form-control"></textarea>
</div>

                            <div class="form-group">
                                <label class="form-label">è°ˆè¯åé¦ˆ *</label>
                                <textarea id="talkFeedback" class="form-control" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">åˆ†çº§å»ºè®® *</label>
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="riskLevel" value="red" required>
                                        <span style="color: #c62828; font-weight: bold;">çº¢è‰²é¢„è­¦</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="riskLevel" value="yellow">
                                        <span style="color: #f57f17; font-weight: bold;">é»„è‰²å…³æ³¨</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="riskLevel" value="green" checked>
                                        <span style="color: #2e7d32; font-weight: bold;">ç»¿è‰²æ­£å¸¸</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">åç»­è·Ÿè¿›è®¡åˆ’</label>
                                <textarea id="followUpPlan" class="form-control" rows="2" placeholder="å¯å¡«å†™åç»­è·Ÿè¿›è®¡åˆ’..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">å¤‡æ³¨</label>
                                <textarea id="generalRemark" class="form-control" rows="2" placeholder="å¯å¡«å†™å…¶ä»–å¤‡æ³¨ä¿¡æ¯..."></textarea>
                            </div>

                            <div class="signature-area">
                                <div class="form-group">
                                    <label class="form-label">å­¦ç”Ÿç­¾å</label>
                                    <input type="text" id="studentSignature" class="form-control" placeholder="æ­¤å¤„å¯æ‰“å°åæ‰‹ç­¾">
                                </div>
                             <div class="form-group">
    <label class="form-label">è¾…å¯¼å‘˜ç­¾å</label>
    <input type="text" id="counselorSignature" class="form-control" value="${currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜'}" readonly>
</div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="submit" class="btn btn-primary" id="saveRecordBtn">ä¿å­˜è®°å½•</button>
                                <button type="button" class="btn" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                                <button type="button" class="btn btn-warning" onclick="showDocPreview()">å¯¼å‡ºä¸ºDOC</button>
                                <button type="button" class="btn btn-info" onclick="saveAsDraft()" id="saveDraftBtn" style="display: none;">ä¿å­˜ä¸ºè‰ç¨¿</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- å­¦ç”Ÿæ•°æ®åº“ -->
                <div id="studentsTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">ğŸ‘¥ å­¦ç”Ÿæ•°æ®åº“ç®¡ç†</h2>
                        
                        <!-- ç®€åŒ–çš„ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="stats-container" id="statsContainer">
                            <!-- ç»Ÿè®¡å¡ç‰‡ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- æ“ä½œåŒºåŸŸ -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">æ•°æ®æ“ä½œ</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-info" onclick="downloadExcelTemplate()">ä¸‹è½½Excelæ¨¡æ¿</button>
                                <button class="btn btn-success" onclick="showAddStudentModal()">+ æ·»åŠ å­¦ç”Ÿ</button>
                                <button class="btn btn-warning" onclick="showImportModal()">ğŸ“¤ æ‰¹é‡å¯¼å…¥Excel</button>
                                <button class="btn btn-primary" onclick="exportStudentsToExcel()">å¯¼å‡ºä¸ºExcel</button>

<button class="btn btn-danger" onclick="simpleBatchDelete()">ğŸ—‘ï¸ åˆ é™¤å‹¾é€‰çš„å­¦ç”Ÿ</button>
                                <button class="btn btn-danger" onclick="batchDeleteStudents()" id="batchDeleteBtn" style="display: none;">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
                            </div>
                            <div id="batchActionInfo" style="margin-top: 10px; font-size: 14px; color: #666; display: none;">
                                <span id="selectedCount">0</span> ä¸ªå­¦ç”Ÿå·²é€‰ä¸­
                                <button class="btn" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
                            </div>
                        </div>

                        <!-- æœç´¢åŒºåŸŸ -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="searchStudentsInput" class="form-control" placeholder="æœç´¢å§“åã€å­¦å·æˆ–ç­çº§..." style="flex: 1; min-width: 250px;">
                            <select id="riskLevelFilter" class="form-control" style="max-width: 200px;">
                                <option value="">å…¨éƒ¨é£é™©ç­‰çº§</option>
                                <option value="red">çº¢è‰²é¢„è­¦</option>
                                <option value="yellow">é»„è‰²å…³æ³¨</option>
                                <option value="green">ç»¿è‰²æ­£å¸¸</option>
                            </select>
                            <select id="politicalStatusFilter" class="form-control" style="max-width: 150px;">
                                <option value="">æ”¿æ²»é¢è²Œ</option>
                                <option value="ä¸­å…±å…šå‘˜">ä¸­å…±å…šå‘˜</option>
                                <option value="ä¸­å…±é¢„å¤‡å…šå‘˜">ä¸­å…±é¢„å¤‡å…šå‘˜</option>
                                <option value="å…±é’å›¢å‘˜">å…±é’å›¢å‘˜</option>
                                <option value="ç¾¤ä¼—">ç¾¤ä¼—</option>
                            </select>
                            <select id="hardshipFilter" class="form-control" style="max-width: 150px;">
                                <option value="">å›°éš¾è®¤å®š</option>
                                <option value="ç‰¹åˆ«å›°éš¾">ç‰¹åˆ«å›°éš¾</option>
                                <option value="å›°éš¾">å›°éš¾</option>
                                <option value="ä¸€èˆ¬å›°éš¾">ä¸€èˆ¬å›°éš¾</option>
                                <option value="æ— ">æ— </option>
                            </select>
                            <button class="btn" onclick="simpleSearchStudents()">æœç´¢</button>
                            <button class="btn" onclick="clearStudentSearch()">é‡ç½®</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents(this)">
                                        </th>
                                       <th>ç…§ç‰‡</th>
<th>å­¦å·</th>
<th>å§“å</th>
<th>ç­çº§</th>
<th>å®¿èˆ</th>
<th>è”ç³»æ–¹å¼</th>
<th>å®¶é•¿è”ç³»æ–¹å¼</th>
<th>èº«ä»½è¯å·</th>
<th>æ”¿æ²»é¢è²Œ</th>
<th>æˆ·ç±åœ°</th>
<th>å›°éš¾è®¤å®š</th>
<th>é£é™©ç­‰çº§</th>
<th>å¤„åˆ†è®°å½•</th>
<th>å­¦ç±å¼‚åŠ¨</th>
<th>è°ˆè¯æ¬¡æ•°</th>
<th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsList">
                                    <!-- å­¦ç”Ÿæ•°æ®åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å†å²è®°å½•æŸ¥è¯¢ -->
                <div id="historyTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">ğŸ“š å†å²è°ˆè¯è®°å½•æŸ¥è¯¢</h2>
                        
                        <!-- è°ˆè¯è¿½è¸ªç»Ÿè®¡ -->
                        <div class="talk-track-card">
                            <div class="track-header">
                                <h4>ğŸ“Š è°ˆè¯è¿½è¸ªç»Ÿè®¡</h4>
                                <div class="talk-count">
                                    <div class="count-item">
                                        <span class="count-number" id="totalTalksCount">0</span>
                                        <span class="count-label">æ€»è°ˆè¯æ•°</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="uniqueStudentsCount">0</span>
                                        <span class="count-label">æ¶‰åŠå­¦ç”Ÿ</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="redTalksCount">0</span>
                                        <span class="count-label" style="color:#c62828">çº¢è‰²é¢„è­¦</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ—¶é—´ç­›é€‰å™¨ -->
                            <div class="time-filter">
                                <button class="time-filter-btn active" onclick="filterByTime('all')">å…¨éƒ¨</button>
                                <button class="time-filter-btn" onclick="filterByTime('today')">ä»Šæ—¥</button>
                                <button class="time-filter-btn" onclick="filterByTime('week')">æœ¬å‘¨</button>
                                <button class="time-filter-btn" onclick="filterByTime('month')">æœ¬æœˆ</button>
                                <button class="time-filter-btn" onclick="filterByTime('quarter')">æœ¬å­£åº¦</button>
                            </div>
                            
                            <!-- æœˆåº¦é€‰æ‹©å™¨ -->
                            <div style="margin-top: 10px;">
                                <label style="font-size: 13px; color: #666; margin-right: 10px;">æŒ‰æœˆä»½ç­›é€‰ï¼š</label>
                                <select id="monthFilter" class="form-control" style="display: inline-block; width: 200px; font-size: 13px;" onchange="filterByMonth()">
                                    <option value="">æ‰€æœ‰æœˆä»½</option>
                                    <!-- æœˆä»½é€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                </select>
                            </div>
                            
                            <!-- é«˜é¢‘è°ˆè¯å­¦ç”Ÿ -->
                            <div id="frequentStudents" style="display: none; margin-top: 10px;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">é«˜é¢‘è°ˆè¯å­¦ç”Ÿï¼š</div>
                                <div id="frequentStudentsList" class="recent-talks-list"></div>
                            </div>
                        </div>

                        <!-- æœˆåº¦ç»Ÿè®¡ -->
                        <div id="monthlyStats" class="month-stats" style="display: none; margin-bottom: 20px;">
                            <!-- æœˆåº¦ç»Ÿè®¡æ•°æ®åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">æ‰¹é‡æ“ä½œ</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="batchDeleteTalkRecords()" id="batchDeleteTalkBtn" style="display: none;">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤è®°å½•</button>
                            </div>
                            <div id="batchTalkActionInfo" style="margin-top: 10px; font-size: 14px; color: #666; display: none;">
                                <span id="selectedTalkCount">0</span> æ¡è®°å½•å·²é€‰ä¸­
                                <button class="btn" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="clearTalkSelection()">æ¸…é™¤é€‰æ‹©</button>
                            </div>
                        </div>

                        <!-- æœç´¢åŒºåŸŸ -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="recordSearch" class="form-control" placeholder="æœç´¢å­¦ç”Ÿå§“åã€å­¦å·æˆ–ç­çº§...">
                            <select id="riskLevelFilterHistory" class="form-control" style="max-width: 150px;">
                                <option value="">å…¨éƒ¨åˆ†çº§</option>
                                <option value="red">çº¢è‰²é¢„è­¦</option>
                                <option value="yellow">é»„è‰²å…³æ³¨</option>
                                <option value="green">ç»¿è‰²æ­£å¸¸</option>
                            </select>
                            <input type="date" id="dateFrom" class="form-control" style="max-width: 150px;">
                            <input type="date" id="dateTo" class="form-control" style="max-width: 150px;">
                            <button class="btn" onclick="searchTalkRecords()">æœç´¢</button>
                            <button class="btn" onclick="clearSearch()">é‡ç½®</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table" id="recordsTable">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllTalks" onchange="toggleSelectAllTalks(this)">
                                        </th>
                                        <th>è°ˆè¯æ—¶é—´</th>
                                        <th>å­¦ç”Ÿå§“å</th>
                                        <th>ç­çº§</th>
                                        <th>è°ˆè¯ä¸»é¢˜</th>
                                        <th>åˆ†çº§å»ºè®®</th>
                                        <th>å¤„åˆ†è®°å½•</th>
                                        <th>å­¦ç±å¼‚åŠ¨</th>
                                        <th>è°ˆè¯æ¬¡æ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="recordsList">
                                    <!-- è®°å½•æ•°æ®åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®åˆ†ææ¨¡å— -->
                <div id="analysisTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">ğŸ“Š æ•°æ®åˆ†æä¸ç»Ÿè®¡</h2>
                        
                        <!-- æ€»ä½“æ•°æ®æ¦‚è§ˆ -->
                        <div class="highlight-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="highlight-value" id="totalAnalysisCount">0</div>
                                    <div class="highlight-label">æ€»è°ˆè¯è®°å½•æ•°</div>
                                </div>
                                <div>
                                    <div class="highlight-value" id="analysisStudentCount">0</div>
                                    <div class="highlight-label">æ¶‰åŠå­¦ç”Ÿæ•°</div>
                                </div>
                                <div>
                                    <div class="highlight-value" id="analysisRedPercent">0%</div>
                                    <div class="highlight-label">é«˜é£é™©å æ¯”</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ•°æ®æ´å¯Ÿ -->
                        <div class="analysis-section">
                            <h3 class="section-title">ğŸ“ˆ æ•°æ®æ´å¯Ÿ</h3>
                            <div class="insight-list" id="insightsList">
                                <!-- æ•°æ®æ´å¯Ÿå†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
                        <div class="analysis-controls">
                            <select id="analysisTimeRange" class="form-control" style="width: 200px;" onchange="updateAnalysisData()">
                                <option value="all">å…¨éƒ¨æ—¶é—´</option>
                                <option value="month">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
                                <option value="quarter">æœ€è¿‘ä¸‰ä¸ªæœˆ</option>
                                <option value="halfyear">æœ€è¿‘å…­ä¸ªæœˆ</option>
                                <option value="year">æœ€è¿‘ä¸€å¹´</option>
                            </select>
                            <select id="analysisClassFilter" class="form-control" style="width: 200px;" onchange="updateAnalysisData()">
                                <option value="">å…¨éƒ¨ç­çº§</option>
                                <!-- ç­çº§é€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                            </select>
                            <button class="btn btn-primary" onclick="refreshAnalysisData()">åˆ·æ–°æ•°æ®</button>
                            <button class="btn btn-success" onclick="exportAnalysisReport()">å¯¼å‡ºåˆ†ææŠ¥å‘Š</button>
                        </div>
                        
                        <!-- é£é™©ç­‰çº§åˆ†å¸ƒ -->
                        <div class="analysis-section">
                            <h3 class="section-title">ğŸ“Š é£é™©ç­‰çº§åˆ†å¸ƒ</h3>
                            <div class="chart-container">
                                <div class="chart-title">é£é™©ç­‰çº§åˆ†å¸ƒå›¾</div>
                                <div class="simple-bar-chart" id="riskLevelChart">
                                    <!-- é£é™©ç­‰çº§æŸ±çŠ¶å›¾ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- è°ˆè¯ä¸»é¢˜åˆ†æ -->
                        <div class="analysis-section">
                            <h3 class="section-title">ğŸ’¬ è°ˆè¯ä¸»é¢˜åˆ†æ</h3>
                            <div class="chart-container">
                                <div class="chart-title">ä¸»é¢˜åˆ†å¸ƒå›¾</div>
                                <div class="pie-chart-container">
                                    <div class="pie-chart" id="topicPieChart"></div>
                                    <div class="pie-legend" id="topicLegend">
                                        <!-- å›¾ä¾‹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ—¶é—´è¶‹åŠ¿åˆ†æ -->
                        <div class="analysis-section">
                            <h3 class="section-title">ğŸ“… æ—¶é—´è¶‹åŠ¿åˆ†æ</h3>
                            <div class="chart-container">
                                <div class="chart-title">æœˆåº¦è°ˆè¯è¶‹åŠ¿</div>
                                <div class="simple-bar-chart" id="monthlyTrendChart">
                                    <!-- æœˆåº¦è¶‹åŠ¿å›¾ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼ -->
                        <div class="analysis-section">
                            <h3 class="section-title">ğŸ“‹ è¯¦ç»†ç»Ÿè®¡æ•°æ®</h3>
                            <div class="chart-container">
                                <div class="chart-title">å„ç­çº§è°ˆè¯ç»Ÿè®¡</div>
                                <div class="table-container">
                                    <table class="analysis-table" id="classAnalysisTable">
                                        <thead>
                                            <tr>
                                                <th>ç­çº§</th>
                                                <th>å­¦ç”Ÿäººæ•°</th>
                                                <th>è°ˆè¯æ¬¡æ•°</th>
                                                <th>äººå‡è°ˆè¯</th>
                                                <th>çº¢è‰²é¢„è­¦</th>
                                                <th>é»„è‰²å…³æ³¨</th>
                                                <th>ç»¿è‰²æ­£å¸¸</th>
                                            </tr>
                                        </thead>
                                        <tbody id="classAnalysisBody">
                                            <!-- ç­çº§ç»Ÿè®¡æ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é«˜é¢‘è°ˆè¯å­¦ç”Ÿ -->
                        <div class="analysis-section">
                            <h3 class="section-title">ğŸ‘¥ é«˜é¢‘è°ˆè¯å­¦ç”Ÿ</h3>
                            <div class="chart-container">
                                <div class="chart-title">è°ˆè¯æ¬¡æ•°æœ€å¤šçš„å­¦ç”Ÿ</div>
                                <div class="table-container">
                                    <table class="analysis-table" id="frequentStudentsTable">
                                        <thead>
                                            <tr>
                                                <th>å§“å</th>
                                                <th>ç­çº§</th>
                                                <th>è°ˆè¯æ¬¡æ•°</th>
                                                <th>é£é™©ç­‰çº§</th>
                                                <th>å¤„åˆ†è®°å½•</th>
                                                <th>å­¦ç±å¼‚åŠ¨</th>
                                                <th>æœ€è¿‘è°ˆè¯</th>
                                            </tr>
                                        </thead>
                                        <tbody id="frequentStudentsBody">
                                            <!-- é«˜é¢‘è°ˆè¯å­¦ç”Ÿæ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®å¯¼å‡º -->
                <div id="exportTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">ğŸ“¤ æ•°æ®å¯¼å‡º</h2>
                        
                        <!-- å¯¼å‡ºç»Ÿè®¡ -->
                        <div class="talk-track-card">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <h4 style="margin: 0;">å¯¼å‡ºç»Ÿè®¡</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">å…± <span id="totalExportCount">0</span> æ¡è®°å½•å¯å¯¼å‡º</p>
                                </div>
                                <div class="talk-count">
                                    <div class="count-item">
                                        <span class="count-number" id="exportRedCount">0</span>
                                        <span class="count-label" style="color:#c62828">çº¢è‰²</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="exportYellowCount">0</span>
                                        <span class="count-label" style="color:#f57f17">é»„è‰²</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="exportGreenCount">0</span>
                                        <span class="count-label" style="color:#2e7d32">ç»¿è‰²</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="export-options" style="margin-top: 20px;">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                                <label>å¯¼å‡ºæ ¼å¼ï¼š</label>
                                <select id="exportFormat" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                                    <option value="excel">Excelæ–‡ä»¶ï¼ˆæ‰€æœ‰è®°å½•ï¼‰</option>
                                    <option value="word">Wordæ–‡æ¡£ï¼ˆå•æ¡è®°å½•ï¼‰</option>
                                    <option value="analysis">åˆ†ææŠ¥å‘Š</option>
                                </select>
                                <label>å¯¼å‡ºèŒƒå›´ï¼š</label>
                                <select id="exportRange" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                                    <option value="all">å…¨éƒ¨è®°å½•</option>
                                    <option value="selected">ä»…é€‰ä¸­è®°å½•</option>
                                    <option value="month">æœ€è¿‘ä¸€ä¸ªæœˆ</option>
                                    <option value="quarter">æœ€è¿‘ä¸‰ä¸ªæœˆ</option>
                                </select>
                                <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                            </div>

                            <div style="margin-top: 15px;">
                                <h3 style="margin-bottom: 10px;">å¯¼å‡ºè¯´æ˜</h3>
                                <p style="color: #666; line-height: 1.6;">
                                    <strong>Excelæ–‡ä»¶ï¼ˆæ‰€æœ‰è®°å½•ï¼‰ï¼š</strong>å°†æ‰€æœ‰è°ˆè¯è®°å½•åˆå¹¶åˆ°ä¸€ä¸ªExcelæ–‡ä»¶ä¸­<br>
                                    <strong>Wordæ–‡æ¡£ï¼ˆå•æ¡è®°å½•ï¼‰ï¼š</strong>å°†å•æ¡è®°å½•å¯¼å‡ºä¸ºWordæ–‡æ¡£ï¼Œæ ¼å¼ä¸åŸè¡¨æ ¼ä¸€è‡´<br>
                                    <strong>åˆ†ææŠ¥å‘Šï¼š</strong>å¯¼å‡ºæ•°æ®åˆ†ææ¨¡å—çš„ç»Ÿè®¡æŠ¥å‘Š<br>
                                    <span style="color: #3498db;">æ–‡ä»¶å‘½åè§„åˆ™ï¼šå§“å_ç­çº§_è°ˆè¯è®°å½•ï¼ˆå¦‚ï¼šå¼ ä¸‰_è®¡ç®—æœº2001ç­_è°ˆå¿ƒè°ˆè¯è®°å½•ï¼‰</span>
                                </p>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>å¯¼å‡ºè®°å½•åˆ—è¡¨</h3>
                            <button class="btn" onclick="refreshExportList()">åˆ·æ–°åˆ—è¡¨</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th width="50"><input type="checkbox" id="selectAllExport" onchange="toggleSelectAllExport(this)"></th>
                                        <th>è°ˆè¯æ—¶é—´</th>
                                        <th>å­¦ç”Ÿå§“å</th>
                                        <th>ç­çº§</th>
                                        <th>è°ˆè¯ä¸»é¢˜</th>
                                        <th>åˆ†çº§å»ºè®®</th>
                                        <th>å¤„åˆ†è®°å½•</th>
                                        <th>è°ˆè¯æ¬¡æ•°</th>
                                    </tr>
                                </thead>
                                <tbody id="exportList">
                                    <!-- å¯¼å‡ºåˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç†æ¨¡å— -->
                <div id="usersTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h2>
                        
                        <!-- ç”¨æˆ·ç»Ÿè®¡ -->
                        <div class="stats-container">
                            <div class="user-stat-card total">
                                <div class="stat-value">
                                    <span style="color: #9b59b6;" id="totalUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">äºº</span>
                                </div>
                                <div class="stat-label">ç”¨æˆ·æ€»æ•°</div>
                            </div>
                            <div class="user-stat-card admin">
                                <div class="stat-value">
                                    <span style="color: #c62828;" id="adminUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">äºº</span>
                                </div>
                                <div class="stat-label">ç®¡ç†å‘˜</div>
                            </div>
                            <div class="user-stat-card counselor">
                                <div class="stat-value">
                                    <span style="color: #27ae60;" id="counselorUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">äºº</span>
                                </div>
                                <div class="stat-label">è¾…å¯¼å‘˜</div>
                            </div>
                            <div class="user-stat-card active">
                                <div class="stat-value">
                                    <span style="color: #3498db;" id="activeUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">äºº</span>
                                </div>
                                <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œåŒºåŸŸ -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">ç”¨æˆ·æ“ä½œ</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="showAddUserModal()">+ æ·»åŠ ç”¨æˆ·</button>
                                <button class="btn btn-warning" onclick="showUserImportModal()">ğŸ“¤ æ‰¹é‡å¯¼å…¥ç”¨æˆ·</button>
                                <button class="btn btn-primary" onclick="exportUsersToExcel()">å¯¼å‡ºç”¨æˆ·åˆ—è¡¨</button>
                                <button class="btn btn-info" onclick="downloadUserTemplate()">ä¸‹è½½ç”¨æˆ·æ¨¡æ¿</button>
                            </div>
                        </div>

                        <!-- æœç´¢åŒºåŸŸ -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="searchUsersInput" class="form-control" placeholder="æœç´¢ç”¨æˆ·åã€å§“åæˆ–éƒ¨é—¨..." style="flex: 1; min-width: 250px;">
                            <select id="roleFilter" class="form-control" style="max-width: 150px;">
                                <option value="">å…¨éƒ¨è§’è‰²</option>
                                <option value="admin">ç®¡ç†å‘˜</option>
                                <option value="counselor">è¾…å¯¼å‘˜</option>
                            </select>
                            <select id="statusFilter" class="form-control" style="max-width: 150px;">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="active">æ´»è·ƒ</option>
                                <option value="inactive">ç¦ç”¨</option>
                            </select>
                            <button class="btn" onclick="searchUsers()">æœç´¢</button>
                            <button class="btn" onclick="clearUserSearch()">é‡ç½®</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>ç”¨æˆ·å</th>
                                        <th>å§“å</th>
                                        <th>éƒ¨é—¨/ç­çº§</th>
                                        <th>è§’è‰²</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åç™»å½•</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <!-- ç”¨æˆ·æ•°æ®åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿè®¾ç½®æ¨¡å— -->
                <div id="settingsTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                        
                        <div class="system-settings-grid">
                            <div class="settings-card">
                                <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                                <div class="settings-item">
                                    <div class="settings-label">ç³»ç»Ÿç‰ˆæœ¬</div>
                                    <div class="settings-value">v2.0</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">æ•°æ®å¤‡ä»½æ—¶é—´</div>
                                    <div class="settings-value" id="lastBackupTime">æœªå¤‡ä»½</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">æ•°æ®å­˜å‚¨å¤§å°</div>
                                    <div class="settings-value" id="dataStorageSize">è®¡ç®—ä¸­...</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">è°ˆè¯è®°å½•æ€»æ•°</div>
                                    <div class="settings-value" id="totalTalkRecords">0</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">å­¦ç”Ÿæ€»æ•°</div>
                                    <div class="settings-value" id="totalStudents">0</div>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>æ•°æ®ç®¡ç†</h3>
                                <div class="settings-item">
                                    <div class="settings-label">è‡ªåŠ¨å¤‡ä»½æ•°æ®</div>
                                    <label class="settings-switch">
                                        <input type="checkbox" id="autoBackup" checked>
                                        <span class="settings-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">å¤‡ä»½é¢‘ç‡</div>
                                    <select id="backupFrequency" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="daily">æ¯å¤©</option>
                                        <option value="weekly">æ¯å‘¨</option>
                                        <option value="monthly">æ¯æœˆ</option>
                                    </select>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">æ•°æ®æ¸…ç†</div>
                                    <button class="btn btn-warning" onclick="cleanOldData()" style="padding: 5px 10px; font-size: 12px;">æ¸…ç†æ—§æ•°æ®</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ç³»ç»Ÿå¤‡ä»½</div>
                                    <button class="btn btn-primary" onclick="backupSystemData()" style="padding: 5px 10px; font-size: 12px;">ç«‹å³å¤‡ä»½</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ç³»ç»Ÿæ¢å¤</div>
                                    <button class="btn btn-danger" onclick="restoreSystemData()" style="padding: 5px 10px; font-size: 12px;">æ¢å¤æ•°æ®</button>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>æƒé™è®¾ç½®</h3>
                                <div class="settings-item">
                                    <div class="settings-label">å…è®¸ç”¨æˆ·æ³¨å†Œ</div>
                                    <label class="settings-switch">
                                        <input type="checkbox" id="allowRegistration">
                                        <span class="settings-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">é»˜è®¤ç”¨æˆ·è§’è‰²</div>
                                    <select id="defaultUserRole" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="counselor">è¾…å¯¼å‘˜</option>
                                        <option value="admin">ç®¡ç†å‘˜</option>
                                    </select>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">å¯†ç å¼ºåº¦è¦æ±‚</div>
                                    <select id="passwordStrength" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="low">ä½</option>
                                        <option value="medium" selected>ä¸­</option>
                                        <option value="high">é«˜</option>
                                    </select>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ä¼šè¯è¶…æ—¶</div>
                                    <select id="sessionTimeout" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="30">30åˆ†é’Ÿ</option>
                                        <option value="60" selected>60åˆ†é’Ÿ</option>
                                        <option value="120">120åˆ†é’Ÿ</option>
                                        <option value="0">æ°¸ä¸è¶…æ—¶</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>ç³»ç»Ÿç»´æŠ¤</h3>
                                <div class="settings-item">
                                    <div class="settings-label">ç³»ç»Ÿæ—¥å¿—</div>
                                    <button class="btn btn-info" onclick="viewSystemLogs()" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹æ—¥å¿—</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ç¼“å­˜æ¸…ç†</div>
                                    <button class="btn btn-warning" onclick="clearSystemCache()" style="padding: 5px 10px; font-size: 12px;">æ¸…ç†ç¼“å­˜</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">æ€§èƒ½ä¼˜åŒ–</div>
                                    <button class="btn btn-primary" onclick="optimizeSystem()" style="padding: 5px 10px; font-size: 12px;">ä¼˜åŒ–ç³»ç»Ÿ</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">æ•°æ®ç»Ÿè®¡</div>
                                    <button class="btn btn-success" onclick="showDataStatistics()" style="padding: 5px 10px; font-size: 12px;">æŸ¥çœ‹ç»Ÿè®¡</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è§’è‰²æƒé™è¯´æ˜ -->
                        <div class="role-permissions" style="margin-top: 20px;">
                            <h4>è§’è‰²æƒé™è¯´æ˜</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                                <div>
                                    <h5 style="color: #c62828;">ç®¡ç†å‘˜æƒé™</h5>
                                    <ul>
                                        <li>ç®¡ç†æ‰€æœ‰ç”¨æˆ·è´¦æˆ·</li>
                                        <li>æ‰¹é‡å¯¼å…¥/å¯¼å‡ºç”¨æˆ·æ•°æ®</li>
                                        <li>æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰è°ˆè¯è®°å½•</li>
                                        <li>ç®¡ç†ç³»ç»Ÿè®¾ç½®å’Œé…ç½®</li>
                                        <li>æ•°æ®å¤‡ä»½å’Œæ¢å¤</li>
                                        <li>æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—å’Œç»Ÿè®¡</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 style="color: #27ae60;">è¾…å¯¼å‘˜æƒé™</h5>
                                    <ul>
                                        <li>ç®¡ç†è‡ªå·±è´Ÿè´£çš„å­¦ç”Ÿ</li>
                                        <li>åˆ›å»ºå’ŒæŸ¥çœ‹è°ˆè¯è®°å½•</li>
                                        <li>å¯¼å‡ºè‡ªå·±çš„è°ˆè¯è®°å½•</li>
                                        <li>æŸ¥çœ‹æ•°æ®ç»Ÿè®¡å’Œåˆ†æ</li>
                                        <li>ä¿®æ”¹ä¸ªäººè´¦æˆ·ä¿¡æ¯</li>
                                        <li>æŸ¥çœ‹å­¦ç”Ÿå†å²è®°å½•</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å­¦ç”Ÿæ¨¡æ€æ¡† -->
    <div id="studentModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;" id="modalTitle">æ·»åŠ å­¦ç”Ÿ</h3>
            <form id="studentForm">
                <input type="hidden" id="modalEditMode" value="false">
                <input type="hidden" id="modalOriginalStudentId" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">å­¦å· *</label>
                        <input type="text" id="modalStudentId" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" id="modalStudentName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç­çº§ *</label>
                        <input type="text" id="modalClassName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å®¿èˆ *</label>
                        <input type="text" id="modalDormitory" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ€§åˆ«</label>
                        <select id="modalGender" class="form-control">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»ç”µè¯</label>
                        <input type="text" id="modalPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ”¿æ²»é¢è²Œ</label>
                        <select id="modalPoliticalStatus" class="form-control">
                            <option value="">è¯·é€‰æ‹©</option>
                           <option value="ä¸­å…±å…šå‘˜">ä¸­å…±å…šå‘˜</option>
<option value="ä¸­å…±é¢„å¤‡å…šå‘˜">ä¸­å…±é¢„å¤‡å…šå‘˜</option>
<option value="å‘å±•å¯¹è±¡">å‘å±•å¯¹è±¡</option>
<option value="å…¥å…šç§¯æåˆ†å­">å…¥å…šç§¯æåˆ†å­</option>
<option value="å…±é’å›¢å‘˜">å…±é’å›¢å‘˜</option>
<option value="ç¾¤ä¼—">ç¾¤ä¼—</option>
                        </select>
<div class="form-group">
    <label class="form-label">èº«ä»½è¯å·</label>
    <input type="text" id="modalIdCard" class="form-control" placeholder="é€‰å¡«">
</div>
<div class="form-group">
    <label class="form-label">è”ç³»æ–¹å¼</label>
    <input type="text" id="modalContactPhone" class="form-control" placeholder="é€‰å¡«">
</div>
<div class="form-group">
    <label class="form-label">å®¶é•¿è”ç³»æ–¹å¼</label>
    <input type="text" id="modalParentPhone" class="form-control" placeholder="é€‰å¡«">
</div>
<div class="form-group">
    <label class="form-label">æˆ·ç±åœ°</label>
    <input type="text" id="modalHometown" class="form-control" placeholder="é€‰å¡«ï¼Œå¦‚ï¼šå¹¿ä¸œçœå¹¿å·å¸‚">
</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å›°éš¾è®¤å®š</label>
                        <select id="modalHardship" class="form-control">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="ç‰¹åˆ«å›°éš¾">ç‰¹åˆ«å›°éš¾</option>
                            <option value="å›°éš¾">å›°éš¾</option>
                            <option value="ä¸€èˆ¬å›°éš¾">ä¸€èˆ¬å›°éš¾</option>
                            <option value="æ— ">æ— </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å­¦ç±å¼‚åŠ¨</label>
                        <input type="text" id="modalStatusChange" class="form-control" placeholder="å¦‚ï¼šä¼‘å­¦ã€è½¬ä¸“ä¸šã€å¤å­¦ç­‰">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é£é™©ç­‰çº§</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalRiskLevel" value="red">
                                <span style="color: #c62828;">çº¢è‰²é¢„è­¦</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalRiskLevel" value="yellow">
                                <span style="color: #f57f17;">é»„è‰²å…³æ³¨</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalRiskLevel" value="green" checked>
                                <span style="color: #2e7d32;">ç»¿è‰²æ­£å¸¸</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- å¤„åˆ†è®°å½• -->
                <div class="form-group">
                    <label class="form-label">å¤„åˆ†è®°å½•</label>
                    <div id="punishmentContainer">
                        <!-- å¤„åˆ†è®°å½•åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <button type="button" class="btn" style="padding: 5px 10px; font-size: 12px; margin-top: 5px;" onclick="addPunishmentField()">+ æ·»åŠ å¤„åˆ†è®°å½•</button>
                </div>
                
                <!-- å­¦ç”Ÿç…§ç‰‡ -->
                <div class="form-group">
                    <label class="form-label">å­¦ç”Ÿç…§ç‰‡</label>
                    <div class="photo-upload-area" onclick="document.getElementById('studentPhotoInput').click()">
                        <div id="photoPreviewContainer">
                            <div class="photo-placeholder">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; color: #666;">å»ºè®®å°ºå¯¸ï¼š120Ã—160pxï¼Œæ”¯æŒJPG/PNGæ ¼å¼</p>
                    </div>
                    <input type="file" id="studentPhotoInput" accept="image/*" style="display: none;" onchange="handleStudentPhotoUpload(event)">
                    <input type="hidden" id="modalStudentPhoto" value="">
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <textarea id="modalGeneralRemark" class="form-control" rows="3" placeholder="å¯å¡«å†™å…¶ä»–å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeStudentModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ‰“å°/å¯¼å‡ºé¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">è°ˆè¯è®°å½•é¢„è§ˆ</h3>
            <div id="docPreview" class="print-content" style="padding: 20px; background: white;">
                <!-- DOCå†…å®¹å°†åŠ¨æ€ç”Ÿæˆåˆ°è¿™é‡Œ -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="exportToWord()">å¯¼å‡ºä¸ºWordæ–‡æ¡£</button>
                <button class="btn" onclick="printDocument()">ç›´æ¥æ‰“å°</button>
                <button class="btn" onclick="closePreviewModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Excelå¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Excelæ‰¹é‡å¯¼å…¥å­¦ç”Ÿæ•°æ®</h3>
            
            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div style="display: flex; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <div style="flex: 1; text-align: center; padding: 10px; background: #3498db; color: white; border-radius: 5px;">
                    æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    æ­¥éª¤2: é¢„è§ˆæ•°æ®
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    æ­¥éª¤3: å¯¼å…¥å®Œæˆ
                </div>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div id="uploadStep">
                <div class="file-upload-area" id="fileDropArea">
                    <div style="font-size: 48px;">ğŸ“</div>
                    <p><strong>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°è¿™é‡Œ</strong></p>
                    <p>æ”¯æŒæ ¼å¼: .xlsx, .xls</p>
                    <p>è¯·ä½¿ç”¨ç³»ç»Ÿæä¾›çš„æ¨¡æ¿æ ¼å¼</p>
                    <div class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
                        é€‰æ‹©Excelæ–‡ä»¶
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                    <h4 style="margin-bottom: 10px;">ğŸ“‹ æ¨¡æ¿æ ¼å¼è¯´æ˜</h4>
                    <p style="margin-bottom: 5px;">Excelæ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼ˆé¡ºåºä¸é™ï¼‰ï¼š</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li><strong>å­¦å·</strong> (å¿…å¡«ï¼Œæ–‡æœ¬æ ¼å¼)</li>
                        <li><strong>å§“å</strong> (å¿…å¡«)</li>
                        <li><strong>ç­çº§</strong> (å¿…å¡«)</li>
                        <li><strong>å®¿èˆ</strong> (é€‰å¡«)</li>
                        <li><strong>æ€§åˆ«</strong> (é€‰å¡«ï¼Œç”·/å¥³)</li>
                        <li><strong>è”ç³»ç”µè¯</strong> (é€‰å¡«)</li>
                        <li><strong>æ”¿æ²»é¢è²Œ</strong> (é€‰å¡«ï¼Œä¸­å…±å…šå‘˜/å…±é’å›¢å‘˜/ç¾¤ä¼—ç­‰)</li>
                        <li><strong>å›°éš¾è®¤å®š</strong> (é€‰å¡«ï¼Œç‰¹åˆ«å›°éš¾/å›°éš¾/ä¸€èˆ¬å›°éš¾/æ— )</li>
                        <li><strong>é£é™©ç­‰çº§</strong> (é€‰å¡«ï¼Œçº¢è‰²é¢„è­¦/é»„è‰²å…³æ³¨/ç»¿è‰²æ­£å¸¸)</li>
                        <li><strong>å¤„åˆ†è®°å½•</strong> (é€‰å¡«ï¼Œå¤šä¸ªå¤„åˆ†ç”¨åˆ†å·åˆ†éš”)</li>
                        <li><strong>å­¦ç±å¼‚åŠ¨</strong> (é€‰å¡«ï¼Œå¦‚ï¼šä¼‘å­¦ã€è½¬ä¸“ä¸šã€å¤å­¦ç­‰)</li>
                        <li><strong>å¤‡æ³¨</strong> (é€‰å¡«)</li>
                    </ul>
                    <button class="btn btn-info" onclick="downloadExcelTemplate()">ä¸‹è½½Excelæ¨¡æ¿</button>
                </div>
            </div>
            
            <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
            <div id="previewStep" style="display: none;">
                <h4 style="margin-bottom: 15px;">æ•°æ®é¢„è§ˆ (å‰10è¡Œ)</h4>
                <div id="previewTableContainer" class="table-container">
                    <!-- é¢„è§ˆè¡¨æ ¼å°†åŠ¨æ€ç”Ÿæˆåˆ°è¿™é‡Œ -->
                </div>
                
                <div id="importSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <p><strong>å¯¼å…¥æ‘˜è¦ï¼š</strong></p>
                    <p>æœ‰æ•ˆæ•°æ®: <span id="validCount">0</span> æ¡</p>
                    <p>æ— æ•ˆæ•°æ®: <span id="invalidCount">0</span> æ¡</p>
                    <p>é‡å¤æ•°æ®: <span id="duplicateCount">0</span> æ¡ (å°†æ›´æ–°)</p>
                </div>
                
                <div class="import-progress" id="importProgress" style="display: none;">
                    <h4 style="margin-bottom: 10px;">å¯¼å…¥è¿›åº¦</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-primary" id="confirmImportBtn" onclick="confirmImport()">ç¡®è®¤å¯¼å…¥</button>
                    <button class="btn" onclick="resetImport()">é‡æ–°ä¸Šä¼ </button>
                    <button class="btn" onclick="closeImportModal()">å–æ¶ˆ</button>
                </div>
            </div>
            
            <!-- å¯¼å…¥å®ŒæˆåŒºåŸŸ -->
            <div id="completeStep" style="display: none; text-align: center;">
                <div style="font-size: 64px; color: #27ae60; margin-bottom: 20px;">âœ…</div>
                <h3>å¯¼å…¥å®Œæˆï¼</h3>
                <p>æˆåŠŸå¯¼å…¥ <span id="successCount">0</span> æ¡å­¦ç”Ÿè®°å½•</p>
                <p>å¤±è´¥ <span id="failCount">0</span> æ¡</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="closeImportModal()">å®Œæˆ</button>
                    <button class="btn" onclick="resetImport()">ç»§ç»­å¯¼å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="studentDetailModal" class="modal">
        <div class="modal-content student-detail-modal">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯</h3>
            <div id="studentDetailContent">
                <!-- å­¦ç”Ÿè¯¦æƒ…å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="editStudentFromDetail()">ç¼–è¾‘</button>
                <button class="btn" onclick="closeStudentDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è°ˆè¯è®°å½•æ¨¡æ€æ¡† -->
    <div id="editTalkModal" class="modal">
        <div class="modal-content edit-talk-modal">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ç¼–è¾‘è°ˆè¯è®°å½•</h3>
            <div id="editTalkFormContainer">
                <!-- ç¼–è¾‘è¡¨å•åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="updateTalkRecord()">ä¿å­˜ä¿®æ”¹</button>
                <button class="btn" onclick="closeEditTalkModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: #2c3e50;" id="userModalTitle">æ·»åŠ ç”¨æˆ·</h3>
            <form id="userForm">
                <input type="hidden" id="userEditMode" value="false">
                <input type="hidden" id="originalUsername" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">ç”¨æˆ·å *</label>
                        <input type="text" id="modalUsername" class="form-control" required oninput="checkUsernameAvailability()">
                        <div id="usernameAvailability" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å§“å *</label>
                        <input type="text" id="modalFullname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç  <span id="passwordRequired">*</span></label>
                        <input type="password" id="modalPassword" class="form-control" oninput="checkPasswordStrength()">
                        <div class="password-strength" id="passwordStrengthIndicator">
                            <div class="password-strength-fill"></div>
                        </div>
                        <div id="passwordStrengthText" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¡®è®¤å¯†ç  <span id="confirmPasswordRequired">*</span></label>
                        <input type="password" id="modalConfirmPassword" class="form-control">
                        <div id="passwordMatch" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">éƒ¨é—¨/ç­çº§</label>
                        <input type="text" id="modalDepartment" class="form-control" placeholder="å¦‚ï¼šè®¡ç®—æœºå­¦é™¢">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è”ç³»ç”µè¯</label>
                        <input type="text" id="modalUserPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é‚®ç®±</label>
                        <input type="email" id="modalEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è§’è‰² *</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserRole" value="admin">
                                <span style="color: #c62828; font-weight: bold;">ç®¡ç†å‘˜</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserRole" value="counselor" checked>
                                <span style="color: #27ae60; font-weight: bold;">è¾…å¯¼å‘˜</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">çŠ¶æ€ *</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserStatus" value="active" checked>
                                <span style="color: #27ae60; font-weight: bold;">æ´»è·ƒ</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserStatus" value="inactive">
                                <span style="color: #95a5a6; font-weight: bold;">ç¦ç”¨</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <textarea id="modalUserRemark" class="form-control" rows="2" placeholder="å¯å¡«å†™ç”¨æˆ·å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeUserModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content user-detail-modal">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</h3>
            <div id="userDetailContent">
                <!-- ç”¨æˆ·è¯¦æƒ…å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="editUserFromDetail()">ç¼–è¾‘</button>
                <button class="btn" onclick="closeUserDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·æ‰¹é‡å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="userImportModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Excelæ‰¹é‡å¯¼å…¥ç”¨æˆ·æ•°æ®</h3>
            
            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div style="display: flex; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <div style="flex: 1; text-align: center; padding: 10px; background: #3498db; color: white; border-radius: 5px;">
                    æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    æ­¥éª¤2: é¢„è§ˆæ•°æ®
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    æ­¥éª¤3: å¯¼å…¥å®Œæˆ
                </div>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div id="userUploadStep">
                <div class="file-upload-area" id="userFileDropArea">
                    <div style="font-size: 48px;">ğŸ‘¤</div>
                    <p><strong>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°è¿™é‡Œ</strong></p>
                    <p>æ”¯æŒæ ¼å¼: .xlsx, .xls</p>
                    <p>è¯·ä½¿ç”¨ç³»ç»Ÿæä¾›çš„æ¨¡æ¿æ ¼å¼</p>
                    <div class="file-upload-btn" onclick="document.getElementById('userFileInput').click()">
                        é€‰æ‹©Excelæ–‡ä»¶
                    </div>
                    <input type="file" id="userFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleUserFileSelect(event)">
                </div>
                
                <div class="user-import-instruction">
                    <h4>ğŸ“‹ ç”¨æˆ·å¯¼å…¥æ¨¡æ¿æ ¼å¼è¯´æ˜</h4>
                    <p style="margin-bottom: 5px;">Excelæ–‡ä»¶å¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼ˆé¡ºåºä¸é™ï¼‰ï¼š</p>
                    <ul>
                        <li><strong>ç”¨æˆ·å</strong> (å¿…å¡«ï¼Œå”¯ä¸€æ ‡è¯†)</li>
                        <li><strong>å§“å</strong> (å¿…å¡«)</li>
                        <li><strong>å¯†ç </strong> (å¿…å¡«ï¼Œè‡³å°‘6ä½)</li>
                        <li><strong>éƒ¨é—¨/ç­çº§</strong> (é€‰å¡«)</li>
                        <li><strong>è”ç³»ç”µè¯</strong> (é€‰å¡«)</li>
                        <li><strong>é‚®ç®±</strong> (é€‰å¡«)</li>
                        <li><strong>è§’è‰²</strong> (é€‰å¡«ï¼Œadmin/counselorï¼Œé»˜è®¤counselor)</li>
                        <li><strong>çŠ¶æ€</strong> (é€‰å¡«ï¼Œactive/inactiveï¼Œé»˜è®¤active)</li>
                        <li><strong>å¤‡æ³¨</strong> (é€‰å¡«)</li>
                    </ul>
                    <button class="btn btn-info" onclick="downloadUserTemplate()">ä¸‹è½½ç”¨æˆ·æ¨¡æ¿</button>
                </div>
            </div>
            
            <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
            <div id="userPreviewStep" style="display: none;">
                <h4 style="margin-bottom: 15px;">ç”¨æˆ·æ•°æ®é¢„è§ˆ (å‰10è¡Œ)</h4>
                <div id="userPreviewTableContainer" class="table-container">
                    <!-- ç”¨æˆ·é¢„è§ˆè¡¨æ ¼å°†åŠ¨æ€ç”Ÿæˆåˆ°è¿™é‡Œ -->
                </div>
                
                <div id="userImportSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <p><strong>å¯¼å…¥æ‘˜è¦ï¼š</strong></p>
                    <p>æœ‰æ•ˆæ•°æ®: <span id="userValidCount">0</span> æ¡</p>
                    <p>æ— æ•ˆæ•°æ®: <span id="userInvalidCount">0</span> æ¡</p>
                    <p>é‡å¤æ•°æ®: <span id="userDuplicateCount">0</span> æ¡ (å°†æ›´æ–°)</p>
                </div>
                
                <div class="import-progress" id="userImportProgress" style="display: none;">
                    <h4 style="margin-bottom: 10px;">å¯¼å…¥è¿›åº¦</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="userProgressFill"></div>
                    </div>
                    <div class="progress-text" id="userProgressText">0%</div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-primary" id="userConfirmImportBtn" onclick="confirmUserImport()">ç¡®è®¤å¯¼å…¥</button>
                    <button class="btn" onclick="resetUserImport()">é‡æ–°ä¸Šä¼ </button>
                    <button class="btn" onclick="closeUserImportModal()">å–æ¶ˆ</button>
                </div>
            </div>
            
            <!-- å¯¼å…¥å®ŒæˆåŒºåŸŸ -->
            <div id="userCompleteStep" style="display: none; text-align: center;">
                <div style="font-size: 64px; color: #27ae60; margin-bottom: 20px;">âœ…</div>
                <h3>ç”¨æˆ·å¯¼å…¥å®Œæˆï¼</h3>
                <p>æˆåŠŸå¯¼å…¥ <span id="userSuccessCount">0</span> ä¸ªç”¨æˆ·</p>
                <p>å¤±è´¥ <span id="userFailCount">0</span> ä¸ª</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="closeUserImportModal()">å®Œæˆ</button>
                    <button class="btn" onclick="resetUserImport()">ç»§ç»­å¯¼å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡ç½®å¯†ç æ¨¡æ€æ¡† -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">é‡ç½®ç”¨æˆ·å¯†ç </h3>
            <div id="resetPasswordContent">
                <p>ç¡®å®šè¦é‡ç½®ç”¨æˆ· <strong id="resetUsername"></strong> çš„å¯†ç å—ï¼Ÿ</p>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">é‡ç½®åå¯†ç å°†å˜ä¸ºï¼š<strong>123456</strong></p>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmResetPassword()">ç¡®è®¤é‡ç½®</button>
                <button class="btn" onclick="closeResetPasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ç®¡ç†å‘˜è´¦å·ä¿¡æ¯
        const ADMIN_USERNAME = 'èµµæ¢¦å©·';
        const ADMIN_PASSWORD = 'CJZFZMT';
        
        // åˆå§‹åŒ–æ•°æ®å­˜å‚¨
        let talkRecords = JSON.parse(localStorage.getItem('talkRecords') || '[]');
        let students = JSON.parse(localStorage.getItem('students') || '[]');
        let drafts = JSON.parse(localStorage.getItem('talkDrafts') || '[]');
        let users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
        let systemSettings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
        let currentUser = null;
        
        // Excelå¯¼å…¥ç›¸å…³å˜é‡
        let importData = [];
        let importPreviewData = [];
        let userImportData = [];
        let userImportPreviewData = [];
        
        // å½“å‰æ—¶é—´ç­›é€‰å™¨
        let currentTimeFilter = 'all';
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®
            initSystemData();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const savedUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainSystem();
                } catch (e) {
                    console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
            
            // è®¾ç½®é»˜è®¤è°ˆè¯æ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const talkTimeInput = document.getElementById('talkTime');
            if (talkTimeInput) {
                talkTimeInput.value = getCurrentDateTime();
            }
            
            // è®¾ç½®è¡¨å•æäº¤äº‹ä»¶
            const talkForm = document.getElementById('talkForm');
            if (talkForm) {
                talkForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTalkRecord();
                });
            }
            
            const studentForm = document.getElementById('studentForm');
            if (studentForm) {
                studentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveStudent();
                });
            }
            
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveUser();
                });
            }
            
            // åˆå§‹åŒ–æ–‡ä»¶æ‹–æ‹½åŠŸèƒ½
            initFileDrop();
            initUserFileDrop();
            
            // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
            initSampleData();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateRecordStats();
            
            // æ£€æŸ¥URLå‚æ•°ï¼Œçœ‹æ˜¯å¦éœ€è¦ç¼–è¾‘è®°å½•
            checkUrlParams();
            
            // æ›´æ–°ç³»ç»Ÿè®¾ç½®æ˜¾ç¤º
            updateSystemSettingsDisplay();
        });
        
        // åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®
        function initSystemData() {
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œåˆå§‹åŒ–ç®¡ç†å‘˜è´¦å·
            if (users.length === 0) {
                const adminUser = {
                    id: Date.now(),
                    username: ADMIN_USERNAME,
                    password: ADMIN_PASSWORD,
                    fullname: 'èµµæ¢¦å©·',
                    role: 'admin',
                    department: 'è´¢ç»æ”¿æ³•å­¦é™¢',
                    phone: '',
                    email: '',
                    status: 'active',
                    createTime: new Date().toISOString(),
                    lastLogin: null,
                    remark: 'ç³»ç»Ÿç®¡ç†å‘˜'
                };
                
                users.push(adminUser);
                localStorage.setItem('systemUsers', JSON.stringify(users));
            }
            
            // å¦‚æœæ²¡æœ‰ç³»ç»Ÿè®¾ç½®ï¼Œåˆå§‹åŒ–é»˜è®¤è®¾ç½®
            if (Object.keys(systemSettings).length === 0) {
                systemSettings = {
                    autoBackup: true,
                    backupFrequency: 'weekly',
                    allowRegistration: false,
                    defaultUserRole: 'counselor',
                    passwordStrength: 'medium',
                    sessionTimeout: 60,
                    lastBackupTime: null
                };
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            }
        }
        
        // æ›´æ–°ç³»ç»Ÿè®¾ç½®æ˜¾ç¤º
        function updateSystemSettingsDisplay() {
            document.getElementById('autoBackup').checked = systemSettings.autoBackup || false;
            document.getElementById('backupFrequency').value = systemSettings.backupFrequency || 'weekly';
            document.getElementById('allowRegistration').checked = systemSettings.allowRegistration || false;
            document.getElementById('defaultUserRole').value = systemSettings.defaultUserRole || 'counselor';
            document.getElementById('passwordStrength').value = systemSettings.passwordStrength || 'medium';
            document.getElementById('sessionTimeout').value = systemSettings.sessionTimeout || 60;
            
            // æ›´æ–°æœ€åå¤‡ä»½æ—¶é—´
            if (systemSettings.lastBackupTime) {
                document.getElementById('lastBackupTime').textContent = formatDate(systemSettings.lastBackupTime);
            }
            
            // è®¡ç®—æ•°æ®å­˜å‚¨å¤§å°
            updateDataStorageSize();
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateSystemStatistics();
        }
        
        // æ›´æ–°æ•°æ®å­˜å‚¨å¤§å°æ˜¾ç¤º
        function updateDataStorageSize() {
            let totalSize = 0;
            
            // è®¡ç®—å„ä¸ªæ•°æ®é¡¹çš„å¤§å°
            const dataItems = [
                { key: 'talkRecords', name: 'è°ˆè¯è®°å½•' },
                { key: 'students', name: 'å­¦ç”Ÿæ•°æ®' },
                { key: 'systemUsers', name: 'ç”¨æˆ·æ•°æ®' },
                { key: 'systemSettings', name: 'ç³»ç»Ÿè®¾ç½®' },
                { key: 'talkDrafts', name: 'è°ˆè¯è‰ç¨¿' }
            ];
            
            dataItems.forEach(item => {
                const data = localStorage.getItem(item.key);
                if (data) {
                    totalSize += new Blob([data]).size;
                }
            });
            
            // è½¬æ¢ä¸ºKBæˆ–MB
            let sizeText;
            if (totalSize < 1024) {
                sizeText = totalSize + ' B';
            } else if (totalSize < 1024 * 1024) {
                sizeText = (totalSize / 1024).toFixed(2) + ' KB';
            } else {
                sizeText = (totalSize / (1024 * 1024)).toFixed(2) + ' MB';
            }
            
            document.getElementById('dataStorageSize').textContent = sizeText;
        }
        
        // æ›´æ–°ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
        function updateSystemStatistics() {
            document.getElementById('totalTalkRecords').textContent = talkRecords.length;
            document.getElementById('totalStudents').textContent = students.length;
        }
        
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            const draftId = urlParams.get('draft');
            
            if (editId) {
                loadTalkRecordForEdit(parseInt(editId));
            } else if (draftId) {
                loadDraftForEdit(parseInt(draftId));
            }
        }
        
        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('username').focus();
        }
        
        // ç™»å½•åŠŸèƒ½
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ï¼', 'error');
                return;
            }
            
            // æŸ¥æ‰¾ç”¨æˆ·
            const user = users.find(u => u.username === username && u.status === 'active');
            
            if (!user) {
                showMessage('è´¦å·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨ï¼', 'error');
                return;
            }
            
            // éªŒè¯å¯†ç 
            if (user.password !== password) {
                showMessage('å¯†ç é”™è¯¯ï¼', 'error');
                return;
            }
            
            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            user.lastLogin = new Date().toISOString();
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            // ä¿å­˜ç™»å½•çŠ¶æ€å’Œå½“å‰ç”¨æˆ·
            currentUser = user;
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            showMainSystem();
            showMessage('ç™»å½•æˆåŠŸï¼', 'success');
        }
        
        function showMainSystem() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            if (currentUser) {
                document.getElementById('counselorName').textContent = currentUser.fullname;
                document.getElementById('currentUserInfo').innerHTML = `
                    ${currentUser.role === 'admin' ? 'ğŸ‘‘ ç®¡ç†å‘˜ï¼š' : 'ğŸ‘¤ è¾…å¯¼å‘˜ï¼š'}
                    <span id="counselorName">${currentUser.fullname}</span>
                `;
                document.getElementById('counselorSignature').value = currentUser.fullname;
                
                // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—ç®¡ç†èœå•
                if (currentUser.role === 'admin') {
                    document.getElementById('userManagementTab').style.display = 'block';
                    document.getElementById('systemSettingsTab').style.display = 'block';
                } else {
                    document.getElementById('userManagementTab').style.display = 'none';
                    document.getElementById('systemSettingsTab').style.display = 'none';
                }
            }
            
            // åŠ è½½æ•°æ®
            loadStudentsTable();
            loadTalkRecords();
            loadExportList();
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼ŒåŠ è½½ç”¨æˆ·åˆ—è¡¨
            if (currentUser && currentUser.role === 'admin') {
                loadUsersTable();
                updateUserStats();
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            updateRecordStats();
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLoginPage();
            showMessage('å·²é€€å‡ºç™»å½•', 'info');
        }
        
        function switchTab(tabName) {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const tabIndex = {
                'record': 0,
                'students': 1,
                'history': 2,
                'analysis': 3,
                'export': 4,
                'users': 5,
                'settings': 6
            }[tabName];
            
            if (tabIndex !== undefined) {
                document.querySelectorAll('.nav-item')[tabIndex].classList.add('active');
            }
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const titles = {
                'record': 'æ–°å»ºè°ˆè¯è®°å½•',
                'students': 'å­¦ç”Ÿæ•°æ®åº“',
                'history': 'å†å²è®°å½•æŸ¥è¯¢',
                'analysis': 'æ•°æ®åˆ†æ',
                'export': 'æ•°æ®å¯¼å‡º',
                'users': 'ç”¨æˆ·ç®¡ç†',
                'settings': 'ç³»ç»Ÿè®¾ç½®'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'æ–°å»ºè°ˆè¯è®°å½•';
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            // å¦‚æœæ˜¯å­¦ç”Ÿæ•°æ®åº“é¡µé¢ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (tabName === 'students') {
                updateStudentStats();
                updateBatchActionState();
            }
            
            // å¦‚æœæ˜¯å†å²è®°å½•é¡µé¢ï¼Œæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (tabName === 'history') {
                updateTalkTrackingStats();
                updateBatchTalkActionState();
            }
            
            // å¦‚æœæ˜¯æ•°æ®åˆ†æé¡µé¢ï¼Œæ›´æ–°åˆ†ææ•°æ®
            if (tabName === 'analysis') {
                updateAnalysisData();
            }
            
            // å¦‚æœæ˜¯å¯¼å‡ºé¡µé¢ï¼Œé‡æ–°åŠ è½½åˆ—è¡¨
            if (tabName === 'export') {
                loadExportList();
            }
            
            // å¦‚æœæ˜¯è®°å½•é¡µé¢ï¼Œæ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            if (tabName === 'record') {
                updateRecordStats();
                const recordStatsCard = document.getElementById('recordStatsCard');
                if (recordStatsCard) {
                    recordStatsCard.style.display = 'block';
                }
            }
            
            // å¦‚æœæ˜¯ç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œæ›´æ–°ç”¨æˆ·ç»Ÿè®¡
            if (tabName === 'users') {
                updateUserStats();
            }
            
            // å¦‚æœæ˜¯ç³»ç»Ÿè®¾ç½®é¡µé¢ï¼Œæ›´æ–°è®¾ç½®æ˜¾ç¤º
            if (tabName === 'settings') {
                updateSystemSettingsDisplay();
            }
        }
        
        function showMessage(message, type) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // åˆ›å»ºæ–°çš„æ¶ˆæ¯
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ç§’åç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
        
        // ==================== ç”¨æˆ·ç®¡ç†åŠŸèƒ½ ====================
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        function loadUsersTable(searchTerm = '', role = '', status = '') {
            const tbody = document.getElementById('usersList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    user.username.includes(searchTerm) ||
                    user.fullname.includes(searchTerm) ||
                    (user.department && user.department.includes(searchTerm))
                );
            }
            
            if (role) {
                filteredUsers = filteredUsers.filter(user => user.role === role);
            }
            
            if (status) {
                filteredUsers = filteredUsers.filter(user => user.status === status);
            }
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                return;
            }
            
            filteredUsers.forEach((user) => {
                const row = document.createElement('tr');
                
                // è§’è‰²æ ‡ç­¾
                let roleTag = '';
                if (user.role === 'admin') {
                    roleTag = '<span class="user-role-tag user-role-admin">ç®¡ç†å‘˜</span>';
                } else {
                    roleTag = '<span class="user-role-tag user-role-counselor">è¾…å¯¼å‘˜</span>';
                }
                
                // çŠ¶æ€æ˜¾ç¤º
                let statusDisplay = '';
                if (user.status === 'active') {
                    statusDisplay = '<span class="user-status-active">æ´»è·ƒ</span>';
                } else {
                    statusDisplay = '<span class="user-status-inactive">ç¦ç”¨</span>';
                }
                
                // æœ€åç™»å½•æ—¶é—´
                let lastLoginDisplay = 'ä»æœªç™»å½•';
                if (user.lastLogin) {
                    lastLoginDisplay = formatDate(user.lastLogin);
                }
                
                // åˆ›å»ºæ—¶é—´
                const createTimeDisplay = formatDate(user.createTime);
                
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullname}</td>
                    <td>${user.department || '-'}</td>
                    <td>${roleTag}</td>
                    <td>${statusDisplay}</td>
                    <td>${lastLoginDisplay}</td>
                    <td>${createTimeDisplay}</td>
                    <td>
                        <button class="user-action-btn user-action-edit" onclick="showUserDetail('${user.username}')">æŸ¥çœ‹</button>
                        <button class="user-action-btn user-action-edit" onclick="editUser('${user.username}')">ç¼–è¾‘</button>
                        <button class="user-action-btn user-action-reset" onclick="resetUserPassword('${user.username}')">é‡ç½®å¯†ç </button>
                        <button class="user-action-btn user-action-toggle" onclick="toggleUserStatus('${user.username}')">${user.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        ${user.username !== ADMIN_USERNAME ? 
                            `<button class="user-action-btn user-action-delete" onclick="deleteUser('${user.username}')">åˆ é™¤</button>` : 
                            ''
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æœç´¢ç”¨æˆ·
        function searchUsers() {
            const searchTerm = document.getElementById('searchUsersInput').value;
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            loadUsersTable(searchTerm, role, status);
        }
        
        // æ¸…ç©ºç”¨æˆ·æœç´¢
        function clearUserSearch() {
            document.getElementById('searchUsersInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            loadUsersTable();
        }
        
        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
        function updateUserStats() {
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.role === 'admin').length;
            const counselorUsers = users.filter(u => u.role === 'counselor').length;
            const activeUsers = users.filter(u => u.status === 'active').length;
            
            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('adminUsersCount').textContent = adminUsers;
            document.getElementById('counselorUsersCount').textContent = counselorUsers;
            document.getElementById('activeUsersCount').textContent = activeUsers;
        }
        
        // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
        function showAddUserModal() {
            const modal = document.getElementById('userModal');
            if (modal) {
                document.getElementById('userModalTitle').textContent = 'æ·»åŠ ç”¨æˆ·';
                document.getElementById('userEditMode').value = 'false';
                document.getElementById('originalUsername').value = '';
                document.getElementById('userForm').reset();
                
                // é‡ç½®å¯†ç ç›¸å…³æ˜¾ç¤º
                document.getElementById('passwordRequired').style.display = 'inline';
                document.getElementById('confirmPasswordRequired').style.display = 'inline';
                document.getElementById('modalPassword').required = true;
                document.getElementById('modalConfirmPassword').required = true;
                
                // é‡ç½®æç¤ºä¿¡æ¯
                document.getElementById('usernameAvailability').innerHTML = '';
                document.getElementById('passwordStrengthText').innerHTML = '';
                document.getElementById('passwordMatch').innerHTML = '';
                document.getElementById('passwordStrengthIndicator').className = 'password-strength';
                
                modal.style.display = 'flex';
            }
        }
        
        // å…³é—­ç”¨æˆ·æ¨¡æ€æ¡†
        function closeUserModal() {
            const modal = document.getElementById('userModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§
        function checkUsernameAvailability() {
            const username = document.getElementById('modalUsername').value.trim();
            const availabilityDiv = document.getElementById('usernameAvailability');
            
            if (!username) {
                availabilityDiv.innerHTML = '';
                return;
            }
            
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            const existingUser = users.find(u => u.username === username);
            const isEditMode = document.getElementById('userEditMode').value === 'true';
            const originalUsername = document.getElementById('originalUsername').value;
            
            if (existingUser && (!isEditMode || (isEditMode && username !== originalUsername))) {
                availabilityDiv.innerHTML = '<span style="color:#c62828">ç”¨æˆ·åå·²å­˜åœ¨ï¼</span>';
                return false;
            } else {
                availabilityDiv.innerHTML = '<span style="color:#27ae60">ç”¨æˆ·åå¯ç”¨</span>';
                return true;
            }
        }
        
        // æ£€æŸ¥å¯†ç å¼ºåº¦
        function checkPasswordStrength() {
            const password = document.getElementById('modalPassword').value;
            const strengthIndicator = document.getElementById('passwordStrengthIndicator');
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (!password) {
                strengthIndicator.className = 'password-strength';
                strengthText.innerHTML = '';
                return 'empty';
            }
            
            let strength = 0;
            
            // æ£€æŸ¥å¯†ç é•¿åº¦
            if (password.length >= 6) strength++;
            if (password.length >= 8) strength++;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­—
            if (/\d/.test(password)) strength++;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å°å†™å­—æ¯
            if (/[a-z]/.test(password)) strength++;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤§å†™å­—æ¯
            if (/[A-Z]/.test(password)) strength++;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            // æ›´æ–°æ˜¾ç¤º
            if (strength <= 2) {
                strengthIndicator.className = 'password-strength weak';
                strengthText.innerHTML = '<span style="color:#c62828">å¯†ç å¼ºåº¦ï¼šå¼±</span>';
                return 'weak';
            } else if (strength <= 4) {
                strengthIndicator.className = 'password-strength medium';
                strengthText.innerHTML = '<span style="color:#f39c12">å¯†ç å¼ºåº¦ï¼šä¸­</span>';
                return 'medium';
            } else {
                strengthIndicator.className = 'password-strength strong';
                strengthText.innerHTML = '<span style="color:#27ae60">å¯†ç å¼ºåº¦ï¼šå¼º</span>';
                return 'strong';
            }
        }
        
        // ä¿å­˜ç”¨æˆ·
        function saveUser() {
            try {
                const isEditMode = document.getElementById('userEditMode').value === 'true';
                const originalUsername = document.getElementById('originalUsername').value;
                
                const username = document.getElementById('modalUsername').value.trim();
                const fullname = document.getElementById('modalFullname').value.trim();
                const password = document.getElementById('modalPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                const department = document.getElementById('modalDepartment').value.trim();
                const phone = document.getElementById('modalUserPhone').value.trim();
                const email = document.getElementById('modalEmail').value.trim();
                const role = document.querySelector('input[name="modalUserRole"]:checked')?.value || 'counselor';
                const status = document.querySelector('input[name="modalUserStatus"]:checked')?.value || 'active';
                const remark = document.getElementById('modalUserRemark').value.trim();
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!username || !fullname) {
                    showMessage('ç”¨æˆ·åå’Œå§“åä¸ºå¿…å¡«é¡¹ï¼', 'error');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§
                if (!checkUsernameAvailability()) {
                    return;
                }
                
                // å¦‚æœæ˜¯æ·»åŠ æ¨¡å¼æˆ–ä¿®æ”¹å¯†ç ï¼ŒéªŒè¯å¯†ç 
                if (!isEditMode || password) {
                    if (!password) {
                        showMessage('è¯·è¾“å…¥å¯†ç ï¼', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showMessage('å¯†ç é•¿åº¦è‡³å°‘6ä½ï¼', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥å¯†ç å¼ºåº¦
                    const passwordStrength = checkPasswordStrength();
                    const requiredStrength = systemSettings.passwordStrength || 'medium';
                    
                    if (requiredStrength === 'medium' && passwordStrength === 'weak') {
                        showMessage('å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ï¼', 'error');
                        return;
                    }
                    
                    if (requiredStrength === 'high' && (passwordStrength === 'weak' || passwordStrength === 'medium')) {
                        showMessage('å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦çš„å¯†ç ï¼', 'error');
                        return;
                    }
                }
                
                // æ„å»ºç”¨æˆ·å¯¹è±¡
                const user = {
                    id: isEditMode ? users.find(u => u.username === originalUsername)?.id || Date.now() : Date.now(),
                    username: username,
                    fullname: fullname,
                    department: department,
                    phone: phone,
                    email: email,
                    role: role,
                    status: status,
                    remark: remark,
                    updateTime: new Date().toISOString()
                };
                
                // å¤„ç†å¯†ç 
                if (isEditMode) {
                    if (password) {
                        user.password = password;
                    } else {
                        // ä¿æŒåŸå¯†ç 
                        const originalUser = users.find(u => u.username === originalUsername);
                        if (originalUser) {
                            user.password = originalUser.password;
                        }
                    }
                    user.createTime = users.find(u => u.username === originalUsername)?.createTime || new Date().toISOString();
                    user.lastLogin = users.find(u => u.username === originalUsername)?.lastLogin || null;
                } else {
                    user.password = password;
                    user.createTime = new Date().toISOString();
                    user.lastLogin = null;
                }
                
                if (isEditMode) {
                    // æ›´æ–°ç°æœ‰ç”¨æˆ·
                    const index = users.findIndex(u => u.username === originalUsername);
                    if (index !== -1) {
                        users[index] = user;
                        
                        // å¦‚æœå½“å‰ç”¨æˆ·ä¿®æ”¹äº†è‡ªå·±çš„ä¿¡æ¯ï¼Œæ›´æ–°å½“å‰ç”¨æˆ·
                        if (currentUser && currentUser.username === originalUsername) {
                            currentUser = user;
                            localStorage.setItem('currentUser', JSON.stringify(user));
                            
                            // æ›´æ–°é¡µé¢æ˜¾ç¤º
                            document.getElementById('counselorName').textContent = user.fullname;
                            document.getElementById('counselorSignature').value = user.fullname;
                        }
                    }
                } else {
                    // æ·»åŠ æ–°ç”¨æˆ·
                    users.push(user);
                }
                
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                updateUserStats();
                closeUserModal();
                showMessage('ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶å‡ºé”™ï¼š', error);
                showMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // ç¼–è¾‘ç”¨æˆ·
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (user) {
                document.getElementById('userModalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
                document.getElementById('userEditMode').value = 'true';
                document.getElementById('originalUsername').value = user.username;
                
                document.getElementById('modalUsername').value = user.username;
                document.getElementById('modalFullname').value = user.fullname;
                document.getElementById('modalDepartment').value = user.department || '';
                document.getElementById('modalUserPhone').value = user.phone || '';
                document.getElementById('modalEmail').value = user.email || '';
                document.getElementById('modalUserRemark').value = user.remark || '';
                
                // è®¾ç½®è§’è‰²
                document.querySelector(`input[name="modalUserRole"][value="${user.role}"]`).checked = true;
                
                // è®¾ç½®çŠ¶æ€
                document.querySelector(`input[name="modalUserStatus"][value="${user.status}"]`).checked = true;
                
                // å¯†ç å­—æ®µç•™ç©ºï¼ˆä¸æ˜¾ç¤ºåŸå¯†ç ï¼‰
                document.getElementById('modalPassword').value = '';
                document.getElementById('modalConfirmPassword').value = '';
                
                // ä¿®æ”¹å¯†ç ç›¸å…³æ˜¾ç¤º
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('confirmPasswordRequired').style.display = 'none';
                document.getElementById('modalPassword').required = false;
                document.getElementById('modalConfirmPassword').required = false;
                document.getElementById('modalPassword').placeholder = 'ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç ';
                
                // é‡ç½®æç¤ºä¿¡æ¯
                document.getElementById('usernameAvailability').innerHTML = '';
                document.getElementById('passwordStrengthText').innerHTML = '';
                document.getElementById('passwordMatch').innerHTML = '';
                document.getElementById('passwordStrengthIndicator').className = 'password-strength';
                
                document.getElementById('userModal').style.display = 'flex';
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…
        function showUserDetail(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // è§’è‰²æ˜¾ç¤º
            let roleDisplay = '';
            if (user.role === 'admin') {
                roleDisplay = '<span class="user-role-tag user-role-admin">ç®¡ç†å‘˜</span>';
            } else {
                roleDisplay = '<span class="user-role-tag user-role-counselor">è¾…å¯¼å‘˜</span>';
            }
            
            // çŠ¶æ€æ˜¾ç¤º
            let statusDisplay = '';
            if (user.status === 'active') {
                statusDisplay = '<span class="user-status-active">æ´»è·ƒ</span>';
            } else {
                statusDisplay = '<span class="user-status-inactive">ç¦ç”¨</span>';
            }
            
            // æœ€åç™»å½•æ—¶é—´
            let lastLoginDisplay = 'ä»æœªç™»å½•';
            if (user.lastLogin) {
                lastLoginDisplay = formatDate(user.lastLogin);
            }
            
            // åˆ›å»ºæ—¶é—´
            const createTimeDisplay = formatDate(user.createTime);
            
            // æ›´æ–°æ—¶é—´
            let updateTimeDisplay = 'æ— ';
            if (user.updateTime) {
                updateTimeDisplay = formatDate(user.updateTime);
            }
            
            const detailContent = `
                <div class="user-detail-grid">
                    <div class="user-detail-item">
                        <div class="user-detail-label">ç”¨æˆ·å</div>
                        <div class="user-detail-value">${user.username}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">å§“å</div>
                        <div class="user-detail-value">${user.fullname}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">éƒ¨é—¨/ç­çº§</div>
                        <div class="user-detail-value">${user.department || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">è”ç³»ç”µè¯</div>
                        <div class="user-detail-value">${user.phone || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">é‚®ç®±</div>
                        <div class="user-detail-value">${user.email || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">è§’è‰²</div>
                        <div class="user-detail-value">${roleDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">çŠ¶æ€</div>
                        <div class="user-detail-value">${statusDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">æœ€åç™»å½•æ—¶é—´</div>
                        <div class="user-detail-value">${lastLoginDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">åˆ›å»ºæ—¶é—´</div>
                        <div class="user-detail-value">${createTimeDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">æœ€åæ›´æ–°æ—¶é—´</div>
                        <div class="user-detail-value">${updateTimeDisplay}</div>
                    </div>
                </div>
                
                ${user.remark ? `
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">å¤‡æ³¨</h4>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${user.remark}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('userDetailContent').innerHTML = detailContent;
            document.getElementById('userDetailModal').style.display = 'flex';
        }
        
        // å…³é—­ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
        function closeUserDetailModal() {
            document.getElementById('userDetailModal').style.display = 'none';
        }
        
        // ä»è¯¦æƒ…é¡µç¼–è¾‘ç”¨æˆ·
        function editUserFromDetail() {
            const modal = document.getElementById('userDetailModal');
            const username = document.querySelector('#userDetailContent .user-detail-value').textContent;
            
            closeUserDetailModal();
            editUser(username);
        }
        
        // é‡ç½®ç”¨æˆ·å¯†ç 
        function resetUserPassword(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            document.getElementById('resetUsername').textContent = username;
            document.getElementById('resetPasswordModal').style.display = 'flex';
            
            // ä¿å­˜è¦é‡ç½®çš„ç”¨æˆ·å
            document.getElementById('resetPasswordModal').setAttribute('data-username', username);
        }
        
        // å…³é—­é‡ç½®å¯†ç æ¨¡æ€æ¡†
        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }
        
        // ç¡®è®¤é‡ç½®å¯†ç 
        function confirmResetPassword() {
            const username = document.getElementById('resetPasswordModal').getAttribute('data-username');
            const user = users.find(u => u.username === username);
            
            if (user) {
                user.password = '123456';
                user.updateTime = new Date().toISOString();
                
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                closeResetPasswordModal();
                showMessage(`ç”¨æˆ· ${username} çš„å¯†ç å·²é‡ç½®ä¸ºï¼š123456`, 'success');
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        function toggleUserStatus(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // ä¸èƒ½ç¦ç”¨è‡ªå·±
            if (currentUser && currentUser.username === username) {
                showMessage('ä¸èƒ½ç¦ç”¨å½“å‰ç™»å½•çš„è´¦å·ï¼', 'error');
                return;
            }
            
            // ä¸èƒ½ç¦ç”¨ç®¡ç†å‘˜è´¦å·
            if (username === ADMIN_USERNAME) {
                showMessage('ä¸èƒ½ç¦ç”¨ç³»ç»Ÿç®¡ç†å‘˜è´¦å·ï¼', 'error');
                return;
            }
            
            const newStatus = user.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
            
            if (confirm(`ç¡®å®šè¦${action}ç”¨æˆ· ${username} å—ï¼Ÿ`)) {
                user.status = newStatus;
                user.updateTime = new Date().toISOString();
                
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                updateUserStats();
                showMessage(`ç”¨æˆ· ${username} å·²${action}`, 'success');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser(username) {
            // ä¸èƒ½åˆ é™¤è‡ªå·±
            if (currentUser && currentUser.username === username) {
                showMessage('ä¸èƒ½åˆ é™¤å½“å‰ç™»å½•çš„è´¦å·ï¼', 'error');
                return;
            }
            
            // ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦å·
            if (username === ADMIN_USERNAME) {
                showMessage('ä¸èƒ½åˆ é™¤ç³»ç»Ÿç®¡ç†å‘˜è´¦å·ï¼', 'error');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                updateUserStats();
                showMessage(`ç”¨æˆ· ${username} å·²åˆ é™¤`, 'success');
            }
        }
        
        // ==================== ç”¨æˆ·æ‰¹é‡å¯¼å…¥åŠŸèƒ½ ====================
        
        // æ˜¾ç¤ºç”¨æˆ·å¯¼å…¥æ¨¡æ€æ¡†
        function showUserImportModal() {
            resetUserImport();
            document.getElementById('userImportModal').style.display = 'flex';
        }
        
        // å…³é—­ç”¨æˆ·å¯¼å…¥æ¨¡æ€æ¡†
        function closeUserImportModal() {
            document.getElementById('userImportModal').style.display = 'none';
        }
        
        // é‡ç½®ç”¨æˆ·å¯¼å…¥
        function resetUserImport() {
            userImportData = [];
            userImportPreviewData = [];
            
            // é‡ç½®æ­¥éª¤æ˜¾ç¤º
            document.getElementById('userUploadStep').style.display = 'block';
            document.getElementById('userPreviewStep').style.display = 'none';
            document.getElementById('userCompleteStep').style.display = 'none';
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            const userFileInput = document.getElementById('userFileInput');
            if (userFileInput) {
                userFileInput.value = '';
            }
            
            // é‡ç½®é¢„è§ˆè¡¨æ ¼
            const userPreviewTableContainer = document.getElementById('userPreviewTableContainer');
            if (userPreviewTableContainer) {
                userPreviewTableContainer.innerHTML = '';
            }
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·æ–‡ä»¶æ‹–æ‹½
        function initUserFileDrop() {
            const dropArea = document.getElementById('userFileDropArea');
            if (!dropArea) return;
            
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });
            
            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
            });
            
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    handleUserFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        }
        
        // å¤„ç†ç”¨æˆ·æ–‡ä»¶é€‰æ‹©
        function handleUserFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xls æ ¼å¼ï¼‰', 'error');
                return;
            }
            
            showMessage('æ­£åœ¨è¯»å–Excelæ–‡ä»¶...', 'info');
            
            // ä½¿ç”¨FileReaderè¯»å–æ–‡ä»¶
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONï¼ˆåŒ…å«ç©ºå•å…ƒæ ¼ï¼‰
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                        header: 1, 
                        defval: '',
                        blankrows: true
                    });
                    
                    if (jsonData.length <= 1) {
                        showMessage('Excelæ–‡ä»¶æ²¡æœ‰æ•°æ®æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿è‡³å°‘æœ‰æ•°æ®è¡Œã€‚', 'error');
                        return;
                    }
                    
                    // å¤„ç†ç”¨æˆ·Excelæ•°æ®
                    processUserExcelData(jsonData);
                    
                } catch (error) {
                    console.error('è¯»å–Excelæ–‡ä»¶æ—¶å‡ºé”™ï¼š', error);
                    showMessage(`è¯»å–Excelæ–‡ä»¶å¤±è´¥ï¼š${error.message}ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚`, 'error');
                }
            };
            
            reader.onerror = function(e) {
                console.error('æ–‡ä»¶è¯»å–é”™è¯¯ï¼š', e);
                showMessage('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // å¤„ç†ç”¨æˆ·Excelæ•°æ®
        function processUserExcelData(jsonData) {
            // è·å–è¡¨å¤´è¡Œ
            const headers = jsonData[0];
            
            // æ ‡å‡†åŒ–è¡¨å¤´åç§°æ˜ å°„
            const headerMapping = {
                'ç”¨æˆ·å': ['ç”¨æˆ·å', 'è´¦å·', 'username', 'Username', 'ç”¨æˆ·è´¦å·'],
                'å§“å': ['å§“å', 'åå­—', 'fullname', 'Fullname', 'ç”¨æˆ·å§“å'],
                'å¯†ç ': ['å¯†ç ', 'password', 'Password'],
                'éƒ¨é—¨/ç­çº§': ['éƒ¨é—¨/ç­çº§', 'éƒ¨é—¨', 'ç­çº§', 'department', 'Department', 'ç­çº§éƒ¨é—¨'],
                'è”ç³»ç”µè¯': ['è”ç³»ç”µè¯', 'ç”µè¯', 'æ‰‹æœº', 'phone', 'Phone', 'è”ç³»ç”µè¯'],
                'é‚®ç®±': ['é‚®ç®±', 'ç”µå­é‚®ä»¶', 'email', 'Email'],
                'è§’è‰²': ['è§’è‰²', 'ç”¨æˆ·è§’è‰²', 'role', 'Role'],
                'çŠ¶æ€': ['çŠ¶æ€', 'ç”¨æˆ·çŠ¶æ€', 'status', 'Status'],
                'å¤‡æ³¨': ['å¤‡æ³¨', 'è¯´æ˜', 'remark', 'Remark']
            };
            
            // åˆ›å»ºå®é™…åˆ—ç´¢å¼•æ˜ å°„
            const headerMap = {};
            
            // æŸ¥æ‰¾å„åˆ—ç´¢å¼•
            headers.forEach((header, index) => {
                if (header) {
                    const headerStr = header.toString().trim();
                    
                    // éå†æ˜ å°„è¡¨ï¼Œæ‰¾åˆ°åŒ¹é…çš„åˆ—
                    for (const [standardName, possibleNames] of Object.entries(headerMapping)) {
                        if (possibleNames.some(name => headerStr.includes(name) || name.includes(headerStr))) {
                            headerMap[standardName] = index;
                            break;
                        }
                    }
                }
            });
            
            // æ£€æŸ¥å¿…éœ€åˆ—
            const requiredColumns = ['ç”¨æˆ·å', 'å§“å', 'å¯†ç '];
            const missingColumns = requiredColumns.filter(col => headerMap[col] === undefined);
            
            if (missingColumns.length > 0) {
                showMessage(`Excelç¼ºå°‘å¿…éœ€åˆ—ï¼š${missingColumns.join('ã€')}ã€‚è¯·ä¸‹è½½æ¨¡æ¿å¹¶æŒ‰æ¨¡æ¿æ ¼å¼å¡«å†™ã€‚`, 'error');
                return;
            }
            
            // å¤„ç†æ•°æ®è¡Œ
            userImportData = [];
            let validCount = 0;
            let invalidCount = 0;
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // è·³è¿‡ç©ºè¡Œ
                if (!row || row.length === 0 || row.every(cell => cell === null || cell === undefined || cell.toString().trim() === '')) {
                    continue;
                }
                
                // æå–æ•°æ®
                const getCellValue = (columnName) => {
                    const index = headerMap[columnName];
                    if (index !== undefined && row[index] !== undefined && row[index] !== null) {
                        return row[index].toString().trim();
                    }
                    return '';
                };
                
                const username = getCellValue('ç”¨æˆ·å');
                const fullname = getCellValue('å§“å');
                const password = getCellValue('å¯†ç ');
                
                // éªŒè¯å¿…éœ€å­—æ®µ
                if (!username || !fullname || !password) {
                    invalidCount++;
                    continue;
                }
                
                // éªŒè¯å¯†ç é•¿åº¦
                if (password.length < 6) {
                    invalidCount++;
                    continue;
                }
                
                // æ„å»ºç”¨æˆ·å¯¹è±¡
                const user = {
                    username: username,
                    fullname: fullname,
                    password: password,
                    department: getCellValue('éƒ¨é—¨/ç­çº§'),
                    phone: getCellValue('è”ç³»ç”µè¯'),
                    email: getCellValue('é‚®ç®±'),
                    remark: getCellValue('å¤‡æ³¨')
                };
                
                // å¤„ç†è§’è‰²
                const roleStr = getCellValue('è§’è‰²');
                if (roleStr) {
                    const roleLower = roleStr.toLowerCase();
                    if (roleLower.includes('admin') || roleLower.includes('ç®¡ç†å‘˜')) {
                        user.role = 'admin';
                    } else {
                        user.role = 'counselor';
                    }
                } else {
                    user.role = systemSettings.defaultUserRole || 'counselor';
                }
                
                // å¤„ç†çŠ¶æ€
                const statusStr = getCellValue('çŠ¶æ€');
                if (statusStr) {
                    const statusLower = statusStr.toLowerCase();
                    if (statusLower.includes('inactive') || statusLower.includes('ç¦ç”¨') || statusLower.includes('åœç”¨')) {
                        user.status = 'inactive';
                    } else {
                        user.status = 'active';
                    }
                } else {
                    user.status = 'active';
                }
                
                userImportData.push(user);
                validCount++;
            }
            
            if (userImportData.length === 0) {
                showMessage('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„ç”¨æˆ·æ•°æ®ã€‚è¯·ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ã€‚', 'error');
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆæ•°æ®ï¼ˆæœ€å¤š10è¡Œï¼‰
            userImportPreviewData = userImportData.slice(0, 10);
            
            // æ£€æŸ¥é‡å¤æ•°æ®
            const existingUsernames = users.map(u => u.username);
            const duplicateCount = userImportData.filter(u => existingUsernames.includes(u.username)).length;
            
            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            document.getElementById('userValidCount').textContent = validCount;
            document.getElementById('userInvalidCount').textContent = invalidCount;
            document.getElementById('userDuplicateCount').textContent = duplicateCount;
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            generateUserPreviewTable();
            
            // åˆ‡æ¢åˆ°é¢„è§ˆæ­¥éª¤
            document.getElementById('userUploadStep').style.display = 'none';
            document.getElementById('userPreviewStep').style.display = 'block';
            
            showMessage(`æˆåŠŸè¯»å– ${validCount} æ¡æœ‰æ•ˆæ•°æ®ï¼Œ${invalidCount} æ¡æ— æ•ˆæ•°æ®`, 'success');
        }
        
        // ç”Ÿæˆç”¨æˆ·é¢„è§ˆè¡¨æ ¼
        function generateUserPreviewTable() {
            const container = document.getElementById('userPreviewTableContainer');
            let html = '<table class="preview-table">';
            
            // è¡¨å¤´
            html += '<thead><tr>';
            html += '<th>ç”¨æˆ·å</th>';
            html += '<th>å§“å</th>';
            html += '<th>éƒ¨é—¨/ç­çº§</th>';
            html += '<th>è§’è‰²</th>';
            html += '<th>çŠ¶æ€</th>';
            html += '<th>çŠ¶æ€</th>';
            html += '</tr></thead>';
            
            // æ•°æ®è¡Œ
            html += '<tbody>';
            
            const existingUsernames = users.map(u => u.username);
            
            userImportPreviewData.forEach((user, index) => {
                const isDuplicate = existingUsernames.includes(user.username);
                const rowClass = isDuplicate ? 'invalid' : 'valid';
                
                // è§’è‰²æ˜¾ç¤º
                let roleDisplay = '';
                if (user.role === 'admin') {
                    roleDisplay = '<span style="color:#c62828;font-weight:bold;">ç®¡ç†å‘˜</span>';
                } else {
                    roleDisplay = '<span style="color:#27ae60;">è¾…å¯¼å‘˜</span>';
                }
                
                // çŠ¶æ€æ˜¾ç¤º
                let statusDisplay = '';
                if (user.status === 'active') {
                    statusDisplay = '<span style="color:#27ae60;font-weight:bold;">æ´»è·ƒ</span>';
                } else {
                    statusDisplay = '<span style="color:#95a5a6;">ç¦ç”¨</span>';
                }
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${user.username}</td>`;
                html += `<td>${user.fullname}</td>`;
                html += `<td>${user.department || '-'}</td>`;
                html += `<td>${roleDisplay}</td>`;
                html += `<td>${statusDisplay}</td>`;
                html += `<td>${isDuplicate ? '<span style="color:#c62828;">é‡å¤</span>' : '<span style="color:#2e7d32;">æœ‰æ•ˆ</span>'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // æ·»åŠ æç¤ºä¿¡æ¯
            if (userImportData.length > 10) {
                html += `<p style="text-align:center;color:#666;margin-top:10px;">ä»…æ˜¾ç¤ºå‰10è¡Œæ•°æ®ï¼Œå…± ${userImportData.length} è¡Œæ•°æ®</p>`;
            }
            
            container.innerHTML = html;
        }
        
        // ç¡®è®¤å¯¼å…¥ç”¨æˆ·
        function confirmUserImport() {
            const existingUsernames = users.map(u => u.username);
            let successCount = 0;
            let failCount = 0;
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('userImportProgress').style.display = 'block';
            const progressFill = document.getElementById('userProgressFill');
            const progressText = document.getElementById('userProgressText');
            
            // åˆ†æ‰¹å¯¼å…¥
            const batchSize = 50;
            const totalBatches = Math.ceil(userImportData.length / batchSize);
            let currentBatch = 0;
            
            function importUserBatch() {
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, userImportData.length);
                
                for (let i = start; i < end; i++) {
                    const userData = userImportData[i];
                    
                    // æ£€æŸ¥æ˜¯å¦é‡å¤
                    if (!existingUsernames.includes(userData.username)) {
                        // æ·»åŠ åˆ›å»ºæ—¶é—´ç­‰ä¿¡æ¯
                        const newUser = {
                            ...userData,
                            id: Date.now() + i,
                            createTime: new Date().toISOString(),
                            lastLogin: null,
                            updateTime: new Date().toISOString()
                        };
                        
                        users.push(newUser);
                        successCount++;
                    } else {
                        // æ›´æ–°ç°æœ‰ç”¨æˆ·ä¿¡æ¯ï¼ˆé™¤äº†å¯†ç ï¼‰
                        const existingIndex = users.findIndex(u => u.username === userData.username);
                        if (existingIndex >= 0) {
                            // ä¿ç•™åŸå¯†ç 
                            const originalPassword = users[existingIndex].password;
                            users[existingIndex] = { 
                                ...users[existingIndex], 
                                ...userData,
                                password: originalPassword, // ä¿ç•™åŸå¯†ç ï¼Œä¸æ›´æ–°
                                updateTime: new Date().toISOString()
                            };
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                }
                
                // æ›´æ–°è¿›åº¦
                currentBatch++;
                const progress = Math.round((currentBatch / totalBatches) * 100);
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${progress}% (${currentBatch * batchSize}/${userImportData.length})`;
                
                if (currentBatch < totalBatches) {
                    // ç»§ç»­ä¸‹ä¸€æ‰¹
                    setTimeout(importUserBatch, 10);
                } else {
                    // å¯¼å…¥å®Œæˆ
                    localStorage.setItem('systemUsers', JSON.stringify(users));
                    
                    // æ›´æ–°å®Œæˆé¡µé¢
                    document.getElementById('userSuccessCount').textContent = successCount;
                    document.getElementById('userFailCount').textContent = failCount;
                    
                    // åˆ‡æ¢åˆ°å®Œæˆæ­¥éª¤
                    document.getElementById('userPreviewStep').style.display = 'none';
                    document.getElementById('userCompleteStep').style.display = 'block';
                    
                    // åˆ·æ–°ç”¨æˆ·è¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯
                    loadUsersTable();
                    updateUserStats();
                    
                    showMessage(`æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªç”¨æˆ·`, 'success');
                }
            }
            
            // å¼€å§‹å¯¼å…¥
            importUserBatch();
        }
        
        // ä¸‹è½½ç”¨æˆ·æ¨¡æ¿
        function downloadUserTemplate() {
            if (typeof XLSX === 'undefined') {
                showMessage('Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            const templateData = [
                ['ç”¨æˆ·å', 'å§“å', 'å¯†ç ', 'éƒ¨é—¨/ç­çº§', 'è”ç³»ç”µè¯', 'é‚®ç®±', 'è§’è‰²', 'çŠ¶æ€', 'å¤‡æ³¨'],
                ['zhangshan', 'å¼ ä¸‰', 'zhangshan123', 'è®¡ç®—æœºå­¦é™¢', '13800138000', 'zhangshan@example.com', 'counselor', 'active', 'è®¡ç®—æœºå­¦é™¢è¾…å¯¼å‘˜'],
                ['lisi', 'æå››', 'lisi123456', 'è½¯ä»¶å·¥ç¨‹2001ç­', '13800138001', 'lisi@example.com', 'counselor', 'active', 'è½¯ä»¶å·¥ç¨‹2001ç­è¾…å¯¼å‘˜'],
                ['wangwu', 'ç‹äº”', 'wangwu123', 'è´¢ç»æ”¿æ³•å­¦é™¢', '13800138002', 'wangwu@example.com', 'admin', 'active', 'ç³»ç»Ÿç®¡ç†å‘˜'],
                ['zhaoliu', 'èµµå…­', 'zhaoliu123', 'äººå·¥æ™ºèƒ½å­¦é™¢', '13800138003', 'zhaoliu@example.com', 'counselor', 'inactive', 'å·²ç¦»èŒ'],
                ['qianqi', 'é’±ä¸ƒ', 'qianqi123', 'æ•°æ®ç§‘å­¦2001ç­', '13800138004', 'qianqi@example.com', 'counselor', 'active', 'æ•°æ®ç§‘å­¦2001ç­è¾…å¯¼å‘˜']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç”¨æˆ·æ•°æ®');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ç”¨æˆ·æ•°æ®å¯¼å…¥æ¨¡æ¿.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('ç”¨æˆ·æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼', 'success');
        }
        
        // å¯¼å‡ºç”¨æˆ·åˆ—è¡¨åˆ°Excel
        function exportUsersToExcel() {
            if (typeof XLSX === 'undefined') {
                showMessage('Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            if (users.length === 0) {
                showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„ç”¨æˆ·æ•°æ®ï¼', 'error');
                return;
            }
            
            const exportData = [
                ['ç”¨æˆ·å', 'å§“å', 'éƒ¨é—¨/ç­çº§', 'è”ç³»ç”µè¯', 'é‚®ç®±', 'è§’è‰²', 'çŠ¶æ€', 'æœ€åç™»å½•æ—¶é—´', 'åˆ›å»ºæ—¶é—´', 'å¤‡æ³¨']
            ];
            
            users.forEach(user => {
                // è½¬æ¢è§’è‰²ä¸ºä¸­æ–‡
                let roleText = 'è¾…å¯¼å‘˜';
                if (user.role === 'admin') {
                    roleText = 'ç®¡ç†å‘˜';
                }
                
                // è½¬æ¢çŠ¶æ€ä¸ºä¸­æ–‡
                let statusText = 'æ´»è·ƒ';
                if (user.status === 'inactive') {
                    statusText = 'ç¦ç”¨';
                }
                
                // æœ€åç™»å½•æ—¶é—´
                let lastLoginText = 'ä»æœªç™»å½•';
                if (user.lastLogin) {
                    lastLoginText = formatDate(user.lastLogin);
                }
                
                // åˆ›å»ºæ—¶é—´
                const createTimeText = formatDate(user.createTime);
                
                exportData.push([
                    user.username,
                    user.fullname,
                    user.department || '',
                    user.phone || '',
                    user.email || '',
                    roleText,
                    statusText,
                    lastLoginText,
                    createTimeText,
                    user.remark || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç”¨æˆ·æ•°æ®');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç”¨æˆ·åˆ—è¡¨_${date}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`ç”¨æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸï¼Œå…±å¯¼å‡º ${users.length} æ¡è®°å½•`, 'success');
        }
        
        // ==================== ç³»ç»Ÿè®¾ç½®åŠŸèƒ½ ====================
        
        // ç³»ç»Ÿæ•°æ®å¤‡ä»½
        function backupSystemData() {
            try {
                // æ”¶é›†æ‰€æœ‰ç³»ç»Ÿæ•°æ®
                const backupData = {
                    talkRecords: talkRecords,
                    students: students,
                    systemUsers: users,
                    systemSettings: systemSettings,
                    talkDrafts: drafts,
                    backupTime: new Date().toISOString()
                };
                
                // åˆ›å»ºå¤‡ä»½æ–‡ä»¶
                const backupStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupStr], { type: 'application/json' });
                const date = new Date();
                const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç³»ç»Ÿå¤‡ä»½_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // æ›´æ–°æœ€åå¤‡ä»½æ—¶é—´
                systemSettings.lastBackupTime = new Date().toISOString();
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                updateSystemSettingsDisplay();
                
                showMessage('ç³»ç»Ÿæ•°æ®å¤‡ä»½æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¤‡ä»½ç³»ç»Ÿæ•°æ®æ—¶å‡ºé”™ï¼š', error);
                showMessage('å¤‡ä»½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // æ¢å¤ç³»ç»Ÿæ•°æ®
        function restoreSystemData() {
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // éªŒè¯å¤‡ä»½æ•°æ®æ ¼å¼
                        if (!backupData.talkRecords || !backupData.students || !backupData.systemUsers) {
                            showMessage('å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼', 'error');
                            return;
                        }
                        
                        if (confirm('ç¡®å®šè¦æ¢å¤ç³»ç»Ÿæ•°æ®å—ï¼Ÿå½“å‰æ‰€æœ‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) {
                            // æ¢å¤æ•°æ®
                            talkRecords = backupData.talkRecords;
                            students = backupData.students;
                            users = backupData.systemUsers;
                            systemSettings = backupData.systemSettings || {};
                            drafts = backupData.talkDrafts || [];
                            
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                            localStorage.setItem('students', JSON.stringify(students));
                            localStorage.setItem('systemUsers', JSON.stringify(users));
                            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                            localStorage.setItem('talkDrafts', JSON.stringify(drafts));
                            
                            // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
                            loadStudentsTable();
                            loadTalkRecords();
                            loadExportList();
                            loadUsersTable();
                            updateRecordStats();
                            updateTalkTrackingStats();
                            updateUserStats();
                            updateSystemSettingsDisplay();
                            
                            showMessage('ç³»ç»Ÿæ•°æ®æ¢å¤æˆåŠŸï¼', 'success');
                        }
                    } catch (error) {
                        console.error('æ¢å¤ç³»ç»Ÿæ•°æ®æ—¶å‡ºé”™ï¼š', error);
                        showMessage('æ¢å¤å¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // æ¸…ç†æ—§æ•°æ®
        function cleanOldData() {
            if (confirm('ç¡®å®šè¦æ¸…ç†ä¸€å¹´å‰çš„è°ˆè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                const oldRecordsCount = talkRecords.length;
                talkRecords = talkRecords.filter(record => new Date(record.talkTime) >= oneYearAgo);
                
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                // é‡æ–°åŠ è½½æ•°æ®
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                updateAnalysisData();
                
                const cleanedCount = oldRecordsCount - talkRecords.length;
                showMessage(`å·²æ¸…ç† ${cleanedCount} æ¡ä¸€å¹´å‰çš„è°ˆè¯è®°å½•`, 'success');
            }
        }
        
        // æ¸…ç†ç³»ç»Ÿç¼“å­˜
        function clearSystemCache() {
            // æ¸…ç†è‰ç¨¿æ•°æ®
            drafts = [];
            localStorage.setItem('talkDrafts', JSON.stringify(drafts));
            
            // æ¸…ç†å…¶ä»–ä¸´æ—¶æ•°æ®
            localStorage.removeItem('importData');
            localStorage.removeItem('importPreviewData');
            localStorage.removeItem('userImportData');
            localStorage.removeItem('userImportPreviewData');
            
            showMessage('ç³»ç»Ÿç¼“å­˜å·²æ¸…ç†ï¼', 'success');
        }
        
        // ç³»ç»Ÿä¼˜åŒ–
        function optimizeSystem() {
            showMessage('ç³»ç»Ÿä¼˜åŒ–å®Œæˆï¼', 'success');
        }
        
        // æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function viewSystemLogs() {
            showMessage('ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
        }
        
        // æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
        function showDataStatistics() {
            // åˆ‡æ¢åˆ°æ•°æ®åˆ†æé¡µé¢
            switchTab('analysis');
        }
        
        // ==================== ä»¥ä¸‹ä¸ºåŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ ====================
        
         // ==================== å†å²è°ˆè¯è®°å½•æ‰¹é‡åˆ é™¤åŠŸèƒ½ ====================
        
        // åˆ‡æ¢æ‰€æœ‰è°ˆè¯è®°å½•çš„é€‰æ‹©çŠ¶æ€
        function toggleSelectAllTalks(checkbox) {
            const checkboxes = document.querySelectorAll('.talk-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBatchTalkActionState();
        }
        
        // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
        function updateBatchTalkActionState() {
            const checkboxes = document.querySelectorAll('.talk-checkbox:checked');
            const selectedCount = checkboxes.length;
            const batchDeleteBtn = document.getElementById('batchDeleteTalkBtn');
            const batchActionInfo = document.getElementById('batchTalkActionInfo');
            const selectedCountSpan = document.getElementById('selectedTalkCount');
            
            if (selectedCount > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchActionInfo.style.display = 'block';
                selectedCountSpan.textContent = selectedCount;
            } else {
                batchDeleteBtn.style.display = 'none';
                batchActionInfo.style.display = 'none';
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰è°ˆè¯è®°å½•çš„é€‰æ‹©
        function clearTalkSelection() {
            const checkboxes = document.querySelectorAll('.talk-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllTalks').checked = false;
            updateBatchTalkActionState();
        }
        
        // æ‰¹é‡åˆ é™¤è°ˆè¯è®°å½•
        function batchDeleteTalkRecords() {
            const checkboxes = document.querySelectorAll('.talk-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è°ˆè¯è®°å½•ï¼', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡è°ˆè¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            try {
                // åˆ é™¤é€‰ä¸­çš„è°ˆè¯è®°å½•
                talkRecords = talkRecords.filter(record => !selectedIds.includes(record.id));
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                // åˆ·æ–°ç•Œé¢
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                updateAnalysisData();
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                clearTalkSelection();
                
                showMessage(`æˆåŠŸåˆ é™¤ ${selectedIds.length} æ¡è°ˆè¯è®°å½•ï¼`, 'success');
                
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤è°ˆè¯è®°å½•æ—¶å‡ºé”™ï¼š', error);
                showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
       // ==================== æ•°æ®åˆ†ææ¨¡å—åŠŸèƒ½ ====================
        
        // æ›´æ–°åˆ†ææ•°æ®
        function updateAnalysisData() {
            console.log('æ›´æ–°åˆ†ææ•°æ®...');
            
            // ä»localStorageé‡æ–°åŠ è½½æ•°æ®
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            const storedStudents = localStorage.getItem('students');
            if (storedStudents) {
                students = JSON.parse(storedStudents);
            }
            
            // è·å–ç­›é€‰æ¡ä»¶
            const timeRange = document.getElementById('analysisTimeRange').value;
            const classFilter = document.getElementById('analysisClassFilter').value;
            
            // ç­›é€‰æ•°æ®
            let filteredRecords = [...talkRecords];
            let filteredStudents = [...students];
            
            // æ—¶é—´ç­›é€‰
            if (timeRange !== 'all') {
                const now = new Date();
                let dateFrom = new Date();
                
                switch(timeRange) {
                    case 'month':
                        dateFrom.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        dateFrom.setMonth(now.getMonth() - 3);
                        break;
                    case 'halfyear':
                        dateFrom.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        dateFrom.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredRecords = filteredRecords.filter(record => 
                    new Date(record.talkTime) >= dateFrom
                );
            }
            
            // ç­çº§ç­›é€‰
            if (classFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.className === classFilter
                );
                
                filteredStudents = filteredStudents.filter(student => 
                    student.className === classFilter
                );
            }
            
            // æ›´æ–°ç­çº§ç­›é€‰å™¨é€‰é¡¹
            updateClassFilterOptions();
            
            // æ›´æ–°æ€»ä½“æ•°æ®æ¦‚è§ˆ
            updateAnalysisOverview(filteredRecords, filteredStudents);
            
            // æ›´æ–°é£é™©ç­‰çº§åˆ†å¸ƒ
            updateRiskLevelChart(filteredRecords);
            
            // æ›´æ–°è°ˆè¯ä¸»é¢˜åˆ†æ
            updateTopicAnalysis(filteredRecords);
            
            // æ›´æ–°æ—¶é—´è¶‹åŠ¿åˆ†æ
            updateTimeTrendChart(filteredRecords);
            
            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼
            updateClassAnalysisTable(filteredRecords, filteredStudents);
            
            // æ›´æ–°é«˜é¢‘è°ˆè¯å­¦ç”Ÿ
            updateFrequentStudentsTable(filteredRecords);
            
            // æ›´æ–°æ•°æ®æ´å¯Ÿ
            updateDataInsights(filteredRecords, filteredStudents);
        }
        
        // åˆ·æ–°åˆ†ææ•°æ®
        function refreshAnalysisData() {
            updateAnalysisData();
            showMessage('åˆ†ææ•°æ®å·²åˆ·æ–°', 'success');
        }
        
        // æ›´æ–°ç­çº§ç­›é€‰å™¨é€‰é¡¹
        function updateClassFilterOptions() {
            const classFilter = document.getElementById('analysisClassFilter');
            if (!classFilter) return;
            
            // è·å–æ‰€æœ‰ç­çº§
            const classes = [...new Set(students.map(student => student.className))].filter(c => c);
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"å…¨éƒ¨ç­çº§"é€‰é¡¹ï¼‰
            while (classFilter.options.length > 1) {
                classFilter.remove(1);
            }
            
            // æ·»åŠ ç­çº§é€‰é¡¹
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }
        
        // æ›´æ–°æ€»ä½“æ•°æ®æ¦‚è§ˆ
        function updateAnalysisOverview(records, studentsData) {
            const totalCount = records.length;
            const studentCount = new Set(records.map(r => r.studentId)).size;
            const redCount = records.filter(r => r.riskLevel === 'red').length;
            const redPercent = totalCount > 0 ? Math.round((redCount / totalCount) * 100) : 0;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalAnalysisCount').textContent = totalCount;
            document.getElementById('analysisStudentCount').textContent = studentCount;
            document.getElementById('analysisRedPercent').textContent = `${redPercent}%`;
        }
        
        // æ›´æ–°é£é™©ç­‰çº§åˆ†å¸ƒå›¾è¡¨
        function updateRiskLevelChart(records) {
            const chartContainer = document.getElementById('riskLevelChart');
            if (!chartContainer) return;
            
            // ç»Ÿè®¡é£é™©ç­‰çº§
            const riskCounts = {
                red: records.filter(r => r.riskLevel === 'red').length,
                yellow: records.filter(r => r.riskLevel === 'yellow').length,
                green: records.filter(r => r.riskLevel === 'green').length
            };
            
            // è®¡ç®—æœ€å¤§æ•°é‡ç”¨äºæ¯”ä¾‹
            const maxCount = Math.max(riskCounts.red, riskCounts.yellow, riskCounts.green, 1);
            
            // æ¸…ç©ºå›¾è¡¨
            chartContainer.innerHTML = '';
            
            // æ·»åŠ Yè½´
            const yAxis = document.createElement('div');
            yAxis.className = 'y-axis';
            yAxis.innerHTML = `
                <div>${maxCount}</div>
                <div>${Math.round(maxCount * 0.75)}</div>
                <div>${Math.round(maxCount * 0.5)}</div>
                <div>${Math.round(maxCount * 0.25)}</div>
                <div>0</div>
            `;
            chartContainer.appendChild(yAxis);
            
            // æ·»åŠ Xè½´
            const xAxis = document.createElement('div');
            xAxis.className = 'x-axis';
            chartContainer.appendChild(xAxis);
            
            // åˆ›å»ºæŸ±çŠ¶å›¾
            const riskData = [
                { label: 'çº¢è‰²é¢„è­¦', value: riskCounts.red, color: '#c62828', type: 'red' },
                { label: 'é»„è‰²å…³æ³¨', value: riskCounts.yellow, color: '#f57f17', type: 'yellow' },
                { label: 'ç»¿è‰²æ­£å¸¸', value: riskCounts.green, color: '#2e7d32', type: 'green' }
            ];
            
            riskData.forEach(data => {
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                
                // è®¡ç®—æŸ±çŠ¶å›¾é«˜åº¦ï¼ˆæœ€å¤§250pxï¼‰
                const heightPercent = (data.value / maxCount) * 100;
                const barHeight = (heightPercent / 100) * 250;
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}px`;
                bar.style.background = data.color;
                
                // æ·»åŠ æ•°å€¼æ ‡ç­¾
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = data.value;
                bar.appendChild(barValue);
                
                // æ·»åŠ æ ‡ç­¾
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = data.label;
                
                barGroup.appendChild(bar);
                barGroup.appendChild(barLabel);
                chartContainer.appendChild(barGroup);
                
                // æ·»åŠ åˆ°Xè½´
                const xLabel = document.createElement('div');
                xLabel.textContent = data.label;
                xAxis.appendChild(xLabel);
            });
        }
        
        // æ›´æ–°è°ˆè¯ä¸»é¢˜åˆ†æ
        function updateTopicAnalysis(records) {
            // ç»Ÿè®¡æ‰€æœ‰ä¸»é¢˜
            const topicCounts = {};
            records.forEach(record => {
                if (record.topics && Array.isArray(record.topics)) {
                    record.topics.forEach(topic => {
                        // å¤„ç†"å…¶ä»–ï¼šxxx"æ ¼å¼çš„ä¸»é¢˜
                        const cleanTopic = topic.startsWith('å…¶ä»–ï¼š') ? 'å…¶ä»–' : topic;
                        topicCounts[cleanTopic] = (topicCounts[cleanTopic] || 0) + 1;
                    });
                }
            });
            
            // æŒ‰æ•°é‡æ’åº
            const sortedTopics = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5); // åªå–å‰5ä¸ªä¸»é¢˜
            
            // æ›´æ–°é¥¼å›¾é¢œè‰²
            const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
            
            // ç”Ÿæˆé¥¼å›¾
            let pieHtml = '';
            if (sortedTopics.length > 0) {
                // åˆ›å»ºé¥¼å›¾çš„conic-gradient
                let cumulativePercent = 0;
                const gradients = sortedTopics.map((topic, index) => {
                    const percent = (topic[1] / records.length) * 100;
                    const start = cumulativePercent;
                    cumulativePercent += percent;
                    return `${colors[index]} ${start}% ${cumulativePercent}%`;
                });
                
                const pieChart = document.getElementById('topicPieChart');
                if (pieChart) {
                    pieChart.style.background = `conic-gradient(${gradients.join(', ')})`;
                }
                
                // æ›´æ–°å›¾ä¾‹
                const legendContainer = document.getElementById('topicLegend');
                if (legendContainer) {
                    legendContainer.innerHTML = '';
                    
                    sortedTopics.forEach((topic, index) => {
                        const percent = Math.round((topic[1] / records.length) * 100);
                        
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.innerHTML = `
                            <div class="legend-color" style="background: ${colors[index]}"></div>
                            <div>${topic[0]}</div>
                            <div style="margin-left: auto; font-weight: bold;">${percent}%</div>
                        `;
                        legendContainer.appendChild(legendItem);
                    });
                }
            }
        }
        
        // æ›´æ–°æ—¶é—´è¶‹åŠ¿å›¾è¡¨
        function updateTimeTrendChart(records) {
            const chartContainer = document.getElementById('monthlyTrendChart');
            if (!chartContainer) return;
            
            // æ¸…ç©ºå›¾è¡¨
            chartContainer.innerHTML = '';
            
            // è·å–æœ€è¿‘6ä¸ªæœˆçš„æ•°æ®
            const now = new Date();
            const months = [];
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = `${date.getFullYear()}å¹´${monthNames[date.getMonth()]}`;
                months.push({ key: monthKey, name: monthName });
            }
            
            // ç»Ÿè®¡æ¯æœˆè°ˆè¯æ•°é‡
            const monthCounts = {};
            months.forEach(month => {
                monthCounts[month.key] = 0;
            });
            
            records.forEach(record => {
                const recordDate = new Date(record.talkTime);
                const year = recordDate.getFullYear();
                const month = String(recordDate.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${month}`;
                
                if (monthCounts.hasOwnProperty(key)) {
                    monthCounts[key]++;
                }
            });
            
            // è®¡ç®—æœ€å¤§å€¼
            const values = Object.values(monthCounts);
            const maxCount = Math.max(...values, 1);
            
            // æ·»åŠ Yè½´
            const yAxis = document.createElement('div');
            yAxis.className = 'y-axis';
            yAxis.innerHTML = `
                <div>${maxCount}</div>
                <div>${Math.round(maxCount * 0.75)}</div>
                <div>${Math.round(maxCount * 0.5)}</div>
                <div>${Math.round(maxCount * 0.25)}</div>
                <div>0</div>
            `;
            chartContainer.appendChild(yAxis);
            
            // æ·»åŠ Xè½´
            const xAxis = document.createElement('div');
            xAxis.className = 'x-axis';
            chartContainer.appendChild(xAxis);
            
            // åˆ›å»ºæŸ±çŠ¶å›¾
            months.forEach(month => {
                const count = monthCounts[month.key] || 0;
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                
                // è®¡ç®—æŸ±çŠ¶å›¾é«˜åº¦
                const heightPercent = (count / maxCount) * 100;
                const barHeight = (heightPercent / 100) * 250;
                
                // è®¾ç½®é¢œè‰²ï¼šå½“å‰æœˆç‰¹æ®Šé¢œè‰²
                const isCurrentMonth = month.key === `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const barColor = isCurrentMonth ? '#3498db' : '#2ecc71';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}px`;
                bar.style.background = barColor;
                
                // æ·»åŠ æ•°å€¼æ ‡ç­¾
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = count;
                bar.appendChild(barValue);
                
                // æ·»åŠ æ ‡ç­¾
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = month.name.replace(`${now.getFullYear()}å¹´`, '');
                
                barGroup.appendChild(bar);
                barGroup.appendChild(barLabel);
                chartContainer.appendChild(barGroup);
                
                // æ·»åŠ åˆ°Xè½´
                const xLabel = document.createElement('div');
                xLabel.textContent = month.name.replace(`${now.getFullYear()}å¹´`, '');
                xAxis.appendChild(xLabel);
            });
        }
        
        // æ›´æ–°ç­çº§åˆ†æè¡¨æ ¼
        function updateClassAnalysisTable(records, studentsData) {
            const tbody = document.getElementById('classAnalysisBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // æŒ‰ç­çº§åˆ†ç»„
            const classData = {};
            
            // åˆå§‹åŒ–ç­çº§æ•°æ®
            const allClasses = [...new Set(studentsData.map(s => s.className))].filter(c => c);
            allClasses.forEach(className => {
                classData[className] = {
                    studentCount: 0,
                    talkCount: 0,
                    redCount: 0,
                    yellowCount: 0,
                    greenCount: 0
                };
            });
            
            // ç»Ÿè®¡å­¦ç”Ÿäººæ•°
            studentsData.forEach(student => {
                if (student.className && classData[student.className]) {
                    classData[student.className].studentCount++;
                }
            });
            
            // ç»Ÿè®¡è°ˆè¯æ•°æ®
            records.forEach(record => {
                const className = record.className;
                if (className && classData[className]) {
                    classData[className].talkCount++;
                    
                    if (record.riskLevel === 'red') {
                        classData[className].redCount++;
                    } else if (record.riskLevel === 'yellow') {
                        classData[className].yellowCount++;
                    } else {
                        classData[className].greenCount++;
                    }
                }
            });
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            Object.entries(classData).forEach(([className, data]) => {
                const row = document.createElement('tr');
                
                // è®¡ç®—äººå‡è°ˆè¯æ¬¡æ•°
                const avgTalks = data.studentCount > 0 ? (data.talkCount / data.studentCount).toFixed(1) : '0';
                
                row.innerHTML = `
                    <td><strong>${className}</strong></td>
                    <td>${data.studentCount}</td>
                    <td>${data.talkCount}</td>
                    <td>${avgTalks}</td>
                    <td><span style="color:#c62828;font-weight:bold;">${data.redCount}</span></td>
                    <td><span style="color:#f57f17;">${data.yellowCount}</span></td>
                    <td><span style="color:#2e7d32;">${data.greenCount}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // æ·»åŠ æ€»è®¡è¡Œ
            if (Object.keys(classData).length > 1) {
                const totalStudentCount = Object.values(classData).reduce((sum, data) => sum + data.studentCount, 0);
                const totalTalkCount = Object.values(classData).reduce((sum, data) => sum + data.talkCount, 0);
                const totalRedCount = Object.values(classData).reduce((sum, data) => sum + data.redCount, 0);
                const totalYellowCount = Object.values(classData).reduce((sum, data) => sum + data.yellowCount, 0);
                const totalGreenCount = Object.values(classData).reduce((sum, data) => sum + data.greenCount, 0);
                const totalAvgTalks = totalStudentCount > 0 ? (totalTalkCount / totalStudentCount).toFixed(1) : '0';
                
                const totalRow = document.createElement('tr');
                totalRow.style.backgroundColor = '#f8f9fa';
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                    <td>æ€»è®¡</td>
                    <td>${totalStudentCount}</td>
                    <td>${totalTalkCount}</td>
                    <td>${totalAvgTalks}</td>
                    <td><span style="color:#c62828;">${totalRedCount}</span></td>
                    <td><span style="color:#f57f17;">${totalYellowCount}</span></td>
                    <td><span style="color:#2e7d32;">${totalGreenCount}</span></td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // æ›´æ–°é«˜é¢‘è°ˆè¯å­¦ç”Ÿè¡¨æ ¼
        function updateFrequentStudentsTable(records) {
            const tbody = document.getElementById('frequentStudentsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°å’Œä¸»é¢˜
            const studentTalkData = {};
            const studentInfo = {};
            
            // è·å–å­¦ç”Ÿä¿¡æ¯
            const storedStudents = JSON.parse(localStorage.getItem('students') || '[]');
            
            records.forEach(record => {
                const studentId = record.studentId;
                if (!studentTalkData[studentId]) {
                    studentTalkData[studentId] = {
                        count: 0,
                        lastTalk: record.talkTime,
                        riskLevel: record.riskLevel
                    };
                }
                
                studentTalkData[studentId].count++;
                
                // æ›´æ–°æœ€è¿‘è°ˆè¯æ—¶é—´
                if (new Date(record.talkTime) > new Date(studentTalkData[studentId].lastTalk)) {
                    studentTalkData[studentId].lastTalk = record.talkTime;
                }
                
                // è®°å½•æœ€ä¸¥é‡çš„é£é™©ç­‰çº§
                const riskOrder = { 'red': 3, 'yellow': 2, 'green': 1 };
                if (riskOrder[record.riskLevel] > riskOrder[studentTalkData[studentId].riskLevel]) {
                    studentTalkData[studentId].riskLevel = record.riskLevel;
                }
                
                // ä¿å­˜å­¦ç”Ÿä¿¡æ¯
                if (!studentInfo[studentId]) {
                    const student = storedStudents.find(s => s.studentId === studentId);
                    if (student) {
                        studentInfo[studentId] = {
                            name: student.name,
                            className: student.className,
                            punishments: student.punishments || [],
                            statusChange: student.statusChange || 'æ— '
                        };
                    }
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆè°ˆè¯æ¬¡æ•°å¤šçš„åœ¨å‰ï¼‰
            const sortedStudents = Object.entries(studentTalkData)
                .filter(([studentId]) => studentInfo[studentId]) // åªä¿ç•™æœ‰ä¿¡æ¯çš„å­¦ç”Ÿ
                .sort(([,a], [,b]) => b.count - a.count)
                .slice(0, 10); // åªå–å‰10å
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            sortedStudents.forEach(([studentId, data]) => {
                const info = studentInfo[studentId];
                const row = document.createElement('tr');
                
                // é£é™©ç­‰çº§æ˜¾ç¤º
                let riskLevelDisplay = '';
                if (data.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">çº¢è‰²é¢„è­¦</span>';
                } else if (data.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">é»„è‰²å…³æ³¨</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ç»¿è‰²æ­£å¸¸</span>';
                }
                
                // å¤„åˆ†è®°å½•æ˜¾ç¤º
                let punishmentsDisplay = 'æ— ';
                if (info.punishments && info.punishments.length > 0) {
                    punishmentsDisplay = `<span class="punishment-tag punishment-yes">æœ‰å¤„åˆ†</span>`;
                } else {
                    punishmentsDisplay = `<span class="punishment-tag punishment-no">æ— å¤„åˆ†</span>`;
                }
                
                // å­¦ç±å¼‚åŠ¨æ˜¾ç¤º
                let statusChangeDisplay = 'æ— ';
                if (info.statusChange && info.statusChange !== 'æ— ') {
                    statusChangeDisplay = `<span class="status-change-tag status-change-yes">${info.statusChange}</span>`;
                } else {
                    statusChangeDisplay = `<span class="status-change-tag status-change-no">æ— </span>`;
                }
                
                // æ ¼å¼åŒ–æœ€è¿‘è°ˆè¯æ—¶é—´
                const lastTalkFormatted = formatDate(data.lastTalk);
                
                row.innerHTML = `
                    <td><strong>${info.name}</strong></td>
                    <td>${info.className}</td>
                    <td><span style="font-weight:bold;color:#3498db;">${data.count}</span></td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${statusChangeDisplay}</td>
                    <td>${lastTalkFormatted}</td>
                `;
                tbody.appendChild(row);
            });
            
            // å¦‚æœæ²¡æœ‰æ•°æ®
            if (sortedStudents.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                        æš‚æ— é«˜é¢‘è°ˆè¯å­¦ç”Ÿæ•°æ®
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
        }
        
        // æ›´æ–°æ•°æ®æ´å¯Ÿ
        function updateDataInsights(records, studentsData) {
            const insightsList = document.getElementById('insightsList');
            if (!insightsList) return;
            
            insightsList.innerHTML = '';
            
            if (records.length === 0) {
                insightsList.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-icon">ğŸ“Š</div>
                        <div class="insight-text">æš‚æ— è°ˆè¯è®°å½•æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ è°ˆè¯è®°å½•</div>
                    </div>
                `;
                return;
            }
            
            const insights = [];
            
            // è®¡ç®—æ€»è°ˆè¯æ¬¡æ•°
            const totalTalks = records.length;
            
            // è®¡ç®—æ¶‰åŠå­¦ç”Ÿæ•°
            const uniqueStudents = new Set(records.map(r => r.studentId)).size;
            
            // è®¡ç®—é«˜é£é™©æ¯”ä¾‹
            const redTalks = records.filter(r => r.riskLevel === 'red').length;
            const redPercentage = Math.round((redTalks / totalTalks) * 100);
            
            // è®¡ç®—å¹³å‡è°ˆè¯æ¬¡æ•°
            const avgTalksPerStudent = (totalTalks / uniqueStudents).toFixed(1);
            
            // è®¡ç®—æœ€é¢‘ç¹çš„è°ˆè¯ä¸»é¢˜
            const topicCounts = {};
            records.forEach(record => {
                record.topics.forEach(topic => {
                    const cleanTopic = topic.startsWith('å…¶ä»–ï¼š') ? 'å…¶ä»–' : topic;
                    topicCounts[cleanTopic] = (topicCounts[cleanTopic] || 0) + 1;
                });
            });
            
            const mostCommonTopic = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a)[0];
            
            // è®¡ç®—æœ€è¿‘ä¸€å‘¨çš„è°ˆè¯è¶‹åŠ¿
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentTalks = records.filter(r => new Date(r.talkTime) >= weekAgo).length;
            const previousWeekTalks = records.filter(r => {
                const recordDate = new Date(r.talkTime);
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                return recordDate >= twoWeeksAgo && recordDate < weekAgo;
            }).length;
            
            const trendChange = previousWeekTalks > 0 ? 
                Math.round(((recentTalks - previousWeekTalks) / previousWeekTalks) * 100) : 0;
            
            // ç”Ÿæˆæ´å¯Ÿ
            insights.push({
                icon: 'ğŸ“ˆ',
                text: `å…±å®Œæˆ <strong>${totalTalks}</strong> æ¬¡è°ˆè¯ï¼Œæ¶‰åŠ <strong>${uniqueStudents}</strong> åå­¦ç”Ÿï¼Œå¹³å‡æ¯äººè°ˆè¯ <strong>${avgTalksPerStudent}</strong> æ¬¡`
            });
            
            if (redPercentage > 0) {
                insights.push({
                    icon: 'âš ï¸',
                    text: `é«˜é£é™©è°ˆè¯å æ¯” <strong>${redPercentage}%</strong>ï¼Œå…± <strong>${redTalks}</strong> æ¬¡çº¢è‰²é¢„è­¦è°ˆè¯ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨`
                });
            } else {
                insights.push({
                    icon: 'âœ…',
                    text: `ç›®å‰æ²¡æœ‰é«˜é£é™©è°ˆè¯è®°å½•ï¼Œæ‰€æœ‰å­¦ç”ŸçŠ¶æ€è‰¯å¥½`
                });
            }
            
            if (mostCommonTopic) {
                const topicPercentage = Math.round((mostCommonTopic[1] / totalTalks) * 100);
                insights.push({
                    icon: 'ğŸ’¬',
                    text: `æœ€å¸¸è®¨è®ºçš„ä¸»é¢˜æ˜¯ <strong>"${mostCommonTopic[0]}"</strong>ï¼Œå æ¯” <strong>${topicPercentage}%</strong>`
                });
            }
            
            if (trendChange > 0) {
                insights.push({
                    icon: 'ğŸ“ˆ',
                    text: `æœ€è¿‘ä¸€å‘¨è°ˆè¯æ¬¡æ•°ç›¸æ¯”å‰ä¸€å‘¨ <strong>å¢é•¿ ${Math.abs(trendChange)}%</strong>ï¼Œå·¥ä½œå¼ºåº¦å¢åŠ `
                });
            } else if (trendChange < 0) {
                insights.push({
                    icon: 'ğŸ“‰',
                    text: `æœ€è¿‘ä¸€å‘¨è°ˆè¯æ¬¡æ•°ç›¸æ¯”å‰ä¸€å‘¨ <strong>å‡å°‘ ${Math.abs(trendChange)}%</strong>ï¼Œå·¥ä½œå¼ºåº¦å‡è½»`
                });
            } else {
                insights.push({
                    icon: 'ğŸ“Š',
                    text: `æœ€è¿‘ä¸€å‘¨è°ˆè¯æ¬¡æ•°ä¸å‰ä¸€å‘¨æŒå¹³ï¼Œå·¥ä½œèŠ‚å¥ç¨³å®š`
                });
            }
            
            // æ‰¾å‡ºè°ˆè¯æœ€å¤šçš„ç­çº§
            const classTalkCounts = {};
            records.forEach(record => {
                const className = record.className;
                classTalkCounts[className] = (classTalkCounts[className] || 0) + 1;
            });
            
            const mostTalkativeClass = Object.entries(classTalkCounts)
                .sort(([,a], [,b]) => b - a)[0];
            
            if (mostTalkativeClass && Object.keys(classTalkCounts).length > 1) {
                insights.push({
                    icon: 'ğŸ‘¥',
                    text: `è°ˆè¯æœ€å¤šçš„ç­çº§æ˜¯ <strong>${mostTalkativeClass[0]}</strong>ï¼Œå…± <strong>${mostTalkativeClass[1]}</strong> æ¬¡è°ˆè¯`
                });
            }
            
            // æ¸²æŸ“æ´å¯Ÿåˆ—è¡¨
            insights.forEach(insight => {
                const insightItem = document.createElement('div');
                insightItem.className = 'insight-item';
                insightItem.innerHTML = `
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-text">${insight.text}</div>
                `;
                insightsList.appendChild(insightItem);
            });
        }
        
        // å¯¼å‡ºåˆ†ææŠ¥å‘Š
        function exportAnalysisReport() {
            try {
                // è·å–å½“å‰åˆ†ææ•°æ®
                const timeRange = document.getElementById('analysisTimeRange').value;
                const classFilter = document.getElementById('analysisClassFilter').value;
                
                // ç”ŸæˆæŠ¥å‘Šæ ‡é¢˜
                let reportTitle = 'è°ˆå¿ƒè°ˆè¯æ•°æ®åˆ†ææŠ¥å‘Š';
                if (classFilter) {
                    reportTitle += ` - ${classFilter}`;
                }
                if (timeRange !== 'all') {
                    const timeLabels = {
                        'month': 'æœ€è¿‘ä¸€ä¸ªæœˆ',
                        'quarter': 'æœ€è¿‘ä¸‰ä¸ªæœˆ',
                        'halfyear': 'æœ€è¿‘å…­ä¸ªæœˆ',
                        'year': 'æœ€è¿‘ä¸€å¹´'
                    };
                    reportTitle += ` (${timeLabels[timeRange]})`;
                }
                
                // è·å–å½“å‰æ—¥æœŸ
                const now = new Date();
                const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
                
                // ç”ŸæˆæŠ¥å‘Šå†…å®¹
                let reportContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${reportTitle}</title>
                        <style>
                            body {
                                font-family: "Microsoft YaHei", sans-serif;
                                margin: 2cm;
                                font-size: 12pt;
                                line-height: 1.6;
                            }
                            h1 {
                                text-align: center;
                                color: #2c3e50;
                                margin-bottom: 10px;
                            }
                            .report-meta {
                                text-align: center;
                                color: #666;
                                margin-bottom: 30px;
                                font-size: 11pt;
                            }
                            .section {
                                margin-bottom: 25px;
                                page-break-inside: avoid;
                            }
                            .section-title {
                                font-size: 14pt;
                                color: #2c3e50;
                                border-bottom: 2px solid #3498db;
                                padding-bottom: 5px;
                                margin-bottom: 15px;
                            }
                            .summary-grid {
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 15px;
                                margin-bottom: 20px;
                            }
                            .summary-item {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                text-align: center;
                            }
                            .summary-value {
                                font-size: 24pt;
                                font-weight: bold;
                                color: #3498db;
                                margin: 10px 0;
                            }
                            .summary-label {
                                font-size: 11pt;
                                color: #666;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 20px;
                                font-size: 11pt;
                            }
                            th {
                                background: #f0f0f0;
                                padding: 10px;
                                text-align: left;
                                border: 1px solid #ddd;
                            }
                            td {
                                padding: 10px;
                                border: 1px solid #ddd;
                            }
                            .insight-list {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                            }
                            .insight-item {
                                margin-bottom: 10px;
                                padding-bottom: 10px;
                                border-bottom: 1px dashed #ddd;
                            }
                            .insight-item:last-child {
                                border-bottom: none;
                                margin-bottom: 0;
                                padding-bottom: 0;
                            }
                            .footer {
                                margin-top: 50px;
                                text-align: right;
                                font-size: 11pt;
                                color: #666;
                            }
                            @page {
                                size: A4;
                                margin: 2cm;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${reportTitle}</h1>
                        <div class="report-meta">
                            ç”Ÿæˆæ—¶é—´ï¼š${dateStr} | ç”Ÿæˆäººï¼š${localStorage.getItem('counselorName') || 'è¾…å¯¼å‘˜'}
                        </div>
                `;
                
                // è·å–åˆ†ææ•°æ®
                const storedRecords = JSON.parse(localStorage.getItem('talkRecords') || '[]');
                const storedStudents = JSON.parse(localStorage.getItem('students') || '[]');
                
                // ç­›é€‰æ•°æ®
                let filteredRecords = [...storedRecords];
                let filteredStudents = [...storedStudents];
                
                // æ—¶é—´ç­›é€‰
                if (timeRange !== 'all') {
                    const now = new Date();
                    let dateFrom = new Date();
                    
                    switch(timeRange) {
                        case 'month':
                            dateFrom.setMonth(now.getMonth() - 1);
                            break;
                        case 'quarter':
                            dateFrom.setMonth(now.getMonth() - 3);
                            break;
                        case 'halfyear':
                            dateFrom.setMonth(now.getMonth() - 6);
                            break;
                        case 'year':
                            dateFrom.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    filteredRecords = filteredRecords.filter(record => 
                        new Date(record.talkTime) >= dateFrom
                    );
                }
                
                // ç­çº§ç­›é€‰
                if (classFilter) {
                    filteredRecords = filteredRecords.filter(record => 
                        record.className === classFilter
                    );
                    
                    filteredStudents = filteredStudents.filter(student => 
                        student.className === classFilter
                    );
                }
                
                // æ•°æ®æ¦‚è§ˆ
                const totalTalks = filteredRecords.length;
                const uniqueStudents = new Set(filteredRecords.map(r => r.studentId)).size;
                const redTalks = filteredRecords.filter(r => r.riskLevel === 'red').length;
                const redPercentage = totalTalks > 0 ? Math.round((redTalks / totalTalks) * 100) : 0;
                const yellowTalks = filteredRecords.filter(r => r.riskLevel === 'yellow').length;
                const greenTalks = filteredRecords.filter(r => r.riskLevel === 'green').length;
                const avgTalksPerStudent = uniqueStudents > 0 ? (totalTalks / uniqueStudents).toFixed(1) : '0';
                
                reportContent += `
                    <div class="section">
                        <h2 class="section-title">ä¸€ã€æ•°æ®æ¦‚è§ˆ</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value">${totalTalks}</div>
                                <div class="summary-label">æ€»è°ˆè¯æ¬¡æ•°</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${uniqueStudents}</div>
                                <div class="summary-label">æ¶‰åŠå­¦ç”Ÿæ•°</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${avgTalksPerStudent}</div>
                                <div class="summary-label">äººå‡è°ˆè¯æ¬¡æ•°</div>
                            </div>
                        </div>
                        
                        <table>
                            <tr>
                                <th>é£é™©ç­‰çº§</th>
                                <th>è°ˆè¯æ¬¡æ•°</th>
                                <th>å æ¯”</th>
                            </tr>
                            <tr>
                                <td><strong style="color:#c62828;">çº¢è‰²é¢„è­¦</strong></td>
                                <td>${redTalks}</td>
                                <td>${redPercentage}%</td>
                            </tr>
                            <tr>
                                <td><strong style="color:#f57f17;">é»„è‰²å…³æ³¨</strong></td>
                                <td>${yellowTalks}</td>
                                <td>${totalTalks > 0 ? Math.round((yellowTalks / totalTalks) * 100) : 0}%</td>
                            </tr>
                            <tr>
                                <td><strong style="color:#2e7d32;">ç»¿è‰²æ­£å¸¸</strong></td>
                                <td>${greenTalks}</td>
                                <td>${totalTalks > 0 ? Math.round((greenTalks / totalTalks) * 100) : 0}%</td>
                            </tr>
                        </table>
                    </div>
                `;
                
                // æ•°æ®æ´å¯Ÿ
                const insights = [];
                
                if (redPercentage > 10) {
                    insights.push(`é«˜é£é™©è°ˆè¯å æ¯”${redPercentage}%ï¼Œéœ€è¦åŠ å¼ºå¯¹é«˜é£é™©å­¦ç”Ÿçš„å…³æ³¨å’Œå¹²é¢„`);
                } else if (redPercentage === 0) {
                    insights.push(`ç›®å‰æ²¡æœ‰é«˜é£é™©è°ˆè¯è®°å½•ï¼Œå­¦ç”Ÿæ•´ä½“çŠ¶æ€è‰¯å¥½`);
                }
                
                if (avgTalksPerStudent > 2) {
                    insights.push(`äººå‡è°ˆè¯æ¬¡æ•°${avgTalksPerStudent}æ¬¡ï¼Œè°ˆè¯å·¥ä½œè¾ƒä¸ºæ·±å…¥`);
                } else if (avgTalksPerStudent < 1) {
                    insights.push(`äººå‡è°ˆè¯æ¬¡æ•°${avgTalksPerStudent}æ¬¡ï¼Œå»ºè®®å¢åŠ å¯¹å­¦ç”Ÿçš„å…³æ³¨`);
                }
                
                // ä¸»é¢˜åˆ†æ
                const topicCounts = {};
                filteredRecords.forEach(record => {
                    record.topics.forEach(topic => {
                        const cleanTopic = topic.startsWith('å…¶ä»–ï¼š') ? 'å…¶ä»–' : topic;
                        topicCounts[cleanTopic] = (topicCounts[cleanTopic] || 0) + 1;
                    });
                });
                
                const sortedTopics = Object.entries(topicCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                if (sortedTopics.length > 0) {
                    let topicsHtml = '<table><tr><th>è°ˆè¯ä¸»é¢˜</th><th>å‡ºç°æ¬¡æ•°</th><th>å æ¯”</th></tr>';
                    sortedTopics.forEach(([topic, count]) => {
                        const percentage = Math.round((count / totalTalks) * 100);
                        topicsHtml += `<tr><td>${topic}</td><td>${count}</td><td>${percentage}%</td></tr>`;
                    });
                    topicsHtml += '</table>';
                    
                    insights.push(`æœ€å¸¸è®¨è®ºçš„ä¸»é¢˜æ˜¯"${sortedTopics[0][0]}"ï¼Œå æ¯”${Math.round((sortedTopics[0][1] / totalTalks) * 100)}%`);
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">äºŒã€è°ˆè¯ä¸»é¢˜åˆ†æ</h2>
                            ${topicsHtml}
                        </div>
                    `;
                }
                
                // ç­çº§åˆ†æ
                const classData = {};
                filteredStudents.forEach(student => {
                    if (student.className) {
                        if (!classData[student.className]) {
                            classData[student.className] = {
                                studentCount: 0,
                                talkCount: 0,
                                redCount: 0,
                                yellowCount: 0,
                                greenCount: 0
                            };
                        }
                        classData[student.className].studentCount++;
                    }
                });
                
                filteredRecords.forEach(record => {
                    const className = record.className;
                    if (className && classData[className]) {
                        classData[className].talkCount++;
                        
                        if (record.riskLevel === 'red') {
                            classData[className].redCount++;
                        } else if (record.riskLevel === 'yellow') {
                            classData[className].yellowCount++;
                        } else {
                            classData[className].greenCount++;
                        }
                    }
                });
                
                if (Object.keys(classData).length > 0) {
                    let classHtml = '<table><tr><th>ç­çº§</th><th>å­¦ç”Ÿæ•°</th><th>è°ˆè¯æ¬¡æ•°</th><th>äººå‡è°ˆè¯</th><th>çº¢è‰²é¢„è­¦</th><th>é»„è‰²å…³æ³¨</th><th>ç»¿è‰²æ­£å¸¸</th></tr>';
                    
                    Object.entries(classData).forEach(([className, data]) => {
                        const avgTalks = data.studentCount > 0 ? (data.talkCount / data.studentCount).toFixed(1) : '0';
                        classHtml += `
                            <tr>
                                <td>${className}</td>
                                <td>${data.studentCount}</td>
                                <td>${data.talkCount}</td>
                                <td>${avgTalks}</td>
                                <td style="color:#c62828;">${data.redCount}</td>
                                <td style="color:#f57f17;">${data.yellowCount}</td>
                                <td style="color:#2e7d32;">${data.greenCount}</td>
                            </tr>
                        `;
                    });
                    
                    classHtml += '</table>';
                    
                    // æ‰¾å‡ºè°ˆè¯æœ€å¤šçš„ç­çº§
                    const mostTalkativeClass = Object.entries(classData)
                        .sort(([,a], [,b]) => b.talkCount - a.talkCount)[0];
                    
                    if (mostTalkativeClass) {
                        insights.push(`è°ˆè¯æœ€å¤šçš„ç­çº§æ˜¯${mostTalkativeClass[0]}ï¼Œå…±${mostTalkativeClass[1].talkCount}æ¬¡è°ˆè¯`);
                    }
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">ä¸‰ã€ç­çº§æ•°æ®åˆ†æ</h2>
                            ${classHtml}
                        </div>
                    `;
                }
                
                // é«˜é¢‘è°ˆè¯å­¦ç”Ÿ
                const studentTalkCounts = {};
                filteredRecords.forEach(record => {
                    const studentId = record.studentId;
                    studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
                });
                
                const topStudents = Object.entries(studentTalkCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                if (topStudents.length > 0) {
                    let studentsHtml = '<table><tr><th>å§“å</th><th>ç­çº§</th><th>è°ˆè¯æ¬¡æ•°</th><th>å¤„åˆ†è®°å½•</th><th>å­¦ç±å¼‚åŠ¨</th><th>ä¸»è¦é£é™©ç­‰çº§</th></tr>';
                    
                    topStudents.forEach(([studentId, count]) => {
                        const student = storedStudents.find(s => s.studentId === studentId);
                        if (student) {
                            // è·å–è¯¥å­¦ç”Ÿçš„é£é™©ç­‰çº§ï¼ˆå–æœ€ä¸¥é‡çš„ï¼‰
                            const studentRecords = filteredRecords.filter(r => r.studentId === studentId);
                            let maxRiskLevel = 'green';
                            studentRecords.forEach(record => {
                                const riskOrder = { 'red': 3, 'yellow': 2, 'green': 1 };
                                if (riskOrder[record.riskLevel] > riskOrder[maxRiskLevel]) {
                                    maxRiskLevel = record.riskLevel;
                                }
                            });
                            
                            let riskDisplay = maxRiskLevel === 'red' ? 'çº¢è‰²é¢„è­¦' : 
                                            maxRiskLevel === 'yellow' ? 'é»„è‰²å…³æ³¨' : 'ç»¿è‰²æ­£å¸¸';
                            let riskColor = maxRiskLevel === 'red' ? '#c62828' : 
                                          maxRiskLevel === 'yellow' ? '#f57f17' : '#2e7d32';
                            
                            // å¤„åˆ†è®°å½•æ˜¾ç¤º
                            const punishments = student.punishments && student.punishments.length > 0 ? 
                                student.punishments.join('ã€') : 'æ— ';
                            
                            // å­¦ç±å¼‚åŠ¨æ˜¾ç¤º
                            const statusChange = student.statusChange || 'æ— ';
                            
                            studentsHtml += `
                                <tr>
                                    <td>${student.name}</td>
                                    <td>${student.className}</td>
                                    <td><strong>${count}</strong></td>
                                    <td>${punishments}</td>
                                    <td>${statusChange}</td>
                                    <td style="color:${riskColor};font-weight:bold;">${riskDisplay}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    studentsHtml += '</table>';
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">å››ã€é«˜é¢‘è°ˆè¯å­¦ç”Ÿ</h2>
                            ${studentsHtml}
                        </div>
                    `;
                }
                
                // æ•°æ®æ´å¯Ÿæ€»ç»“
                if (insights.length > 0) {
                    let insightsHtml = '<div class="insight-list">';
                    insights.forEach(insight => {
                        insightsHtml += `<div class="insight-item">â€¢ ${insight}</div>`;
                    });
                    insightsHtml += '</div>';
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">äº”ã€å…³é”®æ´å¯Ÿä¸å»ºè®®</h2>
                            ${insightsHtml}
                            <p><strong>å·¥ä½œå»ºè®®ï¼š</strong></p>
                            <ul>
                                <li>ç»§ç»­åŠ å¼ºå¯¹é«˜é£é™©å­¦ç”Ÿçš„å…³æ³¨å’Œå®šæœŸè·Ÿè¿›</li>
                                <li>é’ˆå¯¹é«˜é¢‘è°ˆè¯å­¦ç”Ÿï¼Œåˆ†æå…¶æ·±å±‚éœ€æ±‚å¹¶æä¾›é’ˆå¯¹æ€§å¸®åŠ©</li>
                                <li>æ ¹æ®ä¸»é¢˜åˆ†æç»“æœï¼Œå¼€å±•ç›¸å…³ä¸»é¢˜çš„å›¢ä½“è¾…å¯¼æ´»åŠ¨</li>
                                <li>å®šæœŸä¸å­¦ç”Ÿå¹²éƒ¨æ²Ÿé€šï¼Œäº†è§£ç­çº§æ•´ä½“åŠ¨æ€</li>
                                <li>ç‰¹åˆ«å…³æ³¨æœ‰å¤„åˆ†è®°å½•å’Œå­¦ç±å¼‚åŠ¨çš„å­¦ç”Ÿ</li>
                            </ul>
                        </div>
                    `;
                }
                
                // æŠ¥å‘Šç»“å°¾
                reportContent += `
                        <div class="footer">
                            <p>æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿï¼šè¾…å¯¼å‘˜è°ˆå¿ƒè°ˆè¯ç®¡ç†ç³»ç»Ÿ</p>
                            <p>ç”Ÿæˆæ—¶é—´ï¼š${dateStr}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob(['\ufeff', reportContent], {
                    type: 'application/msword'
                });
                
                // ä½¿ç”¨FileSaverä¿å­˜æ–‡ä»¶
                const dateStrFile = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                let fileName = `è°ˆå¿ƒè°ˆè¯åˆ†ææŠ¥å‘Š_${dateStrFile}`;
                
                if (classFilter) {
                    fileName += `_${classFilter}`;
                }
                
                saveAs(blob, `${fileName}.doc`);
                
                showMessage('åˆ†ææŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºåˆ†ææŠ¥å‘Šæ—¶å‡ºé”™ï¼š', error);
                showMessage('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // æ›´æ–°è®°å½•ç»Ÿè®¡
        function updateRecordStats() {
            // ä»localStorageé‡æ–°åŠ è½½æ•°æ®
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            if (talkRecords.length === 0) {
                document.getElementById('recordStatsCard').style.display = 'none';
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // è®¡ç®—ä»Šæ—¥è°ˆè¯æ•°
            const todayCount = talkRecords.filter(record => {
                const recordDate = new Date(record.talkTime);
                return recordDate >= today;
            }).length;
            
            // è®¡ç®—æœ¬å‘¨è°ˆè¯æ•°
            const weekCount = talkRecords.filter(record => {
                const recordDate = new Date(record.talkTime);
                return recordDate >= weekAgo;
            }).length;
            
            // è®¡ç®—æœ¬æœˆè°ˆè¯æ•°
            const monthCount = talkRecords.filter(record => {
                const recordDate = new Date(record.talkTime);
                return recordDate >= monthAgo;
            }).length;
            
            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('monthCount').textContent = monthCount;
            
            // æ›´æ–°è¿‘æœŸè°ˆè¯å­¦ç”Ÿåˆ—è¡¨
            updateRecentStudentsList();
        }
        
        // æ›´æ–°è¿‘æœŸè°ˆè¯å­¦ç”Ÿåˆ—è¡¨
        function updateRecentStudentsList() {
            const monthAgo = new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000);
            const recentTalks = talkRecords.filter(record => {
                return new Date(record.talkTime) >= monthAgo;
            });
            
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
            const studentTalkCounts = {};
            recentTalks.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            // è·å–å­¦ç”Ÿä¿¡æ¯
            const recentStudentsList = document.getElementById('recentStudentsList');
            recentStudentsList.innerHTML = '';
            
            // åªæ˜¾ç¤ºå‰10ä¸ªæœ€è¿‘è°ˆè¯çš„å­¦ç”Ÿ
            Object.entries(studentTalkCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .forEach(([studentId, count]) => {
                    const student = students.find(s => s.studentId === studentId);
                    if (student) {
                        const tag = document.createElement('div');
                        tag.className = 'student-tag';
                        tag.innerHTML = `
                            ${student.name}
                            <span class="talk-count">${count}</span>
                        `;
                        recentStudentsList.appendChild(tag);
                    }
                });
        }
        
      // ç®€åŒ–çš„å­¦ç”Ÿç»Ÿè®¡åŠŸèƒ½
        function updateStudentStats(filteredStudents = null) {
            const statsContainer = document.getElementById('statsContainer');
            
            if (!statsContainer) return;
            
            // è·å–å½“å‰æ˜¾ç¤ºçš„å­¦ç”Ÿæ•°æ®
            const currentStudents = filteredStudents || students;
            const totalStudents = currentStudents.length;
            
            // ç»Ÿè®¡å„é£é™©ç­‰çº§äººæ•°
            const redCount = currentStudents.filter(s => s.riskLevel === 'red').length;
            const yellowCount = currentStudents.filter(s => s.riskLevel === 'yellow').length;
            const greenCount = currentStudents.filter(s => s.riskLevel === 'green').length;
            
            // ç»Ÿè®¡æ”¿æ²»é¢è²Œ
            const partyMemberCount = currentStudents.filter(s => s.politicalStatus === 'ä¸­å…±å…šå‘˜' || s.politicalStatus === 'ä¸­å…±é¢„å¤‡å…šå‘˜').length;
            const leagueMemberCount = currentStudents.filter(s => s.politicalStatus === 'å…±é’å›¢å‘˜').length;
            const massesCount = currentStudents.filter(s => s.politicalStatus === 'ç¾¤ä¼—' || !s.politicalStatus).length;
            
            // ç»Ÿè®¡å›°éš¾è®¤å®š
            const severeHardshipCount = currentStudents.filter(s => s.hardship === 'ç‰¹åˆ«å›°éš¾').length;
            const generalHardshipCount = currentStudents.filter(s => s.hardship === 'å›°éš¾').length;
            const mildHardshipCount = currentStudents.filter(s => s.hardship === 'ä¸€èˆ¬å›°éš¾').length;
            
            // ç»Ÿè®¡å¤„åˆ†è®°å½•
            const punishmentCount = currentStudents.filter(s => s.punishments && s.punishments.length > 0).length;
            
            // ç»Ÿè®¡å­¦ç±å¼‚åŠ¨
            const statusChangeCount = currentStudents.filter(s => s.statusChange && s.statusChange !== 'æ— ' && s.statusChange !== '').length;
            
            // è®¡ç®—ç™¾åˆ†æ¯”
            const redPercentage = totalStudents > 0 ? Math.round((redCount / totalStudents) * 100) : 0;
            const yellowPercentage = totalStudents > 0 ? Math.round((yellowCount / totalStudents) * 100) : 0;
            const greenPercentage = totalStudents > 0 ? Math.round((greenCount / totalStudents) * 100) : 0;
            const punishmentPercentage = totalStudents > 0 ? Math.round((punishmentCount / totalStudents) * 100) : 0;
            const statusChangePercentage = totalStudents > 0 ? Math.round((statusChangeCount / totalStudents) * 100) : 0;
            
            // ç”Ÿæˆç®€åŒ–çš„ç»Ÿè®¡å¡ç‰‡HTML
            statsContainer.innerHTML = `
                <div class="stat-card total">
                    <div class="stat-value">
                        <span style="color: #3498db;">${totalStudents}</span>
                        <span style="font-size: 16px; color: #666;">äºº</span>
                    </div>
                    <div class="stat-label">å­¦ç”Ÿæ€»æ•°</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-value">
                        <span style="color: #c62828;">${redCount}</span>
                        <span style="font-size: 16px; color: #666;">(${redPercentage}%)</span>
                    </div>
                    <div class="stat-label">çº¢è‰²é¢„è­¦</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-value">
                        <span style="color: #f57f17;">${yellowCount}</span>
                        <span style="font-size: 16px; color: #666;">(${yellowPercentage}%)</span>
                    </div>
                    <div class="stat-label">é»„è‰²å…³æ³¨</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-value">
                        <span style="color: #2e7d32;">${greenCount}</span>
                        <span style="font-size: 16px; color: #666;">(${greenPercentage}%)</span>
                    </div>
                    <div class="stat-label">ç»¿è‰²æ­£å¸¸</div>
                </div>
                <div class="stat-card" style="border-top-color: #c62828;">
                    <div class="stat-value">
                        <span style="color: #c62828;">${punishmentCount}</span>
                        <span style="font-size: 16px; color: #666;">(${punishmentPercentage}%)</span>
                    </div>
                    <div class="stat-label">æœ‰å¤„åˆ†è®°å½•</div>
                </div>
                <div class="stat-card" style="border-top-color: #0277bd;">
                    <div class="stat-value">
                        <span style="color: #0277bd;">${statusChangeCount}</span>
                        <span style="font-size: 16px; color: #666;">(${statusChangePercentage}%)</span>
                    </div>
                    <div class="stat-label">å­¦ç±å¼‚åŠ¨</div>
                </div>
            `;
        }
        
        // æ‰¹é‡åˆ é™¤åŠŸèƒ½
        function toggleSelectAllStudents(checkbox) {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBatchActionState();
        }

        function updateBatchActionState() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            const selectedCount = checkboxes.length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchActionInfo = document.getElementById('batchActionInfo');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            if (selectedCount > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchActionInfo.style.display = 'block';
                selectedCountSpan.textContent = selectedCount;
            } else {
                batchDeleteBtn.style.display = 'none';
                batchActionInfo.style.display = 'none';
            }
        }

        function clearSelection() {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllStudents').checked = false;
            updateBatchActionState();
        }

        function batchDeleteStudents() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å­¦ç”Ÿï¼', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} ä¸ªå­¦ç”Ÿå—ï¼Ÿåˆ é™¤åè¿™äº›å­¦ç”Ÿçš„æ‰€æœ‰è°ˆè¯è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼`)) {
                return;
            }
            
            try {
                // åˆ é™¤é€‰ä¸­çš„å­¦ç”Ÿ
                students = students.filter(student => !selectedIds.includes(student.studentId));
                
                // åˆ é™¤è¿™äº›å­¦ç”Ÿçš„æ‰€æœ‰è°ˆè¯è®°å½•
                talkRecords = talkRecords.filter(record => !selectedIds.includes(record.studentId));
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                // åˆ·æ–°ç•Œé¢
                loadStudentsTable();
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                clearSelection();
                
                showMessage(`æˆåŠŸåˆ é™¤ ${selectedIds.length} ä¸ªå­¦ç”ŸåŠç›¸å…³è®°å½•ï¼`, 'success');
                
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å­¦ç”Ÿæ—¶å‡ºé”™ï¼š', error);
                showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
   // è°ˆè¯è¿½è¸ªç»Ÿè®¡åŠŸèƒ½
        function updateTalkTrackingStats() {
            // ä»localStorageé‡æ–°åŠ è½½æ•°æ®
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            const totalTalks = talkRecords.length;
            
            // ç»Ÿè®¡æ¶‰åŠçš„å­¦ç”Ÿæ•°
            const uniqueStudents = new Set();
            talkRecords.forEach(record => {
                if (record.studentId) {
                    uniqueStudents.add(record.studentId);
                }
            });
            
            // ç»Ÿè®¡çº¢è‰²é¢„è­¦è°ˆè¯æ•°
            const redTalks = talkRecords.filter(record => record.riskLevel === 'red').length;
            
            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            document.getElementById('totalTalksCount').textContent = totalTalks;
            document.getElementById('uniqueStudentsCount').textContent = uniqueStudents.size;
            document.getElementById('redTalksCount').textContent = redTalks;
            
            // æ›´æ–°é«˜é¢‘è°ˆè¯å­¦ç”Ÿ
            updateFrequentStudents();
            
            // æ›´æ–°æœˆåº¦ç»Ÿè®¡
            updateMonthlyStats();
            
            // åˆå§‹åŒ–æœˆä»½ç­›é€‰å™¨
            initMonthFilter();
        }
        
        // æ›´æ–°é«˜é¢‘è°ˆè¯å­¦ç”Ÿ
        function updateFrequentStudents() {
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
            const studentTalkCounts = {};
            talkRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            // æ‰¾å‡ºé«˜é¢‘è°ˆè¯å­¦ç”Ÿï¼ˆè°ˆè¯æ¬¡æ•°>=3ï¼‰
            const frequentStudents = Object.entries(studentTalkCounts)
                .filter(([_, count]) => count >= 3)
                .sort(([,a], [,b]) => b - a);
            
            const frequentStudentsList = document.getElementById('frequentStudentsList');
            frequentStudentsList.innerHTML = '';
            
            if (frequentStudents.length > 0) {
                document.getElementById('frequentStudents').style.display = 'block';
                
                frequentStudents.forEach(([studentId, count]) => {
                    const student = students.find(s => s.studentId === studentId);
                    if (student) {
                        const tag = document.createElement('div');
                        tag.className = 'student-tag';
                        tag.innerHTML = `
                            ${student.name}
                            <span class="talk-count" style="background: #c62828;">${count}</span>
                        `;
                        frequentStudentsList.appendChild(tag);
                    }
                });
            } else {
                document.getElementById('frequentStudents').style.display = 'none';
            }
        }
        
        // æ›´æ–°æœˆåº¦ç»Ÿè®¡ï¼ˆå®æ—¶æ›´æ–°ï¼Œæ€»æ˜¯æ˜¾ç¤ºæœ€è¿‘6ä¸ªæœˆï¼‰
        function updateMonthlyStats() {
            const monthlyStats = document.getElementById('monthlyStats');
            monthlyStats.innerHTML = '';
            
            if (talkRecords.length === 0) {
                monthlyStats.style.display = 'none';
                return;
            }
            
            monthlyStats.style.display = 'grid';
            
            // è·å–æœ€è¿‘6ä¸ªæœˆçš„æ•°æ®ï¼ˆåŒ…å«å½“å‰æœˆï¼‰
            const now = new Date();
            const months = [];
            
            // è®¡ç®—æœ€è¿‘6ä¸ªæœˆï¼ˆå½“å‰æœˆ + å‰5ä¸ªæœˆï¼‰
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
                
                // å¦‚æœæ˜¯å½“å‰æœˆï¼Œæ·»åŠ æ ‡è¯†
                const isCurrentMonth = i === 0;
                const displayName = isCurrentMonth ? `${monthName}ï¼ˆæœ¬æœˆï¼‰` : monthName;
                
                months.push({
                    year: date.getFullYear(),
                    month: date.getMonth() + 1,
                    name: monthName,
                    displayName: displayName,
                    isCurrent: isCurrentMonth
                });
            }
            
            // ç»Ÿè®¡æ¯ä¸ªæœˆçš„è°ˆè¯æ•°
            const monthCounts = {};
            months.forEach(m => {
                const key = `${m.year}-${m.month.toString().padStart(2, '0')}`;
                monthCounts[key] = 0;
            });
            
            talkRecords.forEach(record => {
                const recordDate = new Date(record.talkTime);
                const year = recordDate.getFullYear();
                const month = recordDate.getMonth() + 1;
                const key = `${year}-${month.toString().padStart(2, '0')}`;
                
                if (monthCounts.hasOwnProperty(key)) {
                    monthCounts[key]++;
                }
            });
            
            // ç”Ÿæˆæœˆåº¦ç»Ÿè®¡é¡¹
            let totalCount = 0;
            months.forEach(m => {
                const key = `${m.year}-${m.month.toString().padStart(2, '0')}`;
                const count = monthCounts[key] || 0;
                totalCount += count;
                
                const statItem = document.createElement('div');
                statItem.className = 'month-stat-item';
                
                // æ ¹æ®æ˜¯å¦å½“å‰æœˆæ·»åŠ ä¸åŒæ ·å¼
                if (m.isCurrent) {
                    statItem.style.border = '2px solid #3498db';
                    statItem.style.boxShadow = '0 2px 5px rgba(52, 152, 219, 0.2)';
                }
                
                // æ ¹æ®è°ˆè¯æ•°é‡æ·»åŠ é¢œè‰²æç¤º
                let countColor = '#666';
                if (count >= 10) countColor = '#c62828';
                else if (count >= 5) countColor = '#f57f17';
                else if (count > 0) countColor = '#2e7d32';
                
                statItem.innerHTML = `
                    <div class="month-name">${m.displayName}</div>
                    <div class="month-count" style="color: ${countColor}">${count}</div>
                `;
                
                monthlyStats.appendChild(statItem);
            });
            
            // æ·»åŠ æ€»è®¡å¡ç‰‡
            const totalCard = document.createElement('div');
            totalCard.className = 'month-stat-item';
            totalCard.style.gridColumn = '1 / -1'; // è·¨æ‰€æœ‰åˆ—
            totalCard.style.textAlign = 'center';
            totalCard.style.background = '#f8f9fa';
            totalCard.innerHTML = `
                <div class="month-name" style="font-weight: bold;">æœ€è¿‘6ä¸ªæœˆæ€»è®¡</div>
                <div class="month-count" style="font-size: 24px; color: #3498db;">${totalCount}</div>
            `;
            monthlyStats.appendChild(totalCard);
        }
        
        // æœˆä»½ç­›é€‰åŠŸèƒ½
        function initMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            if (!monthFilter) return;
            
            monthFilter.innerHTML = '<option value="">æ‰€æœ‰æœˆä»½</option>';
            
            // è·å–æ‰€æœ‰è°ˆè¯è®°å½•ä¸­çš„æœˆä»½
            const monthSet = new Set();
            talkRecords.forEach(record => {
                const date = new Date(record.talkTime);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const key = `${year}-${month.toString().padStart(2, '0')}`;
                monthSet.add(key);
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
            const months = Array.from(monthSet).sort((a, b) => b.localeCompare(a));
            
            // æ·»åŠ é€‰é¡¹
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = `${year}å¹´${parseInt(month)}æœˆ`;
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                monthFilter.appendChild(option);
            });
        }

        // æŒ‰æœˆä»½ç­›é€‰
        function filterByMonth() {
            const monthFilter = document.getElementById('monthFilter');
            const selectedMonth = monthFilter.value;
            
            if (!selectedMonth) {
                // å¦‚æœé€‰æ‹©"æ‰€æœ‰æœˆä»½"ï¼Œåˆ™ä½¿ç”¨å½“å‰æ—¶é—´ç­›é€‰å™¨
                loadTalkRecords();
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const dateFrom = new Date(year, month - 1, 1);
            const dateTo = new Date(year, month, 0, 23, 59, 59);
            
            // åº”ç”¨ç­›é€‰
            const filters = {
                dateFrom: dateFrom.toISOString().slice(0, 10),
                dateTo: dateTo.toISOString().slice(0, 10)
            };
            
            loadTalkRecords(filters);
        }
        
        // æŒ‰æ—¶é—´ç­›é€‰è®°å½•
        function filterByTime(filterType) {
            currentTimeFilter = filterType;
            
            // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡ç½®æœˆä»½ç­›é€‰
            document.getElementById('monthFilter').value = '';
            
            // é‡æ–°åŠ è½½è®°å½•
            searchTalkRecords();
        }
        
        // è·å–æ—¶é—´ç­›é€‰æ¡ä»¶
        function getTimeFilterRange(filterType) {
            const now = new Date();
            let dateFrom = null;
            let dateTo = null;
            
            switch(filterType) {
                case 'today':
                    dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    dateFrom = new Date(weekAgo.getFullYear(), weekAgo.getMonth(), weekAgo.getDate());
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    dateFrom = new Date(monthAgo.getFullYear(), monthAgo.getMonth(), monthAgo.getDate());
                    break;
                case 'quarter':
                    const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    dateFrom = new Date(quarterAgo.getFullYear(), quarterAgo.getMonth(), quarterAgo.getDate());
                    break;
            }
            
            return { dateFrom, dateTo };
        }
        
        // å­¦ç”Ÿæœç´¢åŠŸèƒ½
        function searchStudentsForSelect(searchTerm) {
            const resultsContainer = document.getElementById('studentSearchResults');
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = '';
            
            if (!searchTerm.trim()) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredStudents = students.filter(student => 
                student.name.includes(searchTerm) ||
                student.studentId.includes(searchTerm) ||
                student.className.includes(searchTerm)
            );
            
            if (filteredStudents.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'search-select-item';
                noResult.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ';
                resultsContainer.appendChild(noResult);
            } else {
                filteredStudents.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'search-select-item';
                    
                    // è·å–å­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
                    const talkCount = talkRecords.filter(r => r.studentId === student.studentId).length;
                    
                    // æ”¿æ²»é¢è²Œæ ‡ç­¾
                    let politicalTag = '';
                    if (student.politicalStatus) {
                        politicalTag = `<span class="political-tag" style="font-size: 10px;">${student.politicalStatus}</span>`;
                    }
                    
                    // å›°éš¾è®¤å®šæ ‡ç­¾
                    let hardshipTag = '';
                    if (student.hardship && student.hardship !== 'æ— ') {
                        let hardshipClass = 'hardship-general';
                        if (student.hardship === 'ç‰¹åˆ«å›°éš¾') hardshipClass = 'hardship-severe';
                        else if (student.hardship === 'ä¸€èˆ¬å›°éš¾') hardshipClass = 'hardship-none';
                        hardshipTag = `<span class="hardship-tag ${hardshipClass}" style="font-size: 10px;">${student.hardship}</span>`;
                    }
                    
                    // å¤„åˆ†è®°å½•æ ‡ç­¾
                    let punishmentTag = '';
                    if (student.punishments && student.punishments.length > 0) {
                        punishmentTag = `<span class="punishment-tag punishment-yes" style="font-size: 10px;">æœ‰å¤„åˆ†</span>`;
                    }
                    
                    // å­¦ç±å¼‚åŠ¨æ ‡ç­¾
                    let statusChangeTag = '';
                    if (student.statusChange && student.statusChange !== 'æ— ') {
                        statusChangeTag = `<span class="status-change-tag status-change-yes" style="font-size: 10px;">${student.statusChange}</span>`;
                    }
                    
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 2px;">
                                    <strong>${student.name}</strong> (${student.studentId})
                                    ${politicalTag}
                                    ${hardshipTag}
                                    ${punishmentTag}
                                    ${statusChangeTag}
                                </div>
                                <small>${student.className} - ${student.dormitory || 'æœªåˆ†é…å®¿èˆ'}</small>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                è°ˆè¯${talkCount}æ¬¡
                            </div>
                        </div>
                    `;
                    item.onclick = () => selectStudent(student);
                    resultsContainer.appendChild(item);
                });
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function selectStudent(student) {
            document.getElementById('studentSearch').value = `${student.name} (${student.studentId})`;
            document.getElementById('studentId').value = student.studentId;
            document.getElementById('className').value = student.className;
            document.getElementById('dormitory').value = student.dormitory || '';
            document.getElementById('studentSearchResults').style.display = 'none';
            
            // æ˜¾ç¤ºå­¦ç”Ÿä¿¡æ¯é¢æ¿
            const panel = document.getElementById('studentInfoPanel');
            if (panel) {
                panel.style.display = 'block';
                
                // è·å–å­¦ç”Ÿçš„è°ˆè¯è®°å½•
                const studentTalks = talkRecords.filter(r => r.studentId === student.studentId);
                const talkCount = studentTalks.length;
                
                // è·å–æœ€è¿‘è°ˆè¯æ—¶é—´
                let lastTalk = 'æ— è®°å½•';
                if (studentTalks.length > 0) {
                    const latestTalk = studentTalks.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime))[0];
                    lastTalk = formatDate(latestTalk.talkTime);
                }
                
                // æ›´æ–°å­¦ç”Ÿä¿¡æ¯
                document.getElementById('infoTalkCount').textContent = `${talkCount}æ¬¡`;
                document.getElementById('infoLastTalk').textContent = lastTalk;
                document.getElementById('infoStatusChange').textContent = student.statusChange || 'æ— ';
                
                // æ›´æ–°é£é™©ç­‰çº§æ˜¾ç¤º
                const riskLevelElement = document.getElementById('infoRiskLevel');
                riskLevelElement.innerHTML = '';
                if (student.riskLevel) {
                    const riskSpan = document.createElement('span');
                    riskSpan.className = `risk-level ${student.riskLevel}`;
                    riskSpan.textContent = 
                        student.riskLevel === 'red' ? 'çº¢è‰²é¢„è­¦' :
                        student.riskLevel === 'yellow' ? 'é»„è‰²å…³æ³¨' : 'ç»¿è‰²æ­£å¸¸';
                    riskLevelElement.appendChild(riskSpan);
                }
            }
            
            // è‡ªåŠ¨å¡«å†™å­¦ç”ŸèƒŒæ™¯
            let background = `å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ï¼š${student.name}ï¼Œ${student.className}ç­ï¼Œå®¿èˆ${student.dormitory || 'æœªåˆ†é…'}ã€‚`;
            
            // å¦‚æœæœ‰æ‰©å±•ä¿¡æ¯ï¼Œæ·»åŠ åˆ°èƒŒæ™¯ä¸­
            if (student.gender) background += ` æ€§åˆ«ï¼š${student.gender}ã€‚`;
            if (student.politicalStatus) background += ` æ”¿æ²»é¢è²Œï¼š${student.politicalStatus}ã€‚`;
            if (student.hardship && student.hardship !== 'æ— ') background += ` å›°éš¾è®¤å®šï¼š${student.hardship}ã€‚`;
            if (student.punishments && student.punishments.length > 0) {
                background += ` å¤„åˆ†è®°å½•ï¼š${student.punishments.join('ï¼›')}ã€‚`;
            }
            if (student.statusChange && student.statusChange !== 'æ— ') {
                background += ` å­¦ç±å¼‚åŠ¨ï¼š${student.statusChange}ã€‚`;
            }
            
            // å¦‚æœæœ‰å†å²è°ˆè¯è®°å½•ï¼Œæ·»åŠ ç›¸å…³ä¿¡æ¯
            const studentTalks = talkRecords.filter(r => r.studentId === student.studentId);
            if (studentTalks.length > 0) {
                const latestTalk = studentTalks.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime))[0];
                background += ` å·²æœ‰${studentTalks.length}æ¬¡è°ˆè¯è®°å½•ï¼Œæœ€è¿‘ä¸€æ¬¡ä¸º${formatDate(latestTalk.talkTime)}ã€‚`;
            }
            
            if (student.phone) background += ` è”ç³»æ–¹å¼ï¼š${student.phone}ã€‚`;
            
            const backgroundElement = document.getElementById('studentBackground');
            if (backgroundElement) {
                backgroundElement.value = background;
            }
        }
        
        // åˆ‡æ¢å…¶ä»–ä¸»é¢˜è¾“å…¥æ¡†
        function toggleOtherTopicInput() {
            const otherCheckbox = document.getElementById('otherTopicCheckbox');
            const otherInput = document.getElementById('otherTopicInput');
            
            if (otherCheckbox && otherInput) {
                if (otherCheckbox.checked) {
                    otherInput.style.display = 'block';
                } else {
                    otherInput.style.display = 'none';
                }
            }
        }
        
               // ä¿å­˜è°ˆè¯è®°å½•
        function saveTalkRecord() {
            try {
                console.log('å¼€å§‹ä¿å­˜è°ˆè¯è®°å½•...');
                
                // è·å–ç¼–è¾‘ID
                const editRecordId = document.getElementById('editRecordId').value;
                
                // è·å–å­¦ç”Ÿä¿¡æ¯
                const studentId = document.getElementById('studentId').value;
                const studentSearch = document.getElementById('studentSearch').value;
                
                console.log('å­¦ç”ŸID:', studentId);
                console.log('å­¦ç”Ÿæœç´¢:', studentSearch);
                
                if (!studentId || !studentSearch) {
                    showMessage('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿï¼', 'error');
                    return;
                }
                
                // è·å–é€‰ä¸­çš„ä¸»é¢˜
                const selectedTopics = [];
                const topicCheckboxes = document.querySelectorAll('input[name="topic"]:checked');
                console.log('é€‰ä¸­çš„ä¸»é¢˜æ•°é‡:', topicCheckboxes.length);
                
                topicCheckboxes.forEach(checkbox => {
                    if (checkbox.value === 'å…¶ä»–') {
                        const otherText = document.getElementById('otherTopicText')?.value;
                        if (otherText && otherText.trim()) {
                            selectedTopics.push(`å…¶ä»–ï¼š${otherText}`);
                        }
                    } else {
                        selectedTopics.push(checkbox.value);
                    }
                });
                
                console.log('é€‰ä¸­çš„ä¸»é¢˜:', selectedTopics);
                
                if (selectedTopics.length === 0) {
                    showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè°ˆè¯ä¸»é¢˜ï¼', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­"å…¶ä»–"ä½†æ²¡è¾“å…¥å†…å®¹
                const otherCheckbox = document.getElementById('otherTopicCheckbox');
                if (otherCheckbox && otherCheckbox.checked) {
                    const otherText = document.getElementById('otherTopicText')?.value;
                    if (!otherText || !otherText.trim()) {
                        showMessage('è¯·å¡«å†™å…¶ä»–è°ˆè¯ä¸»é¢˜å†…å®¹ï¼', 'error');
                        return;
                    }
                }
                
                // è·å–åˆ†çº§å»ºè®®
                const riskLevelRadio = document.querySelector('input[name="riskLevel"]:checked');
                if (!riskLevelRadio) {
                    showMessage('è¯·é€‰æ‹©åˆ†çº§å»ºè®®ï¼', 'error');
                    return;
                }
                const riskLevel = riskLevelRadio.value;
                console.log('é£é™©ç­‰çº§:', riskLevel);
                
                // è·å–å­¦ç”Ÿä¿¡æ¯
const student = students.find(s => s.studentId === studentId);
if (!student) {
    // å°è¯•ä»å­¦ç”Ÿæœç´¢æ¡†ä¸­æå–å­¦ç”Ÿå§“å
    const searchValue = document.getElementById('studentSearch').value;
    if (!searchValue) {
        showMessage('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿï¼', 'error');
        return;
    }
    
    // ä»æœç´¢æ¡†ä¸­æå–å­¦ç”Ÿå§“åï¼ˆæ ¼å¼ï¼šå§“å (å­¦å·)ï¼‰
    let studentName = searchValue.split('(')[0].trim();
    if (!studentName) {
        studentName = 'æœªçŸ¥å­¦ç”Ÿ';
    }
    
    // ä½¿ç”¨ä»è¡¨å•ä¸­è·å–çš„ä¿¡æ¯
    student = {
        studentId: studentId,
        name: studentName,
        className: document.getElementById('className').value,
        dormitory: document.getElementById('dormitory').value
    };
}
                
                console.log('æ‰¾åˆ°å­¦ç”Ÿ:', student);
                
                // åˆ›å»ºè®°å½•å¯¹è±¡
                const record = {
                    id: editRecordId ? parseInt(editRecordId) : Date.now(),
                    studentId: studentId,
                    studentName: student.name,
                    className: document.getElementById('className').value,
                    dormitory: document.getElementById('dormitory').value,
                    talkTime: document.getElementById('talkTime').value,
                    talkLocation: document.getElementById('talkLocation').value,
                    topics: selectedTopics,
                    studentBackground: document.getElementById('studentBackground').value,
                    talkPurpose: document.getElementById('talkPurpose').value,
                    studentStatement: document.getElementById('studentStatement').value,
                    talkPoints: document.getElementById('talkPoints').value,
                    talkFeedback: document.getElementById('talkFeedback').value,
                    riskLevel: riskLevel,
                    followUpPlan: document.getElementById('followUpPlan')?.value || '',
                    generalRemark: document.getElementById('generalRemark')?.value || '',
                    studentSignature: document.getElementById('studentSignature')?.value || '',
                    ccounselorSignature: document.getElementById('counselorSignature')?.value || (currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜'),
                    createTime: editRecordId ? new Date().toISOString() : new Date().toISOString(),
                    updateTime: new Date().toISOString()
                };
                
                console.log('åˆ›å»ºçš„è®°å½•:', record);
                
                // ä¿å­˜è®°å½•
                if (editRecordId) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    const index = talkRecords.findIndex(r => r.id === parseInt(editRecordId));
                    if (index !== -1) {
                        talkRecords[index] = record;
                    }
                } else {
                    // æ·»åŠ æ–°è®°å½•
                    talkRecords.push(record);
                }
                
                console.log('ä¿å­˜å‰çš„è®°å½•æ•°é‡:', talkRecords.length);
                
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                console.log('ä¿å­˜åçš„localStorage:', localStorage.getItem('talkRecords'));
                
                showMessage(editRecordId ? 'è®°å½•æ›´æ–°æˆåŠŸï¼' : 'è®°å½•ä¿å­˜æˆåŠŸï¼', 'success');

// æ›´æ–°å­¦ç”Ÿé£é™©ç­‰çº§ï¼ˆå¦‚æœé€‰æ‹©äº†ä¸åŒç­‰çº§ï¼‰
if (student.riskLevel !== riskLevel) {
    student.riskLevel = riskLevel;
    localStorage.setItem('students', JSON.stringify(students));
}

// ç«‹å³é‡æ–°åŠ è½½æ•°æ®
talkRecords = JSON.parse(localStorage.getItem('talkRecords') || '[]');
students = JSON.parse(localStorage.getItem('students') || '[]');

// æ¸…ç©ºè¡¨å•
clearForm();

// åˆ·æ–°ç›¸å…³é¡µé¢å’Œç»Ÿè®¡ä¿¡æ¯
loadStudentsTable();
loadTalkRecords();
loadExportList();
updateRecordStats();
updateTalkTrackingStats();
updateAnalysisData();  // æ–°å¢ï¼šæ›´æ–°åˆ†ææ•°æ®
                
                // åˆ·æ–°ç›¸å…³é¡µé¢å’Œç»Ÿè®¡ä¿¡æ¯
                loadStudentsTable();
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                
                console.log('ä¿å­˜å®Œæˆ');
                
                // ç§»é™¤URLä¸­çš„ç¼–è¾‘å‚æ•°
                if (editRecordId) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
            } catch (error) {
                console.error('ä¿å­˜è°ˆè¯è®°å½•æ—¶å‡ºé”™ï¼š', error);
                showMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // ä¿å­˜ä¸ºè‰ç¨¿
        function saveAsDraft() {
            try {
                // è·å–è¡¨å•æ•°æ®
                const draftData = {
                    id: Date.now(),
                    studentId: document.getElementById('studentId').value || '',
                    studentSearch: document.getElementById('studentSearch').value || '',
                    className: document.getElementById('className').value || '',
                    dormitory: document.getElementById('dormitory').value || '',
                    talkTime: document.getElementById('talkTime').value || getCurrentDateTime(),
                    talkLocation: document.getElementById('talkLocation').value || '',
                    topics: getSelectedTopics(),
                    studentBackground: document.getElementById('studentBackground').value || '',
                    talkPurpose: document.getElementById('talkPurpose').value || '',
                    studentStatement: document.getElementById('studentStatement').value || '',
                    talkPoints: document.getElementById('talkPoints').value || '',
                    talkFeedback: document.getElementById('talkFeedback').value || '',
                    riskLevel: document.querySelector('input[name="riskLevel"]:checked')?.value || 'green',
                    followUpPlan: document.getElementById('followUpPlan')?.value || '',
                    generalRemark: document.getElementById('generalRemark')?.value || '',
                    studentSignature: document.getElementById('studentSignature')?.value || '',
                    counselorSignature: document.getElementById('counselorSignature')?.value || '',
                    createTime: new Date().toISOString()
                };
                
                // æ·»åŠ åˆ°è‰ç¨¿åˆ—è¡¨
                drafts.push(draftData);
                localStorage.setItem('talkDrafts', JSON.stringify(drafts));
                
                showMessage('å·²ä¿å­˜ä¸ºè‰ç¨¿ï¼', 'success');
                
            } catch (error) {
                console.error('ä¿å­˜è‰ç¨¿æ—¶å‡ºé”™ï¼š', error);
                showMessage('ä¿å­˜è‰ç¨¿å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        function getSelectedTopics() {
            const selectedTopics = [];
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]:checked');
            
            topicCheckboxes.forEach(checkbox => {
                if (checkbox.value === 'å…¶ä»–') {
                    const otherText = document.getElementById('otherTopicText')?.value;
                    if (otherText && otherText.trim()) {
                        selectedTopics.push(`å…¶ä»–ï¼š${otherText}`);
                    }
                } else {
                    selectedTopics.push(checkbox.value);
                }
            });
            
            return selectedTopics;
        }
        
        function clearForm() {
            const form = document.getElementById('talkForm');
            if (form) {
                form.reset();
                document.getElementById('studentSearch').value = '';
                document.getElementById('studentId').value = '';
                document.getElementById('editRecordId').value = '';
                document.getElementById('talkTime').value = getCurrentDateTime();
                document.getElementById('studentInfoPanel').style.display = 'none';
                document.getElementById('counselorSignature').value = currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜';
                document.querySelector('input[name="riskLevel"][value="green"]').checked = true;
                
                // é‡ç½®æŒ‰é’®æ–‡æœ¬
                document.getElementById('saveRecordBtn').textContent = 'ä¿å­˜è®°å½•';
                document.getElementById('saveDraftBtn').style.display = 'none';
                
                // é‡ç½®å…¶ä»–ä¸»é¢˜è¾“å…¥æ¡†
                const otherInput = document.getElementById('otherTopicInput');
                if (otherInput) {
                    otherInput.style.display = 'none';
                }
                const otherText = document.getElementById('otherTopicText');
                if (otherText) {
                    otherText.value = '';
                }
            }
        }
        
        // ç¼–è¾‘è°ˆè¯è®°å½•åŠŸèƒ½
        function loadTalkRecordForEdit(recordId) {
            const record = talkRecords.find(r => r.id === recordId);
            if (!record) {
                showMessage('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„è®°å½•ï¼', 'error');
                return;
            }
            
            // åˆ‡æ¢åˆ°è®°å½•é¡µé¢
            switchTab('record');
            
            // å¡«å……è¡¨å•
            document.getElementById('editRecordId').value = record.id;
            
            // æŸ¥æ‰¾å­¦ç”Ÿ
            const student = students.find(s => s.studentId === record.studentId);
            if (student) {
                document.getElementById('studentSearch').value = `${student.name} (${student.studentId})`;
                document.getElementById('studentId').value = student.studentId;
                selectStudent(student);
            }
            
            document.getElementById('className').value = record.className;
            document.getElementById('dormitory').value = record.dormitory;
            document.getElementById('talkTime').value = record.talkTime.replace(' ', 'T');
            document.getElementById('talkLocation').value = record.talkLocation;
            
            // è®¾ç½®è°ˆè¯ä¸»é¢˜
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]');
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            record.topics.forEach(topic => {
                if (topic.startsWith('å…¶ä»–ï¼š')) {
                    document.getElementById('otherTopicCheckbox').checked = true;
                    document.getElementById('otherTopicText').value = topic.replace('å…¶ä»–ï¼š', '');
                    document.getElementById('otherTopicInput').style.display = 'block';
                } else {
                    const checkbox = document.querySelector(`input[name="topic"][value="${topic}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                }
            });
            
            document.getElementById('studentBackground').value = record.studentBackground;
            document.getElementById('talkPurpose').value = record.talkPurpose;
            document.getElementById('studentStatement').value = record.studentStatement;
            document.getElementById('talkPoints').value = record.talkPoints;
            document.getElementById('talkFeedback').value = record.talkFeedback;
            
            // è®¾ç½®é£é™©ç­‰çº§
            const riskLevelRadio = document.querySelector(`input[name="riskLevel"][value="${record.riskLevel}"]`);
            if (riskLevelRadio) {
                riskLevelRadio.checked = true;
            }
            
            document.getElementById('followUpPlan').value = record.followUpPlan || '';
            document.getElementById('generalRemark').value = record.generalRemark || '';
            document.getElementById('studentSignature').value = record.studentSignature || '';
            document.getElementById('counselorSignature').value = record.counselorSignature || (currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('saveRecordBtn').textContent = 'æ›´æ–°è®°å½•';
            document.getElementById('saveDraftBtn').style.display = 'inline-block';
            
            showMessage('å·²åŠ è½½è¦ç¼–è¾‘çš„è®°å½•', 'info');
        }
        
        function loadDraftForEdit(draftId) {
            const draft = drafts.find(d => d.id === parseInt(draftId));
            if (!draft) {
                showMessage('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„è‰ç¨¿ï¼', 'error');
                return;
            }
            
            // åˆ‡æ¢åˆ°è®°å½•é¡µé¢
            switchTab('record');
            
            // å¡«å……è¡¨å•
            document.getElementById('editRecordId').value = draft.id;
            
            if (draft.studentId) {
                const student = students.find(s => s.studentId === draft.studentId);
                if (student) {
                    document.getElementById('studentSearch').value = draft.studentSearch;
                    document.getElementById('studentId').value = draft.studentId;
                    selectStudent(student);
                }
            }
            
            document.getElementById('className').value = draft.className;
            document.getElementById('dormitory').value = draft.dormitory;
            document.getElementById('talkTime').value = draft.talkTime;
            document.getElementById('talkLocation').value = draft.talkLocation;
            
            // è®¾ç½®è°ˆè¯ä¸»é¢˜
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]');
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            if (draft.topics && draft.topics.length > 0) {
                draft.topics.forEach(topic => {
                    if (topic.startsWith('å…¶ä»–ï¼š')) {
                        document.getElementById('otherTopicCheckbox').checked = true;
                        document.getElementById('otherTopicText').value = topic.replace('å…¶ä»–ï¼š', '');
                        document.getElementById('otherTopicInput').style.display = 'block';
                    } else {
                        const checkbox = document.querySelector(`input[name="topic"][value="${topic}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    }
                });
            }
            
            document.getElementById('studentBackground').value = draft.studentBackground;
            document.getElementById('talkPurpose').value = draft.talkPurpose;
            document.getElementById('studentStatement').value = draft.studentStatement;
            document.getElementById('talkPoints').value = draft.talkPoints;
            document.getElementById('talkFeedback').value = draft.talkFeedback;
            
            // è®¾ç½®é£é™©ç­‰çº§
            if (draft.riskLevel) {
                const riskLevelRadio = document.querySelector(`input[name="riskLevel"][value="${draft.riskLevel}"]`);
                if (riskLevelRadio) {
                    riskLevelRadio.checked = true;
                }
            }
            
            document.getElementById('followUpPlan').value = draft.followUpPlan || '';
            document.getElementById('generalRemark').value = draft.generalRemark || '';
            document.getElementById('studentSignature').value = draft.studentSignature || '';
            document.getElementById('counselorSignature').value = draft.counselorSignature || (currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('saveRecordBtn').textContent = 'ä¿å­˜è®°å½•';
            document.getElementById('saveDraftBtn').style.display = 'inline-block';
            
            showMessage('å·²åŠ è½½è‰ç¨¿', 'info');
        }
        
        // æ˜¾ç¤ºDOCé¢„è§ˆ
        function showDocPreview(recordId) {
            let record;
            
            if (recordId) {
                // å¦‚æœæ˜¯æŸ¥çœ‹å†å²è®°å½•
                record = talkRecords.find(r => r.id === recordId);
            } else {
                // å¦‚æœæ˜¯å½“å‰è¡¨å•
                if (!validateFormForExport()) {
                    return;
                }
                record = getFormDataForExport();
            }
            
            if (!record) {
                showMessage('æœªæ‰¾åˆ°è®°å½•ï¼', 'error');
                return;
            }
            
            const previewHtml = generateDocHtml(record);
            document.getElementById('docPreview').innerHTML = previewHtml;
            document.getElementById('previewModal').style.display = 'flex';
        }
        
        // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        // éªŒè¯è¡¨å•æ•°æ®ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        function validateFormForExport() {
            const studentName = document.getElementById('studentSearch').value;
            if (!studentName || studentName.trim() === '') {
                showMessage('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿï¼', 'error');
                return false;
            }
            
            const topics = document.querySelectorAll('input[name="topic"]:checked');
            if (topics.length === 0) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè°ˆè¯ä¸»é¢˜ï¼', 'error');
                return false;
            }
            
            return true;
        }
        
        // ä»è¡¨å•è·å–æ•°æ®ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        function getFormDataForExport() {
            // è·å–å­¦ç”Ÿä¿¡æ¯
            const studentId = document.getElementById('studentId').value;
            const student = students.find(s => s.studentId === studentId);
            
            // è·å–é€‰ä¸­çš„ä¸»é¢˜
            const selectedTopics = [];
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]:checked');
            topicCheckboxes.forEach(checkbox => {
                if (checkbox.value === 'å…¶ä»–') {
                    const otherText = document.getElementById('otherTopicText')?.value;
                    if (otherText && otherText.trim()) {
                        selectedTopics.push(`å…¶ä»–ï¼š${otherText}`);
                    }
                } else {
                    selectedTopics.push(checkbox.value);
                }
            });
            
            // è·å–åˆ†çº§å»ºè®®
            const riskLevelRadio = document.querySelector('input[name="riskLevel"]:checked');
            const riskLevel = riskLevelRadio ? riskLevelRadio.value : 'green';
            
            // åˆ›å»ºè®°å½•å¯¹è±¡
            return {
                id: Date.now(),
                studentId: studentId,
                studentName: student ? student.name : document.getElementById('studentSearch').value.split('(')[0],
                className: document.getElementById('className').value,
                dormitory: document.getElementById('dormitory').value,
                talkTime: document.getElementById('talkTime').value,
                talkLocation: document.getElementById('talkLocation').value,
                topics: selectedTopics,
                studentBackground: document.getElementById('studentBackground').value,
                talkPurpose: document.getElementById('talkPurpose').value,
                studentStatement: document.getElementById('studentStatement').value,
                talkPoints: document.getElementById('talkPoints').value,
                talkFeedback: document.getElementById('talkFeedback').value,
                riskLevel: riskLevel,
                followUpPlan: document.getElementById('followUpPlan')?.value || '',
                generalRemark: document.getElementById('generalRemark')?.value || '',
                studentSignature: document.getElementById('studentSignature')?.value || '',
                counselorSignature: document.getElementById('counselorSignature')?.value || (currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜'),
                createTime: new Date().toISOString()
            };
        }
        
        // ç”ŸæˆDOCæ ¼å¼çš„HTML
        function generateDocHtml(record) {
            // æ ¼å¼åŒ–æ—¥æœŸ
            const formatDate = (dateString) => {
                try {
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
                } catch (error) {
                    return dateString;
                }
            };
            
            // é£é™©ç­‰çº§æ˜¾ç¤º
            const getRiskLevelText = (riskLevel) => {
                switch(riskLevel) {
                    case 'red': return 'çº¢è‰²é¢„è­¦';
                    case 'yellow': return 'é»„è‰²å…³æ³¨';
                    case 'green': return 'ç»¿è‰²æ­£å¸¸';
                    default: return 'æœªåˆ†çº§';
                }
            };
            
            // é£é™©ç­‰çº§æ ·å¼
            const riskLevelStyle = (riskLevel) => {
                switch(riskLevel) {
                    case 'red': return 'color: #c62828; font-weight: bold;';
                    case 'yellow': return 'color: #f57f17; font-weight: bold;';
                    case 'green': return 'color: #2e7d32; font-weight: bold;';
                    default: return '';
                }
            };
            
            const riskLevelText = getRiskLevelText(record.riskLevel);
            const riskLevelStyleStr = riskLevelStyle(record.riskLevel);
            
            return `
                <div class="doc-content">
                    <div class="doc-header">
                        <h1>å¹¿ä¸œå·¥å•†èŒä¸šæŠ€æœ¯å¤§å­¦è´¢ç»æ”¿æ³•å­¦é™¢</h1>
                        <h2>è¾…å¯¼å‘˜è°ˆå¿ƒè°ˆè¯è®°å½•è¡¨</h2>
                    </div>
                    
                    <table class="print-table">
                        <tr>
                            <th width="15%">è°ˆè¯å¯¹è±¡</th>
                            <td width="35%">${record.studentName || ''}</td>
                            <th width="15%">ç­çº§/å®¿èˆ</th>
                            <td width="35%">${record.className || ''} / ${record.dormitory || ''}</td>
                        </tr>
                        <tr>
                            <th>è°ˆè¯æ—¶é—´</th>
                            <td>${formatDate(record.talkTime)}</td>
                            <th>è°ˆè¯åœ°ç‚¹</th>
                            <td>${record.talkLocation || ''}</td>
                        </tr>
                        <tr>
                            <th>è°ˆè¯ä¸»é¢˜</th>
                            <td colspan="3">${record.topics.join('ã€')}</td>
                        </tr>
                        <tr>
                            <th rowspan="3">è°ˆ<br>è¯<br>è¦<br>ç‚¹</th>
                            <td colspan="3">
                                <strong>å­¦ç”ŸèƒŒæ™¯ï¼š</strong><br>
                                ${record.studentBackground.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>è°ˆè¯ç›®çš„ï¼š</strong><br>
                                ${record.talkPurpose.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>å­¦ç”Ÿè‡ªè¿°ï¼š</strong><br>
                                ${record.studentStatement.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <th>å­¦ç”Ÿç­¾å</th>
                            <td>${record.studentSignature || ''}</td>
                            <th>è¾…å¯¼å‘˜ç­¾å</th>
                            <td>${record.counselorSignature || ''}</td>
                        </tr>
                        <tr>
                            <th rowspan="3">è°ˆ<br>è¯<br>å<br>é¦ˆ</th>
                            <td colspan="3">
                                ${record.talkFeedback.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>åç»­è·Ÿè¿›è®¡åˆ’ï¼š</strong><br>
                                ${record.followUpPlan ? record.followUpPlan.replace(/\n/g, '<br>') : 'æ— '}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>åˆ†çº§å»ºè®®ï¼š</strong> 
                                <span style="${riskLevelStyleStr}">${riskLevelText}</span><br>
                                <strong>å¤‡æ³¨ï¼š</strong> ${record.generalRemark || 'æ— '}
                            </td>
                        </tr>
                    </table>
                    
                    <div class="doc-footer">
                        <p>è®°å½•æ—¶é—´ï¼š${formatDate(record.createTime)}</p>
                        <p>è¾…å¯¼å‘˜ï¼š${record.counselorSignature || (currentUser ? currentUser.fullname : 'è¾…å¯¼å‘˜')}</p>
                    </div>
                </div>
            `;
        }
        
        // å¯¼å‡ºä¸ºWordæ–‡æ¡£
        function exportToWord() {
            try {
                const content = document.getElementById('docPreview').innerHTML;
                
                // ä»é¢„è§ˆå†…å®¹ä¸­æå–å­¦ç”Ÿå§“åå’Œç­çº§
                const previewContent = document.getElementById('docPreview').innerHTML;
                const studentNameMatch = previewContent.match(/è°ˆè¯å¯¹è±¡<\/th>\s*<td[^>]*>([^<]+)</);
                const classNameMatch = previewContent.match(/ç­çº§\/å®¿èˆ<\/th>\s*<td[^>]*>([^<]+)/);
                
                let studentName = 'æœªçŸ¥å­¦ç”Ÿ';
                let className = 'æœªçŸ¥ç­çº§';
                
                if (studentNameMatch && studentNameMatch[1]) {
                    studentName = studentNameMatch[1].trim();
                }
                
                if (classNameMatch && classNameMatch[1]) {
                    // æå–ç­çº§éƒ¨åˆ†ï¼ˆå»æ‰å®¿èˆéƒ¨åˆ†ï¼‰
                    const classAndDorm = classNameMatch[1].trim();
                    className = classAndDorm.split('/')[0].trim();
                }
                
                // åˆ›å»ºå®Œæ•´çš„HTMLæ–‡æ¡£
                const fullHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>è°ˆå¿ƒè°ˆè¯è®°å½•è¡¨</title>
                        <style>
                            body {
                                font-family: "å®‹ä½“", "SimSun", serif;
                                margin: 2cm;
                                font-size: 12pt;
                            }
                            .print-table {
                                width: 100%;
                                border-collapse: collapse;
                                border: 2px solid #000;
                                margin: 20px 0;
                            }
                            .print-table th,
                            .print-table td {
                                border: 1px solid #000;
                                padding: 8px 12px;
                                vertical-align: top;
                            }
                            .print-table th {
                                background-color: #f0f0f0;
                                font-weight: bold;
                                text-align: center;
                            }
                            .doc-header {
                                text-align: center;
                                margin-bottom: 30px;
                                font-family: "é»‘ä½“", "SimHei", sans-serif;
                            }
                            .doc-header h1 {
                                font-size: 22pt;
                                margin-bottom: 10px;
                            }
                            .doc-header h2 {
                                font-size: 16pt;
                                margin-bottom: 20px;
                                color: #333;
                            }
                            .doc-footer {
                                margin-top: 50px;
                                text-align: right;
                                font-size: 11pt;
                                color: #666;
                            }
                            @page {
                                size: A4;
                                margin: 2cm;
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `;
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob(['\ufeff', fullHtml], {
                    type: 'application/msword'
                });
                
                // ä½¿ç”¨FileSaverä¿å­˜æ–‡ä»¶ï¼Œä½¿ç”¨æ–°çš„å‘½åæ–¹å¼
                const fileName = `${studentName}_${className}_è°ˆå¿ƒè°ˆè¯è®°å½•.doc`;
                saveAs(blob, fileName);
                
                showMessage('Wordæ–‡æ¡£å¯¼å‡ºæˆåŠŸï¼', 'success');
                closePreviewModal();
                
            } catch (error) {
                console.error('å¯¼å‡ºWordæ–‡æ¡£æ—¶å‡ºé”™ï¼š', error);
                showMessage('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // ç›´æ¥æ‰“å°æ–‡æ¡£
        function printDocument() {
            window.print();
        }
        
        // Excelæ‰¹é‡å¯¼å…¥åŠŸèƒ½
        function showImportModal() {
            resetImport();
            document.getElementById('importModal').style.display = 'flex';
        }
        
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }
        
        function resetImport() {
            importData = [];
            importPreviewData = [];
            
            // é‡ç½®æ­¥éª¤æ˜¾ç¤º
            document.getElementById('uploadStep').style.display = 'block';
            document.getElementById('previewStep').style.display = 'none';
            document.getElementById('completeStep').style.display = 'none';
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('fileInput').value = '';
            
            // é‡ç½®é¢„è§ˆè¡¨æ ¼
            document.getElementById('previewTableContainer').innerHTML = '';
        }
        
        function initFileDrop() {
            const dropArea = document.getElementById('fileDropArea');
            
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });
            
            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
            });
            
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xls æ ¼å¼ï¼‰', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            showMessage('æ­£åœ¨è¯»å–Excelæ–‡ä»¶...', 'info');
            console.log('å¼€å§‹è¯»å–æ–‡ä»¶:', file.name, 'å¤§å°:', file.size);
            
            // ä½¿ç”¨FileReaderè¯»å–æ–‡ä»¶
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æ...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    
                    console.log('å·¥ä½œç°¿ä¿¡æ¯:', workbook.SheetNames);
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSONï¼ˆåŒ…å«ç©ºå•å…ƒæ ¼ï¼‰
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                        header: 1, 
                        defval: '',
                        blankrows: true
                    });
                    
                    console.log('åŸå§‹Excelæ•°æ®:', jsonData);
                    console.log('æ•°æ®è¡Œæ•°:', jsonData.length);
                    
                    if (jsonData.length <= 1) {
                        showMessage('Excelæ–‡ä»¶æ²¡æœ‰æ•°æ®æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿è‡³å°‘æœ‰æ•°æ®è¡Œã€‚', 'error');
                        return;
                    }
                    
                    // å¤„ç†Excelæ•°æ®
                    processExcelData(jsonData);
                    
                } catch (error) {
                    console.error('è¯»å–Excelæ–‡ä»¶æ—¶å‡ºé”™ï¼š', error);
                    showMessage(`è¯»å–Excelæ–‡ä»¶å¤±è´¥ï¼š${error.message}ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚`, 'error');
                }
            };
            
            reader.onerror = function(e) {
                console.error('æ–‡ä»¶è¯»å–é”™è¯¯ï¼š', e);
                showMessage('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            };
            
            // æ·»åŠ è¿›åº¦äº‹ä»¶ç›‘å¬
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    console.log(`æ–‡ä»¶è¯»å–è¿›åº¦: ${percent}%`);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(jsonData) {
            // è·å–è¡¨å¤´è¡Œ
            const headers = jsonData[0];
            
            // è°ƒè¯•ï¼šæ‰“å°è¡¨å¤´
            console.log('Excelè¡¨å¤´:', headers);
            
            // æ ‡å‡†åŒ–è¡¨å¤´åç§°æ˜ å°„
            // æ ‡å‡†åŒ–è¡¨å¤´åç§°æ˜ å°„
const headerMapping = {
    'å­¦å·': ['å­¦å·', 'studentId', 'Student ID', 'å­¦ç”Ÿç¼–å·', 'å­¦å·ç¼–å·'],
    'å§“å': ['å§“å', 'name', 'Name', 'å­¦ç”Ÿå§“å'],
    'ç­çº§': ['ç­çº§', 'class', 'Class', 'ç­çº§åç§°', 'ç­åˆ«'],
    'å®¿èˆ': ['å®¿èˆ', 'dormitory', 'Dormitory', 'å¯å®¤', 'å®¿èˆå·'],
    'æ€§åˆ«': ['æ€§åˆ«', 'gender', 'Gender', 'sex', 'Sex'],
    'è”ç³»ç”µè¯': ['è”ç³»ç”µè¯', 'ç”µè¯', 'æ‰‹æœº', 'phone', 'Phone', 'å­¦ç”Ÿç”µè¯', 'æ‰‹æœºå·'],
    'å®¶é•¿è”ç³»æ–¹å¼': ['å®¶é•¿è”ç³»æ–¹å¼', 'å®¶é•¿ç”µè¯', 'çˆ¶æ¯ç”µè¯', 'ç´§æ€¥è”ç³»äºº', 'å®¶åº­ç”µè¯', 'ç›‘æŠ¤äººç”µè¯', 'parentPhone', 'Parent Phone'],
    'èº«ä»½è¯å·': ['èº«ä»½è¯å·', 'èº«ä»½è¯', 'ID Card', 'èº«ä»½è¯å·ç '],
    'æ”¿æ²»é¢è²Œ': ['æ”¿æ²»é¢è²Œ', 'æ”¿æ²»èº«ä»½', 'political', 'Political Status'],
    'æˆ·ç±åœ°': ['æˆ·ç±åœ°', 'ç±è´¯', 'hometown', 'Hometown', 'æˆ·å£æ‰€åœ¨åœ°'],
    'å›°éš¾è®¤å®š': ['å›°éš¾è®¤å®š', 'å›°éš¾ç¨‹åº¦', 'hardship', 'Hardship'],
    'é£é™©ç­‰çº§': ['é£é™©ç­‰çº§', 'é£é™©', 'risk', 'Risk Level'],
    'å¤„åˆ†è®°å½•': ['å¤„åˆ†è®°å½•', 'å¤„åˆ†', 'punishment', 'Punishment'],
    'å­¦ç±å¼‚åŠ¨': ['å­¦ç±å¼‚åŠ¨', 'å­¦ç±', 'status', 'Status Change'],
    'å¤‡æ³¨': ['å¤‡æ³¨', 'è¯´æ˜', 'remark', 'Remark', 'note', 'Note']
};
            
            // åˆ›å»ºå®é™…åˆ—ç´¢å¼•æ˜ å°„
            const headerMap = {};
            
            // æŸ¥æ‰¾å„åˆ—ç´¢å¼•ï¼ˆæ”¯æŒå¤šç§è¡¨å¤´åç§°ï¼‰
            headers.forEach((header, index) => {
                if (header) {
                    const headerStr = header.toString().trim();
                    
                    // éå†æ˜ å°„è¡¨ï¼Œæ‰¾åˆ°åŒ¹é…çš„åˆ—
                    for (const [standardName, possibleNames] of Object.entries(headerMapping)) {
                        if (possibleNames.some(name => headerStr.includes(name) || name.includes(headerStr))) {
                            headerMap[standardName] = index;
                            console.log(`æ‰¾åˆ°åˆ—: ${standardName} -> ç´¢å¼•: ${index} (åŸå§‹: ${headerStr})`);
                            break;
                        }
                    }
                }
            });
            
            // è°ƒè¯•ï¼šæ‰“å°æ‰¾åˆ°çš„åˆ—æ˜ å°„
            console.log('åˆ—æ˜ å°„:', headerMap);
            
            // æ£€æŸ¥å¿…éœ€åˆ—
            const requiredColumns = ['å­¦å·', 'å§“å', 'ç­çº§'];
            const missingColumns = requiredColumns.filter(col => headerMap[col] === undefined);
            
            if (missingColumns.length > 0) {
                showMessage(`Excelç¼ºå°‘å¿…éœ€åˆ—ï¼š${missingColumns.join('ã€')}ã€‚è¯·ä¸‹è½½æ¨¡æ¿å¹¶æŒ‰æ¨¡æ¿æ ¼å¼å¡«å†™ã€‚`, 'error');
                console.error('ç¼ºå°‘åˆ—:', missingColumns);
                console.error('æ‰¾åˆ°çš„åˆ—:', Object.keys(headerMap));
                return;
            }
            
            // å¤„ç†æ•°æ®è¡Œ
            importData = [];
            let validCount = 0;
            let invalidCount = 0;
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // è·³è¿‡ç©ºè¡Œ
                if (!row || row.length === 0 || row.every(cell => cell === null || cell === undefined || cell.toString().trim() === '')) {
                    continue;
                }
                
                // æå–æ•°æ®ï¼ˆä½¿ç”¨å®‰å…¨çš„è®¿é—®æ–¹å¼ï¼‰
                const getCellValue = (columnName) => {
                    const index = headerMap[columnName];
                    if (index !== undefined && row[index] !== undefined && row[index] !== null) {
                        return row[index].toString().trim();
                    }
                    return '';
                };
                
                const studentId = getCellValue('å­¦å·');
                const name = getCellValue('å§“å');
                const className = getCellValue('ç­çº§');
                
                // è°ƒè¯•ï¼šæ‰“å°æ¯ä¸€è¡Œæ•°æ®
                console.log(`ç¬¬${i+1}è¡Œæ•°æ®:`, { studentId, name, className, row });
                
                // éªŒè¯å¿…éœ€å­—æ®µ
                if (!studentId || !name || !className) {
                    console.warn(`ç¬¬${i+1}è¡Œæ•°æ®æ— æ•ˆ:`, { studentId, name, className });
                    invalidCount++;
                    continue;
                }
                
                // æ„å»ºå­¦ç”Ÿå¯¹è±¡ - ä¿®å¤ç‰ˆ
const student = {
    studentId: studentId,
    name: name,
    className: className,
    dormitory: getCellValue('å®¿èˆ'),
    gender: getCellValue('æ€§åˆ«'),
    phone: getCellValue('è”ç³»ç”µè¯'),      // å­¦ç”Ÿç”µè¯
    parentPhone: getCellValue('å®¶é•¿è”ç³»æ–¹å¼'),  // â† æ–°å¢ï¼šå®¶é•¿ç”µè¯
    idCard: getCellValue('èº«ä»½è¯å·'),      // â† æ–°å¢ï¼šèº«ä»½è¯å·
    politicalStatus: getCellValue('æ”¿æ²»é¢è²Œ'),
    hometown: getCellValue('æˆ·ç±åœ°'),      // â† æ–°å¢ï¼šæˆ·ç±åœ°
    hardship: getCellValue('å›°éš¾è®¤å®š'),
    statusChange: getCellValue('å­¦ç±å¼‚åŠ¨'),
    generalRemark: getCellValue('å¤‡æ³¨')
};
                
                // å¤„ç†å¤„åˆ†è®°å½•
                const punishmentStr = getCellValue('å¤„åˆ†è®°å½•');
                if (punishmentStr) {
                    student.punishments = punishmentStr.split(/[;ï¼›]/).map(p => p.trim()).filter(p => p);
                }
                
                // å¤„ç†é£é™©ç­‰çº§
                const riskLevelStr = getCellValue('é£é™©ç­‰çº§');
                if (riskLevelStr) {
                    const riskLower = riskLevelStr.toLowerCase();
                    if (riskLower.includes('çº¢') || riskLower.includes('red') || riskLower.includes('é¢„è­¦')) {
                        student.riskLevel = 'red';
                    } else if (riskLower.includes('é»„') || riskLower.includes('yellow') || riskLower.includes('å…³æ³¨')) {
                        student.riskLevel = 'yellow';
                    } else if (riskLower.includes('ç»¿') || riskLower.includes('green') || riskLower.includes('æ­£å¸¸')) {
                        student.riskLevel = 'green';
                    } else {
                        student.riskLevel = 'green'; // é»˜è®¤å€¼
                    }
                } else {
                    student.riskLevel = 'green'; // é»˜è®¤å€¼
                }
                
                // éªŒè¯å­¦å·æ ¼å¼ï¼ˆå¯é€‰ï¼‰
                if (student.studentId.length < 3) {
                    console.warn(`å­¦å·æ ¼å¼å¯èƒ½ä¸æ­£ç¡®: ${student.studentId}`);
                }
                
                importData.push(student);
                validCount++;
                console.log(`ç¬¬${i+1}è¡Œæ•°æ®æœ‰æ•ˆ:`, student);
            }
            
            if (importData.length === 0) {
                showMessage('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„å­¦ç”Ÿæ•°æ®ã€‚è¯·ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ã€‚', 'error');
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆæ•°æ®ï¼ˆæœ€å¤š10è¡Œï¼‰
            importPreviewData = importData.slice(0, 10);
            
            // æ£€æŸ¥é‡å¤æ•°æ®
            const existingIds = students.map(s => s.studentId);
            const duplicateCount = importData.filter(s => existingIds.includes(s.studentId)).length;
            
            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            document.getElementById('validCount').textContent = validCount;
            document.getElementById('invalidCount').textContent = invalidCount;
            document.getElementById('duplicateCount').textContent = duplicateCount;
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            generatePreviewTable();
            
            // åˆ‡æ¢åˆ°é¢„è§ˆæ­¥éª¤
            document.getElementById('uploadStep').style.display = 'none';
            document.getElementById('previewStep').style.display = 'block';
            
            showMessage(`æˆåŠŸè¯»å– ${validCount} æ¡æœ‰æ•ˆæ•°æ®ï¼Œ${invalidCount} æ¡æ— æ•ˆæ•°æ®`, 'success');
            console.log('æœ€ç»ˆå¯¼å…¥æ•°æ®:', importData);
        }
        
        function generatePreviewTable() {
    const container = document.getElementById('previewTableContainer');
    let html = '<table class="preview-table">';
    
    // è¡¨å¤´ - å¢åŠ å®¶é•¿è”ç³»æ–¹å¼åˆ—
    html += '<thead><tr>';
    html += '<th>å­¦å·</th>';
    html += '<th>å§“å</th>';
    html += '<th>ç­çº§</th>';
    html += '<th>å®¿èˆ</th>';
    html += '<th>è”ç³»ç”µè¯</th>';        // â† æ–°å¢
    html += '<th>å®¶é•¿è”ç³»æ–¹å¼</th>';      // â† æ–°å¢
    html += '<th>æ”¿æ²»é¢è²Œ</th>';
    html += '<th>å›°éš¾è®¤å®š</th>';
    html += '<th>é£é™©ç­‰çº§</th>';
    html += '<th>å¤„åˆ†è®°å½•</th>';
    html += '<th>å­¦ç±å¼‚åŠ¨</th>';
    html += '<th>çŠ¶æ€</th>';
    html += '</tr></thead>';
            
            // æ•°æ®è¡Œ
            html += '<tbody>';
            
            const existingIds = students.map(s => s.studentId);
            
            importPreviewData.forEach((student, index) => {
                const isDuplicate = existingIds.includes(student.studentId);
                const rowClass = isDuplicate ? 'invalid' : 'valid';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${student.studentId}</td>`;
                html += `<td>${student.name}</td>`;
                html += `<td>${student.className}</td>`;
                html += `<td>${student.dormitory || '-'}</td>`;
                html += `<td>${student.politicalStatus || '-'}</td>`;
                html += `<td>${student.hardship || '-'}</td>`;
                
                // é£é™©ç­‰çº§æ˜¾ç¤º
                let riskLevelDisplay = '';
                if (student.riskLevel === 'red') {
                    riskLevelDisplay = '<span style="color:#c62828;font-weight:bold;">çº¢è‰²é¢„è­¦</span>';
                } else if (student.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span style="color:#f57f17;font-weight:bold;">é»„è‰²å…³æ³¨</span>';
                } else {
                    riskLevelDisplay = '<span style="color:#2e7d32;">ç»¿è‰²æ­£å¸¸</span>';
                }
                
                // å¤„åˆ†è®°å½•æ˜¾ç¤º
                let punishmentsDisplay = '-';
                if (student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = '<span style="color:#c62828;font-weight:bold;">æœ‰</span>';
                }
                
                // å­¦ç±å¼‚åŠ¨æ˜¾ç¤º
                let statusChangeDisplay = student.statusChange || '-';
                
                html += `<td>${riskLevelDisplay}</td>`;
                html += `<td>${punishmentsDisplay}</td>`;
                html += `<td>${statusChangeDisplay}</td>`;
                html += `<td>${isDuplicate ? '<span style="color:#c62828;">é‡å¤</span>' : '<span style="color:#2e7d32;">æœ‰æ•ˆ</span>'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // æ·»åŠ æç¤ºä¿¡æ¯
            if (importData.length > 10) {
                html += `<p style="text-align:center;color:#666;margin-top:10px;">ä»…æ˜¾ç¤ºå‰10è¡Œæ•°æ®ï¼Œå…± ${importData.length} è¡Œæ•°æ®</p>`;
            }
            
            container.innerHTML = html;
        }
        
        function confirmImport() {
            const existingIds = students.map(s => s.studentId);
            let successCount = 0;
            let failCount = 0;
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('importProgress').style.display = 'block';
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // åˆ†æ‰¹å¯¼å…¥ï¼Œé¿å…UIé˜»å¡
            const batchSize = 50;
            const totalBatches = Math.ceil(importData.length / batchSize);
            let currentBatch = 0;
            
            function importBatch() {
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, importData.length);
                
                for (let i = start; i < end; i++) {
                    const student = importData[i];
                    
                    // æ£€æŸ¥æ˜¯å¦é‡å¤
                    if (!existingIds.includes(student.studentId)) {
                        students.push(student);
                        successCount++;
                    } else {
                        // æ›´æ–°ç°æœ‰å­¦ç”Ÿä¿¡æ¯
                        const existingIndex = students.findIndex(s => s.studentId === student.studentId);
                        if (existingIndex >= 0) {
                            students[existingIndex] = { ...students[existingIndex], ...student };
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                }
                
                // æ›´æ–°è¿›åº¦
                currentBatch++;
                const progress = Math.round((currentBatch / totalBatches) * 100);
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${progress}% (${currentBatch * batchSize}/${importData.length})`;
                
                if (currentBatch < totalBatches) {
                    // ç»§ç»­ä¸‹ä¸€æ‰¹
                    setTimeout(importBatch, 10);
                } else {
                    // å¯¼å…¥å®Œæˆ
                    localStorage.setItem('students', JSON.stringify(students));
                    
                    // æ›´æ–°å®Œæˆé¡µé¢
                    document.getElementById('successCount').textContent = successCount;
                    document.getElementById('failCount').textContent = failCount;
                    
                    // åˆ‡æ¢åˆ°å®Œæˆæ­¥éª¤
                    document.getElementById('previewStep').style.display = 'none';
                    document.getElementById('completeStep').style.display = 'block';
                    
                    // åˆ·æ–°å­¦ç”Ÿè¡¨æ ¼å’Œç»Ÿè®¡ä¿¡æ¯
                    loadStudentsTable();
                    updateStudentStats();
                    
                    showMessage(`æˆåŠŸå¯¼å…¥ ${successCount} æ¡å­¦ç”Ÿæ•°æ®`, 'success');
                }
            }
            
            // å¼€å§‹å¯¼å…¥
            importBatch();
        }
        
         // å­¦ç”Ÿæ•°æ®åº“ç®¡ç†
        function loadStudentsTable(searchTerm = '', riskLevel = '', politicalStatus = '', hardship = '') {
            const tbody = document.getElementById('studentsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // æ¸…ç©ºå…¨é€‰å¤é€‰æ¡†
            const selectAllCheckbox = document.getElementById('selectAllStudents');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            let filteredStudents = students;
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(student =>
                    student.name.includes(searchTerm) ||
                    student.studentId.includes(searchTerm) ||
                    student.className.includes(searchTerm)
                );
            }
            
            if (riskLevel) {
                filteredStudents = filteredStudents.filter(student => student.riskLevel === riskLevel);
            }
            
            if (politicalStatus) {
                filteredStudents = filteredStudents.filter(student => student.politicalStatus === politicalStatus);
            }
            
            if (hardship) {
                if (hardship === 'æ— ') {
                    filteredStudents = filteredStudents.filter(student => !student.hardship || student.hardship === 'æ— ');
                } else {
                    filteredStudents = filteredStudents.filter(student => student.hardship === hardship);
                }
            }
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px;">æš‚æ— å­¦ç”Ÿæ•°æ®</td></tr>';
                updateStudentStats(filteredStudents);
                updateBatchActionState();
                return;
            }
            
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
            const studentTalkCounts = {};
            talkRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            filteredStudents.forEach((student) => {
                const row = document.createElement('tr');
                
                // é£é™©ç­‰çº§æ˜¾ç¤º
                let riskLevelDisplay = '';
                if (student.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">çº¢è‰²é¢„è­¦</span>';
                } else if (student.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">é»„è‰²å…³æ³¨</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ç»¿è‰²æ­£å¸¸</span>';
                }
                
                // æ”¿æ²»é¢è²Œæ˜¾ç¤º
                let politicalDisplay = student.politicalStatus || '-';
                if (student.politicalStatus) {
                    politicalDisplay = `<span class="political-tag">${student.politicalStatus}</span>`;
                }
                
                // å›°éš¾è®¤å®šæ˜¾ç¤º
                let hardshipDisplay = student.hardship || '-';
                if (student.hardship && student.hardship !== 'æ— ') {
                    let hardshipClass = 'hardship-general';
                    if (student.hardship === 'ç‰¹åˆ«å›°éš¾') hardshipClass = 'hardship-severe';
                    else if (student.hardship === 'ä¸€èˆ¬å›°éš¾') hardshipClass = 'hardship-none';
                    hardshipDisplay = `<span class="hardship-tag ${hardshipClass}">${student.hardship}</span>`;
                }
                
                // å¤„åˆ†è®°å½•æ˜¾ç¤º
                let punishmentsDisplay = 'æ— ';
                if (student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = `<span class="punishment-tag punishment-yes">æœ‰å¤„åˆ†</span>`;
                }
                
                // å­¦ç±å¼‚åŠ¨æ˜¾ç¤º
                let statusChangeDisplay = 'æ— ';
                if (student.statusChange && student.statusChange !== 'æ— ') {
                    statusChangeDisplay = `<span class="status-change-tag status-change-yes">${student.statusChange}</span>`;
                }
                
                // è°ˆè¯æ¬¡æ•°æ˜¾ç¤º
                const talkCount = studentTalkCounts[student.studentId] || 0;
                let talkCountDisplay = talkCount.toString();
                
                // æ ¹æ®è°ˆè¯æ¬¡æ•°æ·»åŠ é¢‘ç‡æ ‡ç­¾
                if (talkCount >= 3) {
                    talkCountDisplay += ' <span class="frequency-badge frequency-high">é«˜é¢‘</span>';
                } else if (talkCount >= 2) {
                    talkCountDisplay += ' <span class="frequency-badge frequency-medium">ä¸­é¢‘</span>';
                } else if (talkCount === 0) {
                    talkCountDisplay += ' <span class="frequency-badge frequency-low">æ— è®°å½•</span>';
                }
                
                // å­¦ç”Ÿç…§ç‰‡æ˜¾ç¤º
                let photoDisplay = '<div class="photo-placeholder" style="width: 40px; height: 50px; font-size: 10px;">æ— </div>';
                if (student.photo) {
                    photoDisplay = `<img src="${student.photo}" class="student-photo-small" alt="${student.name}">`;
                }
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="student-checkbox" value="${student.studentId}" 
                               onchange="updateBatchActionState()">
                    </td>
                    <td>${photoDisplay}</td>
                    <td>${student.studentId}</td>
                    <td>
                        <div>${student.name}</div>
                        <div style="font-size: 11px; color: #666;">${student.gender || ''}</div>
                    </td>
                    <td>${student.className}</td>
                    <td>${student.dormitory || '-'}</td>
                    <td>${politicalDisplay}</td>
                    <td>${hardshipDisplay}</td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${statusChangeDisplay}</td>
                    <td>${talkCountDisplay}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="showStudentDetail('${student.studentId}')">æŸ¥çœ‹</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="editStudent('${student.studentId}')">ç¼–è¾‘</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;" onclick="deleteStudent('${student.studentId}')">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateBatchActionState();
            updateStudentStats(filteredStudents);
        }
        
        function searchStudents() {
            const searchTerm = document.getElementById('searchStudentsInput').value;
            const riskLevel = document.getElementById('riskLevelFilter').value;
            const politicalStatus = document.getElementById('politicalStatusFilter').value;
            const hardship = document.getElementById('hardshipFilter').value;
            loadStudentsTable(searchTerm, riskLevel, politicalStatus, hardship);
        }
        
        function clearStudentSearch() {
            document.getElementById('searchStudentsInput').value = '';
            document.getElementById('riskLevelFilter').value = '';
            document.getElementById('politicalStatusFilter').value = '';
            document.getElementById('hardshipFilter').value = '';
            loadStudentsTable();
        }
        
        function showAddStudentModal() {
            const modal = document.getElementById('studentModal');
            if (modal) {
                document.getElementById('modalTitle').textContent = 'æ·»åŠ å­¦ç”Ÿ';
                document.getElementById('modalEditMode').value = 'false';
                document.getElementById('modalOriginalStudentId').value = '';
                document.getElementById('studentForm').reset();
                
                // æ¸…ç©ºå¤„åˆ†è®°å½•
                document.getElementById('punishmentContainer').innerHTML = '';
                
                // æ¸…ç©ºç…§ç‰‡é¢„è§ˆ
                document.getElementById('photoPreviewContainer').innerHTML = '<div class="photo-placeholder">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div>';
                document.getElementById('modalStudentPhoto').value = '';
                
                modal.style.display = 'flex';
            }
        }
        
        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ·»åŠ å¤„åˆ†è®°å½•å­—æ®µ
        function addPunishmentField(punishment = '') {
            const container = document.getElementById('punishmentContainer');
            const div = document.createElement('div');
            div.className = 'punishment-input-group';
            div.innerHTML = `
                <input type="text" class="form-control" value="${punishment}" placeholder="è¯·è¾“å…¥å¤„åˆ†è®°å½•...">
                <button type="button" class="btn" style="padding: 5px 10px; background: #e74c3c;" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            container.appendChild(div);
        }
        
        // å¤„ç†å­¦ç”Ÿç…§ç‰‡ä¸Šä¼ 
        function handleStudentPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match('image.*')) {
                showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼', 'error');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
                showMessage('å›¾ç‰‡æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº2MBçš„å›¾ç‰‡ï¼', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreviewContainer = document.getElementById('photoPreviewContainer');
                photoPreviewContainer.innerHTML = `<img src="${e.target.result}" class="photo-preview" alt="å­¦ç”Ÿç…§ç‰‡">`;
                document.getElementById('modalStudentPhoto').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function saveStudent() {
            try {
                const isEditMode = document.getElementById('modalEditMode').value === 'true';
                const originalStudentId = document.getElementById('modalOriginalStudentId').value;
                
                const student = {
                    studentId: document.getElementById('modalStudentId').value,
                    name: document.getElementById('modalStudentName').value,
                    className: document.getElementById('modalClassName').value,
                    dormitory: document.getElementById('modalDormitory').value,
                    gender: document.getElementById('modalGender').value,
                    phone: document.getElementById('modalPhone').value,
idCard: document.getElementById('modalIdCard')?.value || '',
    contactPhone: document.getElementById('modalContactPhone')?.value || '',
    parentPhone: document.getElementById('modalParentPhone')?.value || '',
    hometown: document.getElementById('modalHometown')?.value || '',
                    politicalStatus: document.getElementById('modalPoliticalStatus').value,
                    hardship: document.getElementById('modalHardship').value,
                    statusChange: document.getElementById('modalStatusChange').value || '',
                    riskLevel: document.querySelector('input[name="modalRiskLevel"]:checked')?.value || 'green',
                    photo: document.getElementById('modalStudentPhoto').value,
                    generalRemark: document.getElementById('modalGeneralRemark')?.value || ''
                };
                
                // æ”¶é›†å¤„åˆ†è®°å½•
                const punishmentInputs = document.querySelectorAll('#punishmentContainer input');
                const punishments = [];
                punishmentInputs.forEach(input => {
                    if (input.value.trim()) {
                        punishments.push(input.value.trim());
                    }
                });
                
                if (punishments.length > 0) {
                    student.punishments = punishments;
                }
                
                // æ£€æŸ¥å¿…éœ€å­—æ®µ
                if (!student.studentId || !student.name || !student.className) {
                    showMessage('å­¦å·ã€å§“åå’Œç­çº§ä¸ºå¿…å¡«é¡¹', 'error');
                    return;
                }
                
                // æ£€æŸ¥å­¦å·æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¦‚æœæ˜¯æ·»åŠ æ¨¡å¼ï¼‰
                if (!isEditMode) {
                    const existingStudent = students.find(s => s.studentId === student.studentId);
                    if (existingStudent) {
                        showMessage('å­¦å·å·²å­˜åœ¨ï¼', 'error');
                        return;
                    }
                }
                
                if (isEditMode && originalStudentId !== student.studentId) {
                    // å¦‚æœå­¦å·è¢«ä¿®æ”¹ï¼Œæ£€æŸ¥æ–°å­¦å·æ˜¯å¦å·²å­˜åœ¨
                    const existingStudent = students.find(s => s.studentId === student.studentId && s.studentId !== originalStudentId);
                    if (existingStudent) {
                        showMessage('å­¦å·å·²å­˜åœ¨ï¼', 'error');
                        return;
                    }
                }
                
                if (isEditMode) {
                    // æ›´æ–°ç°æœ‰å­¦ç”Ÿ
                    const index = students.findIndex(s => s.studentId === originalStudentId);
                    if (index !== -1) {
                        students[index] = student;
                    }
                } else {
                    // æ·»åŠ æ–°å­¦ç”Ÿ
                    students.push(student);
                }
                
                localStorage.setItem('students', JSON.stringify(students));
                loadStudentsTable();
                closeStudentModal();
                showMessage('å­¦ç”Ÿä¿¡æ¯ä¿å­˜æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ä¿å­˜å­¦ç”Ÿä¿¡æ¯æ—¶å‡ºé”™ï¼š', error);
                showMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        function editStudent(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (student) {
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å­¦ç”Ÿ';
                document.getElementById('modalEditMode').value = 'true';
                document.getElementById('modalOriginalStudentId').value = student.studentId;
                document.getElementById('modalStudentId').value = student.studentId;
                document.getElementById('modalStudentName').value = student.name;
                document.getElementById('modalClassName').value = student.className;
                document.getElementById('modalDormitory').value = student.dormitory || '';
                document.getElementById('modalGender').value = student.gender || '';
                document.getElementById('modalPhone').value = student.phone || '';
                document.getElementById('modalPoliticalStatus').value = student.politicalStatus || '';
                document.getElementById('modalHardship').value = student.hardship || '';
                document.getElementById('modalStatusChange').value = student.statusChange || '';
                document.getElementById('modalGeneralRemark').value = student.generalRemark || '';
                document.getElementById('modalStudentPhoto').value = student.photo || '';
                  document.getElementById('modalIdCard').value = student.idCard || '';
        document.getElementById('modalContactPhone').value = student.contactPhone || '';
        document.getElementById('modalParentPhone').value = student.parentPhone || '';
        document.getElementById('modalHometown').value = student.hometown || '';
                // è®¾ç½®é£é™©ç­‰çº§
                const riskLevel = student.riskLevel || 'green';
                document.querySelector(`input[name="modalRiskLevel"][value="${riskLevel}"]`).checked = true;
                
                // è®¾ç½®å¤„åˆ†è®°å½•
                const punishmentContainer = document.getElementById('punishmentContainer');
                punishmentContainer.innerHTML = '';
                if (student.punishments && student.punishments.length > 0) {
                    student.punishments.forEach(punishment => {
                        addPunishmentField(punishment);
                    });
                }
                
                // è®¾ç½®ç…§ç‰‡é¢„è§ˆ
                const photoPreviewContainer = document.getElementById('photoPreviewContainer');
                if (student.photo) {
                    photoPreviewContainer.innerHTML = `<img src="${student.photo}" class="photo-preview" alt="å­¦ç”Ÿç…§ç‰‡">`;
                } else {
                    photoPreviewContainer.innerHTML = '<div class="photo-placeholder">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div>';
                }
                
                document.getElementById('studentModal').style.display = 'flex';
            }
        }
        
        // æ˜¾ç¤ºå­¦ç”Ÿè¯¦æƒ…
        function showStudentDetail(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (!student) return;
            
            // è·å–å­¦ç”Ÿçš„è°ˆè¯è®°å½•
            const studentTalks = talkRecords.filter(r => r.studentId === studentId);
            const talkCount = studentTalks.length;
            
            // è·å–æœ€è¿‘è°ˆè¯æ—¶é—´
            let lastTalk = 'æ— è®°å½•';
            if (studentTalks.length > 0) {
                const latestTalk = studentTalks.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime))[0];
                lastTalk = formatDate(latestTalk.talkTime);
            }
            
            // é£é™©ç­‰çº§æ˜¾ç¤º
            let riskLevelDisplay = '';
            if (student.riskLevel === 'red') {
                riskLevelDisplay = '<span class="risk-level red">çº¢è‰²é¢„è­¦</span>';
            } else if (student.riskLevel === 'yellow') {
                riskLevelDisplay = '<span class="risk-level yellow">é»„è‰²å…³æ³¨</span>';
            } else {
                riskLevelDisplay = '<span class="risk-level green">ç»¿è‰²æ­£å¸¸</span>';
            }
            
            // å¤„åˆ†è®°å½•æ˜¾ç¤º
            let punishmentsDisplay = 'æ— ';
            if (student.punishments && student.punishments.length > 0) {
                punishmentsDisplay = student.punishments.map(p => `<div class="punishment-record">${p}</div>`).join('');
            }
            
            // å›°éš¾è®¤å®šæ˜¾ç¤º
            let hardshipDisplay = student.hardship || 'æœªè®¤å®š';
            if (student.hardship && student.hardship !== 'æ— ') {
                let hardshipClass = 'hardship-general';
                if (student.hardship === 'ç‰¹åˆ«å›°éš¾') hardshipClass = 'hardship-severe';
                else if (student.hardship === 'ä¸€èˆ¬å›°éš¾') hardshipClass = 'hardship-none';
                hardshipDisplay = `<span class="hardship-tag ${hardshipClass}">${student.hardship}</span>`;
            }
            
            // å­¦ç±å¼‚åŠ¨æ˜¾ç¤º
            let statusChangeDisplay = student.statusChange || 'æ— ';
            if (student.statusChange && student.statusChange !== 'æ— ') {
                statusChangeDisplay = `<span class="status-change-tag status-change-yes">${student.statusChange}</span>`;
            }
            
            // ç…§ç‰‡æ˜¾ç¤º
            let photoDisplay = '<div class="photo-placeholder">æš‚æ— ç…§ç‰‡</div>';
            if (student.photo) {
                photoDisplay = `<img src="${student.photo}" class="photo-preview" alt="${student.name}">`;
            }
            
            const detailContent = `
                <div class="student-detail-grid">
                    <div class="student-photo-section">
                        ${photoDisplay}
                        <h4 style="margin-top: 10px;">${student.name}</h4>
                        <p style="font-size: 12px; color: #666;">${student.studentId}</p>
                    </div>
                    <div class="student-info-section">
                        <div class="student-detail-item">
                            <div class="student-detail-label">ç­çº§</div>
                            <div class="student-detail-value">${student.className}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">å®¿èˆ</div>
                            <div class="student-detail-value">${student.dormitory || 'æœªåˆ†é…'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">æ€§åˆ«</div>
                            <div class="student-detail-value">${student.gender || 'æœªå¡«å†™'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">è”ç³»ç”µè¯</div>
                            <div class="student-detail-value">${student.phone || 'æœªå¡«å†™'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">æ”¿æ²»é¢è²Œ</div>
                            <div class="student-detail-value">${student.politicalStatus || 'æœªå¡«å†™'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">å›°éš¾è®¤å®š</div>
                            <div class="student-detail-value">${hardshipDisplay}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">é£é™©ç­‰çº§</div>
                            <div class="student-detail-value">${riskLevelDisplay}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">å­¦ç±å¼‚åŠ¨</div>
                            <div class="student-detail-value">${statusChangeDisplay}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">è°ˆè¯æ¬¡æ•°</div>
                            <div class="student-detail-value">${talkCount}æ¬¡</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">æœ€è¿‘è°ˆè¯æ—¶é—´</div>
                            <div class="student-detail-value">${lastTalk}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">å¤„åˆ†è®°å½•</h4>
                    <div id="punishmentList">${punishmentsDisplay}</div>
                </div>
                
                ${student.generalRemark ? `
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">å¤‡æ³¨</h4>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${student.generalRemark}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('studentDetailContent').innerHTML = detailContent;
            document.getElementById('studentDetailModal').style.display = 'flex';
        }
        
        function closeStudentDetailModal() {
            document.getElementById('studentDetailModal').style.display = 'none';
        }
        
        function editStudentFromDetail() {
            const modal = document.getElementById('studentDetailModal');
            const studentId = document.querySelector('#studentDetailContent h4').textContent;
            const student = students.find(s => s.name === studentId);
            
            if (student) {
                closeStudentDetailModal();
                editStudent(student.studentId);
            }
        }
        
        function deleteStudent(studentId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦ç”Ÿå—ï¼Ÿåˆ é™¤åè¯¥å­¦ç”Ÿçš„æ‰€æœ‰è°ˆè¯è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼')) {
                // åˆ é™¤å­¦ç”Ÿ
                students = students.filter(s => s.studentId !== studentId);
                
                // åˆ é™¤è¯¥å­¦ç”Ÿçš„æ‰€æœ‰è°ˆè¯è®°å½•
                talkRecords = talkRecords.filter(r => r.studentId !== studentId);
                
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                loadStudentsTable();
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                
                showMessage('å­¦ç”ŸåŠç›¸å…³è®°å½•åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }
        
        function downloadExcelTemplate() {
            if (typeof XLSX === 'undefined') {
                showMessage('Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            const templateData = [
                ['å­¦å·', 'å§“å', 'ç­çº§', 'å®¿èˆ', 'æ€§åˆ«', 'è”ç³»ç”µè¯', 'æ”¿æ²»é¢è²Œ', 'å›°éš¾è®¤å®š', 'é£é™©ç­‰çº§', 'å¤„åˆ†è®°å½•', 'å­¦ç±å¼‚åŠ¨', 'å¤‡æ³¨'],
                ['20200101', 'å¼ ä¸‰', 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2001', 'æ¢…å›­1æ ‹302', 'ç”·', '13800138000', 'å…±é’å›¢å‘˜', 'ä¸€èˆ¬å›°éš¾', 'ç»¿è‰²æ­£å¸¸', 'æ— ', 'æ— ', 'ä¼˜ç§€å­¦ç”Ÿ'],
                ['20200102', 'æå››', 'è½¯ä»¶å·¥ç¨‹2001', 'æ¢…å›­2æ ‹401', 'å¥³', '13800138001', 'ä¸­å…±å…šå‘˜', 'ç‰¹åˆ«å›°éš¾', 'é»„è‰²å…³æ³¨', 'è­¦å‘Šå¤„åˆ†', 'æ— ', 'éœ€è¦å…³æ³¨å­¦ä¹ æƒ…å†µ'],
                ['20200103', 'ç‹äº”', 'ç½‘ç»œå·¥ç¨‹2001', 'ç«¹å›­3æ ‹201', 'ç”·', '13800138002', 'ç¾¤ä¼—', 'æ— ', 'çº¢è‰²é¢„è­¦', 'ä¸¥é‡è­¦å‘Šå¤„åˆ†;è®°è¿‡å¤„åˆ†', 'ä¼‘å­¦ä¸€å­¦æœŸ', 'é‡ç‚¹å…³æ³¨å¯¹è±¡'],
                ['20200104', 'èµµå…­', 'äººå·¥æ™ºèƒ½2001', 'å…°å›­4æ ‹101', 'å¥³', '13800138003', 'å…±é’å›¢å‘˜', 'å›°éš¾', 'ç»¿è‰²æ­£å¸¸', 'æ— ', 'è½¬ä¸“ä¸š', ''],
                ['20200105', 'é’±ä¸ƒ', 'æ•°æ®ç§‘å­¦2001', 'èŠå›­5æ ‹202', 'ç”·', '13800138004', 'ä¸­å…±é¢„å¤‡å…šå‘˜', 'ä¸€èˆ¬å›°éš¾', 'ç»¿è‰²æ­£å¸¸', 'æ— ', 'å¤å­¦', 'ç­å¹²éƒ¨']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å­¦ç”Ÿæ•°æ®');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å­¦ç”Ÿæ•°æ®å¯¼å…¥æ¨¡æ¿.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼', 'success');
        }
        
        function exportStudentsToExcel() {
            if (typeof XLSX === 'undefined') {
                showMessage('Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            if (students.length === 0) {
                showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„å­¦ç”Ÿæ•°æ®ï¼', 'error');
                return;
            }
            
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
            const studentTalkCounts = {};
            talkRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            const exportData = [
                ['å­¦å·', 'å§“å', 'ç­çº§', 'å®¿èˆ', 'æ€§åˆ«', 'è”ç³»ç”µè¯', 'æ”¿æ²»é¢è²Œ', 'å›°éš¾è®¤å®š', 'é£é™©ç­‰çº§', 'å¤„åˆ†è®°å½•', 'å­¦ç±å¼‚åŠ¨', 'è°ˆè¯æ¬¡æ•°', 'å¤‡æ³¨']
            ];
            
            students.forEach(student => {
                // è½¬æ¢é£é™©ç­‰çº§ä¸ºä¸­æ–‡
                let riskLevelText = 'ç»¿è‰²æ­£å¸¸';
                if (student.riskLevel === 'red') {
                    riskLevelText = 'çº¢è‰²é¢„è­¦';
                } else if (student.riskLevel === 'yellow') {
                    riskLevelText = 'é»„è‰²å…³æ³¨';
                } else {
                    riskLevelText = 'ç»¿è‰²æ­£å¸¸';
                }
                
                const talkCount = studentTalkCounts[student.studentId] || 0;
                const punishments = student.punishments ? student.punishments.join('ï¼›') : 'æ— ';
                const statusChange = student.statusChange || 'æ— ';
                
                exportData.push([
                    student.studentId,
                    student.name,
                    student.className,
                    student.dormitory || '',
                    student.gender || '',
                    student.phone || '',
                    student.politicalStatus || '',
                    student.hardship || '',
                    riskLevelText,
                    punishments,
                    statusChange,
                    talkCount,
                    student.generalRemark || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å­¦ç”Ÿæ•°æ®');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å­¦ç”Ÿæ•°æ®åº“_${date}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`å­¦ç”Ÿæ•°æ®å¯¼å‡ºæˆåŠŸï¼Œå…±å¯¼å‡º ${students.length} æ¡è®°å½•`, 'success');
        }
        
        // å†å²è®°å½•ç®¡ç†
        function loadTalkRecords(filters = {}) {
            const tbody = document.getElementById('recordsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ä»localStorageé‡æ–°åŠ è½½æ•°æ®
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            console.log('åŠ è½½è°ˆè¯è®°å½•ï¼Œæ€»æ•°:', talkRecords.length);
            
            let filteredRecords = talkRecords;
            
            // åº”ç”¨æ—¶é—´ç­›é€‰å™¨
            if (currentTimeFilter !== 'all') {
                const timeRange = getTimeFilterRange(currentTimeFilter);
                if (timeRange.dateFrom) {
                    filteredRecords = filteredRecords.filter(record =>
                        new Date(record.talkTime) >= timeRange.dateFrom
                    );
                }
            }
            
            if (filters.search) {
                filteredRecords = filteredRecords.filter(record =>
                    record.studentName.includes(filters.search) ||
                    (record.studentId && record.studentId.includes(filters.search)) ||
                    record.className.includes(filters.search)
                );
            }
            
            if (filters.riskLevel) {
                filteredRecords = filteredRecords.filter(record =>
                    record.riskLevel === filters.riskLevel
                );
            }
            
            if (filters.dateFrom) {
                filteredRecords = filteredRecords.filter(record =>
                    new Date(record.talkTime) >= new Date(filters.dateFrom)
                );
            }
            
            if (filters.dateTo) {
                filteredRecords = filteredRecords.filter(record =>
                    new Date(record.talkTime) <= new Date(filters.dateTo + 'T23:59:59')
                );
            }
            
            filteredRecords.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime));
            
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
            const studentTalkCounts = {};
            filteredRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">æš‚æ— è°ˆè¯è®°å½•</td></tr>';
                return;
            }
            
            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // é£é™©ç­‰çº§æ˜¾ç¤º
                let riskLevelDisplay = '';
                if (record.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">çº¢è‰²é¢„è­¦</span>';
                } else if (record.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">é»„è‰²å…³æ³¨</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ç»¿è‰²æ­£å¸¸</span>';
                }
                
                // è·å–å­¦ç”Ÿä¿¡æ¯
                const student = students.find(s => s.studentId === record.studentId);
                
                // å¤„åˆ†è®°å½•æ˜¾ç¤º
                let punishmentsDisplay = 'æ— ';
                if (student && student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = `<span class="punishment-tag punishment-yes">æœ‰å¤„åˆ†</span>`;
                }
                
                // å­¦ç±å¼‚åŠ¨æ˜¾ç¤º
                let statusChangeDisplay = 'æ— ';
                if (student && student.statusChange && student.statusChange !== 'æ— ') {
                    statusChangeDisplay = `<span class="status-change-tag status-change-yes">${student.statusChange}</span>`;
                }
                
                // è°ˆè¯æ¬¡æ•°
                const talkCount = studentTalkCounts[record.studentId] || 0;
                let talkCountDisplay = talkCount.toString();
                
                // æ ¹æ®è°ˆè¯æ¬¡æ•°æ·»åŠ æ ·å¼
                if (talkCount >= 3) {
                    talkCountDisplay = `<strong style="color:#c62828;">${talkCount}</strong>`;
                } else if (talkCount >= 2) {
                    talkCountDisplay = `<strong style="color:#f57f17;">${talkCount}</strong>`;
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="talk-checkbox" value="${record.id}" onchange="updateBatchTalkActionState()"></td>
                    <td>${formatDate(record.talkTime)}</td>
                    <td>${record.studentName}</td>
                    <td>${record.className}</td>
                    <td>${record.topics.join(', ')}</td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${statusChangeDisplay}</td>
                    <td>${talkCountDisplay}</td>
                    <td>
                        <button class="edit-record-btn" onclick="editTalkRecord(${record.id})">ç¼–è¾‘</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #3498db;" onclick="showDocPreview(${record.id})">å¯¼å‡ºDOC</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;" onclick="deleteTalkRecord(${record.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ›´æ–°æ‰¹é‡æ“ä½œçŠ¶æ€
            updateBatchTalkActionState();
        }
        
        function searchTalkRecords() {
            const filters = {
                search: document.getElementById('recordSearch').value,
                riskLevel: document.getElementById('riskLevelFilterHistory').value,
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value
            };
            loadTalkRecords(filters);
        }
        
        function clearSearch() {
            document.getElementById('recordSearch').value = '';
            document.getElementById('riskLevelFilterHistory').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            currentTimeFilter = 'all';
            
            // é‡ç½®æ—¶é—´ç­›é€‰æŒ‰é’®
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.time-filter-btn').classList.add('active');
            
            loadTalkRecords();
        }
        
        function editTalkRecord(recordId) {
            // åˆ‡æ¢åˆ°è®°å½•é¡µé¢å¹¶åŠ è½½è®°å½•
            switchTab('record');
            loadTalkRecordForEdit(recordId);
        }
        
        function deleteTalkRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è°ˆè¯è®°å½•å—ï¼Ÿ')) {
                talkRecords = talkRecords.filter(r => r.id !== id);
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                showMessage('è®°å½•åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }
        
        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function loadExportList() {
            const tbody = document.getElementById('exportList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ä»localStorageé‡æ–°åŠ è½½æ•°æ®
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedRecords = [...talkRecords].sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime));
            
            // ç»Ÿè®¡å¯¼å‡ºæ•°æ®
            const totalCount = sortedRecords.length;
            const redCount = sortedRecords.filter(r => r.riskLevel === 'red').length;
            const yellowCount = sortedRecords.filter(r => r.riskLevel === 'yellow').length;
            const greenCount = sortedRecords.filter(r => r.riskLevel === 'green').length;
            
            // æ›´æ–°å¯¼å‡ºç»Ÿè®¡
            document.getElementById('totalExportCount').textContent = totalCount;
            document.getElementById('exportRedCount').textContent = redCount;
            document.getElementById('exportYellowCount').textContent = yellowCount;
            document.getElementById('exportGreenCount').textContent = greenCount;
            
            // ç»Ÿè®¡æ¯ä¸ªå­¦ç”Ÿçš„è°ˆè¯æ¬¡æ•°
            const studentTalkCounts = {};
            sortedRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            if (sortedRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">æš‚æ— è°ˆè¯è®°å½•</td></tr>';
                return;
            }
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // é£é™©ç­‰çº§æ˜¾ç¤º
                let riskLevelDisplay = '';
                if (record.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">çº¢è‰²é¢„è­¦</span>';
                } else if (record.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">é»„è‰²å…³æ³¨</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ç»¿è‰²æ­£å¸¸</span>';
                }
                
                // è·å–å­¦ç”Ÿä¿¡æ¯
                const student = students.find(s => s.studentId === record.studentId);
                
                // å¤„åˆ†è®°å½•æ˜¾ç¤º
                let punishmentsDisplay = 'æ— ';
                if (student && student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = 'æœ‰å¤„åˆ†';
                }
                
                // è°ˆè¯æ¬¡æ•°
                const talkCount = studentTalkCounts[record.studentId] || 0;
                
                row.innerHTML = `
                    <td><input type="checkbox" value="${record.id}" class="export-checkbox"></td>
                    <td>${formatDate(record.talkTime)}</td>
                    <td>${record.studentName}</td>
                    <td>${record.className}</td>
                    <td>${record.topics.join(', ')}</td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${talkCount}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function refreshExportList() {
            loadExportList();
            showMessage('å¯¼å‡ºåˆ—è¡¨å·²åˆ·æ–°', 'success');
        }
        
        function toggleSelectAllExport(checkbox) {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        function exportData() {
            // ä»localStorageé‡æ–°åŠ è½½æ•°æ®
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            if (talkRecords.length === 0) {
                showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•ï¼', 'error');
                return;
            }
            
            const exportFormat = document.getElementById('exportFormat').value;
            const exportRange = document.getElementById('exportRange').value;
            
            let recordsToExport = [];
            
            if (exportRange === 'all') {
                recordsToExport = talkRecords;
            } else if (exportRange === 'selected') {
                const checkboxes = document.querySelectorAll('.export-checkbox:checked');
                if (checkboxes.length === 0) {
                    showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡è®°å½•ï¼', 'error');
                    return;
                }
                
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                recordsToExport = talkRecords.filter(record => selectedIds.includes(record.id));
            } else if (exportRange === 'month') {
                const monthAgo = new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000);
                recordsToExport = talkRecords.filter(record => {
                    return new Date(record.talkTime) >= monthAgo;
                });
            } else if (exportRange === 'quarter') {
                const quarterAgo = new Date(new Date().getTime() - 90 * 24 * 60 * 60 * 1000);
                recordsToExport = talkRecords.filter(record => {
                    return new Date(record.talkTime) >= quarterAgo;
                });
            }
            
            if (recordsToExport.length === 0) {
                showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•ï¼', 'error');
                return;
            }
            
            showMessage(`å¼€å§‹å¯¼å‡º ${recordsToExport.length} æ¡è®°å½•...`, 'info');
            
            try {
                if (exportFormat === 'excel') {
                    exportToExcel(recordsToExport);
                } else if (exportFormat === 'word') {
                    // Wordæ ¼å¼åªæ”¯æŒå•æ¡è®°å½•å¯¼å‡º
                    if (recordsToExport.length > 1) {
                        showMessage('Wordæ ¼å¼åªæ”¯æŒå•æ¡è®°å½•å¯¼å‡ºï¼Œè¯·åªé€‰æ‹©ä¸€æ¡è®°å½•ï¼', 'error');
                        return;
                    }
                    showDocPreview(recordsToExport[0].id);
                } else if (exportFormat === 'analysis') {
                    exportAnalysisReport();
                }
            } catch (error) {
                showMessage('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
                console.error('å¯¼å‡ºé”™è¯¯ï¼š', error);
            }
        }
        
        // å¯¼å‡ºåˆ°Excelæ–‡ä»¶
        function exportToExcel(records) {
            if (typeof XLSX === 'undefined') {
                showMessage('Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            const exportData = [
                ['åºå·', 'è°ˆè¯æ—¶é—´', 'å­¦ç”Ÿå§“å', 'å­¦å·', 'ç­çº§', 'å®¿èˆ', 'è°ˆè¯åœ°ç‚¹', 
                 'è°ˆè¯ä¸»é¢˜', 'é£é™©ç­‰çº§', 'å­¦ç”ŸèƒŒæ™¯', 'è°ˆè¯ç›®çš„', 'å­¦ç”Ÿè‡ªè¿°', 'è°ˆè¯è¦ç‚¹', 
                 'è°ˆè¯åé¦ˆ', 'åç»­è·Ÿè¿›è®¡åˆ’', 'å¤‡æ³¨', 'å­¦ç”Ÿç­¾å', 'è¾…å¯¼å‘˜ç­¾å', 'è®°å½•æ—¶é—´']
            ];
            
            records.forEach((record, index) => {
                const riskLevelText = getRiskLevelText(record.riskLevel);
                
                exportData.push([
                    index + 1,
                    formatDate(record.talkTime),
                    record.studentName,
                    record.studentId || '',
                    record.className,
                    record.dormitory,
                    record.talkLocation,
                    record.topics.join('ã€'),
                    riskLevelText,
                    record.studentBackground,
                    record.talkPurpose,
                    record.studentStatement,
                    record.talkPoints,
                    record.talkFeedback,
                    record.followUpPlan || '',
                    record.generalRemark || '',
                    record.studentSignature || '',
                    record.counselorSignature || '',
                    formatDate(record.createTime)
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è°ˆè¯è®°å½•');
            
            // è®¾ç½®åˆ—å®½
            const wscols = [
                {wch: 8},   // åºå·
                {wch: 20},  // è°ˆè¯æ—¶é—´
                {wch: 10},  // å­¦ç”Ÿå§“å
                {wch: 12},  // å­¦å·
                {wch: 20},  // ç­çº§
                {wch: 10},  // å®¿èˆ
                {wch: 15},  // è°ˆè¯åœ°ç‚¹
                {wch: 25},  // è°ˆè¯ä¸»é¢˜
                {wch: 12},  // é£é™©ç­‰çº§
                {wch: 30},  // å­¦ç”ŸèƒŒæ™¯
                {wch: 30},  // è°ˆè¯ç›®çš„
                {wch: 30},  // å­¦ç”Ÿè‡ªè¿°
                {wch: 30},  // è°ˆè¯è¦ç‚¹
                {wch: 30},  // è°ˆè¯åé¦ˆ
                {wch: 30},  // åç»­è·Ÿè¿›è®¡åˆ’
                {wch: 20},  // å¤‡æ³¨
                {wch: 15},  // å­¦ç”Ÿç­¾å
                {wch: 15},  // è¾…å¯¼å‘˜ç­¾å
                {wch: 20}   // è®°å½•æ—¶é—´
            ];
            ws['!cols'] = wscols;
            
            // ç”Ÿæˆæ–‡ä»¶
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // ä½¿ç”¨æ–°çš„å‘½åæ–¹å¼ï¼šå§“å_ç­çº§_è°ˆè¯è®°å½•.xlsx
            // å¦‚æœæœ‰å¤šæ¡è®°å½•ï¼Œä½¿ç”¨ç¬¬ä¸€æ¡è®°å½•çš„å­¦ç”Ÿä¿¡æ¯
            let fileName = 'è°ˆå¿ƒè°ˆè¯è®°å½•';
            if (records.length > 0) {
                const studentName = records[0].studentName;
                const className = records[0].className;
                fileName = `${studentName}_${className}_è°ˆå¿ƒè°ˆè¯è®°å½•`;
                
                // å¦‚æœæœ‰å¤šæ¡è®°å½•ï¼Œæ·»åŠ "ç­‰"å­—
                if (records.length > 1) {
                    fileName = `${studentName}ç­‰${records.length}äºº_è°ˆå¿ƒè°ˆè¯è®°å½•`;
                }
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼', 'success');
        }
        
        // è·å–é£é™©ç­‰çº§æ–‡æœ¬
        function getRiskLevelText(riskLevel) {
            switch(riskLevel) {
                case 'red': return 'çº¢è‰²é¢„è­¦';
                case 'yellow': return 'é»„è‰²å…³æ³¨';
                case 'green': return 'ç»¿è‰²æ­£å¸¸';
                default: return 'æœªåˆ†çº§';
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                return dateString;
            }
        }
        
        // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
        function initSampleData() {
            console.log('åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®...');
            
            // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œåˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
            if (students.length === 0) {
                console.log('åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®...');
                students = [
                    {
                        studentId: '20200101',
                        name: 'å¼ ä¸‰',
                        className: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2001',
                        dormitory: 'æ¢…å›­1æ ‹302',
                        gender: 'ç”·',
                        phone: '13800138000',
                        politicalStatus: 'å…±é’å›¢å‘˜',
                        hardship: 'ä¸€èˆ¬å›°éš¾',
                        riskLevel: 'green',
                        punishments: [],
                        statusChange: 'æ— ',
                        generalRemark: 'ä¼˜ç§€å­¦ç”Ÿ'
                    },
                    {
                        studentId: '20200102',
                        name: 'æå››',
                        className: 'è½¯ä»¶å·¥ç¨‹2001',
                        dormitory: 'æ¢…å›­2æ ‹401',
                        gender: 'å¥³',
                        phone: '13800138001',
                        politicalStatus: 'ä¸­å…±å…šå‘˜',
                        hardship: 'ç‰¹åˆ«å›°éš¾',
                        riskLevel: 'yellow',
                        punishments: ['è­¦å‘Šå¤„åˆ†'],
                        statusChange: 'æ— ',
                        generalRemark: 'éœ€è¦å…³æ³¨å­¦ä¹ æƒ…å†µ'
                    },
                    {
                        studentId: '20200103',
                        name: 'ç‹äº”',
                        className: 'ç½‘ç»œå·¥ç¨‹2001',
                        dormitory: 'ç«¹å›­3æ ‹201',
                        gender: 'ç”·',
                        phone: '13800138002',
                        politicalStatus: 'ç¾¤ä¼—',
                        hardship: 'æ— ',
                        riskLevel: 'red',
                        punishments: ['ä¸¥é‡è­¦å‘Šå¤„åˆ†', 'è®°è¿‡å¤„åˆ†'],
                        statusChange: 'ä¼‘å­¦ä¸€å­¦æœŸ',
                        generalRemark: 'é‡ç‚¹å…³æ³¨å¯¹è±¡'
                    },
                    {
                        studentId: '20200104',
                        name: 'èµµå…­',
                        className: 'äººå·¥æ™ºèƒ½2001',
                        dormitory: 'å…°å›­4æ ‹101',
                        gender: 'å¥³',
                        phone: '13800138003',
                        politicalStatus: 'å…±é’å›¢å‘˜',
                        hardship: 'å›°éš¾',
                        riskLevel: 'green',
                        punishments: [],
                        statusChange: 'è½¬ä¸“ä¸š',
                        generalRemark: 'å­¦ä¹ å§”å‘˜'
                    },
                    {
                        studentId: '20200105',
                        name: 'é’±ä¸ƒ',
                        className: 'æ•°æ®ç§‘å­¦2001',
                        dormitory: 'èŠå›­5æ ‹202',
                        gender: 'ç”·',
                        phone: '13800138004',
                        politicalStatus: 'ä¸­å…±é¢„å¤‡å…šå‘˜',
                        hardship: 'ä¸€èˆ¬å›°éš¾',
                        riskLevel: 'green',
                        punishments: [],
                        statusChange: 'å¤å­¦',
                        generalRemark: 'ç­å¹²éƒ¨'
                    }
                ];
                localStorage.setItem('students', JSON.stringify(students));
                console.log('å­¦ç”Ÿæ•°æ®å·²ä¿å­˜');
            }
            
            // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰è°ˆè¯è®°å½•ï¼Œåˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
            if (talkRecords.length === 0) {
                console.log('åˆå§‹åŒ–è°ˆè¯è®°å½•æ•°æ®...');
                
                // åˆ›å»ºç¤ºä¾‹è°ˆè¯è®°å½•
                const sampleRecords = [
                    {
                        id: Date.now(),
                        studentId: '20200101',
                        studentName: 'å¼ ä¸‰',
                        className: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2001',
                        dormitory: 'æ¢…å›­1æ ‹302',
                        talkTime: new Date('2024-01-15T10:30:00').toISOString().slice(0, 16),
                        talkLocation: 'è¾…å¯¼å‘˜åŠå…¬å®¤',
                        topics: ['å­¦ä¸š', 'å°±ä¸š'],
                        studentBackground: 'å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ï¼šå¼ ä¸‰ï¼Œè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯2001ç­ï¼Œå®¿èˆæ¢…å›­1æ ‹302ã€‚æˆç»©ä¼˜ç§€ï¼Œç§¯æå‚ä¸ç¤¾å›¢æ´»åŠ¨ã€‚',
                        talkPurpose: 'äº†è§£å­¦ç”Ÿè¿‘æœŸå­¦ä¹ æƒ…å†µå’Œå°±ä¸šè§„åˆ’',
                        studentStatement: 'æœ€è¿‘å­¦ä¹ å‹åŠ›è¾ƒå¤§ï¼Œå¯¹æœªæ¥çš„å°±ä¸šæ–¹å‘æ„Ÿåˆ°è¿·èŒ«ï¼Œå¸Œæœ›å¾—åˆ°æŒ‡å¯¼ã€‚',
                        talkPoints: '1. åˆ†æäº†å½“å‰çš„å­¦ä¹ æƒ…å†µï¼›2. è®¨è®ºäº†å°±ä¸šæ–¹å‘é€‰æ‹©ï¼›3. åˆ¶å®šäº†å­¦ä¹ è®¡åˆ’ï¼›4. å»ºè®®å‚åŠ å®ä¹ ç§¯ç´¯ç»éªŒã€‚',
                        talkFeedback: 'å­¦ç”Ÿè¡¨ç¤ºä¼šè°ƒæ•´å­¦ä¹ çŠ¶æ€ï¼Œç§¯æå‡†å¤‡å°±ä¸šï¼Œå¯¹è°ˆè¯è¡¨ç¤ºæ„Ÿè°¢ã€‚',
                        riskLevel: 'green',
                        followUpPlan: 'ä¸€ä¸ªæœˆåè·Ÿè¿›å°±ä¸šå‡†å¤‡æƒ…å†µ',
                        generalRemark: 'å­¦ç”Ÿæ€åº¦ç§¯æï¼Œéœ€è¦å®šæœŸè·Ÿè¿›å°±ä¸šè¿›å±•ã€‚',
                        studentSignature: 'å¼ ä¸‰',
                        counselorSignature: 'é™ˆ',
                        createTime: new Date('2024-01-15T10:30:00').toISOString(),
                        updateTime: new Date('2024-01-15T10:30:00').toISOString()
                    },
                    {
                        id: Date.now() + 1,
                        studentId: '20200102',
                        studentName: 'æå››',
                        className: 'è½¯ä»¶å·¥ç¨‹2001',
                        dormitory: 'æ¢…å›­2æ ‹401',
                        talkTime: new Date('2024-02-20T14:00:00').toISOString().slice(0, 16),
                        talkLocation: 'å¿ƒç†å’¨è¯¢å®¤',
                        topics: ['æƒ…ç»ª/å¥åº·', 'äººé™…å…³ç³»'],
                        studentBackground: 'å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ï¼šæå››ï¼Œè½¯ä»¶å·¥ç¨‹2001ç­ï¼Œå®¿èˆæ¢…å›­2æ ‹401ã€‚å®¶åº­ç»æµå›°éš¾ï¼Œæ€§æ ¼å†…å‘ã€‚',
                        talkPurpose: 'äº†è§£å­¦ç”Ÿè¿‘æœŸæƒ…ç»ªçŠ¶æ€å’Œäººé™…å…³ç³»',
                        studentStatement: 'æœ€è¿‘æ„Ÿåˆ°ç„¦è™‘ï¼Œä¸å®¤å‹å…³ç³»ç´§å¼ ï¼Œç¡çœ è´¨é‡ä¸‹é™ã€‚',
                        talkPoints: '1. å€¾å¬å­¦ç”Ÿæƒ…ç»ªè¡¨è¾¾ï¼›2. åˆ†æäº†äººé™…å…³ç³»é—®é¢˜ï¼›3. æä¾›äº†æƒ…ç»ªè°ƒèŠ‚æ–¹æ³•ï¼›4. å»ºè®®å‚åŠ å¿ƒç†è¾…å¯¼ã€‚',
                        talkFeedback: 'å­¦ç”Ÿæƒ…ç»ªæœ‰æ‰€ç¼“è§£ï¼Œæ„¿æ„å°è¯•æ”¹å–„äººé™…å…³ç³»ã€‚',
                        riskLevel: 'yellow',
                        followUpPlan: 'ä¸¤å‘¨åè·Ÿè¿›æƒ…ç»ªçŠ¶æ€',
                        generalRemark: 'éœ€è¦æŒç»­å…³æ³¨å­¦ç”Ÿæƒ…ç»ªå˜åŒ–ã€‚',
                        studentSignature: 'æå››',
                        counselorSignature: 'é™ˆ',
                        createTime: new Date('2024-02-20T14:00:00').toISOString(),
                        updateTime: new Date('2024-02-20T14:00:00').toISOString()
                    },
                    {
                        id: Date.now() + 2,
                        studentId: '20200103',
                        studentName: 'ç‹äº”',
                        className: 'ç½‘ç»œå·¥ç¨‹2001',
                        dormitory: 'ç«¹å›­3æ ‹201',
                        talkTime: new Date('2024-03-10T09:00:00').toISOString().slice(0, 16),
                        talkLocation: 'è¾…å¯¼å‘˜åŠå…¬å®¤',
                        topics: ['è­¦ç¤ºæ•™è‚²', 'é€‚åº”æ€§'],
                        studentBackground: 'å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ï¼šç‹äº”ï¼Œç½‘ç»œå·¥ç¨‹2001ç­ï¼Œå®¿èˆç«¹å›­3æ ‹201ã€‚æœ‰å¤„åˆ†è®°å½•ï¼Œå­¦ä¹ æ€åº¦æ¶ˆæã€‚',
                        talkPurpose: 'è¿›è¡Œè­¦ç¤ºæ•™è‚²ï¼Œäº†è§£å­¦ç”Ÿè¿‘æœŸè¡¨ç°',
                        studentStatement: 'æ‰¿è®¤ä¹‹å‰çš„è¡Œä¸ºä¸å½“ï¼Œä½†ç°åœ¨å·²ç»æ”¹æ­£ï¼Œå¸Œæœ›æœ‰æœºä¼šè¯æ˜è‡ªå·±ã€‚',
                        talkPoints: '1. å¼ºè°ƒäº†æ ¡çºªæ ¡è§„ï¼›2. äº†è§£äº†å­¦ç”Ÿè¿‘æœŸè¡¨ç°ï¼›3. é¼“åŠ±å­¦ç”Ÿç§¯ææ”¹æ­£ï¼›4. åˆ¶å®šäº†æ”¹è¿›è®¡åˆ’ã€‚',
                        talkFeedback: 'å­¦ç”Ÿæ€åº¦è¯šæ³ï¼Œè¡¨ç¤ºä¼šåŠªåŠ›æ”¹æ­£ã€‚',
                        riskLevel: 'red',
                        followUpPlan: 'æ¯å‘¨è·Ÿè¿›å­¦ç”Ÿè¡¨ç°',
                        generalRemark: 'é«˜é£é™©å­¦ç”Ÿï¼Œéœ€è¦é‡ç‚¹ç›‘æ§ã€‚',
                        studentSignature: 'ç‹äº”',
                        counselorSignature: 'é™ˆ',
                        createTime: new Date('2024-03-10T09:00:00').toISOString(),
                        updateTime: new Date('2024-03-10T09:00:00').toISOString()
                    },
                    {
                        id: Date.now() + 3,
                        studentId: '20200104',
                        studentName: 'èµµå…­',
                        className: 'äººå·¥æ™ºèƒ½2001',
                        dormitory: 'å…°å›­4æ ‹101',
                        talkTime: new Date('2024-03-25T15:30:00').toISOString().slice(0, 16),
                        talkLocation: 'å­¦ç”Ÿæ´»åŠ¨ä¸­å¿ƒ',
                        topics: ['å­¦ä¸š', 'å®¶åº­'],
                        studentBackground: 'å­¦ç”ŸåŸºæœ¬ä¿¡æ¯ï¼šèµµå…­ï¼Œäººå·¥æ™ºèƒ½2001ç­ï¼Œå®¿èˆå…°å›­4æ ‹101ã€‚å­¦ä¹ å§”å‘˜ï¼Œå®¶åº­ç»æµå›°éš¾ã€‚',
                        talkPurpose: 'äº†è§£å­¦ç”Ÿå­¦ä¹ æƒ…å†µå’Œå®¶åº­çŠ¶å†µ',
                        studentStatement: 'å­¦ä¹ æˆç»©ç¨³å®šï¼Œä½†å®¶åº­ç»æµå‹åŠ›å¤§ï¼Œæ‹…å¿ƒå½±å“åç»­å­¦ä¹ ã€‚',
                        talkPoints: '1. äº†è§£äº†å­¦ç”Ÿå­¦ä¹ æƒ…å†µï¼›2. è®¨è®ºäº†å®¶åº­ç»æµå›°éš¾ï¼›3. ä»‹ç»äº†å­¦æ ¡èµ„åŠ©æ”¿ç­–ï¼›4. æä¾›äº†å­¦ä¹ å»ºè®®ã€‚',
                        talkFeedback: 'å­¦ç”Ÿäº†è§£äº†èµ„åŠ©æ”¿ç­–ï¼Œæƒ…ç»ªç¨³å®šã€‚',
                        riskLevel: 'green',
                        followUpPlan: 'ååŠ©ç”³è¯·èµ„åŠ©',
                        generalRemark: 'ä¼˜ç§€å­¦ç”Ÿï¼Œéœ€è¦å…³æ³¨å®¶åº­ç»æµçŠ¶å†µã€‚',
                        studentSignature: 'èµµå…­',
                        counselorSignature: 'é™ˆ',
                        createTime: new Date('2024-03-25T15:30:00').toISOString(),
                        updateTime: new Date('2024-03-25T15:30:00').toISOString()
                    }
                ];
                
                sampleRecords.forEach(record => {
                    talkRecords.push(record);
                });
                
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                console.log('è°ˆè¯è®°å½•å·²ä¿å­˜');
            }
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œå­¦ç”Ÿæ•°:', students.length, 'ï¼Œè®°å½•æ•°:', talkRecords.length);
        }
// ========== ä¿®å¤å­¦ç”Ÿè¡¨æ ¼æ˜¾ç¤º ==========
// æ–°çš„è¡¨æ ¼æ˜¾ç¤ºå‡½æ•°
function loadStudentsTable(searchTerm = '', riskFilter = '', politicalFilter = '', hardshipFilter = '') {
    const tbody = document.getElementById('studentsList');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let filteredStudents = [...students];
    
    // æœç´¢è¿‡æ»¤
    if (searchTerm) {
        filteredStudents = filteredStudents.filter(student =>
            student.name.includes(searchTerm) ||
            student.studentId.includes(searchTerm)
        );
    }
    
    // é£é™©ç­‰çº§è¿‡æ»¤
    if (riskFilter) {
        filteredStudents = filteredStudents.filter(student => 
            student.riskLevel === riskFilter
        );
    }
    
    if (filteredStudents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="17" style="text-align: center; padding: 20px;">æš‚æ— å­¦ç”Ÿæ•°æ®</td></tr>';
        return;
    }
    
    filteredStudents.forEach((student) => {
        const row = document.createElement('tr');
        
        // è°ˆè¯æ¬¡æ•°
        const talkCount = talkRecords.filter(record => record.studentId === student.studentId).length;
        
        // é£é™©ç­‰çº§æ˜¾ç¤º
        let riskLevelDisplay = '';
        if (student.riskLevel) {
            let color = '';
            let text = '';
            if (student.riskLevel === 'red') {
                color = '#c62828';
                text = 'çº¢è‰²é¢„è­¦';
            } else if (student.riskLevel === 'yellow') {
                color = '#f57f17';
                text = 'é»„è‰²å…³æ³¨';
            } else {
                color = '#2e7d32';
                text = 'ç»¿è‰²æ­£å¸¸';
            }
            riskLevelDisplay = `<span style="color: ${color}; font-weight: bold;">${text}</span>`;
        }
        
        row.innerHTML = `
            <td><input type="checkbox" class="student-checkbox" value="${student.studentId}"></td>
            <td>-</td>
            <td>${student.studentId || ''}</td>
            <td>${student.name || ''}</td>
            <td>${student.className || ''}</td>
            <td>${student.dormitory || ''}</td>
            <td>${student.phone || ''}</td>
            <td>${student.parentPhone || ''}</td>
            <td>${student.idCard || ''}</td>
            <td>${student.politicalStatus || ''}</td>
            <td>${student.hometown || ''}</td>
            <td>${student.hardship || 'æ— '}</td>
            <td>${riskLevelDisplay}</td>
            <td>${student.punishments && student.punishments.length > 0 ? 'æœ‰' : 'æ— '}</td>
            <td>${student.statusChange || 'æ— '}</td>
            <td>${talkCount}æ¬¡</td>
            <td>
                <button style="padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; margin-right: 5px;" onclick="showStudentDetail('${student.studentId}')">æŸ¥çœ‹</button>
                <button style="padding: 5px 10px; background: #27ae60; color: white; border: none; border-radius: 4px; margin-right: 5px;" onclick="editStudent('${student.studentId}')">ç¼–è¾‘</button>
                <button style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px;" onclick="deleteStudent('${student.studentId}')">åˆ é™¤</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
// ========== ä¿®å¤ç»“æŸ ==========
   // ========== ä¿®å¤æ”¿æ²»é¢è²Œç­›é€‰é€‰é¡¹ ==========
// è¿™ä¸ªå‡½æ•°ä¼šåœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œ
function fixPoliticalFilter() {
    // æ‰¾åˆ°æ”¿æ²»é¢è²Œç­›é€‰çš„ä¸‹æ‹‰èœå•
    const filterSelect = document.getElementById('politicalStatusFilter');
    const modalSelect = document.getElementById('modalPoliticalStatus');
    
    // å®Œæ•´çš„æ”¿æ²»é¢è²Œé€‰é¡¹
    const options = [
        { value: '', text: 'å…¨éƒ¨æ”¿æ²»é¢è²Œ' },
        { value: 'ä¸­å…±å…šå‘˜', text: 'ä¸­å…±å…šå‘˜' },
        { value: 'ä¸­å…±é¢„å¤‡å…šå‘˜', text: 'ä¸­å…±é¢„å¤‡å…šå‘˜' },
        { value: 'å‘å±•å¯¹è±¡', text: 'å‘å±•å¯¹è±¡' },
        { value: 'å…¥å…šç§¯æåˆ†å­', text: 'å…¥å…šç§¯æåˆ†å­' },
        { value: 'å…±é’å›¢å‘˜', text: 'å…±é’å›¢å‘˜' },
        { value: 'ç¾¤ä¼—', text: 'ç¾¤ä¼—' }
    ];
    
    // ä¿®å¤ç­›é€‰ä¸‹æ‹‰èœå•
    if (filterSelect) {
        filterSelect.innerHTML = '';
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            filterSelect.appendChild(optionElement);
        });
    }
    
    // ä¿®å¤æ·»åŠ /ç¼–è¾‘è¡¨å•çš„ä¸‹æ‹‰èœå•
    if (modalSelect) {
        modalSelect.innerHTML = '';
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text || 'è¯·é€‰æ‹©';
            modalSelect.appendChild(optionElement);
        });
    }
}

// é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œä¿®å¤å‡½æ•°
setTimeout(fixPoliticalFilter, 1000);
// ========== ä¿®å¤ç»“æŸ ==========
 // ç®€å•æœç´¢å‡½æ•° - è§£å†³æ”¿æ²»é¢è²Œå’Œå›°éš¾è®¤å®šæœç´¢é—®é¢˜
function simpleSearchStudents() {
    // 1. è·å–æœç´¢å†…å®¹
    const keyword = document.getElementById('searchStudentsInput').value;
    const riskLevel = document.getElementById('riskLevelFilter').value;
    const political = document.getElementById('politicalStatusFilter').value;
    const hardship = document.getElementById('hardshipFilter').value;
    
    // 2. ä»æœ¬åœ°è·å–æ‰€æœ‰å­¦ç”Ÿæ•°æ®
    const allStudents = JSON.parse(localStorage.getItem('students') || '[]');
    
    if (allStudents.length === 0) {
        alert('è¿˜æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œè¯·å…ˆæ·»åŠ å­¦ç”Ÿï¼');
        return;
    }
    
    // 3. å¼€å§‹ç­›é€‰
    let filteredStudents = allStudents;
    
    // æŒ‰å…³é”®è¯æœç´¢
    if (keyword) {
        filteredStudents = filteredStudents.filter(student => 
            student.name.includes(keyword) ||
            student.studentId.includes(keyword) ||
            student.className.includes(keyword)
        );
    }
    
    // æŒ‰é£é™©ç­‰çº§ç­›é€‰
    if (riskLevel) {
        filteredStudents = filteredStudents.filter(student => 
            student.riskLevel === riskLevel
        );
    }
    
    // æŒ‰æ”¿æ²»é¢è²Œç­›é€‰
    if (political) {
        filteredStudents = filteredStudents.filter(student => 
            student.politicalStatus === political
        );
    }
    
    // æŒ‰å›°éš¾è®¤å®šç­›é€‰
    if (hardship) {
        filteredStudents = filteredStudents.filter(student => 
            student.hardship === hardship
        );
    }
    
    // 4. æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
    updateStudentTable(filteredStudents);
    
    // 5. æ˜¾ç¤ºæœç´¢ç»“æœçš„ç»Ÿè®¡ä¿¡æ¯
    showSearchResultStats(filteredStudents);
}

// æ›´æ–°å­¦ç”Ÿè¡¨æ ¼
function updateStudentTable(students) {
    const tbody = document.getElementById('studentsList');
    tbody.innerHTML = '';
    
    if (students.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="17" style="text-align: center; padding: 30px; color: #666;">
                    <div>ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ</div>
                </td>
            </tr>
        `;
        return;
    }
    
    // æ˜¾ç¤ºæ¯ä¸ªå­¦ç”Ÿ
    students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="student-checkbox" value="${student.studentId}"></td>
            <td>-</td>
            <td>${student.studentId || '-'}</td>
            <td><strong>${student.name || '-'}</strong></td>
            <td>${student.className || '-'}</td>
            <td>${student.dormitory || '-'}</td>
            <td>${student.phone || '-'}</td>
            <td>${student.parentPhone || '-'}</td>
            <td>${student.idCard || '-'}</td>
            <td>${student.politicalStatus || '-'}</td>
            <td>${student.hometown || '-'}</td>
            <td>${student.hardship || 'æ— '}</td>
            <td>
                ${student.riskLevel === 'red' ? '<span style="color:#c62828">çº¢è‰²é¢„è­¦</span>' : 
                  student.riskLevel === 'yellow' ? '<span style="color:#f57f17">é»„è‰²å…³æ³¨</span>' : 
                  '<span style="color:#2e7d32">ç»¿è‰²æ­£å¸¸</span>'}
            </td>
            <td>${student.punishments && student.punishments.length > 0 ? 'æœ‰' : 'æ— '}</td>
            <td>${student.statusChange || 'æ— '}</td>
            <td>0</td>
            <td>
                <button onclick="editStudent('${student.studentId}')" style="padding:3px 8px; background:#3498db; color:white; border:none; border-radius:3px;">ç¼–è¾‘</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// æ˜¾ç¤ºæœç´¢ç»“æœç»Ÿè®¡
function showSearchResultStats(students) {
    // ç§»é™¤æ—§çš„ç»Ÿè®¡ä¿¡æ¯
    const oldStats = document.getElementById('search-stats');
    if (oldStats) oldStats.remove();
    
    // åˆ›å»ºç»Ÿè®¡ä¿¡æ¯
    const totalCount = students.length;
    
    // ç»Ÿè®¡å›°éš¾è®¤å®šäººæ•°
    const hardshipCounts = {
        'ç‰¹åˆ«å›°éš¾': students.filter(s => s.hardship === 'ç‰¹åˆ«å›°éš¾').length,
        'å›°éš¾': students.filter(s => s.hardship === 'å›°éš¾').length,
        'ä¸€èˆ¬å›°éš¾': students.filter(s => s.hardship === 'ä¸€èˆ¬å›°éš¾').length,
        'æ— ': students.filter(s => !s.hardship || s.hardship === 'æ— ').length
    };
    
    // ç»Ÿè®¡æ”¿æ²»é¢è²Œäººæ•°
    const politicalCounts = {
        'ä¸­å…±å…šå‘˜': students.filter(s => s.politicalStatus === 'ä¸­å…±å…šå‘˜').length,
        'ä¸­å…±é¢„å¤‡å…šå‘˜': students.filter(s => s.politicalStatus === 'ä¸­å…±é¢„å¤‡å…šå‘˜').length,
        'å…±é’å›¢å‘˜': students.filter(s => s.politicalStatus === 'å…±é’å›¢å‘˜').length,
        'ç¾¤ä¼—': students.filter(s => !s.politicalStatus || s.politicalStatus === 'ç¾¤ä¼—').length
    };
    
    // ç»Ÿè®¡é£é™©ç­‰çº§äººæ•°
    const riskCounts = {
        'çº¢è‰²é¢„è­¦': students.filter(s => s.riskLevel === 'red').length,
        'é»„è‰²å…³æ³¨': students.filter(s => s.riskLevel === 'yellow').length,
        'ç»¿è‰²æ­£å¸¸': students.filter(s => s.riskLevel === 'green').length
    };
    
    // åˆ›å»ºç»Ÿè®¡ä¿¡æ¯HTML
    const statsHTML = `
        <div id="search-stats" style="
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        ">
            <div style="font-weight: bold; margin-bottom: 10px; color: #1976d2;">
                ğŸ” æœç´¢ç»“æœç»Ÿè®¡ï¼šå…±æ‰¾åˆ° ${totalCount} ä¸ªå­¦ç”Ÿ
            </div>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- é£é™©ç­‰çº§ç»Ÿè®¡ -->
                <div>
                    <div style="font-size: 14px; color: #555; margin-bottom: 5px;">é£é™©ç­‰çº§ï¼š</div>
                    <div style="display: flex; gap: 10px;">
                        <span style="color: #c62828;">çº¢è‰²: ${riskCounts['çº¢è‰²é¢„è­¦']}</span>
                        <span style="color: #f57f17;">é»„è‰²: ${riskCounts['é»„è‰²å…³æ³¨']}</span>
                        <span style="color: #2e7d32;">ç»¿è‰²: ${riskCounts['ç»¿è‰²æ­£å¸¸']}</span>
                    </div>
                </div>
                
                <!-- æ”¿æ²»é¢è²Œç»Ÿè®¡ -->
                <div>
                    <div style="font-size: 14px; color: #555; margin-bottom: 5px;">æ”¿æ²»é¢è²Œï¼š</div>
                    <div style="display: flex; gap: 10px;">
                        <span style="color: #c62828;">å…šå‘˜: ${politicalCounts['ä¸­å…±å…šå‘˜']}</span>
                        <span style="color: #f57f17;">é¢„å¤‡: ${politicalCounts['ä¸­å…±é¢„å¤‡å…šå‘˜']}</span>
                        <span style="color: #1976d2;">å›¢å‘˜: ${politicalCounts['å…±é’å›¢å‘˜']}</span>
                        <span style="color: #666;">ç¾¤ä¼—: ${politicalCounts['ç¾¤ä¼—']}</span>
                    </div>
                </div>
                
                <!-- å›°éš¾è®¤å®šç»Ÿè®¡ -->
                <div>
                    <div style="font-size: 14px; color: #555; margin-bottom: 5px;">å›°éš¾è®¤å®šï¼š</div>
                    <div style="display: flex; gap: 10px;">
                        <span style="color: #c62828;">ç‰¹åˆ«: ${hardshipCounts['ç‰¹åˆ«å›°éš¾']}</span>
                        <span style="color: #f57f17;">å›°éš¾: ${hardshipCounts['å›°éš¾']}</span>
                        <span style="color: #9c27b0;">ä¸€èˆ¬: ${hardshipCounts['ä¸€èˆ¬å›°éš¾']}</span>
                        <span style="color: #2e7d32;">æ— : ${hardshipCounts['æ— ']}</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                <button onclick="clearSearch()" style="padding: 3px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px;">æ¸…é™¤æœç´¢</button>
            </div>
        </div>
    `;
    
    // æ’å…¥åˆ°è¡¨æ ¼å‰é¢
    const tableContainer = document.querySelector('.table-container');
    if (tableContainer) {
        tableContainer.insertAdjacentHTML('beforebegin', statsHTML);
    }
}

// æ¸…é™¤æœç´¢
function clearSearch() {
    document.getElementById('searchStudentsInput').value = '';
    document.getElementById('riskLevelFilter').value = '';
    document.getElementById('politicalStatusFilter').value = '';
    document.getElementById('hardshipFilter').value = '';
    
    // é‡æ–°åŠ è½½æ‰€æœ‰å­¦ç”Ÿ
    loadStudentsTable();
    
    // ç§»é™¤ç»Ÿè®¡ä¿¡æ¯
    const statsDiv = document.getElementById('search-stats');
    if (statsDiv) statsDiv.remove();
    
    alert('æœç´¢æ¡ä»¶å·²æ¸…é™¤ï¼');
}
// æœ€ç®€å•çš„æ‰¹é‡åˆ é™¤å‡½æ•° - æ·»åŠ åˆ°è¿™é‡Œ
function simpleBatchDelete() {
    // æ‰¾åˆ°æ‰€æœ‰è¢«å‹¾é€‰çš„å­¦ç”Ÿ
    const checkboxes = document.querySelectorAll('.student-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„å­¦ç”Ÿï¼');
        return;
    }
    
    // æ”¶é›†è¦åˆ é™¤çš„å­¦ç”ŸID
    const idsToDelete = [];
    checkboxes.forEach(cb => {
        idsToDelete.push(cb.value);
    });
    
    // ç¡®è®¤æ˜¯å¦åˆ é™¤
    if (confirm(`ç¡®å®šè¦åˆ é™¤ ${idsToDelete.length} ä¸ªå­¦ç”Ÿå—ï¼Ÿ`)) {
        // åˆ é™¤è¿™äº›å­¦ç”Ÿ
        students = students.filter(student => !idsToDelete.includes(student.studentId));
        localStorage.setItem('students', JSON.stringify(students));
        
        // åˆ é™¤è¿™äº›å­¦ç”Ÿçš„è°ˆè¯è®°å½•
        talkRecords = talkRecords.filter(record => !idsToDelete.includes(record.studentId));
        localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
        
        // åˆ·æ–°é¡µé¢
        loadStudentsTable();
        loadTalkRecords();
        alert(`å·²åˆ é™¤ ${idsToDelete.length} ä¸ªå­¦ç”Ÿï¼`);
    }
}
</script>
</body>
</html>