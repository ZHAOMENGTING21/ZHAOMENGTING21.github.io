<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËæÖÂØºÂëòË∞àÂøÉË∞àËØùÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo h1 {
            font-size: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: #3498db;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: #3498db;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0 30px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Âç°ÁâáÊ†∑Âºè */
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Ë°®ÂçïÊ†∑Âºè */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* ÊêúÁ¥¢ÈÄâÊã©Ê°Ü */
        .search-select-container {
            position: relative;
        }

        .search-select-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-select-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-select-item:hover {
            background: #f5f7fa;
        }

        .search-select-item.selected {
            background: #e3f2fd;
        }

        /* Â§çÈÄâÊ°ÜÁªÑ */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .signature-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #3498db;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-danger {
            background: #e74c3c;
        }

        /* Ë°®Ê†ºÊ†∑Âºè */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Â≠¶Áîü‰ø°ÊÅØÈù¢Êùø */
        .student-info-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .student-info-item {
            display: flex;
            flex-direction: column;
        }

        .student-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .student-info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* È£éÈô©Á≠âÁ∫ßÊ†áÁ≠æ */
        .risk-level {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .risk-level.red {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .risk-level.yellow {
            background: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffcc80;
        }

        .risk-level.green {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 800px;
        }

        /* Ê∂àÊÅØÊèêÁ§∫ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: #27ae60;
        }

        .message.error {
            background: #e74c3c;
        }

        .message.info {
            background: #3498db;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ÂÖ∂‰ªñÊ†∑Âºè */
        .other-topic-input {
            display: none;
            margin-top: 10px;
        }
        
        /* ÊâìÂç∞Ê†∑Âºè */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-content, .print-content * {
                visibility: visible;
            }
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 12pt;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
            margin: 20px 0;
            font-size: 12pt;
            font-family: "ÂÆã‰Ωì", "SimSun", serif;
        }
        
        .print-table th,
        .print-table td {
            border: 1px solid #000;
            padding: 8px 12px;
            vertical-align: top;
        }
        
        .print-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        .doc-header {
            text-align: center;
            margin-bottom: 30px;
            font-family: "Èªë‰Ωì", "SimHei", sans-serif;
        }
        
        .doc-header h1 {
            font-size: 22pt;
            margin-bottom: 10px;
        }
        
        .doc-header h2 {
            font-size: 16pt;
            margin-bottom: 20px;
            color: #333;
        }
        
        .doc-footer {
            margin-top: 50px;
            text-align: right;
            font-size: 11pt;
            color: #666;
        }
        
        /* Êñá‰ª∂‰∏ä‰º†Âå∫ÂüüÊ†∑Âºè */
        .file-upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .file-upload-area.drag-over {
            border-color: #27ae60;
            background: #e8f5e9;
        }
        
        .file-upload-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .file-upload-area p {
            margin-bottom: 10px;
            color: #666;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 10px 25px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .file-upload-btn:hover {
            background: #2980b9;
        }
        
        /* ÂØºÂÖ•È¢ÑËßàË°®Ê†º */
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .preview-table th {
            background: #f0f0f0;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .preview-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .preview-table .valid {
            background-color: #e8f5e9;
        }
        
        .preview-table .invalid {
            background-color: #ffebee;
        }
        
        .import-progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        
        /* ========== ÁÆÄÂåñÁöÑÁªüËÆ°Âç°ÁâáÊ†∑Âºè ========== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 4px solid #3498db;
        }
        
        .stat-card.total {
            border-top-color: #3498db;
        }
        
        .stat-card.red {
            border-top-color: #c62828;
        }
        
        .stat-card.yellow {
            border-top-color: #f57f17;
        }
        
        .stat-card.green {
            border-top-color: #2e7d32;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* Ë∞àËØùËøΩË∏™Ê†∑Âºè */
        .talk-track-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .talk-count {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .count-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .count-number {
            font-size: 18px;
            font-weight: bold;
        }
        
        .count-label {
            font-size: 12px;
            color: #666;
        }
        
        /* ËøëÊúüË∞àËØùÂ≠¶ÁîüÂàóË°® */
        .recent-talks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .student-tag {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .student-tag .talk-count {
            background: #3498db;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        /* Ë∞àËØùÈ¢ëÁéáÊ†∑Âºè */
        .frequency-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .frequency-high {
            background: #ffebee;
            color: #c62828;
        }
        
        .frequency-medium {
            background: #fff8e1;
            color: #f57f17;
        }
        
        .frequency-low {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* ÊúàÂ∫¶ÁªüËÆ°Ê†∑Âºè */
        .month-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .month-stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .month-name {
            font-size: 12px;
            color: #666;
        }
        
        .month-count {
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Êó∂Èó¥Á≠õÈÄâÂô®Ê†∑Âºè */
        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .time-filter-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .time-filter-btn.active {
            background: #3498db;
            color: white;
        }
        
        /* ÊâπÈáèÊìç‰ΩúÁõ∏ÂÖ≥Ê†∑Âºè */
        .batch-action-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        /* ÈÄâ‰∏≠Ë°åÁöÑÊ†∑Âºè */
        .data-table tr.selected {
            background-color: #e3f2fd;
        }
        
        /* Êúà‰ªΩÁªüËÆ°È°πÊÇ¨ÂÅúÊïàÊûú */
        .month-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        /* ÂΩìÂâçÊúà‰ªΩÁ™ÅÂá∫ÊòæÁ§∫ */
        .current-month {
            position: relative;
            overflow: hidden;
        }
        
        .current-month::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent #3498db transparent transparent;
        }
        
        .current-month::after {
            content: 'ÂΩìÂâç';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: white;
            transform: rotate(45deg);
            transform-origin: right top;
        }
        
        /* ========== Êñ∞Â¢ûÊ†∑Âºè ========== */
        
        /* ÁÖßÁâá‰∏ä‰º†Ê†∑Âºè */
        .photo-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload-area:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .photo-preview {
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
        
        .photo-placeholder {
            width: 120px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 6px;
            margin: 10px auto;
            color: #666;
        }
        
        /* Â§ÑÂàÜËÆ∞ÂΩïÊ†∑Âºè */
        .punishment-record {
            background: #fff8e1;
            border-left: 4px solid #f57f17;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        /* Âõ∞ÈöæËÆ§ÂÆöÊ†áÁ≠æ */
        .hardship-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .hardship-severe {
            background: #ffebee;
            color: #c62828;
        }
        
        .hardship-general {
            background: #fff8e1;
            color: #f57f17;
        }
        
        .hardship-none {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* ÊîøÊ≤ªÈù¢Ë≤åÊ†áÁ≠æ */
        .political-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            background: #e3f2fd;
            color: #1565c0;
        }
        
        /* ÁºñËæëËÆ∞ÂΩïÊ†∑Âºè */
        .edit-record-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }
        
        .edit-record-btn:hover {
            background: #2980b9;
        }
        
        /* Â≠¶ÁîüËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */
        .student-detail-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .student-detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .student-photo-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .student-info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .student-detail-item {
            margin-bottom: 10px;
        }
        
        .student-detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .student-detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        /* ÁºñËæëË∞àËØùËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü */
        .edit-talk-modal {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Â§ÑÂàÜËÆ∞ÂΩïËæìÂÖ•Ê†∑Âºè */
        .punishment-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .punishment-input-group input {
            flex: 1;
        }
        
        .punishment-list {
            margin-top: 10px;
        }
        
        /* Â≠¶ÁîüÁÖßÁâáÊòæÁ§∫ */
        .student-photo-small {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* Êâ©Â±ï‰ø°ÊÅØÊ†áÁ≠æ */
        .info-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-right: 5px;
            margin-bottom: 3px;
        }
        
        .info-tag.punishment {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .info-tag.hardship {
            background: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffcc80;
        }
        
        .info-tag.political {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        /* ========== Êï∞ÊçÆÂàÜÊûêÊ®°ÂùóÊ†∑Âºè ========== */
        .analysis-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #34495e;
        }
        
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 6px;
            color: #666;
            font-size: 14px;
        }
        
        .simple-bar-chart {
            display: flex;
            align-items: flex-end;
            height: 250px;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            border-left: 1px solid #ddd;
            position: relative;
            margin-top: 20px;
        }
        
        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .bar {
            width: 60%;
            min-height: 2px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            position: relative;
        }
        
        .bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }
        
        .bar-label {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 0;
            font-size: 11px;
            color: #666;
        }
        
        .x-axis {
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            margin-left: 30px;
            font-size: 11px;
            color: #666;
        }
        
        .pie-chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 250px;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background: conic-gradient(
                #3498db 0% 40%,
                #2ecc71 40% 70%,
                #e74c3c 70% 85%,
                #f39c12 85% 95%,
                #9b59b6 95% 100%
            );
        }
        
        .pie-legend {
            margin-left: 30px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }
        
        .trend-line {
            height: 2px;
            background: #3498db;
            position: relative;
            margin: 40px 0 20px 30px;
        }
        
        .trend-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #3498db;
            border-radius: 50%;
            top: -4px;
            transform: translateX(-50%);
        }
        
        .trend-point:hover::after {
            content: attr(data-value);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .analysis-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .analysis-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .analysis-table tr:hover {
            background: #f5f7fa;
        }
        
        .analysis-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .analysis-controls select,
        .analysis-controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .analysis-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .highlight-card {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .highlight-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .highlight-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .insight-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .insight-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .insight-text {
            flex: 1;
            font-size: 13px;
        }
        
        /* ========== Êñ∞Â¢ûÔºöÂ≠¶Á±çÂºÇÂä®Ê†∑Âºè ========== */
        .status-change-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
            background: #e1f5fe;
            color: #0277bd;
            border: 1px solid #4fc3f7;
        }
        
        .status-change-yes {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffb74d;
        }
        
        .status-change-no {
            background: #f1f8e9;
            color: #558b2f;
            border: 1px solid #9ccc65;
        }
        
        .punishment-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .punishment-yes {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        
        .punishment-no {
            background: #f1f8e9;
            color: #558b2f;
            border: 1px solid #9ccc65;
        }
        
        /* ========== Êñ∞Â¢ûÔºöÁî®Êà∑ÁÆ°ÁêÜÊ®°ÂùóÊ†∑Âºè ========== */
        .user-role-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .user-role-admin {
            background: linear-gradient(135deg, #ff6b6b, #c62828);
            color: white;
        }
        
        .user-role-counselor {
            background: linear-gradient(135deg, #4ecdc4, #27ae60);
            color: white;
        }
        
        .user-status-active {
            color: #27ae60;
            font-weight: bold;
        }
        
        .user-status-inactive {
            color: #95a5a6;
        }
        
        /* Áî®Êà∑ÁªüËÆ°Âç°Áâá */
        .user-stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 4px solid #9b59b6;
        }
        
        .user-stat-card.total {
            border-top-color: #9b59b6;
        }
        
        .user-stat-card.admin {
            border-top-color: #c62828;
        }
        
        .user-stat-card.counselor {
            border-top-color: #27ae60;
        }
        
        .user-stat-card.active {
            border-top-color: #3498db;
        }
        
        /* Áî®Êà∑Êìç‰ΩúÊåâÈíÆ */
        .user-action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .user-action-edit {
            background: #3498db;
            color: white;
        }
        
        .user-action-reset {
            background: #f39c12;
            color: white;
        }
        
        .user-action-delete {
            background: #e74c3c;
            color: white;
        }
        
        .user-action-toggle {
            background: #9b59b6;
            color: white;
        }
        
        /* Áî®Êà∑ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */
        .user-detail-modal {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .user-detail-item {
            margin-bottom: 15px;
        }
        
        .user-detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .user-detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        /* ÂØÜÁ†ÅÂº∫Â∫¶ÊåáÁ§∫Âô® */
        .password-strength {
            margin-top: 5px;
            height: 4px;
            border-radius: 2px;
            background: #e0e0e0;
            overflow: hidden;
        }
        
        .password-strength-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .password-strength.weak .password-strength-fill {
            background-color: #e74c3c;
            width: 33%;
        }
        
        .password-strength.medium .password-strength-fill {
            background-color: #f39c12;
            width: 66%;
        }
        
        .password-strength.strong .password-strength-fill {
            background-color: #27ae60;
            width: 100%;
        }
        
        /* Áî®Êà∑ÊâπÈáèÂØºÂÖ•Ê†∑Âºè */
        .user-import-step {
            margin-bottom: 20px;
        }
        
        .user-import-instruction {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .user-import-instruction h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .user-import-instruction ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .user-import-instruction li {
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }
        
        /* Áî®Êà∑ÊùÉÈôêÊ†áÁ≠æ */
        .permission-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 3px;
            margin-bottom: 3px;
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        /* ÁôªÂΩïÈ°µÈù¢Ê†∑Âºè */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form .form-label {
            font-size: 14px;
            color: #34495e;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .login-form .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .login-form .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 13px;
        }
        
        /* ËßíËâ≤ÊùÉÈôêËØ¥Êòé */
        .role-permissions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .role-permissions h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .role-permissions ul {
            margin-left: 20px;
        }
        
        .role-permissions li {
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }
        
        /* Á≥ªÁªüËÆæÁΩÆÊ†∑Âºè */
        .system-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .settings-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        .settings-card h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: 14px;
            color: #333;
        }
        
        .settings-value {
            font-size: 14px;
            color: #666;
        }
        
        .settings-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .settings-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .settings-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .settings-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .settings-switch input:checked + .settings-slider {
            background-color: #27ae60;
        }
        
        .settings-switch input:checked + .settings-slider:before {
            transform: translateX(26px);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="logo">
                <h1>üí¨ ËæÖÂØºÂëòË∞àÂøÉË∞àËØùÁ≥ªÁªü</h1>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="switchTab('record')">
                    üìù Êñ∞Âª∫Ë∞àËØùËÆ∞ÂΩï
                </div>
                <div class="nav-item" onclick="switchTab('students')">
                    üë• Â≠¶ÁîüÊï∞ÊçÆÂ∫ì
                </div>
                <div class="nav-item" onclick="switchTab('history')">
                    üìö ÂéÜÂè≤ËÆ∞ÂΩïÊü•ËØ¢
                </div>
                <div class="nav-item" onclick="switchTab('analysis')">
                    üìä Êï∞ÊçÆÂàÜÊûê
                </div>
                <div class="nav-item" onclick="switchTab('export')">
                    üì§ Êï∞ÊçÆÂØºÂá∫
                </div>
                <div class="nav-item" id="userManagementTab" style="display: none;" onclick="switchTab('users')">
                    üë§ Áî®Êà∑ÁÆ°ÁêÜ
                </div>
                <div class="nav-item" id="systemSettingsTab" style="display: none;" onclick="switchTab('settings')">
                    ‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ
                </div>
            </div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Êñ∞Âª∫Ë∞àËØùËÆ∞ÂΩï</h1>
                <div class="user-info">
                    <span id="currentUserInfo">ËæÖÂØºÂëòÔºö<span id="counselorName">ËµµÊ¢¶Â©∑</span></span>
                    <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
                </div>
            </div>

            <!-- ÁôªÂΩïÁïåÈù¢ -->
            <div id="loginPage" class="login-container">
                <div class="login-header">
                    <div class="login-logo">üí¨</div>
                    <h1>ËæÖÂØºÂëòË∞àÂøÉË∞àËØùÁ≥ªÁªü</h1>
                    <p>ËæÖÂØºÂëòÂ∑•‰ΩúÁÆ°ÁêÜ‰∏éÂ≠¶ÁîüË∞àÂøÉË∞àËØùËÆ∞ÂΩïÂπ≥Âè∞</p>
                </div>
                <div class="login-form">
                    <div class="form-group">
                        <label class="form-label">Ë¥¶Âè∑</label>
                        <input type="text" id="username" class="form-control" placeholder="ËØ∑ËæìÂÖ•Ë¥¶Âè∑">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂØÜÁ†Å</label>
                        <input type="password" id="password" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                    </div>
                    <button class="login-btn" onclick="login()">ÁôªÂΩï</button>
                </div>
                <div class="login-footer">
                    <p>Á≥ªÁªüÁâàÊú¨Ôºöv2.0 | ÁÆ°ÁêÜÂëòË¥¶Âè∑ÔºöËµµÊ¢¶Â©∑</p>
                </div>
            </div>

            <!-- ‰∏ªÁ≥ªÁªüÁïåÈù¢ -->
            <div id="mainSystem" style="display: none;">
                <!-- Êñ∞Âª∫Ë∞àËØùËÆ∞ÂΩï -->
                <div id="recordTab" class="content-tab">
                    <div class="card">
                        <h2 class="card-title">üìù Êñ∞Âª∫Ë∞àÂøÉË∞àËØùËÆ∞ÂΩï</h2>
                        
                        <!-- Ë∞àËØùÁªüËÆ°‰ø°ÊÅØ -->
                        <div class="talk-track-card" id="recordStatsCard" style="display: none;">
                            <div class="track-header">
                                <h4>üìä ËøëÊúüË∞àËØùÁªüËÆ°</h4>
                                <div class="talk-count">
                                    <div class="count-item">
                                        <span class="count-number" id="todayCount">0</span>
                                        <span class="count-label">‰ªäÊó•</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="weekCount">0</span>
                                        <span class="count-label">Êú¨Âë®</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="monthCount">0</span>
                                        <span class="count-label">Êú¨Êúà</span>
                                    </div>
                                </div>
                            </div>
                            <div id="recentStudentsList" class="recent-talks-list">
                                <!-- ËøëÊúüË∞àËØùÂ≠¶ÁîüÂàóË°® -->
                            </div>
                        </div>
                        
                        <form id="talkForm">
                            <input type="hidden" id="editRecordId" value="">
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">ÈÄâÊã©Â≠¶Áîü *</label>
                                    <div class="search-select-container">
                                        <input type="text" 
                                               id="studentSearch" 
                                               class="search-select-input" 
                                               placeholder="ËæìÂÖ•ÂßìÂêç„ÄÅÂ≠¶Âè∑ÊàñÁè≠Á∫ßÊêúÁ¥¢..."
                                               oninput="searchStudentsForSelect(this.value)">
                                        <div id="studentSearchResults" class="search-select-dropdown"></div>
                                    </div>
                                    <input type="hidden" id="studentId">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">‰∏ì‰∏öÁè≠Á∫ß *</label>
                                    <input type="text" id="className" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ÂÆøËàç *</label>
                                    <input type="text" id="dormitory" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ë∞àËØùÊó∂Èó¥ *</label>
                                    <input type="datetime-local" id="talkTime" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ë∞àËØùÂú∞ÁÇπ *</label>
                                    <input type="text" id="talkLocation" class="form-control" required>
                                </div>
                            </div>

                            <!-- Â≠¶Áîü‰ø°ÊÅØÈù¢Êùø -->
                            <div id="studentInfoPanel" class="student-info-panel" style="display: none;">
                                <div class="student-info-grid">
                                    <div class="student-info-item">
                                        <span class="student-info-label">È£éÈô©Á≠âÁ∫ß</span>
                                        <span id="infoRiskLevel" class="student-info-value"></span>
                                    </div>
                                    <div class="student-info-item">
                                        <span class="student-info-label">ÂéÜÂè≤Ë∞àËØùÊ¨°Êï∞</span>
                                        <span class="student-info-value" id="infoTalkCount">0Ê¨°</span>
                                    </div>
                                    <div class="student-info-item">
                                        <span class="student-info-label">ÊúÄËøëË∞àËØùÊó∂Èó¥</span>
                                        <span class="student-info-value" id="infoLastTalk">Êó†ËÆ∞ÂΩï</span>
                                    </div>
                                    <div class="student-info-item">
                                        <span class="student-info-label">Â≠¶Á±çÂºÇÂä®</span>
                                        <span class="student-info-value" id="infoStatusChange">Êó†</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ë∞àËØù‰∏ªÈ¢ò *</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="ÈÄÇÂ∫îÊÄß"> ÈÄÇÂ∫îÊÄß
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="‰∫∫ÈôÖÂÖ≥Á≥ª"> ‰∫∫ÈôÖÂÖ≥Á≥ª
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="ÊÉÖÊÑü"> ÊÉÖÊÑü
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="Â≠¶‰∏ö"> Â≠¶‰∏ö
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="Â∞±‰∏ö"> Â∞±‰∏ö
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="ÊÉÖÁª™/ÂÅ•Â∫∑"> ÊÉÖÁª™/ÂÅ•Â∫∑
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="ÂÆ∂Â∫≠"> ÂÆ∂Â∫≠
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="Ë≠¶Á§∫ÊïôËÇ≤"> Ë≠¶Á§∫ÊïôËÇ≤
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="topic" value="ÂÖ∂‰ªñ" id="otherTopicCheckbox" onchange="toggleOtherTopicInput()"> ÂÖ∂‰ªñ
                                    </label>
                                </div>
                                <div id="otherTopicInput" class="other-topic-input">
                                    <input type="text" id="otherTopicText" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂÖ∂‰ªñË∞àËØù‰∏ªÈ¢ò...">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Â≠¶ÁîüËÉåÊôØ *</label>
                                <textarea id="studentBackground" class="form-control" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Ë∞àËØùÁõÆÁöÑ *</label>
                                <textarea id="talkPurpose" class="form-control" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Â≠¶ÁîüËá™Ëø∞ *</label>
                                <textarea id="studentStatement" class="form-control" required></textarea>
                            </div>

                            <div class="form-group" style="display: none;">
    <label class="form-label">Ë∞àËØùË¶ÅÁÇπËÆ∞ÂΩï *</label>
    <textarea id="talkPoints" class="form-control"></textarea>
</div>

                            <div class="form-group">
                                <label class="form-label">Ë∞àËØùÂèçÈ¶à *</label>
                                <textarea id="talkFeedback" class="form-control" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ÂàÜÁ∫ßÂª∫ËÆÆ *</label>
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="riskLevel" value="red" required>
                                        <span style="color: #c62828; font-weight: bold;">Á∫¢Ëâ≤È¢ÑË≠¶</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="riskLevel" value="yellow">
                                        <span style="color: #f57f17; font-weight: bold;">ÈªÑËâ≤ÂÖ≥Ê≥®</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" name="riskLevel" value="green" checked>
                                        <span style="color: #2e7d32; font-weight: bold;">ÁªøËâ≤Ê≠£Â∏∏</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ÂêéÁª≠Ë∑üËøõËÆ°Âàí</label>
                                <textarea id="followUpPlan" class="form-control" rows="2" placeholder="ÂèØÂ°´ÂÜôÂêéÁª≠Ë∑üËøõËÆ°Âàí..."></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Â§áÊ≥®</label>
                                <textarea id="generalRemark" class="form-control" rows="2" placeholder="ÂèØÂ°´ÂÜôÂÖ∂‰ªñÂ§áÊ≥®‰ø°ÊÅØ..."></textarea>
                            </div>

                            <div class="signature-area">
                                <div class="form-group">
                                    <label class="form-label">Â≠¶ÁîüÁ≠æÂêç</label>
                                    <input type="text" id="studentSignature" class="form-control" placeholder="Ê≠§Â§ÑÂèØÊâìÂç∞ÂêéÊâãÁ≠æ">
                                </div>
                             <div class="form-group">
    <label class="form-label">ËæÖÂØºÂëòÁ≠æÂêç</label>
    <input type="text" id="counselorSignature" class="form-control" value="${currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò'}" readonly>
</div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="submit" class="btn btn-primary" id="saveRecordBtn">‰øùÂ≠òËÆ∞ÂΩï</button>
                                <button type="button" class="btn" onclick="clearForm()">Ê∏ÖÁ©∫Ë°®Âçï</button>
                                <button type="button" class="btn btn-warning" onclick="showDocPreview()">ÂØºÂá∫‰∏∫DOC</button>
                                <button type="button" class="btn btn-info" onclick="saveAsDraft()" id="saveDraftBtn" style="display: none;">‰øùÂ≠ò‰∏∫ËçâÁ®ø</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Â≠¶ÁîüÊï∞ÊçÆÂ∫ì -->
                <div id="studentsTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">üë• Â≠¶ÁîüÊï∞ÊçÆÂ∫ìÁÆ°ÁêÜ</h2>
                        
                        <!-- ÁÆÄÂåñÁöÑÁªüËÆ°Âç°Áâá -->
                        <div class="stats-container" id="statsContainer">
                            <!-- ÁªüËÆ°Âç°Áâá‰ºöÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <!-- Êìç‰ΩúÂå∫Âüü -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">Êï∞ÊçÆÊìç‰Ωú</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-info" onclick="downloadExcelTemplate()">‰∏ãËΩΩExcelÊ®°Êùø</button>
                                <button class="btn btn-success" onclick="showAddStudentModal()">+ Ê∑ªÂä†Â≠¶Áîü</button>
                                <button class="btn btn-warning" onclick="showImportModal()">üì§ ÊâπÈáèÂØºÂÖ•Excel</button>
                                <button class="btn btn-primary" onclick="exportStudentsToExcel()">ÂØºÂá∫‰∏∫Excel</button>
                                <button class="btn btn-danger" onclick="batchDeleteStudents()" id="batchDeleteBtn" style="display: none;">üóëÔ∏è ÊâπÈáèÂà†Èô§</button>
                            </div>
                            <div id="batchActionInfo" style="margin-top: 10px; font-size: 14px; color: #666; display: none;">
                                <span id="selectedCount">0</span> ‰∏™Â≠¶ÁîüÂ∑≤ÈÄâ‰∏≠
                                <button class="btn" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="clearSelection()">Ê∏ÖÈô§ÈÄâÊã©</button>
                            </div>
                        </div>

                        <!-- ÊêúÁ¥¢Âå∫Âüü -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="searchStudentsInput" class="form-control" placeholder="ÊêúÁ¥¢ÂßìÂêç„ÄÅÂ≠¶Âè∑ÊàñÁè≠Á∫ß..." style="flex: 1; min-width: 250px;">
                            <select id="riskLevelFilter" class="form-control" style="max-width: 200px;">
                                <option value="">ÂÖ®ÈÉ®È£éÈô©Á≠âÁ∫ß</option>
                                <option value="red">Á∫¢Ëâ≤È¢ÑË≠¶</option>
                                <option value="yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</option>
                                <option value="green">ÁªøËâ≤Ê≠£Â∏∏</option>
                            </select>
                            <select id="politicalStatusFilter" class="form-control" style="max-width: 150px;">
                                <option value="">ÊîøÊ≤ªÈù¢Ë≤å</option>
                                <option value="‰∏≠ÂÖ±ÂÖöÂëò">‰∏≠ÂÖ±ÂÖöÂëò</option>
                                <option value="‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò">‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò</option>
                                <option value="ÂÖ±ÈùíÂõ¢Âëò">ÂÖ±ÈùíÂõ¢Âëò</option>
                                <option value="Áæ§‰ºó">Áæ§‰ºó</option>
                            </select>
                            <select id="hardshipFilter" class="form-control" style="max-width: 150px;">
                                <option value="">Âõ∞ÈöæËÆ§ÂÆö</option>
                                <option value="ÁâπÂà´Âõ∞Èöæ">ÁâπÂà´Âõ∞Èöæ</option>
                                <option value="Âõ∞Èöæ">Âõ∞Èöæ</option>
                                <option value="‰∏ÄËà¨Âõ∞Èöæ">‰∏ÄËà¨Âõ∞Èöæ</option>
                                <option value="Êó†">Êó†</option>
                            </select>
                            <button class="btn" onclick="searchStudents()">ÊêúÁ¥¢</button>
                            <button class="btn" onclick="clearStudentSearch()">ÈáçÁΩÆ</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents(this)">
                                        </th>
                                        <th>ÁÖßÁâá</th>
                                        <th>Â≠¶Âè∑</th>
                                        <th>ÂßìÂêç</th>
                                        <th>Áè≠Á∫ß</th>
                                        <th>ÂÆøËàç</th>
                                        <th>ÊîøÊ≤ªÈù¢Ë≤å</th>
                                        <th>Âõ∞ÈöæËÆ§ÂÆö</th>
                                        <th>È£éÈô©Á≠âÁ∫ß</th>
                                        <th>Â§ÑÂàÜËÆ∞ÂΩï</th>
                                        <th>Â≠¶Á±çÂºÇÂä®</th>
                                        <th>Ë∞àËØùÊ¨°Êï∞</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsList">
                                    <!-- Â≠¶ÁîüÊï∞ÊçÆÂä®ÊÄÅÂä†ËΩΩ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ÂéÜÂè≤ËÆ∞ÂΩïÊü•ËØ¢ -->
                <div id="historyTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">üìö ÂéÜÂè≤Ë∞àËØùËÆ∞ÂΩïÊü•ËØ¢</h2>
                        
                        <!-- Ë∞àËØùËøΩË∏™ÁªüËÆ° -->
                        <div class="talk-track-card">
                            <div class="track-header">
                                <h4>üìä Ë∞àËØùËøΩË∏™ÁªüËÆ°</h4>
                                <div class="talk-count">
                                    <div class="count-item">
                                        <span class="count-number" id="totalTalksCount">0</span>
                                        <span class="count-label">ÊÄªË∞àËØùÊï∞</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="uniqueStudentsCount">0</span>
                                        <span class="count-label">Ê∂âÂèäÂ≠¶Áîü</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="redTalksCount">0</span>
                                        <span class="count-label" style="color:#c62828">Á∫¢Ëâ≤È¢ÑË≠¶</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Êó∂Èó¥Á≠õÈÄâÂô® -->
                            <div class="time-filter">
                                <button class="time-filter-btn active" onclick="filterByTime('all')">ÂÖ®ÈÉ®</button>
                                <button class="time-filter-btn" onclick="filterByTime('today')">‰ªäÊó•</button>
                                <button class="time-filter-btn" onclick="filterByTime('week')">Êú¨Âë®</button>
                                <button class="time-filter-btn" onclick="filterByTime('month')">Êú¨Êúà</button>
                                <button class="time-filter-btn" onclick="filterByTime('quarter')">Êú¨Â≠£Â∫¶</button>
                            </div>
                            
                            <!-- ÊúàÂ∫¶ÈÄâÊã©Âô® -->
                            <div style="margin-top: 10px;">
                                <label style="font-size: 13px; color: #666; margin-right: 10px;">ÊåâÊúà‰ªΩÁ≠õÈÄâÔºö</label>
                                <select id="monthFilter" class="form-control" style="display: inline-block; width: 200px; font-size: 13px;" onchange="filterByMonth()">
                                    <option value="">ÊâÄÊúâÊúà‰ªΩ</option>
                                    <!-- Êúà‰ªΩÈÄâÈ°π‰ºöÂä®ÊÄÅÁîüÊàê -->
                                </select>
                            </div>
                            
                            <!-- È´òÈ¢ëË∞àËØùÂ≠¶Áîü -->
                            <div id="frequentStudents" style="display: none; margin-top: 10px;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">È´òÈ¢ëË∞àËØùÂ≠¶ÁîüÔºö</div>
                                <div id="frequentStudentsList" class="recent-talks-list"></div>
                            </div>
                        </div>

                        <!-- ÊúàÂ∫¶ÁªüËÆ° -->
                        <div id="monthlyStats" class="month-stats" style="display: none; margin-bottom: 20px;">
                            <!-- ÊúàÂ∫¶ÁªüËÆ°Êï∞ÊçÆÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <!-- ÊâπÈáèÊìç‰ΩúÂå∫Âüü -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">ÊâπÈáèÊìç‰Ωú</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="batchDeleteTalkRecords()" id="batchDeleteTalkBtn" style="display: none;">üóëÔ∏è ÊâπÈáèÂà†Èô§ËÆ∞ÂΩï</button>
                            </div>
                            <div id="batchTalkActionInfo" style="margin-top: 10px; font-size: 14px; color: #666; display: none;">
                                <span id="selectedTalkCount">0</span> Êù°ËÆ∞ÂΩïÂ∑≤ÈÄâ‰∏≠
                                <button class="btn" style="padding: 4px 8px; font-size: 12px; margin-left: 10px;" onclick="clearTalkSelection()">Ê∏ÖÈô§ÈÄâÊã©</button>
                            </div>
                        </div>

                        <!-- ÊêúÁ¥¢Âå∫Âüü -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="recordSearch" class="form-control" placeholder="ÊêúÁ¥¢Â≠¶ÁîüÂßìÂêç„ÄÅÂ≠¶Âè∑ÊàñÁè≠Á∫ß...">
                            <select id="riskLevelFilterHistory" class="form-control" style="max-width: 150px;">
                                <option value="">ÂÖ®ÈÉ®ÂàÜÁ∫ß</option>
                                <option value="red">Á∫¢Ëâ≤È¢ÑË≠¶</option>
                                <option value="yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</option>
                                <option value="green">ÁªøËâ≤Ê≠£Â∏∏</option>
                            </select>
                            <input type="date" id="dateFrom" class="form-control" style="max-width: 150px;">
                            <input type="date" id="dateTo" class="form-control" style="max-width: 150px;">
                            <button class="btn" onclick="searchTalkRecords()">ÊêúÁ¥¢</button>
                            <button class="btn" onclick="clearSearch()">ÈáçÁΩÆ</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table" id="recordsTable">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllTalks" onchange="toggleSelectAllTalks(this)">
                                        </th>
                                        <th>Ë∞àËØùÊó∂Èó¥</th>
                                        <th>Â≠¶ÁîüÂßìÂêç</th>
                                        <th>Áè≠Á∫ß</th>
                                        <th>Ë∞àËØù‰∏ªÈ¢ò</th>
                                        <th>ÂàÜÁ∫ßÂª∫ËÆÆ</th>
                                        <th>Â§ÑÂàÜËÆ∞ÂΩï</th>
                                        <th>Â≠¶Á±çÂºÇÂä®</th>
                                        <th>Ë∞àËØùÊ¨°Êï∞</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="recordsList">
                                    <!-- ËÆ∞ÂΩïÊï∞ÊçÆÂä®ÊÄÅÂä†ËΩΩ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂàÜÊûêÊ®°Âùó -->
                <div id="analysisTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">üìä Êï∞ÊçÆÂàÜÊûê‰∏éÁªüËÆ°</h2>
                        
                        <!-- ÊÄª‰ΩìÊï∞ÊçÆÊ¶ÇËßà -->
                        <div class="highlight-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="highlight-value" id="totalAnalysisCount">0</div>
                                    <div class="highlight-label">ÊÄªË∞àËØùËÆ∞ÂΩïÊï∞</div>
                                </div>
                                <div>
                                    <div class="highlight-value" id="analysisStudentCount">0</div>
                                    <div class="highlight-label">Ê∂âÂèäÂ≠¶ÁîüÊï∞</div>
                                </div>
                                <div>
                                    <div class="highlight-value" id="analysisRedPercent">0%</div>
                                    <div class="highlight-label">È´òÈ£éÈô©Âç†ÊØî</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êï∞ÊçÆÊ¥ûÂØü -->
                        <div class="analysis-section">
                            <h3 class="section-title">üìà Êï∞ÊçÆÊ¥ûÂØü</h3>
                            <div class="insight-list" id="insightsList">
                                <!-- Êï∞ÊçÆÊ¥ûÂØüÂÜÖÂÆπ‰ºöÂä®ÊÄÅÁîüÊàê -->
                            </div>
                        </div>
                        
                        <!-- Êó∂Èó¥ËåÉÂõ¥Á≠õÈÄâ -->
                        <div class="analysis-controls">
                            <select id="analysisTimeRange" class="form-control" style="width: 200px;" onchange="updateAnalysisData()">
                                <option value="all">ÂÖ®ÈÉ®Êó∂Èó¥</option>
                                <option value="month">ÊúÄËøë‰∏Ä‰∏™Êúà</option>
                                <option value="quarter">ÊúÄËøë‰∏â‰∏™Êúà</option>
                                <option value="halfyear">ÊúÄËøëÂÖ≠‰∏™Êúà</option>
                                <option value="year">ÊúÄËøë‰∏ÄÂπ¥</option>
                            </select>
                            <select id="analysisClassFilter" class="form-control" style="width: 200px;" onchange="updateAnalysisData()">
                                <option value="">ÂÖ®ÈÉ®Áè≠Á∫ß</option>
                                <!-- Áè≠Á∫ßÈÄâÈ°π‰ºöÂä®ÊÄÅÁîüÊàê -->
                            </select>
                            <button class="btn btn-primary" onclick="refreshAnalysisData()">Âà∑Êñ∞Êï∞ÊçÆ</button>
                            <button class="btn btn-success" onclick="exportAnalysisReport()">ÂØºÂá∫ÂàÜÊûêÊä•Âëä</button>
                        </div>
                        
                        <!-- È£éÈô©Á≠âÁ∫ßÂàÜÂ∏É -->
                        <div class="analysis-section">
                            <h3 class="section-title">üìä È£éÈô©Á≠âÁ∫ßÂàÜÂ∏É</h3>
                            <div class="chart-container">
                                <div class="chart-title">È£éÈô©Á≠âÁ∫ßÂàÜÂ∏ÉÂõæ</div>
                                <div class="simple-bar-chart" id="riskLevelChart">
                                    <!-- È£éÈô©Á≠âÁ∫ßÊü±Áä∂Âõæ‰ºöÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ë∞àËØù‰∏ªÈ¢òÂàÜÊûê -->
                        <div class="analysis-section">
                            <h3 class="section-title">üí¨ Ë∞àËØù‰∏ªÈ¢òÂàÜÊûê</h3>
                            <div class="chart-container">
                                <div class="chart-title">‰∏ªÈ¢òÂàÜÂ∏ÉÂõæ</div>
                                <div class="pie-chart-container">
                                    <div class="pie-chart" id="topicPieChart"></div>
                                    <div class="pie-legend" id="topicLegend">
                                        <!-- Âõæ‰æã‰ºöÂä®ÊÄÅÁîüÊàê -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êó∂Èó¥Ë∂ãÂäøÂàÜÊûê -->
                        <div class="analysis-section">
                            <h3 class="section-title">üìÖ Êó∂Èó¥Ë∂ãÂäøÂàÜÊûê</h3>
                            <div class="chart-container">
                                <div class="chart-title">ÊúàÂ∫¶Ë∞àËØùË∂ãÂäø</div>
                                <div class="simple-bar-chart" id="monthlyTrendChart">
                                    <!-- ÊúàÂ∫¶Ë∂ãÂäøÂõæ‰ºöÂä®ÊÄÅÁîüÊàê -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- ËØ¶ÁªÜÁªüËÆ°Ë°®Ê†º -->
                        <div class="analysis-section">
                            <h3 class="section-title">üìã ËØ¶ÁªÜÁªüËÆ°Êï∞ÊçÆ</h3>
                            <div class="chart-container">
                                <div class="chart-title">ÂêÑÁè≠Á∫ßË∞àËØùÁªüËÆ°</div>
                                <div class="table-container">
                                    <table class="analysis-table" id="classAnalysisTable">
                                        <thead>
                                            <tr>
                                                <th>Áè≠Á∫ß</th>
                                                <th>Â≠¶Áîü‰∫∫Êï∞</th>
                                                <th>Ë∞àËØùÊ¨°Êï∞</th>
                                                <th>‰∫∫ÂùáË∞àËØù</th>
                                                <th>Á∫¢Ëâ≤È¢ÑË≠¶</th>
                                                <th>ÈªÑËâ≤ÂÖ≥Ê≥®</th>
                                                <th>ÁªøËâ≤Ê≠£Â∏∏</th>
                                            </tr>
                                        </thead>
                                        <tbody id="classAnalysisBody">
                                            <!-- Áè≠Á∫ßÁªüËÆ°Êï∞ÊçÆ‰ºöÂä®ÊÄÅÁîüÊàê -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- È´òÈ¢ëË∞àËØùÂ≠¶Áîü -->
                        <div class="analysis-section">
                            <h3 class="section-title">üë• È´òÈ¢ëË∞àËØùÂ≠¶Áîü</h3>
                            <div class="chart-container">
                                <div class="chart-title">Ë∞àËØùÊ¨°Êï∞ÊúÄÂ§öÁöÑÂ≠¶Áîü</div>
                                <div class="table-container">
                                    <table class="analysis-table" id="frequentStudentsTable">
                                        <thead>
                                            <tr>
                                                <th>ÂßìÂêç</th>
                                                <th>Áè≠Á∫ß</th>
                                                <th>Ë∞àËØùÊ¨°Êï∞</th>
                                                <th>È£éÈô©Á≠âÁ∫ß</th>
                                                <th>Â§ÑÂàÜËÆ∞ÂΩï</th>
                                                <th>Â≠¶Á±çÂºÇÂä®</th>
                                                <th>ÊúÄËøëË∞àËØù</th>
                                            </tr>
                                        </thead>
                                        <tbody id="frequentStudentsBody">
                                            <!-- È´òÈ¢ëË∞àËØùÂ≠¶ÁîüÊï∞ÊçÆ‰ºöÂä®ÊÄÅÁîüÊàê -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂØºÂá∫ -->
                <div id="exportTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">üì§ Êï∞ÊçÆÂØºÂá∫</h2>
                        
                        <!-- ÂØºÂá∫ÁªüËÆ° -->
                        <div class="talk-track-card">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <h4 style="margin: 0;">ÂØºÂá∫ÁªüËÆ°</h4>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">ÂÖ± <span id="totalExportCount">0</span> Êù°ËÆ∞ÂΩïÂèØÂØºÂá∫</p>
                                </div>
                                <div class="talk-count">
                                    <div class="count-item">
                                        <span class="count-number" id="exportRedCount">0</span>
                                        <span class="count-label" style="color:#c62828">Á∫¢Ëâ≤</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="exportYellowCount">0</span>
                                        <span class="count-label" style="color:#f57f17">ÈªÑËâ≤</span>
                                    </div>
                                    <div class="count-item">
                                        <span class="count-number" id="exportGreenCount">0</span>
                                        <span class="count-label" style="color:#2e7d32">ÁªøËâ≤</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="export-options" style="margin-top: 20px;">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                                <label>ÂØºÂá∫Ê†ºÂºèÔºö</label>
                                <select id="exportFormat" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                                    <option value="excel">ExcelÊñá‰ª∂ÔºàÊâÄÊúâËÆ∞ÂΩïÔºâ</option>
                                    <option value="word">WordÊñáÊ°£ÔºàÂçïÊù°ËÆ∞ÂΩïÔºâ</option>
                                    <option value="analysis">ÂàÜÊûêÊä•Âëä</option>
                                </select>
                                <label>ÂØºÂá∫ËåÉÂõ¥Ôºö</label>
                                <select id="exportRange" style="padding: 8px 15px; border-radius: 6px; border: 1px solid #ddd;">
                                    <option value="all">ÂÖ®ÈÉ®ËÆ∞ÂΩï</option>
                                    <option value="selected">‰ªÖÈÄâ‰∏≠ËÆ∞ÂΩï</option>
                                    <option value="month">ÊúÄËøë‰∏Ä‰∏™Êúà</option>
                                    <option value="quarter">ÊúÄËøë‰∏â‰∏™Êúà</option>
                                </select>
                                <button class="btn btn-success" onclick="exportData()">ÂØºÂá∫Êï∞ÊçÆ</button>
                            </div>

                            <div style="margin-top: 15px;">
                                <h3 style="margin-bottom: 10px;">ÂØºÂá∫ËØ¥Êòé</h3>
                                <p style="color: #666; line-height: 1.6;">
                                    <strong>ExcelÊñá‰ª∂ÔºàÊâÄÊúâËÆ∞ÂΩïÔºâÔºö</strong>Â∞ÜÊâÄÊúâË∞àËØùËÆ∞ÂΩïÂêàÂπ∂Âà∞‰∏Ä‰∏™ExcelÊñá‰ª∂‰∏≠<br>
                                    <strong>WordÊñáÊ°£ÔºàÂçïÊù°ËÆ∞ÂΩïÔºâÔºö</strong>Â∞ÜÂçïÊù°ËÆ∞ÂΩïÂØºÂá∫‰∏∫WordÊñáÊ°£ÔºåÊ†ºÂºè‰∏éÂéüË°®Ê†º‰∏ÄËá¥<br>
                                    <strong>ÂàÜÊûêÊä•ÂëäÔºö</strong>ÂØºÂá∫Êï∞ÊçÆÂàÜÊûêÊ®°ÂùóÁöÑÁªüËÆ°Êä•Âëä<br>
                                    <span style="color: #3498db;">Êñá‰ª∂ÂëΩÂêçËßÑÂàôÔºöÂßìÂêç_Áè≠Á∫ß_Ë∞àËØùËÆ∞ÂΩïÔºàÂ¶ÇÔºöÂº†‰∏â_ËÆ°ÁÆóÊú∫2001Áè≠_Ë∞àÂøÉË∞àËØùËÆ∞ÂΩïÔºâ</span>
                                </p>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>ÂØºÂá∫ËÆ∞ÂΩïÂàóË°®</h3>
                            <button class="btn" onclick="refreshExportList()">Âà∑Êñ∞ÂàóË°®</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th width="50"><input type="checkbox" id="selectAllExport" onchange="toggleSelectAllExport(this)"></th>
                                        <th>Ë∞àËØùÊó∂Èó¥</th>
                                        <th>Â≠¶ÁîüÂßìÂêç</th>
                                        <th>Áè≠Á∫ß</th>
                                        <th>Ë∞àËØù‰∏ªÈ¢ò</th>
                                        <th>ÂàÜÁ∫ßÂª∫ËÆÆ</th>
                                        <th>Â§ÑÂàÜËÆ∞ÂΩï</th>
                                        <th>Ë∞àËØùÊ¨°Êï∞</th>
                                    </tr>
                                </thead>
                                <tbody id="exportList">
                                    <!-- ÂØºÂá∫ÂàóË°®Âä®ÊÄÅÂä†ËΩΩ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Áî®Êà∑ÁÆ°ÁêÜÊ®°Âùó -->
                <div id="usersTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">üë§ Áî®Êà∑ÁÆ°ÁêÜ</h2>
                        
                        <!-- Áî®Êà∑ÁªüËÆ° -->
                        <div class="stats-container">
                            <div class="user-stat-card total">
                                <div class="stat-value">
                                    <span style="color: #9b59b6;" id="totalUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">‰∫∫</span>
                                </div>
                                <div class="stat-label">Áî®Êà∑ÊÄªÊï∞</div>
                            </div>
                            <div class="user-stat-card admin">
                                <div class="stat-value">
                                    <span style="color: #c62828;" id="adminUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">‰∫∫</span>
                                </div>
                                <div class="stat-label">ÁÆ°ÁêÜÂëò</div>
                            </div>
                            <div class="user-stat-card counselor">
                                <div class="stat-value">
                                    <span style="color: #27ae60;" id="counselorUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">‰∫∫</span>
                                </div>
                                <div class="stat-label">ËæÖÂØºÂëò</div>
                            </div>
                            <div class="user-stat-card active">
                                <div class="stat-value">
                                    <span style="color: #3498db;" id="activeUsersCount">0</span>
                                    <span style="font-size: 16px; color: #666;">‰∫∫</span>
                                </div>
                                <div class="stat-label">Ê¥ªË∑ÉÁî®Êà∑</div>
                            </div>
                        </div>
                        
                        <!-- Êìç‰ΩúÂå∫Âüü -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px;">Áî®Êà∑Êìç‰Ωú</h3>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="showAddUserModal()">+ Ê∑ªÂä†Áî®Êà∑</button>
                                <button class="btn btn-warning" onclick="showUserImportModal()">üì§ ÊâπÈáèÂØºÂÖ•Áî®Êà∑</button>
                                <button class="btn btn-primary" onclick="exportUsersToExcel()">ÂØºÂá∫Áî®Êà∑ÂàóË°®</button>
                                <button class="btn btn-info" onclick="downloadUserTemplate()">‰∏ãËΩΩÁî®Êà∑Ê®°Êùø</button>
                            </div>
                        </div>

                        <!-- ÊêúÁ¥¢Âå∫Âüü -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" id="searchUsersInput" class="form-control" placeholder="ÊêúÁ¥¢Áî®Êà∑Âêç„ÄÅÂßìÂêçÊàñÈÉ®Èó®..." style="flex: 1; min-width: 250px;">
                            <select id="roleFilter" class="form-control" style="max-width: 150px;">
                                <option value="">ÂÖ®ÈÉ®ËßíËâ≤</option>
                                <option value="admin">ÁÆ°ÁêÜÂëò</option>
                                <option value="counselor">ËæÖÂØºÂëò</option>
                            </select>
                            <select id="statusFilter" class="form-control" style="max-width: 150px;">
                                <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                                <option value="active">Ê¥ªË∑É</option>
                                <option value="inactive">Á¶ÅÁî®</option>
                            </select>
                            <button class="btn" onclick="searchUsers()">ÊêúÁ¥¢</button>
                            <button class="btn" onclick="clearUserSearch()">ÈáçÁΩÆ</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Áî®Êà∑Âêç</th>
                                        <th>ÂßìÂêç</th>
                                        <th>ÈÉ®Èó®/Áè≠Á∫ß</th>
                                        <th>ËßíËâ≤</th>
                                        <th>Áä∂ÊÄÅ</th>
                                        <th>ÊúÄÂêéÁôªÂΩï</th>
                                        <th>ÂàõÂª∫Êó∂Èó¥</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <!-- Áî®Êà∑Êï∞ÊçÆÂä®ÊÄÅÂä†ËΩΩ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Á≥ªÁªüËÆæÁΩÆÊ®°Âùó -->
                <div id="settingsTab" class="content-tab" style="display: none;">
                    <div class="card">
                        <h2 class="card-title">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</h2>
                        
                        <div class="system-settings-grid">
                            <div class="settings-card">
                                <h3>Á≥ªÁªü‰ø°ÊÅØ</h3>
                                <div class="settings-item">
                                    <div class="settings-label">Á≥ªÁªüÁâàÊú¨</div>
                                    <div class="settings-value">v2.0</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Êï∞ÊçÆÂ§á‰ªΩÊó∂Èó¥</div>
                                    <div class="settings-value" id="lastBackupTime">Êú™Â§á‰ªΩ</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Êï∞ÊçÆÂ≠òÂÇ®Â§ßÂ∞è</div>
                                    <div class="settings-value" id="dataStorageSize">ËÆ°ÁÆó‰∏≠...</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Ë∞àËØùËÆ∞ÂΩïÊÄªÊï∞</div>
                                    <div class="settings-value" id="totalTalkRecords">0</div>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Â≠¶ÁîüÊÄªÊï∞</div>
                                    <div class="settings-value" id="totalStudents">0</div>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>Êï∞ÊçÆÁÆ°ÁêÜ</h3>
                                <div class="settings-item">
                                    <div class="settings-label">Ëá™Âä®Â§á‰ªΩÊï∞ÊçÆ</div>
                                    <label class="settings-switch">
                                        <input type="checkbox" id="autoBackup" checked>
                                        <span class="settings-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Â§á‰ªΩÈ¢ëÁéá</div>
                                    <select id="backupFrequency" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="daily">ÊØèÂ§©</option>
                                        <option value="weekly">ÊØèÂë®</option>
                                        <option value="monthly">ÊØèÊúà</option>
                                    </select>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Êï∞ÊçÆÊ∏ÖÁêÜ</div>
                                    <button class="btn btn-warning" onclick="cleanOldData()" style="padding: 5px 10px; font-size: 12px;">Ê∏ÖÁêÜÊóßÊï∞ÊçÆ</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Á≥ªÁªüÂ§á‰ªΩ</div>
                                    <button class="btn btn-primary" onclick="backupSystemData()" style="padding: 5px 10px; font-size: 12px;">Á´ãÂç≥Â§á‰ªΩ</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Á≥ªÁªüÊÅ¢Â§ç</div>
                                    <button class="btn btn-danger" onclick="restoreSystemData()" style="padding: 5px 10px; font-size: 12px;">ÊÅ¢Â§çÊï∞ÊçÆ</button>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>ÊùÉÈôêËÆæÁΩÆ</h3>
                                <div class="settings-item">
                                    <div class="settings-label">ÂÖÅËÆ∏Áî®Êà∑Ê≥®ÂÜå</div>
                                    <label class="settings-switch">
                                        <input type="checkbox" id="allowRegistration">
                                        <span class="settings-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ÈªòËÆ§Áî®Êà∑ËßíËâ≤</div>
                                    <select id="defaultUserRole" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="counselor">ËæÖÂØºÂëò</option>
                                        <option value="admin">ÁÆ°ÁêÜÂëò</option>
                                    </select>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ÂØÜÁ†ÅÂº∫Â∫¶Ë¶ÅÊ±Ç</div>
                                    <select id="passwordStrength" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="low">‰Ωé</option>
                                        <option value="medium" selected>‰∏≠</option>
                                        <option value="high">È´ò</option>
                                    </select>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">‰ºöËØùË∂ÖÊó∂</div>
                                    <select id="sessionTimeout" class="form-control" style="width: 120px; padding: 5px;">
                                        <option value="30">30ÂàÜÈíü</option>
                                        <option value="60" selected>60ÂàÜÈíü</option>
                                        <option value="120">120ÂàÜÈíü</option>
                                        <option value="0">Ê∞∏‰∏çË∂ÖÊó∂</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>Á≥ªÁªüÁª¥Êä§</h3>
                                <div class="settings-item">
                                    <div class="settings-label">Á≥ªÁªüÊó•Âøó</div>
                                    <button class="btn btn-info" onclick="viewSystemLogs()" style="padding: 5px 10px; font-size: 12px;">Êü•ÁúãÊó•Âøó</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ÁºìÂ≠òÊ∏ÖÁêÜ</div>
                                    <button class="btn btn-warning" onclick="clearSystemCache()" style="padding: 5px 10px; font-size: 12px;">Ê∏ÖÁêÜÁºìÂ≠ò</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">ÊÄßËÉΩ‰ºòÂåñ</div>
                                    <button class="btn btn-primary" onclick="optimizeSystem()" style="padding: 5px 10px; font-size: 12px;">‰ºòÂåñÁ≥ªÁªü</button>
                                </div>
                                <div class="settings-item">
                                    <div class="settings-label">Êï∞ÊçÆÁªüËÆ°</div>
                                    <button class="btn btn-success" onclick="showDataStatistics()" style="padding: 5px 10px; font-size: 12px;">Êü•ÁúãÁªüËÆ°</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ËßíËâ≤ÊùÉÈôêËØ¥Êòé -->
                        <div class="role-permissions" style="margin-top: 20px;">
                            <h4>ËßíËâ≤ÊùÉÈôêËØ¥Êòé</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                                <div>
                                    <h5 style="color: #c62828;">ÁÆ°ÁêÜÂëòÊùÉÈôê</h5>
                                    <ul>
                                        <li>ÁÆ°ÁêÜÊâÄÊúâÁî®Êà∑Ë¥¶Êà∑</li>
                                        <li>ÊâπÈáèÂØºÂÖ•/ÂØºÂá∫Áî®Êà∑Êï∞ÊçÆ</li>
                                        <li>Êü•ÁúãÁ≥ªÁªüÊâÄÊúâË∞àËØùËÆ∞ÂΩï</li>
                                        <li>ÁÆ°ÁêÜÁ≥ªÁªüËÆæÁΩÆÂíåÈÖçÁΩÆ</li>
                                        <li>Êï∞ÊçÆÂ§á‰ªΩÂíåÊÅ¢Â§ç</li>
                                        <li>Êü•ÁúãÁ≥ªÁªüÊó•ÂøóÂíåÁªüËÆ°</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 style="color: #27ae60;">ËæÖÂØºÂëòÊùÉÈôê</h5>
                                    <ul>
                                        <li>ÁÆ°ÁêÜËá™Â∑±Ë¥üË¥£ÁöÑÂ≠¶Áîü</li>
                                        <li>ÂàõÂª∫ÂíåÊü•ÁúãË∞àËØùËÆ∞ÂΩï</li>
                                        <li>ÂØºÂá∫Ëá™Â∑±ÁöÑË∞àËØùËÆ∞ÂΩï</li>
                                        <li>Êü•ÁúãÊï∞ÊçÆÁªüËÆ°ÂíåÂàÜÊûê</li>
                                        <li>‰øÆÊîπ‰∏™‰∫∫Ë¥¶Êà∑‰ø°ÊÅØ</li>
                                        <li>Êü•ÁúãÂ≠¶ÁîüÂéÜÂè≤ËÆ∞ÂΩï</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÂ≠¶ÁîüÊ®°ÊÄÅÊ°Ü -->
    <div id="studentModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;" id="modalTitle">Ê∑ªÂä†Â≠¶Áîü</h3>
            <form id="studentForm">
                <input type="hidden" id="modalEditMode" value="false">
                <input type="hidden" id="modalOriginalStudentId" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Â≠¶Âè∑ *</label>
                        <input type="text" id="modalStudentId" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂßìÂêç *</label>
                        <input type="text" id="modalStudentName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Áè≠Á∫ß *</label>
                        <input type="text" id="modalClassName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂÆøËàç *</label>
                        <input type="text" id="modalDormitory" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÊÄßÂà´</label>
                        <select id="modalGender" class="form-control">
                            <option value="">ËØ∑ÈÄâÊã©</option>
                            <option value="Áî∑">Áî∑</option>
                            <option value="Â•≥">Â•≥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ËÅîÁ≥ªÁîµËØù</label>
                        <input type="text" id="modalPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÊîøÊ≤ªÈù¢Ë≤å</label>
                        <select id="modalPoliticalStatus" class="form-control">
                            <option value="">ËØ∑ÈÄâÊã©</option>
                            <option value="‰∏≠ÂÖ±ÂÖöÂëò">‰∏≠ÂÖ±ÂÖöÂëò</option>
                            <option value="‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò">‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò</option>
                            <option value="ÂÖ±ÈùíÂõ¢Âëò">ÂÖ±ÈùíÂõ¢Âëò</option>
                            <option value="Áæ§‰ºó">Áæ§‰ºó</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Âõ∞ÈöæËÆ§ÂÆö</label>
                        <select id="modalHardship" class="form-control">
                            <option value="">ËØ∑ÈÄâÊã©</option>
                            <option value="ÁâπÂà´Âõ∞Èöæ">ÁâπÂà´Âõ∞Èöæ</option>
                            <option value="Âõ∞Èöæ">Âõ∞Èöæ</option>
                            <option value="‰∏ÄËà¨Âõ∞Èöæ">‰∏ÄËà¨Âõ∞Èöæ</option>
                            <option value="Êó†">Êó†</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Â≠¶Á±çÂºÇÂä®</label>
                        <input type="text" id="modalStatusChange" class="form-control" placeholder="Â¶ÇÔºö‰ºëÂ≠¶„ÄÅËΩ¨‰∏ì‰∏ö„ÄÅÂ§çÂ≠¶Á≠â">
                    </div>
                    <div class="form-group">
                        <label class="form-label">È£éÈô©Á≠âÁ∫ß</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalRiskLevel" value="red">
                                <span style="color: #c62828;">Á∫¢Ëâ≤È¢ÑË≠¶</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalRiskLevel" value="yellow">
                                <span style="color: #f57f17;">ÈªÑËâ≤ÂÖ≥Ê≥®</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalRiskLevel" value="green" checked>
                                <span style="color: #2e7d32;">ÁªøËâ≤Ê≠£Â∏∏</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Â§ÑÂàÜËÆ∞ÂΩï -->
                <div class="form-group">
                    <label class="form-label">Â§ÑÂàÜËÆ∞ÂΩï</label>
                    <div id="punishmentContainer">
                        <!-- Â§ÑÂàÜËÆ∞ÂΩïÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <button type="button" class="btn" style="padding: 5px 10px; font-size: 12px; margin-top: 5px;" onclick="addPunishmentField()">+ Ê∑ªÂä†Â§ÑÂàÜËÆ∞ÂΩï</button>
                </div>
                
                <!-- Â≠¶ÁîüÁÖßÁâá -->
                <div class="form-group">
                    <label class="form-label">Â≠¶ÁîüÁÖßÁâá</label>
                    <div class="photo-upload-area" onclick="document.getElementById('studentPhotoInput').click()">
                        <div id="photoPreviewContainer">
                            <div class="photo-placeholder">ÁÇπÂáª‰∏ä‰º†ÁÖßÁâá</div>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; color: #666;">Âª∫ËÆÆÂ∞∫ÂØ∏Ôºö120√ó160pxÔºåÊîØÊåÅJPG/PNGÊ†ºÂºè</p>
                    </div>
                    <input type="file" id="studentPhotoInput" accept="image/*" style="display: none;" onchange="handleStudentPhotoUpload(event)">
                    <input type="hidden" id="modalStudentPhoto" value="">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Â§áÊ≥®</label>
                    <textarea id="modalGeneralRemark" class="form-control" rows="3" placeholder="ÂèØÂ°´ÂÜôÂÖ∂‰ªñÂ§áÊ≥®‰ø°ÊÅØ..."></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                    <button type="button" class="btn" onclick="closeStudentModal()">ÂèñÊ∂à</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÊâìÂç∞/ÂØºÂá∫È¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div id="previewModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Ë∞àËØùËÆ∞ÂΩïÈ¢ÑËßà</h3>
            <div id="docPreview" class="print-content" style="padding: 20px; background: white;">
                <!-- DOCÂÜÖÂÆπÂ∞ÜÂä®ÊÄÅÁîüÊàêÂà∞ËøôÈáå -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="exportToWord()">ÂØºÂá∫‰∏∫WordÊñáÊ°£</button>
                <button class="btn" onclick="printDocument()">Áõ¥Êé•ÊâìÂç∞</button>
                <button class="btn" onclick="closePreviewModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- ExcelÂØºÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div id="importModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ExcelÊâπÈáèÂØºÂÖ•Â≠¶ÁîüÊï∞ÊçÆ</h3>
            
            <!-- Ê≠•È™§ÊåáÁ§∫Âô® -->
            <div style="display: flex; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <div style="flex: 1; text-align: center; padding: 10px; background: #3498db; color: white; border-radius: 5px;">
                    Ê≠•È™§1: ‰∏ä‰º†Êñá‰ª∂
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    Ê≠•È™§2: È¢ÑËßàÊï∞ÊçÆ
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    Ê≠•È™§3: ÂØºÂÖ•ÂÆåÊàê
                </div>
            </div>
            
            <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
            <div id="uploadStep">
                <div class="file-upload-area" id="fileDropArea">
                    <div style="font-size: 48px;">üìÅ</div>
                    <p><strong>ÁÇπÂáªÊàñÊãñÊãΩExcelÊñá‰ª∂Âà∞ËøôÈáå</strong></p>
                    <p>ÊîØÊåÅÊ†ºÂºè: .xlsx, .xls</p>
                    <p>ËØ∑‰ΩøÁî®Á≥ªÁªüÊèê‰æõÁöÑÊ®°ÊùøÊ†ºÂºè</p>
                    <div class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
                        ÈÄâÊã©ExcelÊñá‰ª∂
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                    <h4 style="margin-bottom: 10px;">üìã Ê®°ÊùøÊ†ºÂºèËØ¥Êòé</h4>
                    <p style="margin-bottom: 5px;">ExcelÊñá‰ª∂ÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãÂàóÔºàÈ°∫Â∫è‰∏çÈôêÔºâÔºö</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li><strong>Â≠¶Âè∑</strong> (ÂøÖÂ°´ÔºåÊñáÊú¨Ê†ºÂºè)</li>
                        <li><strong>ÂßìÂêç</strong> (ÂøÖÂ°´)</li>
                        <li><strong>Áè≠Á∫ß</strong> (ÂøÖÂ°´)</li>
                        <li><strong>ÂÆøËàç</strong> (ÈÄâÂ°´)</li>
                        <li><strong>ÊÄßÂà´</strong> (ÈÄâÂ°´ÔºåÁî∑/Â•≥)</li>
                        <li><strong>ËÅîÁ≥ªÁîµËØù</strong> (ÈÄâÂ°´)</li>
                        <li><strong>ÊîøÊ≤ªÈù¢Ë≤å</strong> (ÈÄâÂ°´Ôºå‰∏≠ÂÖ±ÂÖöÂëò/ÂÖ±ÈùíÂõ¢Âëò/Áæ§‰ºóÁ≠â)</li>
                        <li><strong>Âõ∞ÈöæËÆ§ÂÆö</strong> (ÈÄâÂ°´ÔºåÁâπÂà´Âõ∞Èöæ/Âõ∞Èöæ/‰∏ÄËà¨Âõ∞Èöæ/Êó†)</li>
                        <li><strong>È£éÈô©Á≠âÁ∫ß</strong> (ÈÄâÂ°´ÔºåÁ∫¢Ëâ≤È¢ÑË≠¶/ÈªÑËâ≤ÂÖ≥Ê≥®/ÁªøËâ≤Ê≠£Â∏∏)</li>
                        <li><strong>Â§ÑÂàÜËÆ∞ÂΩï</strong> (ÈÄâÂ°´ÔºåÂ§ö‰∏™Â§ÑÂàÜÁî®ÂàÜÂè∑ÂàÜÈöî)</li>
                        <li><strong>Â≠¶Á±çÂºÇÂä®</strong> (ÈÄâÂ°´ÔºåÂ¶ÇÔºö‰ºëÂ≠¶„ÄÅËΩ¨‰∏ì‰∏ö„ÄÅÂ§çÂ≠¶Á≠â)</li>
                        <li><strong>Â§áÊ≥®</strong> (ÈÄâÂ°´)</li>
                    </ul>
                    <button class="btn btn-info" onclick="downloadExcelTemplate()">‰∏ãËΩΩExcelÊ®°Êùø</button>
                </div>
            </div>
            
            <!-- Êï∞ÊçÆÈ¢ÑËßàÂå∫Âüü -->
            <div id="previewStep" style="display: none;">
                <h4 style="margin-bottom: 15px;">Êï∞ÊçÆÈ¢ÑËßà (Ââç10Ë°å)</h4>
                <div id="previewTableContainer" class="table-container">
                    <!-- È¢ÑËßàË°®Ê†ºÂ∞ÜÂä®ÊÄÅÁîüÊàêÂà∞ËøôÈáå -->
                </div>
                
                <div id="importSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <p><strong>ÂØºÂÖ•ÊëòË¶ÅÔºö</strong></p>
                    <p>ÊúâÊïàÊï∞ÊçÆ: <span id="validCount">0</span> Êù°</p>
                    <p>Êó†ÊïàÊï∞ÊçÆ: <span id="invalidCount">0</span> Êù°</p>
                    <p>ÈáçÂ§çÊï∞ÊçÆ: <span id="duplicateCount">0</span> Êù° (Â∞ÜÊõ¥Êñ∞)</p>
                </div>
                
                <div class="import-progress" id="importProgress" style="display: none;">
                    <h4 style="margin-bottom: 10px;">ÂØºÂÖ•ËøõÂ∫¶</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-primary" id="confirmImportBtn" onclick="confirmImport()">Á°ÆËÆ§ÂØºÂÖ•</button>
                    <button class="btn" onclick="resetImport()">ÈáçÊñ∞‰∏ä‰º†</button>
                    <button class="btn" onclick="closeImportModal()">ÂèñÊ∂à</button>
                </div>
            </div>
            
            <!-- ÂØºÂÖ•ÂÆåÊàêÂå∫Âüü -->
            <div id="completeStep" style="display: none; text-align: center;">
                <div style="font-size: 64px; color: #27ae60; margin-bottom: 20px;">‚úÖ</div>
                <h3>ÂØºÂÖ•ÂÆåÊàêÔºÅ</h3>
                <p>ÊàêÂäüÂØºÂÖ• <span id="successCount">0</span> Êù°Â≠¶ÁîüËÆ∞ÂΩï</p>
                <p>Â§±Ë¥• <span id="failCount">0</span> Êù°</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="closeImportModal()">ÂÆåÊàê</button>
                    <button class="btn" onclick="resetImport()">ÁªßÁª≠ÂØºÂÖ•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Â≠¶ÁîüËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div id="studentDetailModal" class="modal">
        <div class="modal-content student-detail-modal">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Â≠¶ÁîüËØ¶ÁªÜ‰ø°ÊÅØ</h3>
            <div id="studentDetailContent">
                <!-- Â≠¶ÁîüËØ¶ÊÉÖÂÜÖÂÆπÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="editStudentFromDetail()">ÁºñËæë</button>
                <button class="btn" onclick="closeStudentDetailModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- ÁºñËæëË∞àËØùËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="editTalkModal" class="modal">
        <div class="modal-content edit-talk-modal">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ÁºñËæëË∞àËØùËÆ∞ÂΩï</h3>
            <div id="editTalkFormContainer">
                <!-- ÁºñËæëË°®ÂçïÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="updateTalkRecord()">‰øùÂ≠ò‰øÆÊîπ</button>
                <button class="btn" onclick="closeEditTalkModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÁî®Êà∑Ê®°ÊÄÅÊ°Ü -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: #2c3e50;" id="userModalTitle">Ê∑ªÂä†Áî®Êà∑</h3>
            <form id="userForm">
                <input type="hidden" id="userEditMode" value="false">
                <input type="hidden" id="originalUsername" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Áî®Êà∑Âêç *</label>
                        <input type="text" id="modalUsername" class="form-control" required oninput="checkUsernameAvailability()">
                        <div id="usernameAvailability" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂßìÂêç *</label>
                        <input type="text" id="modalFullname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂØÜÁ†Å <span id="passwordRequired">*</span></label>
                        <input type="password" id="modalPassword" class="form-control" oninput="checkPasswordStrength()">
                        <div class="password-strength" id="passwordStrengthIndicator">
                            <div class="password-strength-fill"></div>
                        </div>
                        <div id="passwordStrengthText" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Á°ÆËÆ§ÂØÜÁ†Å <span id="confirmPasswordRequired">*</span></label>
                        <input type="password" id="modalConfirmPassword" class="form-control">
                        <div id="passwordMatch" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÈÉ®Èó®/Áè≠Á∫ß</label>
                        <input type="text" id="modalDepartment" class="form-control" placeholder="Â¶ÇÔºöËÆ°ÁÆóÊú∫Â≠¶Èô¢">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ËÅîÁ≥ªÁîµËØù</label>
                        <input type="text" id="modalUserPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÈÇÆÁÆ±</label>
                        <input type="email" id="modalEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ËßíËâ≤ *</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserRole" value="admin">
                                <span style="color: #c62828; font-weight: bold;">ÁÆ°ÁêÜÂëò</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserRole" value="counselor" checked>
                                <span style="color: #27ae60; font-weight: bold;">ËæÖÂØºÂëò</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Áä∂ÊÄÅ *</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserStatus" value="active" checked>
                                <span style="color: #27ae60; font-weight: bold;">Ê¥ªË∑É</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="modalUserStatus" value="inactive">
                                <span style="color: #95a5a6; font-weight: bold;">Á¶ÅÁî®</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Â§áÊ≥®</label>
                    <textarea id="modalUserRemark" class="form-control" rows="2" placeholder="ÂèØÂ°´ÂÜôÁî®Êà∑Â§áÊ≥®‰ø°ÊÅØ..."></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                    <button type="button" class="btn" onclick="closeUserModal()">ÂèñÊ∂à</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Áî®Êà∑ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content user-detail-modal">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Áî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØ</h3>
            <div id="userDetailContent">
                <!-- Áî®Êà∑ËØ¶ÊÉÖÂÜÖÂÆπÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="editUserFromDetail()">ÁºñËæë</button>
                <button class="btn" onclick="closeUserDetailModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <!-- Áî®Êà∑ÊâπÈáèÂØºÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div id="userImportModal" class="modal">
        <div class="modal-content modal-lg">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ExcelÊâπÈáèÂØºÂÖ•Áî®Êà∑Êï∞ÊçÆ</h3>
            
            <!-- Ê≠•È™§ÊåáÁ§∫Âô® -->
            <div style="display: flex; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <div style="flex: 1; text-align: center; padding: 10px; background: #3498db; color: white; border-radius: 5px;">
                    Ê≠•È™§1: ‰∏ä‰º†Êñá‰ª∂
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    Ê≠•È™§2: È¢ÑËßàÊï∞ÊçÆ
                </div>
                <div style="flex: 1; text-align: center; padding: 10px; background: #ddd; color: #666; border-radius: 5px;">
                    Ê≠•È™§3: ÂØºÂÖ•ÂÆåÊàê
                </div>
            </div>
            
            <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
            <div id="userUploadStep">
                <div class="file-upload-area" id="userFileDropArea">
                    <div style="font-size: 48px;">üë§</div>
                    <p><strong>ÁÇπÂáªÊàñÊãñÊãΩExcelÊñá‰ª∂Âà∞ËøôÈáå</strong></p>
                    <p>ÊîØÊåÅÊ†ºÂºè: .xlsx, .xls</p>
                    <p>ËØ∑‰ΩøÁî®Á≥ªÁªüÊèê‰æõÁöÑÊ®°ÊùøÊ†ºÂºè</p>
                    <div class="file-upload-btn" onclick="document.getElementById('userFileInput').click()">
                        ÈÄâÊã©ExcelÊñá‰ª∂
                    </div>
                    <input type="file" id="userFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleUserFileSelect(event)">
                </div>
                
                <div class="user-import-instruction">
                    <h4>üìã Áî®Êà∑ÂØºÂÖ•Ê®°ÊùøÊ†ºÂºèËØ¥Êòé</h4>
                    <p style="margin-bottom: 5px;">ExcelÊñá‰ª∂ÂøÖÈ°ªÂåÖÂê´‰ª•‰∏ãÂàóÔºàÈ°∫Â∫è‰∏çÈôêÔºâÔºö</p>
                    <ul>
                        <li><strong>Áî®Êà∑Âêç</strong> (ÂøÖÂ°´ÔºåÂîØ‰∏ÄÊ†áËØÜ)</li>
                        <li><strong>ÂßìÂêç</strong> (ÂøÖÂ°´)</li>
                        <li><strong>ÂØÜÁ†Å</strong> (ÂøÖÂ°´ÔºåËá≥Â∞ë6‰Ωç)</li>
                        <li><strong>ÈÉ®Èó®/Áè≠Á∫ß</strong> (ÈÄâÂ°´)</li>
                        <li><strong>ËÅîÁ≥ªÁîµËØù</strong> (ÈÄâÂ°´)</li>
                        <li><strong>ÈÇÆÁÆ±</strong> (ÈÄâÂ°´)</li>
                        <li><strong>ËßíËâ≤</strong> (ÈÄâÂ°´Ôºåadmin/counselorÔºåÈªòËÆ§counselor)</li>
                        <li><strong>Áä∂ÊÄÅ</strong> (ÈÄâÂ°´Ôºåactive/inactiveÔºåÈªòËÆ§active)</li>
                        <li><strong>Â§áÊ≥®</strong> (ÈÄâÂ°´)</li>
                    </ul>
                    <button class="btn btn-info" onclick="downloadUserTemplate()">‰∏ãËΩΩÁî®Êà∑Ê®°Êùø</button>
                </div>
            </div>
            
            <!-- Êï∞ÊçÆÈ¢ÑËßàÂå∫Âüü -->
            <div id="userPreviewStep" style="display: none;">
                <h4 style="margin-bottom: 15px;">Áî®Êà∑Êï∞ÊçÆÈ¢ÑËßà (Ââç10Ë°å)</h4>
                <div id="userPreviewTableContainer" class="table-container">
                    <!-- Áî®Êà∑È¢ÑËßàË°®Ê†ºÂ∞ÜÂä®ÊÄÅÁîüÊàêÂà∞ËøôÈáå -->
                </div>
                
                <div id="userImportSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <p><strong>ÂØºÂÖ•ÊëòË¶ÅÔºö</strong></p>
                    <p>ÊúâÊïàÊï∞ÊçÆ: <span id="userValidCount">0</span> Êù°</p>
                    <p>Êó†ÊïàÊï∞ÊçÆ: <span id="userInvalidCount">0</span> Êù°</p>
                    <p>ÈáçÂ§çÊï∞ÊçÆ: <span id="userDuplicateCount">0</span> Êù° (Â∞ÜÊõ¥Êñ∞)</p>
                </div>
                
                <div class="import-progress" id="userImportProgress" style="display: none;">
                    <h4 style="margin-bottom: 10px;">ÂØºÂÖ•ËøõÂ∫¶</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="userProgressFill"></div>
                    </div>
                    <div class="progress-text" id="userProgressText">0%</div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-primary" id="userConfirmImportBtn" onclick="confirmUserImport()">Á°ÆËÆ§ÂØºÂÖ•</button>
                    <button class="btn" onclick="resetUserImport()">ÈáçÊñ∞‰∏ä‰º†</button>
                    <button class="btn" onclick="closeUserImportModal()">ÂèñÊ∂à</button>
                </div>
            </div>
            
            <!-- ÂØºÂÖ•ÂÆåÊàêÂå∫Âüü -->
            <div id="userCompleteStep" style="display: none; text-align: center;">
                <div style="font-size: 64px; color: #27ae60; margin-bottom: 20px;">‚úÖ</div>
                <h3>Áî®Êà∑ÂØºÂÖ•ÂÆåÊàêÔºÅ</h3>
                <p>ÊàêÂäüÂØºÂÖ• <span id="userSuccessCount">0</span> ‰∏™Áî®Êà∑</p>
                <p>Â§±Ë¥• <span id="userFailCount">0</span> ‰∏™</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="closeUserImportModal()">ÂÆåÊàê</button>
                    <button class="btn" onclick="resetUserImport()">ÁªßÁª≠ÂØºÂÖ•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈáçÁΩÆÂØÜÁ†ÅÊ®°ÊÄÅÊ°Ü -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">ÈáçÁΩÆÁî®Êà∑ÂØÜÁ†Å</h3>
            <div id="resetPasswordContent">
                <p>Á°ÆÂÆöË¶ÅÈáçÁΩÆÁî®Êà∑ <strong id="resetUsername"></strong> ÁöÑÂØÜÁ†ÅÂêóÔºü</p>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">ÈáçÁΩÆÂêéÂØÜÁ†ÅÂ∞ÜÂèò‰∏∫Ôºö<strong>123456</strong></p>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmResetPassword()">Á°ÆËÆ§ÈáçÁΩÆ</button>
                <button class="btn" onclick="closeResetPasswordModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <script>
        // ÁÆ°ÁêÜÂëòË¥¶Âè∑‰ø°ÊÅØ
        const ADMIN_USERNAME = 'ËµµÊ¢¶Â©∑';
        const ADMIN_PASSWORD = 'CJZFZMT';
        
        // ÂàùÂßãÂåñÊï∞ÊçÆÂ≠òÂÇ®
        let talkRecords = JSON.parse(localStorage.getItem('talkRecords') || '[]');
        let students = JSON.parse(localStorage.getItem('students') || '[]');
        let drafts = JSON.parse(localStorage.getItem('talkDrafts') || '[]');
        let users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
        let systemSettings = JSON.parse(localStorage.getItem('systemSettings') || '{}');
        let currentUser = null;
        
        // ExcelÂØºÂÖ•Áõ∏ÂÖ≥ÂèòÈáè
        let importData = [];
        let importPreviewData = [];
        let userImportData = [];
        let userImportPreviewData = [];
        
        // ÂΩìÂâçÊó∂Èó¥Á≠õÈÄâÂô®
        let currentTimeFilter = 'all';
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÁ≥ªÁªüÊï∞ÊçÆ
            initSystemData();
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const savedUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainSystem();
                } catch (e) {
                    console.error('Ëß£ÊûêÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', e);
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
            
            // ËÆæÁΩÆÈªòËÆ§Ë∞àËØùÊó∂Èó¥‰∏∫ÂΩìÂâçÊó∂Èó¥
            const talkTimeInput = document.getElementById('talkTime');
            if (talkTimeInput) {
                talkTimeInput.value = getCurrentDateTime();
            }
            
            // ËÆæÁΩÆË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
            const talkForm = document.getElementById('talkForm');
            if (talkForm) {
                talkForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTalkRecord();
                });
            }
            
            const studentForm = document.getElementById('studentForm');
            if (studentForm) {
                studentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveStudent();
                });
            }
            
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveUser();
                });
            }
            
            // ÂàùÂßãÂåñÊñá‰ª∂ÊãñÊãΩÂäüËÉΩ
            initFileDrop();
            initUserFileDrop();
            
            // ÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ
            initSampleData();
            
            // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            updateRecordStats();
            
            // Ê£ÄÊü•URLÂèÇÊï∞ÔºåÁúãÊòØÂê¶ÈúÄË¶ÅÁºñËæëËÆ∞ÂΩï
            checkUrlParams();
            
            // Êõ¥Êñ∞Á≥ªÁªüËÆæÁΩÆÊòæÁ§∫
            updateSystemSettingsDisplay();
        });
        
        // ÂàùÂßãÂåñÁ≥ªÁªüÊï∞ÊçÆ
        function initSystemData() {
            // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑Êï∞ÊçÆÔºåÂàùÂßãÂåñÁÆ°ÁêÜÂëòË¥¶Âè∑
            if (users.length === 0) {
                const adminUser = {
                    id: Date.now(),
                    username: ADMIN_USERNAME,
                    password: ADMIN_PASSWORD,
                    fullname: 'ËµµÊ¢¶Â©∑',
                    role: 'admin',
                    department: 'Ë¥¢ÁªèÊîøÊ≥ïÂ≠¶Èô¢',
                    phone: '',
                    email: '',
                    status: 'active',
                    createTime: new Date().toISOString(),
                    lastLogin: null,
                    remark: 'Á≥ªÁªüÁÆ°ÁêÜÂëò'
                };
                
                users.push(adminUser);
                localStorage.setItem('systemUsers', JSON.stringify(users));
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÁ≥ªÁªüËÆæÁΩÆÔºåÂàùÂßãÂåñÈªòËÆ§ËÆæÁΩÆ
            if (Object.keys(systemSettings).length === 0) {
                systemSettings = {
                    autoBackup: true,
                    backupFrequency: 'weekly',
                    allowRegistration: false,
                    defaultUserRole: 'counselor',
                    passwordStrength: 'medium',
                    sessionTimeout: 60,
                    lastBackupTime: null
                };
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
            }
        }
        
        // Êõ¥Êñ∞Á≥ªÁªüËÆæÁΩÆÊòæÁ§∫
        function updateSystemSettingsDisplay() {
            document.getElementById('autoBackup').checked = systemSettings.autoBackup || false;
            document.getElementById('backupFrequency').value = systemSettings.backupFrequency || 'weekly';
            document.getElementById('allowRegistration').checked = systemSettings.allowRegistration || false;
            document.getElementById('defaultUserRole').value = systemSettings.defaultUserRole || 'counselor';
            document.getElementById('passwordStrength').value = systemSettings.passwordStrength || 'medium';
            document.getElementById('sessionTimeout').value = systemSettings.sessionTimeout || 60;
            
            // Êõ¥Êñ∞ÊúÄÂêéÂ§á‰ªΩÊó∂Èó¥
            if (systemSettings.lastBackupTime) {
                document.getElementById('lastBackupTime').textContent = formatDate(systemSettings.lastBackupTime);
            }
            
            // ËÆ°ÁÆóÊï∞ÊçÆÂ≠òÂÇ®Â§ßÂ∞è
            updateDataStorageSize();
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            updateSystemStatistics();
        }
        
        // Êõ¥Êñ∞Êï∞ÊçÆÂ≠òÂÇ®Â§ßÂ∞èÊòæÁ§∫
        function updateDataStorageSize() {
            let totalSize = 0;
            
            // ËÆ°ÁÆóÂêÑ‰∏™Êï∞ÊçÆÈ°πÁöÑÂ§ßÂ∞è
            const dataItems = [
                { key: 'talkRecords', name: 'Ë∞àËØùËÆ∞ÂΩï' },
                { key: 'students', name: 'Â≠¶ÁîüÊï∞ÊçÆ' },
                { key: 'systemUsers', name: 'Áî®Êà∑Êï∞ÊçÆ' },
                { key: 'systemSettings', name: 'Á≥ªÁªüËÆæÁΩÆ' },
                { key: 'talkDrafts', name: 'Ë∞àËØùËçâÁ®ø' }
            ];
            
            dataItems.forEach(item => {
                const data = localStorage.getItem(item.key);
                if (data) {
                    totalSize += new Blob([data]).size;
                }
            });
            
            // ËΩ¨Êç¢‰∏∫KBÊàñMB
            let sizeText;
            if (totalSize < 1024) {
                sizeText = totalSize + ' B';
            } else if (totalSize < 1024 * 1024) {
                sizeText = (totalSize / 1024).toFixed(2) + ' KB';
            } else {
                sizeText = (totalSize / (1024 * 1024)).toFixed(2) + ' MB';
            }
            
            document.getElementById('dataStorageSize').textContent = sizeText;
        }
        
        // Êõ¥Êñ∞Á≥ªÁªüÁªüËÆ°‰ø°ÊÅØ
        function updateSystemStatistics() {
            document.getElementById('totalTalkRecords').textContent = talkRecords.length;
            document.getElementById('totalStudents').textContent = students.length;
        }
        
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            const draftId = urlParams.get('draft');
            
            if (editId) {
                loadTalkRecordForEdit(parseInt(editId));
            } else if (draftId) {
                loadDraftForEdit(parseInt(draftId));
            }
        }
        
        // ÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('username').focus();
        }
        
        // ÁôªÂΩïÂäüËÉΩ
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('ËØ∑ËæìÂÖ•Ë¥¶Âè∑ÂíåÂØÜÁ†ÅÔºÅ', 'error');
                return;
            }
            
            // Êü•ÊâæÁî®Êà∑
            const user = users.find(u => u.username === username && u.status === 'active');
            
            if (!user) {
                showMessage('Ë¥¶Âè∑‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Á¶ÅÁî®ÔºÅ', 'error');
                return;
            }
            
            // È™åËØÅÂØÜÁ†Å
            if (user.password !== password) {
                showMessage('ÂØÜÁ†ÅÈîôËØØÔºÅ', 'error');
                return;
            }
            
            // Êõ¥Êñ∞ÊúÄÂêéÁôªÂΩïÊó∂Èó¥
            user.lastLogin = new Date().toISOString();
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            // ‰øùÂ≠òÁôªÂΩïÁä∂ÊÄÅÂíåÂΩìÂâçÁî®Êà∑
            currentUser = user;
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            showMainSystem();
            showMessage('ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
        }
        
        function showMainSystem() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            
            // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫
            if (currentUser) {
                document.getElementById('counselorName').textContent = currentUser.fullname;
                document.getElementById('currentUserInfo').innerHTML = `
                    ${currentUser.role === 'admin' ? 'üëë ÁÆ°ÁêÜÂëòÔºö' : 'üë§ ËæÖÂØºÂëòÔºö'}
                    <span id="counselorName">${currentUser.fullname}</span>
                `;
                document.getElementById('counselorSignature').value = currentUser.fullname;
                
                // Ê†πÊçÆÁî®Êà∑ËßíËâ≤ÊòæÁ§∫/ÈöêËóèÁÆ°ÁêÜËèúÂçï
                if (currentUser.role === 'admin') {
                    document.getElementById('userManagementTab').style.display = 'block';
                    document.getElementById('systemSettingsTab').style.display = 'block';
                } else {
                    document.getElementById('userManagementTab').style.display = 'none';
                    document.getElementById('systemSettingsTab').style.display = 'none';
                }
            }
            
            // Âä†ËΩΩÊï∞ÊçÆ
            loadStudentsTable();
            loadTalkRecords();
            loadExportList();
            
            // Â¶ÇÊûúÊòØÁÆ°ÁêÜÂëòÔºåÂä†ËΩΩÁî®Êà∑ÂàóË°®
            if (currentUser && currentUser.role === 'admin') {
                loadUsersTable();
                updateUserStats();
            }
            
            // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
            updateRecordStats();
        }
        
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLoginPage();
            showMessage('Â∑≤ÈÄÄÂá∫ÁôªÂΩï', 'info');
        }
        
        function switchTab(tabName) {
            // Êõ¥Êñ∞ÂØºËà™Áä∂ÊÄÅ
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const tabIndex = {
                'record': 0,
                'students': 1,
                'history': 2,
                'analysis': 3,
                'export': 4,
                'users': 5,
                'settings': 6
            }[tabName];
            
            if (tabIndex !== undefined) {
                document.querySelectorAll('.nav-item')[tabIndex].classList.add('active');
            }
            
            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            const titles = {
                'record': 'Êñ∞Âª∫Ë∞àËØùËÆ∞ÂΩï',
                'students': 'Â≠¶ÁîüÊï∞ÊçÆÂ∫ì',
                'history': 'ÂéÜÂè≤ËÆ∞ÂΩïÊü•ËØ¢',
                'analysis': 'Êï∞ÊçÆÂàÜÊûê',
                'export': 'Êï∞ÊçÆÂØºÂá∫',
                'users': 'Áî®Êà∑ÁÆ°ÁêÜ',
                'settings': 'Á≥ªÁªüËÆæÁΩÆ'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Êñ∞Âª∫Ë∞àËØùËÆ∞ÂΩï';
            
            // ÊòæÁ§∫ÂØπÂ∫îÂÜÖÂÆπÂå∫Âüü
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            // Â¶ÇÊûúÊòØÂ≠¶ÁîüÊï∞ÊçÆÂ∫ìÈ°µÈù¢ÔºåÊõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            if (tabName === 'students') {
                updateStudentStats();
                updateBatchActionState();
            }
            
            // Â¶ÇÊûúÊòØÂéÜÂè≤ËÆ∞ÂΩïÈ°µÈù¢ÔºåÊõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            if (tabName === 'history') {
                updateTalkTrackingStats();
                updateBatchTalkActionState();
            }
            
            // Â¶ÇÊûúÊòØÊï∞ÊçÆÂàÜÊûêÈ°µÈù¢ÔºåÊõ¥Êñ∞ÂàÜÊûêÊï∞ÊçÆ
            if (tabName === 'analysis') {
                updateAnalysisData();
            }
            
            // Â¶ÇÊûúÊòØÂØºÂá∫È°µÈù¢ÔºåÈáçÊñ∞Âä†ËΩΩÂàóË°®
            if (tabName === 'export') {
                loadExportList();
            }
            
            // Â¶ÇÊûúÊòØËÆ∞ÂΩïÈ°µÈù¢ÔºåÊòæÁ§∫ÁªüËÆ°Âç°Áâá
            if (tabName === 'record') {
                updateRecordStats();
                const recordStatsCard = document.getElementById('recordStatsCard');
                if (recordStatsCard) {
                    recordStatsCard.style.display = 'block';
                }
            }
            
            // Â¶ÇÊûúÊòØÁî®Êà∑ÁÆ°ÁêÜÈ°µÈù¢ÔºåÊõ¥Êñ∞Áî®Êà∑ÁªüËÆ°
            if (tabName === 'users') {
                updateUserStats();
            }
            
            // Â¶ÇÊûúÊòØÁ≥ªÁªüËÆæÁΩÆÈ°µÈù¢ÔºåÊõ¥Êñ∞ËÆæÁΩÆÊòæÁ§∫
            if (tabName === 'settings') {
                updateSystemSettingsDisplay();
            }
        }
        
        function showMessage(message, type) {
            // ÁßªÈô§Áé∞ÊúâÁöÑÊ∂àÊÅØ
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // ÂàõÂª∫Êñ∞ÁöÑÊ∂àÊÅØ
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ÁßíÂêéÁßªÈô§Ê∂àÊÅØ
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
        
        // ==================== Áî®Êà∑ÁÆ°ÁêÜÂäüËÉΩ ====================
        
        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        function loadUsersTable(searchTerm = '', role = '', status = '') {
            const tbody = document.getElementById('usersList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let filteredUsers = users;
            
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(user =>
                    user.username.includes(searchTerm) ||
                    user.fullname.includes(searchTerm) ||
                    (user.department && user.department.includes(searchTerm))
                );
            }
            
            if (role) {
                filteredUsers = filteredUsers.filter(user => user.role === role);
            }
            
            if (status) {
                filteredUsers = filteredUsers.filter(user => user.status === status);
            }
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</td></tr>';
                return;
            }
            
            filteredUsers.forEach((user) => {
                const row = document.createElement('tr');
                
                // ËßíËâ≤Ê†áÁ≠æ
                let roleTag = '';
                if (user.role === 'admin') {
                    roleTag = '<span class="user-role-tag user-role-admin">ÁÆ°ÁêÜÂëò</span>';
                } else {
                    roleTag = '<span class="user-role-tag user-role-counselor">ËæÖÂØºÂëò</span>';
                }
                
                // Áä∂ÊÄÅÊòæÁ§∫
                let statusDisplay = '';
                if (user.status === 'active') {
                    statusDisplay = '<span class="user-status-active">Ê¥ªË∑É</span>';
                } else {
                    statusDisplay = '<span class="user-status-inactive">Á¶ÅÁî®</span>';
                }
                
                // ÊúÄÂêéÁôªÂΩïÊó∂Èó¥
                let lastLoginDisplay = '‰ªéÊú™ÁôªÂΩï';
                if (user.lastLogin) {
                    lastLoginDisplay = formatDate(user.lastLogin);
                }
                
                // ÂàõÂª∫Êó∂Èó¥
                const createTimeDisplay = formatDate(user.createTime);
                
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullname}</td>
                    <td>${user.department || '-'}</td>
                    <td>${roleTag}</td>
                    <td>${statusDisplay}</td>
                    <td>${lastLoginDisplay}</td>
                    <td>${createTimeDisplay}</td>
                    <td>
                        <button class="user-action-btn user-action-edit" onclick="showUserDetail('${user.username}')">Êü•Áúã</button>
                        <button class="user-action-btn user-action-edit" onclick="editUser('${user.username}')">ÁºñËæë</button>
                        <button class="user-action-btn user-action-reset" onclick="resetUserPassword('${user.username}')">ÈáçÁΩÆÂØÜÁ†Å</button>
                        <button class="user-action-btn user-action-toggle" onclick="toggleUserStatus('${user.username}')">${user.status === 'active' ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}</button>
                        ${user.username !== ADMIN_USERNAME ? 
                            `<button class="user-action-btn user-action-delete" onclick="deleteUser('${user.username}')">Âà†Èô§</button>` : 
                            ''
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ÊêúÁ¥¢Áî®Êà∑
        function searchUsers() {
            const searchTerm = document.getElementById('searchUsersInput').value;
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            loadUsersTable(searchTerm, role, status);
        }
        
        // Ê∏ÖÁ©∫Áî®Êà∑ÊêúÁ¥¢
        function clearUserSearch() {
            document.getElementById('searchUsersInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            loadUsersTable();
        }
        
        // Êõ¥Êñ∞Áî®Êà∑ÁªüËÆ°
        function updateUserStats() {
            const totalUsers = users.length;
            const adminUsers = users.filter(u => u.role === 'admin').length;
            const counselorUsers = users.filter(u => u.role === 'counselor').length;
            const activeUsers = users.filter(u => u.status === 'active').length;
            
            document.getElementById('totalUsersCount').textContent = totalUsers;
            document.getElementById('adminUsersCount').textContent = adminUsers;
            document.getElementById('counselorUsersCount').textContent = counselorUsers;
            document.getElementById('activeUsersCount').textContent = activeUsers;
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†Áî®Êà∑Ê®°ÊÄÅÊ°Ü
        function showAddUserModal() {
            const modal = document.getElementById('userModal');
            if (modal) {
                document.getElementById('userModalTitle').textContent = 'Ê∑ªÂä†Áî®Êà∑';
                document.getElementById('userEditMode').value = 'false';
                document.getElementById('originalUsername').value = '';
                document.getElementById('userForm').reset();
                
                // ÈáçÁΩÆÂØÜÁ†ÅÁõ∏ÂÖ≥ÊòæÁ§∫
                document.getElementById('passwordRequired').style.display = 'inline';
                document.getElementById('confirmPasswordRequired').style.display = 'inline';
                document.getElementById('modalPassword').required = true;
                document.getElementById('modalConfirmPassword').required = true;
                
                // ÈáçÁΩÆÊèêÁ§∫‰ø°ÊÅØ
                document.getElementById('usernameAvailability').innerHTML = '';
                document.getElementById('passwordStrengthText').innerHTML = '';
                document.getElementById('passwordMatch').innerHTML = '';
                document.getElementById('passwordStrengthIndicator').className = 'password-strength';
                
                modal.style.display = 'flex';
            }
        }
        
        // ÂÖ≥Èó≠Áî®Êà∑Ê®°ÊÄÅÊ°Ü
        function closeUserModal() {
            const modal = document.getElementById('userModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Ê£ÄÊü•Áî®Êà∑ÂêçÂèØÁî®ÊÄß
        function checkUsernameAvailability() {
            const username = document.getElementById('modalUsername').value.trim();
            const availabilityDiv = document.getElementById('usernameAvailability');
            
            if (!username) {
                availabilityDiv.innerHTML = '';
                return;
            }
            
            // Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶Â∑≤Â≠òÂú®
            const existingUser = users.find(u => u.username === username);
            const isEditMode = document.getElementById('userEditMode').value === 'true';
            const originalUsername = document.getElementById('originalUsername').value;
            
            if (existingUser && (!isEditMode || (isEditMode && username !== originalUsername))) {
                availabilityDiv.innerHTML = '<span style="color:#c62828">Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºÅ</span>';
                return false;
            } else {
                availabilityDiv.innerHTML = '<span style="color:#27ae60">Áî®Êà∑ÂêçÂèØÁî®</span>';
                return true;
            }
        }
        
        // Ê£ÄÊü•ÂØÜÁ†ÅÂº∫Â∫¶
        function checkPasswordStrength() {
            const password = document.getElementById('modalPassword').value;
            const strengthIndicator = document.getElementById('passwordStrengthIndicator');
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (!password) {
                strengthIndicator.className = 'password-strength';
                strengthText.innerHTML = '';
                return 'empty';
            }
            
            let strength = 0;
            
            // Ê£ÄÊü•ÂØÜÁ†ÅÈïøÂ∫¶
            if (password.length >= 6) strength++;
            if (password.length >= 8) strength++;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Êï∞Â≠ó
            if (/\d/.test(password)) strength++;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Â∞èÂÜôÂ≠óÊØç
            if (/[a-z]/.test(password)) strength++;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Â§ßÂÜôÂ≠óÊØç
            if (/[A-Z]/.test(password)) strength++;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÁâπÊÆäÂ≠óÁ¨¶
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            if (strength <= 2) {
                strengthIndicator.className = 'password-strength weak';
                strengthText.innerHTML = '<span style="color:#c62828">ÂØÜÁ†ÅÂº∫Â∫¶ÔºöÂº±</span>';
                return 'weak';
            } else if (strength <= 4) {
                strengthIndicator.className = 'password-strength medium';
                strengthText.innerHTML = '<span style="color:#f39c12">ÂØÜÁ†ÅÂº∫Â∫¶Ôºö‰∏≠</span>';
                return 'medium';
            } else {
                strengthIndicator.className = 'password-strength strong';
                strengthText.innerHTML = '<span style="color:#27ae60">ÂØÜÁ†ÅÂº∫Â∫¶ÔºöÂº∫</span>';
                return 'strong';
            }
        }
        
        // ‰øùÂ≠òÁî®Êà∑
        function saveUser() {
            try {
                const isEditMode = document.getElementById('userEditMode').value === 'true';
                const originalUsername = document.getElementById('originalUsername').value;
                
                const username = document.getElementById('modalUsername').value.trim();
                const fullname = document.getElementById('modalFullname').value.trim();
                const password = document.getElementById('modalPassword').value;
                const confirmPassword = document.getElementById('modalConfirmPassword').value;
                const department = document.getElementById('modalDepartment').value.trim();
                const phone = document.getElementById('modalUserPhone').value.trim();
                const email = document.getElementById('modalEmail').value.trim();
                const role = document.querySelector('input[name="modalUserRole"]:checked')?.value || 'counselor';
                const status = document.querySelector('input[name="modalUserStatus"]:checked')?.value || 'active';
                const remark = document.getElementById('modalUserRemark').value.trim();
                
                // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
                if (!username || !fullname) {
                    showMessage('Áî®Êà∑ÂêçÂíåÂßìÂêç‰∏∫ÂøÖÂ°´È°πÔºÅ', 'error');
                    return;
                }
                
                // Ê£ÄÊü•Áî®Êà∑ÂêçÂèØÁî®ÊÄß
                if (!checkUsernameAvailability()) {
                    return;
                }
                
                // Â¶ÇÊûúÊòØÊ∑ªÂä†Ê®°ÂºèÊàñ‰øÆÊîπÂØÜÁ†ÅÔºåÈ™åËØÅÂØÜÁ†Å
                if (!isEditMode || password) {
                    if (!password) {
                        showMessage('ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºÅ', 'error');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showMessage('ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë6‰ΩçÔºÅ', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showMessage('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºÅ', 'error');
                        return;
                    }
                    
                    // Ê£ÄÊü•ÂØÜÁ†ÅÂº∫Â∫¶
                    const passwordStrength = checkPasswordStrength();
                    const requiredStrength = systemSettings.passwordStrength || 'medium';
                    
                    if (requiredStrength === 'medium' && passwordStrength === 'weak') {
                        showMessage('ÂØÜÁ†ÅÂº∫Â∫¶‰∏çË∂≥ÔºåËØ∑‰ΩøÁî®Êõ¥Â§çÊùÇÁöÑÂØÜÁ†ÅÔºÅ', 'error');
                        return;
                    }
                    
                    if (requiredStrength === 'high' && (passwordStrength === 'weak' || passwordStrength === 'medium')) {
                        showMessage('ÂØÜÁ†ÅÂº∫Â∫¶‰∏çË∂≥ÔºåËØ∑‰ΩøÁî®ÂåÖÂê´Â§ßÂ∞èÂÜôÂ≠óÊØç„ÄÅÊï∞Â≠óÂíåÁâπÊÆäÂ≠óÁ¨¶ÁöÑÂØÜÁ†ÅÔºÅ', 'error');
                        return;
                    }
                }
                
                // ÊûÑÂª∫Áî®Êà∑ÂØπË±°
                const user = {
                    id: isEditMode ? users.find(u => u.username === originalUsername)?.id || Date.now() : Date.now(),
                    username: username,
                    fullname: fullname,
                    department: department,
                    phone: phone,
                    email: email,
                    role: role,
                    status: status,
                    remark: remark,
                    updateTime: new Date().toISOString()
                };
                
                // Â§ÑÁêÜÂØÜÁ†Å
                if (isEditMode) {
                    if (password) {
                        user.password = password;
                    } else {
                        // ‰øùÊåÅÂéüÂØÜÁ†Å
                        const originalUser = users.find(u => u.username === originalUsername);
                        if (originalUser) {
                            user.password = originalUser.password;
                        }
                    }
                    user.createTime = users.find(u => u.username === originalUsername)?.createTime || new Date().toISOString();
                    user.lastLogin = users.find(u => u.username === originalUsername)?.lastLogin || null;
                } else {
                    user.password = password;
                    user.createTime = new Date().toISOString();
                    user.lastLogin = null;
                }
                
                if (isEditMode) {
                    // Êõ¥Êñ∞Áé∞ÊúâÁî®Êà∑
                    const index = users.findIndex(u => u.username === originalUsername);
                    if (index !== -1) {
                        users[index] = user;
                        
                        // Â¶ÇÊûúÂΩìÂâçÁî®Êà∑‰øÆÊîπ‰∫ÜËá™Â∑±ÁöÑ‰ø°ÊÅØÔºåÊõ¥Êñ∞ÂΩìÂâçÁî®Êà∑
                        if (currentUser && currentUser.username === originalUsername) {
                            currentUser = user;
                            localStorage.setItem('currentUser', JSON.stringify(user));
                            
                            // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
                            document.getElementById('counselorName').textContent = user.fullname;
                            document.getElementById('counselorSignature').value = user.fullname;
                        }
                    }
                } else {
                    // Ê∑ªÂä†Êñ∞Áî®Êà∑
                    users.push(user);
                }
                
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                updateUserStats();
                closeUserModal();
                showMessage('Áî®Êà∑‰ø°ÊÅØ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
                
            } catch (error) {
                console.error('‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÊó∂Âá∫ÈîôÔºö', error);
                showMessage('‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // ÁºñËæëÁî®Êà∑
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (user) {
                document.getElementById('userModalTitle').textContent = 'ÁºñËæëÁî®Êà∑';
                document.getElementById('userEditMode').value = 'true';
                document.getElementById('originalUsername').value = user.username;
                
                document.getElementById('modalUsername').value = user.username;
                document.getElementById('modalFullname').value = user.fullname;
                document.getElementById('modalDepartment').value = user.department || '';
                document.getElementById('modalUserPhone').value = user.phone || '';
                document.getElementById('modalEmail').value = user.email || '';
                document.getElementById('modalUserRemark').value = user.remark || '';
                
                // ËÆæÁΩÆËßíËâ≤
                document.querySelector(`input[name="modalUserRole"][value="${user.role}"]`).checked = true;
                
                // ËÆæÁΩÆÁä∂ÊÄÅ
                document.querySelector(`input[name="modalUserStatus"][value="${user.status}"]`).checked = true;
                
                // ÂØÜÁ†ÅÂ≠óÊÆµÁïôÁ©∫Ôºà‰∏çÊòæÁ§∫ÂéüÂØÜÁ†ÅÔºâ
                document.getElementById('modalPassword').value = '';
                document.getElementById('modalConfirmPassword').value = '';
                
                // ‰øÆÊîπÂØÜÁ†ÅÁõ∏ÂÖ≥ÊòæÁ§∫
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('confirmPasswordRequired').style.display = 'none';
                document.getElementById('modalPassword').required = false;
                document.getElementById('modalConfirmPassword').required = false;
                document.getElementById('modalPassword').placeholder = 'ÁïôÁ©∫Ë°®Á§∫‰∏ç‰øÆÊîπÂØÜÁ†Å';
                
                // ÈáçÁΩÆÊèêÁ§∫‰ø°ÊÅØ
                document.getElementById('usernameAvailability').innerHTML = '';
                document.getElementById('passwordStrengthText').innerHTML = '';
                document.getElementById('passwordMatch').innerHTML = '';
                document.getElementById('passwordStrengthIndicator').className = 'password-strength';
                
                document.getElementById('userModal').style.display = 'flex';
            }
        }
        
        // ÊòæÁ§∫Áî®Êà∑ËØ¶ÊÉÖ
        function showUserDetail(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // ËßíËâ≤ÊòæÁ§∫
            let roleDisplay = '';
            if (user.role === 'admin') {
                roleDisplay = '<span class="user-role-tag user-role-admin">ÁÆ°ÁêÜÂëò</span>';
            } else {
                roleDisplay = '<span class="user-role-tag user-role-counselor">ËæÖÂØºÂëò</span>';
            }
            
            // Áä∂ÊÄÅÊòæÁ§∫
            let statusDisplay = '';
            if (user.status === 'active') {
                statusDisplay = '<span class="user-status-active">Ê¥ªË∑É</span>';
            } else {
                statusDisplay = '<span class="user-status-inactive">Á¶ÅÁî®</span>';
            }
            
            // ÊúÄÂêéÁôªÂΩïÊó∂Èó¥
            let lastLoginDisplay = '‰ªéÊú™ÁôªÂΩï';
            if (user.lastLogin) {
                lastLoginDisplay = formatDate(user.lastLogin);
            }
            
            // ÂàõÂª∫Êó∂Èó¥
            const createTimeDisplay = formatDate(user.createTime);
            
            // Êõ¥Êñ∞Êó∂Èó¥
            let updateTimeDisplay = 'Êó†';
            if (user.updateTime) {
                updateTimeDisplay = formatDate(user.updateTime);
            }
            
            const detailContent = `
                <div class="user-detail-grid">
                    <div class="user-detail-item">
                        <div class="user-detail-label">Áî®Êà∑Âêç</div>
                        <div class="user-detail-value">${user.username}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ÂßìÂêç</div>
                        <div class="user-detail-value">${user.fullname}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ÈÉ®Èó®/Áè≠Á∫ß</div>
                        <div class="user-detail-value">${user.department || 'Êú™ËÆæÁΩÆ'}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ËÅîÁ≥ªÁîµËØù</div>
                        <div class="user-detail-value">${user.phone || 'Êú™ËÆæÁΩÆ'}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ÈÇÆÁÆ±</div>
                        <div class="user-detail-value">${user.email || 'Êú™ËÆæÁΩÆ'}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ËßíËâ≤</div>
                        <div class="user-detail-value">${roleDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Áä∂ÊÄÅ</div>
                        <div class="user-detail-value">${statusDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ÊúÄÂêéÁôªÂΩïÊó∂Èó¥</div>
                        <div class="user-detail-value">${lastLoginDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ÂàõÂª∫Êó∂Èó¥</div>
                        <div class="user-detail-value">${createTimeDisplay}</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥</div>
                        <div class="user-detail-value">${updateTimeDisplay}</div>
                    </div>
                </div>
                
                ${user.remark ? `
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Â§áÊ≥®</h4>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${user.remark}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('userDetailContent').innerHTML = detailContent;
            document.getElementById('userDetailModal').style.display = 'flex';
        }
        
        // ÂÖ≥Èó≠Áî®Êà∑ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function closeUserDetailModal() {
            document.getElementById('userDetailModal').style.display = 'none';
        }
        
        // ‰ªéËØ¶ÊÉÖÈ°µÁºñËæëÁî®Êà∑
        function editUserFromDetail() {
            const modal = document.getElementById('userDetailModal');
            const username = document.querySelector('#userDetailContent .user-detail-value').textContent;
            
            closeUserDetailModal();
            editUser(username);
        }
        
        // ÈáçÁΩÆÁî®Êà∑ÂØÜÁ†Å
        function resetUserPassword(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            document.getElementById('resetUsername').textContent = username;
            document.getElementById('resetPasswordModal').style.display = 'flex';
            
            // ‰øùÂ≠òË¶ÅÈáçÁΩÆÁöÑÁî®Êà∑Âêç
            document.getElementById('resetPasswordModal').setAttribute('data-username', username);
        }
        
        // ÂÖ≥Èó≠ÈáçÁΩÆÂØÜÁ†ÅÊ®°ÊÄÅÊ°Ü
        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }
        
        // Á°ÆËÆ§ÈáçÁΩÆÂØÜÁ†Å
        function confirmResetPassword() {
            const username = document.getElementById('resetPasswordModal').getAttribute('data-username');
            const user = users.find(u => u.username === username);
            
            if (user) {
                user.password = '123456';
                user.updateTime = new Date().toISOString();
                
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                closeResetPasswordModal();
                showMessage(`Áî®Êà∑ ${username} ÁöÑÂØÜÁ†ÅÂ∑≤ÈáçÁΩÆ‰∏∫Ôºö123456`, 'success');
            }
        }
        
        // ÂàáÊç¢Áî®Êà∑Áä∂ÊÄÅ
        function toggleUserStatus(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            // ‰∏çËÉΩÁ¶ÅÁî®Ëá™Â∑±
            if (currentUser && currentUser.username === username) {
                showMessage('‰∏çËÉΩÁ¶ÅÁî®ÂΩìÂâçÁôªÂΩïÁöÑË¥¶Âè∑ÔºÅ', 'error');
                return;
            }
            
            // ‰∏çËÉΩÁ¶ÅÁî®ÁÆ°ÁêÜÂëòË¥¶Âè∑
            if (username === ADMIN_USERNAME) {
                showMessage('‰∏çËÉΩÁ¶ÅÁî®Á≥ªÁªüÁÆ°ÁêÜÂëòË¥¶Âè∑ÔºÅ', 'error');
                return;
            }
            
            const newStatus = user.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            
            if (confirm(`Á°ÆÂÆöË¶Å${action}Áî®Êà∑ ${username} ÂêóÔºü`)) {
                user.status = newStatus;
                user.updateTime = new Date().toISOString();
                
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                updateUserStats();
                showMessage(`Áî®Êà∑ ${username} Â∑≤${action}`, 'success');
            }
        }
        
        // Âà†Èô§Áî®Êà∑
        function deleteUser(username) {
            // ‰∏çËÉΩÂà†Èô§Ëá™Â∑±
            if (currentUser && currentUser.username === username) {
                showMessage('‰∏çËÉΩÂà†Èô§ÂΩìÂâçÁôªÂΩïÁöÑË¥¶Âè∑ÔºÅ', 'error');
                return;
            }
            
            // ‰∏çËÉΩÂà†Èô§ÁÆ°ÁêÜÂëòË¥¶Âè∑
            if (username === ADMIN_USERNAME) {
                showMessage('‰∏çËÉΩÂà†Èô§Á≥ªÁªüÁÆ°ÁêÜÂëòË¥¶Âè∑ÔºÅ', 'error');
                return;
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ ${username} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                loadUsersTable();
                updateUserStats();
                showMessage(`Áî®Êà∑ ${username} Â∑≤Âà†Èô§`, 'success');
            }
        }
        
        // ==================== Áî®Êà∑ÊâπÈáèÂØºÂÖ•ÂäüËÉΩ ====================
        
        // ÊòæÁ§∫Áî®Êà∑ÂØºÂÖ•Ê®°ÊÄÅÊ°Ü
        function showUserImportModal() {
            resetUserImport();
            document.getElementById('userImportModal').style.display = 'flex';
        }
        
        // ÂÖ≥Èó≠Áî®Êà∑ÂØºÂÖ•Ê®°ÊÄÅÊ°Ü
        function closeUserImportModal() {
            document.getElementById('userImportModal').style.display = 'none';
        }
        
        // ÈáçÁΩÆÁî®Êà∑ÂØºÂÖ•
        function resetUserImport() {
            userImportData = [];
            userImportPreviewData = [];
            
            // ÈáçÁΩÆÊ≠•È™§ÊòæÁ§∫
            document.getElementById('userUploadStep').style.display = 'block';
            document.getElementById('userPreviewStep').style.display = 'none';
            document.getElementById('userCompleteStep').style.display = 'none';
            
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            const userFileInput = document.getElementById('userFileInput');
            if (userFileInput) {
                userFileInput.value = '';
            }
            
            // ÈáçÁΩÆÈ¢ÑËßàË°®Ê†º
            const userPreviewTableContainer = document.getElementById('userPreviewTableContainer');
            if (userPreviewTableContainer) {
                userPreviewTableContainer.innerHTML = '';
            }
        }
        
        // ÂàùÂßãÂåñÁî®Êà∑Êñá‰ª∂ÊãñÊãΩ
        function initUserFileDrop() {
            const dropArea = document.getElementById('userFileDropArea');
            if (!dropArea) return;
            
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });
            
            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
            });
            
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    handleUserFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        }
        
        // Â§ÑÁêÜÁî®Êà∑Êñá‰ª∂ÈÄâÊã©
        function handleUserFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('ËØ∑ÈÄâÊã©ExcelÊñá‰ª∂Ôºà.xlsx Êàñ .xls Ê†ºÂºèÔºâ', 'error');
                return;
            }
            
            showMessage('Ê≠£Âú®ËØªÂèñExcelÊñá‰ª∂...', 'info');
            
            // ‰ΩøÁî®FileReaderËØªÂèñÊñá‰ª∂
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    
                    // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™Â∑•‰ΩúË°®
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Â∞ÜÂ∑•‰ΩúË°®ËΩ¨Êç¢‰∏∫JSONÔºàÂåÖÂê´Á©∫ÂçïÂÖÉÊ†ºÔºâ
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                        header: 1, 
                        defval: '',
                        blankrows: true
                    });
                    
                    if (jsonData.length <= 1) {
                        showMessage('ExcelÊñá‰ª∂Ê≤°ÊúâÊï∞ÊçÆÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇËØ∑Á°Æ‰øùËá≥Â∞ëÊúâÊï∞ÊçÆË°å„ÄÇ', 'error');
                        return;
                    }
                    
                    // Â§ÑÁêÜÁî®Êà∑ExcelÊï∞ÊçÆ
                    processUserExcelData(jsonData);
                    
                } catch (error) {
                    console.error('ËØªÂèñExcelÊñá‰ª∂Êó∂Âá∫ÈîôÔºö', error);
                    showMessage(`ËØªÂèñExcelÊñá‰ª∂Â§±Ë¥•Ôºö${error.message}„ÄÇËØ∑Á°Æ‰øùÊñá‰ª∂Ê†ºÂºèÊ≠£Á°Æ„ÄÇ`, 'error');
                }
            };
            
            reader.onerror = function(e) {
                console.error('Êñá‰ª∂ËØªÂèñÈîôËØØÔºö', e);
                showMessage('ËØªÂèñÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Â§ÑÁêÜÁî®Êà∑ExcelÊï∞ÊçÆ
        function processUserExcelData(jsonData) {
            // Ëé∑ÂèñË°®Â§¥Ë°å
            const headers = jsonData[0];
            
            // Ê†áÂáÜÂåñË°®Â§¥ÂêçÁß∞Êò†Â∞Ñ
            const headerMapping = {
                'Áî®Êà∑Âêç': ['Áî®Êà∑Âêç', 'Ë¥¶Âè∑', 'username', 'Username', 'Áî®Êà∑Ë¥¶Âè∑'],
                'ÂßìÂêç': ['ÂßìÂêç', 'ÂêçÂ≠ó', 'fullname', 'Fullname', 'Áî®Êà∑ÂßìÂêç'],
                'ÂØÜÁ†Å': ['ÂØÜÁ†Å', 'password', 'Password'],
                'ÈÉ®Èó®/Áè≠Á∫ß': ['ÈÉ®Èó®/Áè≠Á∫ß', 'ÈÉ®Èó®', 'Áè≠Á∫ß', 'department', 'Department', 'Áè≠Á∫ßÈÉ®Èó®'],
                'ËÅîÁ≥ªÁîµËØù': ['ËÅîÁ≥ªÁîµËØù', 'ÁîµËØù', 'ÊâãÊú∫', 'phone', 'Phone', 'ËÅîÁ≥ªÁîµËØù'],
                'ÈÇÆÁÆ±': ['ÈÇÆÁÆ±', 'ÁîµÂ≠êÈÇÆ‰ª∂', 'email', 'Email'],
                'ËßíËâ≤': ['ËßíËâ≤', 'Áî®Êà∑ËßíËâ≤', 'role', 'Role'],
                'Áä∂ÊÄÅ': ['Áä∂ÊÄÅ', 'Áî®Êà∑Áä∂ÊÄÅ', 'status', 'Status'],
                'Â§áÊ≥®': ['Â§áÊ≥®', 'ËØ¥Êòé', 'remark', 'Remark']
            };
            
            // ÂàõÂª∫ÂÆûÈôÖÂàóÁ¥¢ÂºïÊò†Â∞Ñ
            const headerMap = {};
            
            // Êü•ÊâæÂêÑÂàóÁ¥¢Âºï
            headers.forEach((header, index) => {
                if (header) {
                    const headerStr = header.toString().trim();
                    
                    // ÈÅçÂéÜÊò†Â∞ÑË°®ÔºåÊâæÂà∞ÂåπÈÖçÁöÑÂàó
                    for (const [standardName, possibleNames] of Object.entries(headerMapping)) {
                        if (possibleNames.some(name => headerStr.includes(name) || name.includes(headerStr))) {
                            headerMap[standardName] = index;
                            break;
                        }
                    }
                }
            });
            
            // Ê£ÄÊü•ÂøÖÈúÄÂàó
            const requiredColumns = ['Áî®Êà∑Âêç', 'ÂßìÂêç', 'ÂØÜÁ†Å'];
            const missingColumns = requiredColumns.filter(col => headerMap[col] === undefined);
            
            if (missingColumns.length > 0) {
                showMessage(`ExcelÁº∫Â∞ëÂøÖÈúÄÂàóÔºö${missingColumns.join('„ÄÅ')}„ÄÇËØ∑‰∏ãËΩΩÊ®°ÊùøÂπ∂ÊåâÊ®°ÊùøÊ†ºÂºèÂ°´ÂÜô„ÄÇ`, 'error');
                return;
            }
            
            // Â§ÑÁêÜÊï∞ÊçÆË°å
            userImportData = [];
            let validCount = 0;
            let invalidCount = 0;
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // Ë∑≥ËøáÁ©∫Ë°å
                if (!row || row.length === 0 || row.every(cell => cell === null || cell === undefined || cell.toString().trim() === '')) {
                    continue;
                }
                
                // ÊèêÂèñÊï∞ÊçÆ
                const getCellValue = (columnName) => {
                    const index = headerMap[columnName];
                    if (index !== undefined && row[index] !== undefined && row[index] !== null) {
                        return row[index].toString().trim();
                    }
                    return '';
                };
                
                const username = getCellValue('Áî®Êà∑Âêç');
                const fullname = getCellValue('ÂßìÂêç');
                const password = getCellValue('ÂØÜÁ†Å');
                
                // È™åËØÅÂøÖÈúÄÂ≠óÊÆµ
                if (!username || !fullname || !password) {
                    invalidCount++;
                    continue;
                }
                
                // È™åËØÅÂØÜÁ†ÅÈïøÂ∫¶
                if (password.length < 6) {
                    invalidCount++;
                    continue;
                }
                
                // ÊûÑÂª∫Áî®Êà∑ÂØπË±°
                const user = {
                    username: username,
                    fullname: fullname,
                    password: password,
                    department: getCellValue('ÈÉ®Èó®/Áè≠Á∫ß'),
                    phone: getCellValue('ËÅîÁ≥ªÁîµËØù'),
                    email: getCellValue('ÈÇÆÁÆ±'),
                    remark: getCellValue('Â§áÊ≥®')
                };
                
                // Â§ÑÁêÜËßíËâ≤
                const roleStr = getCellValue('ËßíËâ≤');
                if (roleStr) {
                    const roleLower = roleStr.toLowerCase();
                    if (roleLower.includes('admin') || roleLower.includes('ÁÆ°ÁêÜÂëò')) {
                        user.role = 'admin';
                    } else {
                        user.role = 'counselor';
                    }
                } else {
                    user.role = systemSettings.defaultUserRole || 'counselor';
                }
                
                // Â§ÑÁêÜÁä∂ÊÄÅ
                const statusStr = getCellValue('Áä∂ÊÄÅ');
                if (statusStr) {
                    const statusLower = statusStr.toLowerCase();
                    if (statusLower.includes('inactive') || statusLower.includes('Á¶ÅÁî®') || statusLower.includes('ÂÅúÁî®')) {
                        user.status = 'inactive';
                    } else {
                        user.status = 'active';
                    }
                } else {
                    user.status = 'active';
                }
                
                userImportData.push(user);
                validCount++;
            }
            
            if (userImportData.length === 0) {
                showMessage('ExcelÊñá‰ª∂‰∏≠Ê≤°ÊúâÊúâÊïàÁöÑÁî®Êà∑Êï∞ÊçÆ„ÄÇËØ∑Á°Æ‰øùÊï∞ÊçÆÊ†ºÂºèÊ≠£Á°Æ„ÄÇ', 'error');
                return;
            }
            
            // ÁîüÊàêÈ¢ÑËßàÊï∞ÊçÆÔºàÊúÄÂ§ö10Ë°åÔºâ
            userImportPreviewData = userImportData.slice(0, 10);
            
            // Ê£ÄÊü•ÈáçÂ§çÊï∞ÊçÆ
            const existingUsernames = users.map(u => u.username);
            const duplicateCount = userImportData.filter(u => existingUsernames.includes(u.username)).length;
            
            // Êõ¥Êñ∞ÊëòË¶Å‰ø°ÊÅØ
            document.getElementById('userValidCount').textContent = validCount;
            document.getElementById('userInvalidCount').textContent = invalidCount;
            document.getElementById('userDuplicateCount').textContent = duplicateCount;
            
            // ÁîüÊàêÈ¢ÑËßàË°®Ê†º
            generateUserPreviewTable();
            
            // ÂàáÊç¢Âà∞È¢ÑËßàÊ≠•È™§
            document.getElementById('userUploadStep').style.display = 'none';
            document.getElementById('userPreviewStep').style.display = 'block';
            
            showMessage(`ÊàêÂäüËØªÂèñ ${validCount} Êù°ÊúâÊïàÊï∞ÊçÆÔºå${invalidCount} Êù°Êó†ÊïàÊï∞ÊçÆ`, 'success');
        }
        
        // ÁîüÊàêÁî®Êà∑È¢ÑËßàË°®Ê†º
        function generateUserPreviewTable() {
            const container = document.getElementById('userPreviewTableContainer');
            let html = '<table class="preview-table">';
            
            // Ë°®Â§¥
            html += '<thead><tr>';
            html += '<th>Áî®Êà∑Âêç</th>';
            html += '<th>ÂßìÂêç</th>';
            html += '<th>ÈÉ®Èó®/Áè≠Á∫ß</th>';
            html += '<th>ËßíËâ≤</th>';
            html += '<th>Áä∂ÊÄÅ</th>';
            html += '<th>Áä∂ÊÄÅ</th>';
            html += '</tr></thead>';
            
            // Êï∞ÊçÆË°å
            html += '<tbody>';
            
            const existingUsernames = users.map(u => u.username);
            
            userImportPreviewData.forEach((user, index) => {
                const isDuplicate = existingUsernames.includes(user.username);
                const rowClass = isDuplicate ? 'invalid' : 'valid';
                
                // ËßíËâ≤ÊòæÁ§∫
                let roleDisplay = '';
                if (user.role === 'admin') {
                    roleDisplay = '<span style="color:#c62828;font-weight:bold;">ÁÆ°ÁêÜÂëò</span>';
                } else {
                    roleDisplay = '<span style="color:#27ae60;">ËæÖÂØºÂëò</span>';
                }
                
                // Áä∂ÊÄÅÊòæÁ§∫
                let statusDisplay = '';
                if (user.status === 'active') {
                    statusDisplay = '<span style="color:#27ae60;font-weight:bold;">Ê¥ªË∑É</span>';
                } else {
                    statusDisplay = '<span style="color:#95a5a6;">Á¶ÅÁî®</span>';
                }
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${user.username}</td>`;
                html += `<td>${user.fullname}</td>`;
                html += `<td>${user.department || '-'}</td>`;
                html += `<td>${roleDisplay}</td>`;
                html += `<td>${statusDisplay}</td>`;
                html += `<td>${isDuplicate ? '<span style="color:#c62828;">ÈáçÂ§ç</span>' : '<span style="color:#2e7d32;">ÊúâÊïà</span>'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // Ê∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØ
            if (userImportData.length > 10) {
                html += `<p style="text-align:center;color:#666;margin-top:10px;">‰ªÖÊòæÁ§∫Ââç10Ë°åÊï∞ÊçÆÔºåÂÖ± ${userImportData.length} Ë°åÊï∞ÊçÆ</p>`;
            }
            
            container.innerHTML = html;
        }
        
        // Á°ÆËÆ§ÂØºÂÖ•Áî®Êà∑
        function confirmUserImport() {
            const existingUsernames = users.map(u => u.username);
            let successCount = 0;
            let failCount = 0;
            
            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            document.getElementById('userImportProgress').style.display = 'block';
            const progressFill = document.getElementById('userProgressFill');
            const progressText = document.getElementById('userProgressText');
            
            // ÂàÜÊâπÂØºÂÖ•
            const batchSize = 50;
            const totalBatches = Math.ceil(userImportData.length / batchSize);
            let currentBatch = 0;
            
            function importUserBatch() {
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, userImportData.length);
                
                for (let i = start; i < end; i++) {
                    const userData = userImportData[i];
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈáçÂ§ç
                    if (!existingUsernames.includes(userData.username)) {
                        // Ê∑ªÂä†ÂàõÂª∫Êó∂Èó¥Á≠â‰ø°ÊÅØ
                        const newUser = {
                            ...userData,
                            id: Date.now() + i,
                            createTime: new Date().toISOString(),
                            lastLogin: null,
                            updateTime: new Date().toISOString()
                        };
                        
                        users.push(newUser);
                        successCount++;
                    } else {
                        // Êõ¥Êñ∞Áé∞ÊúâÁî®Êà∑‰ø°ÊÅØÔºàÈô§‰∫ÜÂØÜÁ†ÅÔºâ
                        const existingIndex = users.findIndex(u => u.username === userData.username);
                        if (existingIndex >= 0) {
                            // ‰øùÁïôÂéüÂØÜÁ†Å
                            const originalPassword = users[existingIndex].password;
                            users[existingIndex] = { 
                                ...users[existingIndex], 
                                ...userData,
                                password: originalPassword, // ‰øùÁïôÂéüÂØÜÁ†ÅÔºå‰∏çÊõ¥Êñ∞
                                updateTime: new Date().toISOString()
                            };
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                }
                
                // Êõ¥Êñ∞ËøõÂ∫¶
                currentBatch++;
                const progress = Math.round((currentBatch / totalBatches) * 100);
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${progress}% (${currentBatch * batchSize}/${userImportData.length})`;
                
                if (currentBatch < totalBatches) {
                    // ÁªßÁª≠‰∏ã‰∏ÄÊâπ
                    setTimeout(importUserBatch, 10);
                } else {
                    // ÂØºÂÖ•ÂÆåÊàê
                    localStorage.setItem('systemUsers', JSON.stringify(users));
                    
                    // Êõ¥Êñ∞ÂÆåÊàêÈ°µÈù¢
                    document.getElementById('userSuccessCount').textContent = successCount;
                    document.getElementById('userFailCount').textContent = failCount;
                    
                    // ÂàáÊç¢Âà∞ÂÆåÊàêÊ≠•È™§
                    document.getElementById('userPreviewStep').style.display = 'none';
                    document.getElementById('userCompleteStep').style.display = 'block';
                    
                    // Âà∑Êñ∞Áî®Êà∑Ë°®Ê†ºÂíåÁªüËÆ°‰ø°ÊÅØ
                    loadUsersTable();
                    updateUserStats();
                    
                    showMessage(`ÊàêÂäüÂØºÂÖ• ${successCount} ‰∏™Áî®Êà∑`, 'success');
                }
            }
            
            // ÂºÄÂßãÂØºÂÖ•
            importUserBatch();
        }
        
        // ‰∏ãËΩΩÁî®Êà∑Ê®°Êùø
        function downloadUserTemplate() {
            if (typeof XLSX === 'undefined') {
                showMessage('ExcelÂ§ÑÁêÜÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                return;
            }
            
            const templateData = [
                ['Áî®Êà∑Âêç', 'ÂßìÂêç', 'ÂØÜÁ†Å', 'ÈÉ®Èó®/Áè≠Á∫ß', 'ËÅîÁ≥ªÁîµËØù', 'ÈÇÆÁÆ±', 'ËßíËâ≤', 'Áä∂ÊÄÅ', 'Â§áÊ≥®'],
                ['zhangshan', 'Âº†‰∏â', 'zhangshan123', 'ËÆ°ÁÆóÊú∫Â≠¶Èô¢', '13800138000', 'zhangshan@example.com', 'counselor', 'active', 'ËÆ°ÁÆóÊú∫Â≠¶Èô¢ËæÖÂØºÂëò'],
                ['lisi', 'ÊùéÂõõ', 'lisi123456', 'ËΩØ‰ª∂Â∑•Á®ã2001Áè≠', '13800138001', 'lisi@example.com', 'counselor', 'active', 'ËΩØ‰ª∂Â∑•Á®ã2001Áè≠ËæÖÂØºÂëò'],
                ['wangwu', 'Áéã‰∫î', 'wangwu123', 'Ë¥¢ÁªèÊîøÊ≥ïÂ≠¶Èô¢', '13800138002', 'wangwu@example.com', 'admin', 'active', 'Á≥ªÁªüÁÆ°ÁêÜÂëò'],
                ['zhaoliu', 'ËµµÂÖ≠', 'zhaoliu123', '‰∫∫Â∑•Êô∫ËÉΩÂ≠¶Èô¢', '13800138003', 'zhaoliu@example.com', 'counselor', 'inactive', 'Â∑≤Á¶ªËÅå'],
                ['qianqi', 'Èí±‰∏É', 'qianqi123', 'Êï∞ÊçÆÁßëÂ≠¶2001Áè≠', '13800138004', 'qianqi@example.com', 'counselor', 'active', 'Êï∞ÊçÆÁßëÂ≠¶2001Áè≠ËæÖÂØºÂëò']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Áî®Êà∑Êï∞ÊçÆ');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Áî®Êà∑Êï∞ÊçÆÂØºÂÖ•Ê®°Êùø.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Áî®Êà∑Ê®°Êùø‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
        }
        
        // ÂØºÂá∫Áî®Êà∑ÂàóË°®Âà∞Excel
        function exportUsersToExcel() {
            if (typeof XLSX === 'undefined') {
                showMessage('ExcelÂ§ÑÁêÜÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                return;
            }
            
            if (users.length === 0) {
                showMessage('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÁî®Êà∑Êï∞ÊçÆÔºÅ', 'error');
                return;
            }
            
            const exportData = [
                ['Áî®Êà∑Âêç', 'ÂßìÂêç', 'ÈÉ®Èó®/Áè≠Á∫ß', 'ËÅîÁ≥ªÁîµËØù', 'ÈÇÆÁÆ±', 'ËßíËâ≤', 'Áä∂ÊÄÅ', 'ÊúÄÂêéÁôªÂΩïÊó∂Èó¥', 'ÂàõÂª∫Êó∂Èó¥', 'Â§áÊ≥®']
            ];
            
            users.forEach(user => {
                // ËΩ¨Êç¢ËßíËâ≤‰∏∫‰∏≠Êñá
                let roleText = 'ËæÖÂØºÂëò';
                if (user.role === 'admin') {
                    roleText = 'ÁÆ°ÁêÜÂëò';
                }
                
                // ËΩ¨Êç¢Áä∂ÊÄÅ‰∏∫‰∏≠Êñá
                let statusText = 'Ê¥ªË∑É';
                if (user.status === 'inactive') {
                    statusText = 'Á¶ÅÁî®';
                }
                
                // ÊúÄÂêéÁôªÂΩïÊó∂Èó¥
                let lastLoginText = '‰ªéÊú™ÁôªÂΩï';
                if (user.lastLogin) {
                    lastLoginText = formatDate(user.lastLogin);
                }
                
                // ÂàõÂª∫Êó∂Èó¥
                const createTimeText = formatDate(user.createTime);
                
                exportData.push([
                    user.username,
                    user.fullname,
                    user.department || '',
                    user.phone || '',
                    user.email || '',
                    roleText,
                    statusText,
                    lastLoginText,
                    createTimeText,
                    user.remark || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Áî®Êà∑Êï∞ÊçÆ');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Áî®Êà∑ÂàóË°®_${date}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`Áî®Êà∑Êï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºåÂÖ±ÂØºÂá∫ ${users.length} Êù°ËÆ∞ÂΩï`, 'success');
        }
        
        // ==================== Á≥ªÁªüËÆæÁΩÆÂäüËÉΩ ====================
        
        // Á≥ªÁªüÊï∞ÊçÆÂ§á‰ªΩ
        function backupSystemData() {
            try {
                // Êî∂ÈõÜÊâÄÊúâÁ≥ªÁªüÊï∞ÊçÆ
                const backupData = {
                    talkRecords: talkRecords,
                    students: students,
                    systemUsers: users,
                    systemSettings: systemSettings,
                    talkDrafts: drafts,
                    backupTime: new Date().toISOString()
                };
                
                // ÂàõÂª∫Â§á‰ªΩÊñá‰ª∂
                const backupStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([backupStr], { type: 'application/json' });
                const date = new Date();
                const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}`;
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Á≥ªÁªüÂ§á‰ªΩ_${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Êõ¥Êñ∞ÊúÄÂêéÂ§á‰ªΩÊó∂Èó¥
                systemSettings.lastBackupTime = new Date().toISOString();
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                updateSystemSettingsDisplay();
                
                showMessage('Á≥ªÁªüÊï∞ÊçÆÂ§á‰ªΩÊàêÂäüÔºÅ', 'success');
                
            } catch (error) {
                console.error('Â§á‰ªΩÁ≥ªÁªüÊï∞ÊçÆÊó∂Âá∫ÈîôÔºö', error);
                showMessage('Â§á‰ªΩÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // ÊÅ¢Â§çÁ≥ªÁªüÊï∞ÊçÆ
        function restoreSystemData() {
            // ÂàõÂª∫Êñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // È™åËØÅÂ§á‰ªΩÊï∞ÊçÆÊ†ºÂºè
                        if (!backupData.talkRecords || !backupData.students || !backupData.systemUsers) {
                            showMessage('Â§á‰ªΩÊñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºÅ', 'error');
                            return;
                        }
                        
                        if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÁ≥ªÁªüÊï∞ÊçÆÂêóÔºüÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÂ∞ÜË¢´Ë¶ÜÁõñÔºÅ')) {
                            // ÊÅ¢Â§çÊï∞ÊçÆ
                            talkRecords = backupData.talkRecords;
                            students = backupData.students;
                            users = backupData.systemUsers;
                            systemSettings = backupData.systemSettings || {};
                            drafts = backupData.talkDrafts || [];
                            
                            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                            localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                            localStorage.setItem('students', JSON.stringify(students));
                            localStorage.setItem('systemUsers', JSON.stringify(users));
                            localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                            localStorage.setItem('talkDrafts', JSON.stringify(drafts));
                            
                            // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢Êï∞ÊçÆ
                            loadStudentsTable();
                            loadTalkRecords();
                            loadExportList();
                            loadUsersTable();
                            updateRecordStats();
                            updateTalkTrackingStats();
                            updateUserStats();
                            updateSystemSettingsDisplay();
                            
                            showMessage('Á≥ªÁªüÊï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ', 'success');
                        }
                    } catch (error) {
                        console.error('ÊÅ¢Â§çÁ≥ªÁªüÊï∞ÊçÆÊó∂Âá∫ÈîôÔºö', error);
                        showMessage('ÊÅ¢Â§çÂ§±Ë¥•Ôºö' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // Ê∏ÖÁêÜÊóßÊï∞ÊçÆ
        function cleanOldData() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜ‰∏ÄÂπ¥ÂâçÁöÑË∞àËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                
                const oldRecordsCount = talkRecords.length;
                talkRecords = talkRecords.filter(record => new Date(record.talkTime) >= oneYearAgo);
                
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                updateAnalysisData();
                
                const cleanedCount = oldRecordsCount - talkRecords.length;
                showMessage(`Â∑≤Ê∏ÖÁêÜ ${cleanedCount} Êù°‰∏ÄÂπ¥ÂâçÁöÑË∞àËØùËÆ∞ÂΩï`, 'success');
            }
        }
        
        // Ê∏ÖÁêÜÁ≥ªÁªüÁºìÂ≠ò
        function clearSystemCache() {
            // Ê∏ÖÁêÜËçâÁ®øÊï∞ÊçÆ
            drafts = [];
            localStorage.setItem('talkDrafts', JSON.stringify(drafts));
            
            // Ê∏ÖÁêÜÂÖ∂‰ªñ‰∏¥Êó∂Êï∞ÊçÆ
            localStorage.removeItem('importData');
            localStorage.removeItem('importPreviewData');
            localStorage.removeItem('userImportData');
            localStorage.removeItem('userImportPreviewData');
            
            showMessage('Á≥ªÁªüÁºìÂ≠òÂ∑≤Ê∏ÖÁêÜÔºÅ', 'success');
        }
        
        // Á≥ªÁªü‰ºòÂåñ
        function optimizeSystem() {
            showMessage('Á≥ªÁªü‰ºòÂåñÂÆåÊàêÔºÅ', 'success');
        }
        
        // Êü•ÁúãÁ≥ªÁªüÊó•ÂøóÔºàÁÆÄÂåñÁâàÔºâ
        function viewSystemLogs() {
            showMessage('Á≥ªÁªüÊó•ÂøóÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'info');
        }
        
        // Êü•ÁúãÊï∞ÊçÆÁªüËÆ°
        function showDataStatistics() {
            // ÂàáÊç¢Âà∞Êï∞ÊçÆÂàÜÊûêÈ°µÈù¢
            switchTab('analysis');
        }
        
        // ==================== ‰ª•‰∏ã‰∏∫ÂéüÊúâÂäüËÉΩ‰øùÊåÅ‰∏çÂèò ====================
        
         // ==================== ÂéÜÂè≤Ë∞àËØùËÆ∞ÂΩïÊâπÈáèÂà†Èô§ÂäüËÉΩ ====================
        
        // ÂàáÊç¢ÊâÄÊúâË∞àËØùËÆ∞ÂΩïÁöÑÈÄâÊã©Áä∂ÊÄÅ
        function toggleSelectAllTalks(checkbox) {
            const checkboxes = document.querySelectorAll('.talk-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBatchTalkActionState();
        }
        
        // Êõ¥Êñ∞ÊâπÈáèÂà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
        function updateBatchTalkActionState() {
            const checkboxes = document.querySelectorAll('.talk-checkbox:checked');
            const selectedCount = checkboxes.length;
            const batchDeleteBtn = document.getElementById('batchDeleteTalkBtn');
            const batchActionInfo = document.getElementById('batchTalkActionInfo');
            const selectedCountSpan = document.getElementById('selectedTalkCount');
            
            if (selectedCount > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchActionInfo.style.display = 'block';
                selectedCountSpan.textContent = selectedCount;
            } else {
                batchDeleteBtn.style.display = 'none';
                batchActionInfo.style.display = 'none';
            }
        }
        
        // Ê∏ÖÈô§ÊâÄÊúâË∞àËØùËÆ∞ÂΩïÁöÑÈÄâÊã©
        function clearTalkSelection() {
            const checkboxes = document.querySelectorAll('.talk-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllTalks').checked = false;
            updateBatchTalkActionState();
        }
        
        // ÊâπÈáèÂà†Èô§Ë∞àËØùËÆ∞ÂΩï
        function batchDeleteTalkRecords() {
            const checkboxes = document.querySelectorAll('.talk-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showMessage('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑË∞àËØùËÆ∞ÂΩïÔºÅ', 'error');
                return;
            }
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedIds.length} Êù°Ë∞àËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                return;
            }
            
            try {
                // Âà†Èô§ÈÄâ‰∏≠ÁöÑË∞àËØùËÆ∞ÂΩï
                talkRecords = talkRecords.filter(record => !selectedIds.includes(record.id));
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                // Âà∑Êñ∞ÁïåÈù¢
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                updateAnalysisData();
                
                // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
                clearTalkSelection();
                
                showMessage(`ÊàêÂäüÂà†Èô§ ${selectedIds.length} Êù°Ë∞àËØùËÆ∞ÂΩïÔºÅ`, 'success');
                
            } catch (error) {
                console.error('ÊâπÈáèÂà†Èô§Ë∞àËØùËÆ∞ÂΩïÊó∂Âá∫ÈîôÔºö', error);
                showMessage('ÊâπÈáèÂà†Èô§Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
       // ==================== Êï∞ÊçÆÂàÜÊûêÊ®°ÂùóÂäüËÉΩ ====================
        
        // Êõ¥Êñ∞ÂàÜÊûêÊï∞ÊçÆ
        function updateAnalysisData() {
            console.log('Êõ¥Êñ∞ÂàÜÊûêÊï∞ÊçÆ...');
            
            // ‰ªélocalStorageÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            const storedStudents = localStorage.getItem('students');
            if (storedStudents) {
                students = JSON.parse(storedStudents);
            }
            
            // Ëé∑ÂèñÁ≠õÈÄâÊù°‰ª∂
            const timeRange = document.getElementById('analysisTimeRange').value;
            const classFilter = document.getElementById('analysisClassFilter').value;
            
            // Á≠õÈÄâÊï∞ÊçÆ
            let filteredRecords = [...talkRecords];
            let filteredStudents = [...students];
            
            // Êó∂Èó¥Á≠õÈÄâ
            if (timeRange !== 'all') {
                const now = new Date();
                let dateFrom = new Date();
                
                switch(timeRange) {
                    case 'month':
                        dateFrom.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        dateFrom.setMonth(now.getMonth() - 3);
                        break;
                    case 'halfyear':
                        dateFrom.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        dateFrom.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredRecords = filteredRecords.filter(record => 
                    new Date(record.talkTime) >= dateFrom
                );
            }
            
            // Áè≠Á∫ßÁ≠õÈÄâ
            if (classFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.className === classFilter
                );
                
                filteredStudents = filteredStudents.filter(student => 
                    student.className === classFilter
                );
            }
            
            // Êõ¥Êñ∞Áè≠Á∫ßÁ≠õÈÄâÂô®ÈÄâÈ°π
            updateClassFilterOptions();
            
            // Êõ¥Êñ∞ÊÄª‰ΩìÊï∞ÊçÆÊ¶ÇËßà
            updateAnalysisOverview(filteredRecords, filteredStudents);
            
            // Êõ¥Êñ∞È£éÈô©Á≠âÁ∫ßÂàÜÂ∏É
            updateRiskLevelChart(filteredRecords);
            
            // Êõ¥Êñ∞Ë∞àËØù‰∏ªÈ¢òÂàÜÊûê
            updateTopicAnalysis(filteredRecords);
            
            // Êõ¥Êñ∞Êó∂Èó¥Ë∂ãÂäøÂàÜÊûê
            updateTimeTrendChart(filteredRecords);
            
            // Êõ¥Êñ∞ËØ¶ÁªÜÁªüËÆ°Ë°®Ê†º
            updateClassAnalysisTable(filteredRecords, filteredStudents);
            
            // Êõ¥Êñ∞È´òÈ¢ëË∞àËØùÂ≠¶Áîü
            updateFrequentStudentsTable(filteredRecords);
            
            // Êõ¥Êñ∞Êï∞ÊçÆÊ¥ûÂØü
            updateDataInsights(filteredRecords, filteredStudents);
        }
        
        // Âà∑Êñ∞ÂàÜÊûêÊï∞ÊçÆ
        function refreshAnalysisData() {
            updateAnalysisData();
            showMessage('ÂàÜÊûêÊï∞ÊçÆÂ∑≤Âà∑Êñ∞', 'success');
        }
        
        // Êõ¥Êñ∞Áè≠Á∫ßÁ≠õÈÄâÂô®ÈÄâÈ°π
        function updateClassFilterOptions() {
            const classFilter = document.getElementById('analysisClassFilter');
            if (!classFilter) return;
            
            // Ëé∑ÂèñÊâÄÊúâÁè≠Á∫ß
            const classes = [...new Set(students.map(student => student.className))].filter(c => c);
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÁ¨¨‰∏Ä‰∏™"ÂÖ®ÈÉ®Áè≠Á∫ß"ÈÄâÈ°πÔºâ
            while (classFilter.options.length > 1) {
                classFilter.remove(1);
            }
            
            // Ê∑ªÂä†Áè≠Á∫ßÈÄâÈ°π
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }
        
        // Êõ¥Êñ∞ÊÄª‰ΩìÊï∞ÊçÆÊ¶ÇËßà
        function updateAnalysisOverview(records, studentsData) {
            const totalCount = records.length;
            const studentCount = new Set(records.map(r => r.studentId)).size;
            const redCount = records.filter(r => r.riskLevel === 'red').length;
            const redPercent = totalCount > 0 ? Math.round((redCount / totalCount) * 100) : 0;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            document.getElementById('totalAnalysisCount').textContent = totalCount;
            document.getElementById('analysisStudentCount').textContent = studentCount;
            document.getElementById('analysisRedPercent').textContent = `${redPercent}%`;
        }
        
        // Êõ¥Êñ∞È£éÈô©Á≠âÁ∫ßÂàÜÂ∏ÉÂõæË°®
        function updateRiskLevelChart(records) {
            const chartContainer = document.getElementById('riskLevelChart');
            if (!chartContainer) return;
            
            // ÁªüËÆ°È£éÈô©Á≠âÁ∫ß
            const riskCounts = {
                red: records.filter(r => r.riskLevel === 'red').length,
                yellow: records.filter(r => r.riskLevel === 'yellow').length,
                green: records.filter(r => r.riskLevel === 'green').length
            };
            
            // ËÆ°ÁÆóÊúÄÂ§ßÊï∞ÈáèÁî®‰∫éÊØî‰æã
            const maxCount = Math.max(riskCounts.red, riskCounts.yellow, riskCounts.green, 1);
            
            // Ê∏ÖÁ©∫ÂõæË°®
            chartContainer.innerHTML = '';
            
            // Ê∑ªÂä†YËΩ¥
            const yAxis = document.createElement('div');
            yAxis.className = 'y-axis';
            yAxis.innerHTML = `
                <div>${maxCount}</div>
                <div>${Math.round(maxCount * 0.75)}</div>
                <div>${Math.round(maxCount * 0.5)}</div>
                <div>${Math.round(maxCount * 0.25)}</div>
                <div>0</div>
            `;
            chartContainer.appendChild(yAxis);
            
            // Ê∑ªÂä†XËΩ¥
            const xAxis = document.createElement('div');
            xAxis.className = 'x-axis';
            chartContainer.appendChild(xAxis);
            
            // ÂàõÂª∫Êü±Áä∂Âõæ
            const riskData = [
                { label: 'Á∫¢Ëâ≤È¢ÑË≠¶', value: riskCounts.red, color: '#c62828', type: 'red' },
                { label: 'ÈªÑËâ≤ÂÖ≥Ê≥®', value: riskCounts.yellow, color: '#f57f17', type: 'yellow' },
                { label: 'ÁªøËâ≤Ê≠£Â∏∏', value: riskCounts.green, color: '#2e7d32', type: 'green' }
            ];
            
            riskData.forEach(data => {
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                
                // ËÆ°ÁÆóÊü±Áä∂ÂõæÈ´òÂ∫¶ÔºàÊúÄÂ§ß250pxÔºâ
                const heightPercent = (data.value / maxCount) * 100;
                const barHeight = (heightPercent / 100) * 250;
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}px`;
                bar.style.background = data.color;
                
                // Ê∑ªÂä†Êï∞ÂÄºÊ†áÁ≠æ
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = data.value;
                bar.appendChild(barValue);
                
                // Ê∑ªÂä†Ê†áÁ≠æ
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = data.label;
                
                barGroup.appendChild(bar);
                barGroup.appendChild(barLabel);
                chartContainer.appendChild(barGroup);
                
                // Ê∑ªÂä†Âà∞XËΩ¥
                const xLabel = document.createElement('div');
                xLabel.textContent = data.label;
                xAxis.appendChild(xLabel);
            });
        }
        
        // Êõ¥Êñ∞Ë∞àËØù‰∏ªÈ¢òÂàÜÊûê
        function updateTopicAnalysis(records) {
            // ÁªüËÆ°ÊâÄÊúâ‰∏ªÈ¢ò
            const topicCounts = {};
            records.forEach(record => {
                if (record.topics && Array.isArray(record.topics)) {
                    record.topics.forEach(topic => {
                        // Â§ÑÁêÜ"ÂÖ∂‰ªñÔºöxxx"Ê†ºÂºèÁöÑ‰∏ªÈ¢ò
                        const cleanTopic = topic.startsWith('ÂÖ∂‰ªñÔºö') ? 'ÂÖ∂‰ªñ' : topic;
                        topicCounts[cleanTopic] = (topicCounts[cleanTopic] || 0) + 1;
                    });
                }
            });
            
            // ÊåâÊï∞ÈáèÊéíÂ∫è
            const sortedTopics = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5); // Âè™ÂèñÂâç5‰∏™‰∏ªÈ¢ò
            
            // Êõ¥Êñ∞È•ºÂõæÈ¢úËâ≤
            const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
            
            // ÁîüÊàêÈ•ºÂõæ
            let pieHtml = '';
            if (sortedTopics.length > 0) {
                // ÂàõÂª∫È•ºÂõæÁöÑconic-gradient
                let cumulativePercent = 0;
                const gradients = sortedTopics.map((topic, index) => {
                    const percent = (topic[1] / records.length) * 100;
                    const start = cumulativePercent;
                    cumulativePercent += percent;
                    return `${colors[index]} ${start}% ${cumulativePercent}%`;
                });
                
                const pieChart = document.getElementById('topicPieChart');
                if (pieChart) {
                    pieChart.style.background = `conic-gradient(${gradients.join(', ')})`;
                }
                
                // Êõ¥Êñ∞Âõæ‰æã
                const legendContainer = document.getElementById('topicLegend');
                if (legendContainer) {
                    legendContainer.innerHTML = '';
                    
                    sortedTopics.forEach((topic, index) => {
                        const percent = Math.round((topic[1] / records.length) * 100);
                        
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.innerHTML = `
                            <div class="legend-color" style="background: ${colors[index]}"></div>
                            <div>${topic[0]}</div>
                            <div style="margin-left: auto; font-weight: bold;">${percent}%</div>
                        `;
                        legendContainer.appendChild(legendItem);
                    });
                }
            }
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥Ë∂ãÂäøÂõæË°®
        function updateTimeTrendChart(records) {
            const chartContainer = document.getElementById('monthlyTrendChart');
            if (!chartContainer) return;
            
            // Ê∏ÖÁ©∫ÂõæË°®
            chartContainer.innerHTML = '';
            
            // Ëé∑ÂèñÊúÄËøë6‰∏™ÊúàÁöÑÊï∞ÊçÆ
            const now = new Date();
            const months = [];
            const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthName = `${date.getFullYear()}Âπ¥${monthNames[date.getMonth()]}`;
                months.push({ key: monthKey, name: monthName });
            }
            
            // ÁªüËÆ°ÊØèÊúàË∞àËØùÊï∞Èáè
            const monthCounts = {};
            months.forEach(month => {
                monthCounts[month.key] = 0;
            });
            
            records.forEach(record => {
                const recordDate = new Date(record.talkTime);
                const year = recordDate.getFullYear();
                const month = String(recordDate.getMonth() + 1).padStart(2, '0');
                const key = `${year}-${month}`;
                
                if (monthCounts.hasOwnProperty(key)) {
                    monthCounts[key]++;
                }
            });
            
            // ËÆ°ÁÆóÊúÄÂ§ßÂÄº
            const values = Object.values(monthCounts);
            const maxCount = Math.max(...values, 1);
            
            // Ê∑ªÂä†YËΩ¥
            const yAxis = document.createElement('div');
            yAxis.className = 'y-axis';
            yAxis.innerHTML = `
                <div>${maxCount}</div>
                <div>${Math.round(maxCount * 0.75)}</div>
                <div>${Math.round(maxCount * 0.5)}</div>
                <div>${Math.round(maxCount * 0.25)}</div>
                <div>0</div>
            `;
            chartContainer.appendChild(yAxis);
            
            // Ê∑ªÂä†XËΩ¥
            const xAxis = document.createElement('div');
            xAxis.className = 'x-axis';
            chartContainer.appendChild(xAxis);
            
            // ÂàõÂª∫Êü±Áä∂Âõæ
            months.forEach(month => {
                const count = monthCounts[month.key] || 0;
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                
                // ËÆ°ÁÆóÊü±Áä∂ÂõæÈ´òÂ∫¶
                const heightPercent = (count / maxCount) * 100;
                const barHeight = (heightPercent / 100) * 250;
                
                // ËÆæÁΩÆÈ¢úËâ≤ÔºöÂΩìÂâçÊúàÁâπÊÆäÈ¢úËâ≤
                const isCurrentMonth = month.key === `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const barColor = isCurrentMonth ? '#3498db' : '#2ecc71';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}px`;
                bar.style.background = barColor;
                
                // Ê∑ªÂä†Êï∞ÂÄºÊ†áÁ≠æ
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = count;
                bar.appendChild(barValue);
                
                // Ê∑ªÂä†Ê†áÁ≠æ
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = month.name.replace(`${now.getFullYear()}Âπ¥`, '');
                
                barGroup.appendChild(bar);
                barGroup.appendChild(barLabel);
                chartContainer.appendChild(barGroup);
                
                // Ê∑ªÂä†Âà∞XËΩ¥
                const xLabel = document.createElement('div');
                xLabel.textContent = month.name.replace(`${now.getFullYear()}Âπ¥`, '');
                xAxis.appendChild(xLabel);
            });
        }
        
        // Êõ¥Êñ∞Áè≠Á∫ßÂàÜÊûêË°®Ê†º
        function updateClassAnalysisTable(records, studentsData) {
            const tbody = document.getElementById('classAnalysisBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ÊåâÁè≠Á∫ßÂàÜÁªÑ
            const classData = {};
            
            // ÂàùÂßãÂåñÁè≠Á∫ßÊï∞ÊçÆ
            const allClasses = [...new Set(studentsData.map(s => s.className))].filter(c => c);
            allClasses.forEach(className => {
                classData[className] = {
                    studentCount: 0,
                    talkCount: 0,
                    redCount: 0,
                    yellowCount: 0,
                    greenCount: 0
                };
            });
            
            // ÁªüËÆ°Â≠¶Áîü‰∫∫Êï∞
            studentsData.forEach(student => {
                if (student.className && classData[student.className]) {
                    classData[student.className].studentCount++;
                }
            });
            
            // ÁªüËÆ°Ë∞àËØùÊï∞ÊçÆ
            records.forEach(record => {
                const className = record.className;
                if (className && classData[className]) {
                    classData[className].talkCount++;
                    
                    if (record.riskLevel === 'red') {
                        classData[className].redCount++;
                    } else if (record.riskLevel === 'yellow') {
                        classData[className].yellowCount++;
                    } else {
                        classData[className].greenCount++;
                    }
                }
            });
            
            // ÁîüÊàêË°®Ê†ºË°å
            Object.entries(classData).forEach(([className, data]) => {
                const row = document.createElement('tr');
                
                // ËÆ°ÁÆó‰∫∫ÂùáË∞àËØùÊ¨°Êï∞
                const avgTalks = data.studentCount > 0 ? (data.talkCount / data.studentCount).toFixed(1) : '0';
                
                row.innerHTML = `
                    <td><strong>${className}</strong></td>
                    <td>${data.studentCount}</td>
                    <td>${data.talkCount}</td>
                    <td>${avgTalks}</td>
                    <td><span style="color:#c62828;font-weight:bold;">${data.redCount}</span></td>
                    <td><span style="color:#f57f17;">${data.yellowCount}</span></td>
                    <td><span style="color:#2e7d32;">${data.greenCount}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Ê∑ªÂä†ÊÄªËÆ°Ë°å
            if (Object.keys(classData).length > 1) {
                const totalStudentCount = Object.values(classData).reduce((sum, data) => sum + data.studentCount, 0);
                const totalTalkCount = Object.values(classData).reduce((sum, data) => sum + data.talkCount, 0);
                const totalRedCount = Object.values(classData).reduce((sum, data) => sum + data.redCount, 0);
                const totalYellowCount = Object.values(classData).reduce((sum, data) => sum + data.yellowCount, 0);
                const totalGreenCount = Object.values(classData).reduce((sum, data) => sum + data.greenCount, 0);
                const totalAvgTalks = totalStudentCount > 0 ? (totalTalkCount / totalStudentCount).toFixed(1) : '0';
                
                const totalRow = document.createElement('tr');
                totalRow.style.backgroundColor = '#f8f9fa';
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                    <td>ÊÄªËÆ°</td>
                    <td>${totalStudentCount}</td>
                    <td>${totalTalkCount}</td>
                    <td>${totalAvgTalks}</td>
                    <td><span style="color:#c62828;">${totalRedCount}</span></td>
                    <td><span style="color:#f57f17;">${totalYellowCount}</span></td>
                    <td><span style="color:#2e7d32;">${totalGreenCount}</span></td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // Êõ¥Êñ∞È´òÈ¢ëË∞àËØùÂ≠¶ÁîüË°®Ê†º
        function updateFrequentStudentsTable(records) {
            const tbody = document.getElementById('frequentStudentsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞Âíå‰∏ªÈ¢ò
            const studentTalkData = {};
            const studentInfo = {};
            
            // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
            const storedStudents = JSON.parse(localStorage.getItem('students') || '[]');
            
            records.forEach(record => {
                const studentId = record.studentId;
                if (!studentTalkData[studentId]) {
                    studentTalkData[studentId] = {
                        count: 0,
                        lastTalk: record.talkTime,
                        riskLevel: record.riskLevel
                    };
                }
                
                studentTalkData[studentId].count++;
                
                // Êõ¥Êñ∞ÊúÄËøëË∞àËØùÊó∂Èó¥
                if (new Date(record.talkTime) > new Date(studentTalkData[studentId].lastTalk)) {
                    studentTalkData[studentId].lastTalk = record.talkTime;
                }
                
                // ËÆ∞ÂΩïÊúÄ‰∏•ÈáçÁöÑÈ£éÈô©Á≠âÁ∫ß
                const riskOrder = { 'red': 3, 'yellow': 2, 'green': 1 };
                if (riskOrder[record.riskLevel] > riskOrder[studentTalkData[studentId].riskLevel]) {
                    studentTalkData[studentId].riskLevel = record.riskLevel;
                }
                
                // ‰øùÂ≠òÂ≠¶Áîü‰ø°ÊÅØ
                if (!studentInfo[studentId]) {
                    const student = storedStudents.find(s => s.studentId === studentId);
                    if (student) {
                        studentInfo[studentId] = {
                            name: student.name,
                            className: student.className,
                            punishments: student.punishments || [],
                            statusChange: student.statusChange || 'Êó†'
                        };
                    }
                }
            });
            
            // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊéíÂ∫èÔºàË∞àËØùÊ¨°Êï∞Â§öÁöÑÂú®ÂâçÔºâ
            const sortedStudents = Object.entries(studentTalkData)
                .filter(([studentId]) => studentInfo[studentId]) // Âè™‰øùÁïôÊúâ‰ø°ÊÅØÁöÑÂ≠¶Áîü
                .sort(([,a], [,b]) => b.count - a.count)
                .slice(0, 10); // Âè™ÂèñÂâç10Âêç
            
            // ÁîüÊàêË°®Ê†ºË°å
            sortedStudents.forEach(([studentId, data]) => {
                const info = studentInfo[studentId];
                const row = document.createElement('tr');
                
                // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
                let riskLevelDisplay = '';
                if (data.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">Á∫¢Ëâ≤È¢ÑË≠¶</span>';
                } else if (data.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ÁªøËâ≤Ê≠£Â∏∏</span>';
                }
                
                // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
                let punishmentsDisplay = 'Êó†';
                if (info.punishments && info.punishments.length > 0) {
                    punishmentsDisplay = `<span class="punishment-tag punishment-yes">ÊúâÂ§ÑÂàÜ</span>`;
                } else {
                    punishmentsDisplay = `<span class="punishment-tag punishment-no">Êó†Â§ÑÂàÜ</span>`;
                }
                
                // Â≠¶Á±çÂºÇÂä®ÊòæÁ§∫
                let statusChangeDisplay = 'Êó†';
                if (info.statusChange && info.statusChange !== 'Êó†') {
                    statusChangeDisplay = `<span class="status-change-tag status-change-yes">${info.statusChange}</span>`;
                } else {
                    statusChangeDisplay = `<span class="status-change-tag status-change-no">Êó†</span>`;
                }
                
                // Ê†ºÂºèÂåñÊúÄËøëË∞àËØùÊó∂Èó¥
                const lastTalkFormatted = formatDate(data.lastTalk);
                
                row.innerHTML = `
                    <td><strong>${info.name}</strong></td>
                    <td>${info.className}</td>
                    <td><span style="font-weight:bold;color:#3498db;">${data.count}</span></td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${statusChangeDisplay}</td>
                    <td>${lastTalkFormatted}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆ
            if (sortedStudents.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                        ÊöÇÊó†È´òÈ¢ëË∞àËØùÂ≠¶ÁîüÊï∞ÊçÆ
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
        }
        
        // Êõ¥Êñ∞Êï∞ÊçÆÊ¥ûÂØü
        function updateDataInsights(records, studentsData) {
            const insightsList = document.getElementById('insightsList');
            if (!insightsList) return;
            
            insightsList.innerHTML = '';
            
            if (records.length === 0) {
                insightsList.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-icon">üìä</div>
                        <div class="insight-text">ÊöÇÊó†Ë∞àËØùËÆ∞ÂΩïÊï∞ÊçÆÔºåËØ∑ÂÖàÊ∑ªÂä†Ë∞àËØùËÆ∞ÂΩï</div>
                    </div>
                `;
                return;
            }
            
            const insights = [];
            
            // ËÆ°ÁÆóÊÄªË∞àËØùÊ¨°Êï∞
            const totalTalks = records.length;
            
            // ËÆ°ÁÆóÊ∂âÂèäÂ≠¶ÁîüÊï∞
            const uniqueStudents = new Set(records.map(r => r.studentId)).size;
            
            // ËÆ°ÁÆóÈ´òÈ£éÈô©ÊØî‰æã
            const redTalks = records.filter(r => r.riskLevel === 'red').length;
            const redPercentage = Math.round((redTalks / totalTalks) * 100);
            
            // ËÆ°ÁÆóÂπ≥ÂùáË∞àËØùÊ¨°Êï∞
            const avgTalksPerStudent = (totalTalks / uniqueStudents).toFixed(1);
            
            // ËÆ°ÁÆóÊúÄÈ¢ëÁπÅÁöÑË∞àËØù‰∏ªÈ¢ò
            const topicCounts = {};
            records.forEach(record => {
                record.topics.forEach(topic => {
                    const cleanTopic = topic.startsWith('ÂÖ∂‰ªñÔºö') ? 'ÂÖ∂‰ªñ' : topic;
                    topicCounts[cleanTopic] = (topicCounts[cleanTopic] || 0) + 1;
                });
            });
            
            const mostCommonTopic = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a)[0];
            
            // ËÆ°ÁÆóÊúÄËøë‰∏ÄÂë®ÁöÑË∞àËØùË∂ãÂäø
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentTalks = records.filter(r => new Date(r.talkTime) >= weekAgo).length;
            const previousWeekTalks = records.filter(r => {
                const recordDate = new Date(r.talkTime);
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                return recordDate >= twoWeeksAgo && recordDate < weekAgo;
            }).length;
            
            const trendChange = previousWeekTalks > 0 ? 
                Math.round(((recentTalks - previousWeekTalks) / previousWeekTalks) * 100) : 0;
            
            // ÁîüÊàêÊ¥ûÂØü
            insights.push({
                icon: 'üìà',
                text: `ÂÖ±ÂÆåÊàê <strong>${totalTalks}</strong> Ê¨°Ë∞àËØùÔºåÊ∂âÂèä <strong>${uniqueStudents}</strong> ÂêçÂ≠¶ÁîüÔºåÂπ≥ÂùáÊØè‰∫∫Ë∞àËØù <strong>${avgTalksPerStudent}</strong> Ê¨°`
            });
            
            if (redPercentage > 0) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    text: `È´òÈ£éÈô©Ë∞àËØùÂç†ÊØî <strong>${redPercentage}%</strong>ÔºåÂÖ± <strong>${redTalks}</strong> Ê¨°Á∫¢Ëâ≤È¢ÑË≠¶Ë∞àËØùÔºåÈúÄË¶ÅÈáçÁÇπÂÖ≥Ê≥®`
                });
            } else {
                insights.push({
                    icon: '‚úÖ',
                    text: `ÁõÆÂâçÊ≤°ÊúâÈ´òÈ£éÈô©Ë∞àËØùËÆ∞ÂΩïÔºåÊâÄÊúâÂ≠¶ÁîüÁä∂ÊÄÅËâØÂ•Ω`
                });
            }
            
            if (mostCommonTopic) {
                const topicPercentage = Math.round((mostCommonTopic[1] / totalTalks) * 100);
                insights.push({
                    icon: 'üí¨',
                    text: `ÊúÄÂ∏∏ËÆ®ËÆ∫ÁöÑ‰∏ªÈ¢òÊòØ <strong>"${mostCommonTopic[0]}"</strong>ÔºåÂç†ÊØî <strong>${topicPercentage}%</strong>`
                });
            }
            
            if (trendChange > 0) {
                insights.push({
                    icon: 'üìà',
                    text: `ÊúÄËøë‰∏ÄÂë®Ë∞àËØùÊ¨°Êï∞Áõ∏ÊØîÂâç‰∏ÄÂë® <strong>Â¢ûÈïø ${Math.abs(trendChange)}%</strong>ÔºåÂ∑•‰ΩúÂº∫Â∫¶Â¢ûÂä†`
                });
            } else if (trendChange < 0) {
                insights.push({
                    icon: 'üìâ',
                    text: `ÊúÄËøë‰∏ÄÂë®Ë∞àËØùÊ¨°Êï∞Áõ∏ÊØîÂâç‰∏ÄÂë® <strong>ÂáèÂ∞ë ${Math.abs(trendChange)}%</strong>ÔºåÂ∑•‰ΩúÂº∫Â∫¶ÂáèËΩª`
                });
            } else {
                insights.push({
                    icon: 'üìä',
                    text: `ÊúÄËøë‰∏ÄÂë®Ë∞àËØùÊ¨°Êï∞‰∏éÂâç‰∏ÄÂë®ÊåÅÂπ≥ÔºåÂ∑•‰ΩúËäÇÂ•èÁ®≥ÂÆö`
                });
            }
            
            // ÊâæÂá∫Ë∞àËØùÊúÄÂ§öÁöÑÁè≠Á∫ß
            const classTalkCounts = {};
            records.forEach(record => {
                const className = record.className;
                classTalkCounts[className] = (classTalkCounts[className] || 0) + 1;
            });
            
            const mostTalkativeClass = Object.entries(classTalkCounts)
                .sort(([,a], [,b]) => b - a)[0];
            
            if (mostTalkativeClass && Object.keys(classTalkCounts).length > 1) {
                insights.push({
                    icon: 'üë•',
                    text: `Ë∞àËØùÊúÄÂ§öÁöÑÁè≠Á∫ßÊòØ <strong>${mostTalkativeClass[0]}</strong>ÔºåÂÖ± <strong>${mostTalkativeClass[1]}</strong> Ê¨°Ë∞àËØù`
                });
            }
            
            // Ê∏≤ÊüìÊ¥ûÂØüÂàóË°®
            insights.forEach(insight => {
                const insightItem = document.createElement('div');
                insightItem.className = 'insight-item';
                insightItem.innerHTML = `
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-text">${insight.text}</div>
                `;
                insightsList.appendChild(insightItem);
            });
        }
        
        // ÂØºÂá∫ÂàÜÊûêÊä•Âëä
        function exportAnalysisReport() {
            try {
                // Ëé∑ÂèñÂΩìÂâçÂàÜÊûêÊï∞ÊçÆ
                const timeRange = document.getElementById('analysisTimeRange').value;
                const classFilter = document.getElementById('analysisClassFilter').value;
                
                // ÁîüÊàêÊä•ÂëäÊ†áÈ¢ò
                let reportTitle = 'Ë∞àÂøÉË∞àËØùÊï∞ÊçÆÂàÜÊûêÊä•Âëä';
                if (classFilter) {
                    reportTitle += ` - ${classFilter}`;
                }
                if (timeRange !== 'all') {
                    const timeLabels = {
                        'month': 'ÊúÄËøë‰∏Ä‰∏™Êúà',
                        'quarter': 'ÊúÄËøë‰∏â‰∏™Êúà',
                        'halfyear': 'ÊúÄËøëÂÖ≠‰∏™Êúà',
                        'year': 'ÊúÄËøë‰∏ÄÂπ¥'
                    };
                    reportTitle += ` (${timeLabels[timeRange]})`;
                }
                
                // Ëé∑ÂèñÂΩìÂâçÊó•Êúü
                const now = new Date();
                const dateStr = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà${now.getDate()}Êó•`;
                
                // ÁîüÊàêÊä•ÂëäÂÜÖÂÆπ
                let reportContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>${reportTitle}</title>
                        <style>
                            body {
                                font-family: "Microsoft YaHei", sans-serif;
                                margin: 2cm;
                                font-size: 12pt;
                                line-height: 1.6;
                            }
                            h1 {
                                text-align: center;
                                color: #2c3e50;
                                margin-bottom: 10px;
                            }
                            .report-meta {
                                text-align: center;
                                color: #666;
                                margin-bottom: 30px;
                                font-size: 11pt;
                            }
                            .section {
                                margin-bottom: 25px;
                                page-break-inside: avoid;
                            }
                            .section-title {
                                font-size: 14pt;
                                color: #2c3e50;
                                border-bottom: 2px solid #3498db;
                                padding-bottom: 5px;
                                margin-bottom: 15px;
                            }
                            .summary-grid {
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 15px;
                                margin-bottom: 20px;
                            }
                            .summary-item {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                text-align: center;
                            }
                            .summary-value {
                                font-size: 24pt;
                                font-weight: bold;
                                color: #3498db;
                                margin: 10px 0;
                            }
                            .summary-label {
                                font-size: 11pt;
                                color: #666;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 20px;
                                font-size: 11pt;
                            }
                            th {
                                background: #f0f0f0;
                                padding: 10px;
                                text-align: left;
                                border: 1px solid #ddd;
                            }
                            td {
                                padding: 10px;
                                border: 1px solid #ddd;
                            }
                            .insight-list {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                            }
                            .insight-item {
                                margin-bottom: 10px;
                                padding-bottom: 10px;
                                border-bottom: 1px dashed #ddd;
                            }
                            .insight-item:last-child {
                                border-bottom: none;
                                margin-bottom: 0;
                                padding-bottom: 0;
                            }
                            .footer {
                                margin-top: 50px;
                                text-align: right;
                                font-size: 11pt;
                                color: #666;
                            }
                            @page {
                                size: A4;
                                margin: 2cm;
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${reportTitle}</h1>
                        <div class="report-meta">
                            ÁîüÊàêÊó∂Èó¥Ôºö${dateStr} | ÁîüÊàê‰∫∫Ôºö${localStorage.getItem('counselorName') || 'ËæÖÂØºÂëò'}
                        </div>
                `;
                
                // Ëé∑ÂèñÂàÜÊûêÊï∞ÊçÆ
                const storedRecords = JSON.parse(localStorage.getItem('talkRecords') || '[]');
                const storedStudents = JSON.parse(localStorage.getItem('students') || '[]');
                
                // Á≠õÈÄâÊï∞ÊçÆ
                let filteredRecords = [...storedRecords];
                let filteredStudents = [...storedStudents];
                
                // Êó∂Èó¥Á≠õÈÄâ
                if (timeRange !== 'all') {
                    const now = new Date();
                    let dateFrom = new Date();
                    
                    switch(timeRange) {
                        case 'month':
                            dateFrom.setMonth(now.getMonth() - 1);
                            break;
                        case 'quarter':
                            dateFrom.setMonth(now.getMonth() - 3);
                            break;
                        case 'halfyear':
                            dateFrom.setMonth(now.getMonth() - 6);
                            break;
                        case 'year':
                            dateFrom.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    filteredRecords = filteredRecords.filter(record => 
                        new Date(record.talkTime) >= dateFrom
                    );
                }
                
                // Áè≠Á∫ßÁ≠õÈÄâ
                if (classFilter) {
                    filteredRecords = filteredRecords.filter(record => 
                        record.className === classFilter
                    );
                    
                    filteredStudents = filteredStudents.filter(student => 
                        student.className === classFilter
                    );
                }
                
                // Êï∞ÊçÆÊ¶ÇËßà
                const totalTalks = filteredRecords.length;
                const uniqueStudents = new Set(filteredRecords.map(r => r.studentId)).size;
                const redTalks = filteredRecords.filter(r => r.riskLevel === 'red').length;
                const redPercentage = totalTalks > 0 ? Math.round((redTalks / totalTalks) * 100) : 0;
                const yellowTalks = filteredRecords.filter(r => r.riskLevel === 'yellow').length;
                const greenTalks = filteredRecords.filter(r => r.riskLevel === 'green').length;
                const avgTalksPerStudent = uniqueStudents > 0 ? (totalTalks / uniqueStudents).toFixed(1) : '0';
                
                reportContent += `
                    <div class="section">
                        <h2 class="section-title">‰∏Ä„ÄÅÊï∞ÊçÆÊ¶ÇËßà</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value">${totalTalks}</div>
                                <div class="summary-label">ÊÄªË∞àËØùÊ¨°Êï∞</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${uniqueStudents}</div>
                                <div class="summary-label">Ê∂âÂèäÂ≠¶ÁîüÊï∞</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${avgTalksPerStudent}</div>
                                <div class="summary-label">‰∫∫ÂùáË∞àËØùÊ¨°Êï∞</div>
                            </div>
                        </div>
                        
                        <table>
                            <tr>
                                <th>È£éÈô©Á≠âÁ∫ß</th>
                                <th>Ë∞àËØùÊ¨°Êï∞</th>
                                <th>Âç†ÊØî</th>
                            </tr>
                            <tr>
                                <td><strong style="color:#c62828;">Á∫¢Ëâ≤È¢ÑË≠¶</strong></td>
                                <td>${redTalks}</td>
                                <td>${redPercentage}%</td>
                            </tr>
                            <tr>
                                <td><strong style="color:#f57f17;">ÈªÑËâ≤ÂÖ≥Ê≥®</strong></td>
                                <td>${yellowTalks}</td>
                                <td>${totalTalks > 0 ? Math.round((yellowTalks / totalTalks) * 100) : 0}%</td>
                            </tr>
                            <tr>
                                <td><strong style="color:#2e7d32;">ÁªøËâ≤Ê≠£Â∏∏</strong></td>
                                <td>${greenTalks}</td>
                                <td>${totalTalks > 0 ? Math.round((greenTalks / totalTalks) * 100) : 0}%</td>
                            </tr>
                        </table>
                    </div>
                `;
                
                // Êï∞ÊçÆÊ¥ûÂØü
                const insights = [];
                
                if (redPercentage > 10) {
                    insights.push(`È´òÈ£éÈô©Ë∞àËØùÂç†ÊØî${redPercentage}%ÔºåÈúÄË¶ÅÂä†Âº∫ÂØπÈ´òÈ£éÈô©Â≠¶ÁîüÁöÑÂÖ≥Ê≥®ÂíåÂπ≤È¢Ñ`);
                } else if (redPercentage === 0) {
                    insights.push(`ÁõÆÂâçÊ≤°ÊúâÈ´òÈ£éÈô©Ë∞àËØùËÆ∞ÂΩïÔºåÂ≠¶ÁîüÊï¥‰ΩìÁä∂ÊÄÅËâØÂ•Ω`);
                }
                
                if (avgTalksPerStudent > 2) {
                    insights.push(`‰∫∫ÂùáË∞àËØùÊ¨°Êï∞${avgTalksPerStudent}Ê¨°ÔºåË∞àËØùÂ∑•‰ΩúËæÉ‰∏∫Ê∑±ÂÖ•`);
                } else if (avgTalksPerStudent < 1) {
                    insights.push(`‰∫∫ÂùáË∞àËØùÊ¨°Êï∞${avgTalksPerStudent}Ê¨°ÔºåÂª∫ËÆÆÂ¢ûÂä†ÂØπÂ≠¶ÁîüÁöÑÂÖ≥Ê≥®`);
                }
                
                // ‰∏ªÈ¢òÂàÜÊûê
                const topicCounts = {};
                filteredRecords.forEach(record => {
                    record.topics.forEach(topic => {
                        const cleanTopic = topic.startsWith('ÂÖ∂‰ªñÔºö') ? 'ÂÖ∂‰ªñ' : topic;
                        topicCounts[cleanTopic] = (topicCounts[cleanTopic] || 0) + 1;
                    });
                });
                
                const sortedTopics = Object.entries(topicCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                if (sortedTopics.length > 0) {
                    let topicsHtml = '<table><tr><th>Ë∞àËØù‰∏ªÈ¢ò</th><th>Âá∫Áé∞Ê¨°Êï∞</th><th>Âç†ÊØî</th></tr>';
                    sortedTopics.forEach(([topic, count]) => {
                        const percentage = Math.round((count / totalTalks) * 100);
                        topicsHtml += `<tr><td>${topic}</td><td>${count}</td><td>${percentage}%</td></tr>`;
                    });
                    topicsHtml += '</table>';
                    
                    insights.push(`ÊúÄÂ∏∏ËÆ®ËÆ∫ÁöÑ‰∏ªÈ¢òÊòØ"${sortedTopics[0][0]}"ÔºåÂç†ÊØî${Math.round((sortedTopics[0][1] / totalTalks) * 100)}%`);
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">‰∫å„ÄÅË∞àËØù‰∏ªÈ¢òÂàÜÊûê</h2>
                            ${topicsHtml}
                        </div>
                    `;
                }
                
                // Áè≠Á∫ßÂàÜÊûê
                const classData = {};
                filteredStudents.forEach(student => {
                    if (student.className) {
                        if (!classData[student.className]) {
                            classData[student.className] = {
                                studentCount: 0,
                                talkCount: 0,
                                redCount: 0,
                                yellowCount: 0,
                                greenCount: 0
                            };
                        }
                        classData[student.className].studentCount++;
                    }
                });
                
                filteredRecords.forEach(record => {
                    const className = record.className;
                    if (className && classData[className]) {
                        classData[className].talkCount++;
                        
                        if (record.riskLevel === 'red') {
                            classData[className].redCount++;
                        } else if (record.riskLevel === 'yellow') {
                            classData[className].yellowCount++;
                        } else {
                            classData[className].greenCount++;
                        }
                    }
                });
                
                if (Object.keys(classData).length > 0) {
                    let classHtml = '<table><tr><th>Áè≠Á∫ß</th><th>Â≠¶ÁîüÊï∞</th><th>Ë∞àËØùÊ¨°Êï∞</th><th>‰∫∫ÂùáË∞àËØù</th><th>Á∫¢Ëâ≤È¢ÑË≠¶</th><th>ÈªÑËâ≤ÂÖ≥Ê≥®</th><th>ÁªøËâ≤Ê≠£Â∏∏</th></tr>';
                    
                    Object.entries(classData).forEach(([className, data]) => {
                        const avgTalks = data.studentCount > 0 ? (data.talkCount / data.studentCount).toFixed(1) : '0';
                        classHtml += `
                            <tr>
                                <td>${className}</td>
                                <td>${data.studentCount}</td>
                                <td>${data.talkCount}</td>
                                <td>${avgTalks}</td>
                                <td style="color:#c62828;">${data.redCount}</td>
                                <td style="color:#f57f17;">${data.yellowCount}</td>
                                <td style="color:#2e7d32;">${data.greenCount}</td>
                            </tr>
                        `;
                    });
                    
                    classHtml += '</table>';
                    
                    // ÊâæÂá∫Ë∞àËØùÊúÄÂ§öÁöÑÁè≠Á∫ß
                    const mostTalkativeClass = Object.entries(classData)
                        .sort(([,a], [,b]) => b.talkCount - a.talkCount)[0];
                    
                    if (mostTalkativeClass) {
                        insights.push(`Ë∞àËØùÊúÄÂ§öÁöÑÁè≠Á∫ßÊòØ${mostTalkativeClass[0]}ÔºåÂÖ±${mostTalkativeClass[1].talkCount}Ê¨°Ë∞àËØù`);
                    }
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">‰∏â„ÄÅÁè≠Á∫ßÊï∞ÊçÆÂàÜÊûê</h2>
                            ${classHtml}
                        </div>
                    `;
                }
                
                // È´òÈ¢ëË∞àËØùÂ≠¶Áîü
                const studentTalkCounts = {};
                filteredRecords.forEach(record => {
                    const studentId = record.studentId;
                    studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
                });
                
                const topStudents = Object.entries(studentTalkCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                if (topStudents.length > 0) {
                    let studentsHtml = '<table><tr><th>ÂßìÂêç</th><th>Áè≠Á∫ß</th><th>Ë∞àËØùÊ¨°Êï∞</th><th>Â§ÑÂàÜËÆ∞ÂΩï</th><th>Â≠¶Á±çÂºÇÂä®</th><th>‰∏ªË¶ÅÈ£éÈô©Á≠âÁ∫ß</th></tr>';
                    
                    topStudents.forEach(([studentId, count]) => {
                        const student = storedStudents.find(s => s.studentId === studentId);
                        if (student) {
                            // Ëé∑ÂèñËØ•Â≠¶ÁîüÁöÑÈ£éÈô©Á≠âÁ∫ßÔºàÂèñÊúÄ‰∏•ÈáçÁöÑÔºâ
                            const studentRecords = filteredRecords.filter(r => r.studentId === studentId);
                            let maxRiskLevel = 'green';
                            studentRecords.forEach(record => {
                                const riskOrder = { 'red': 3, 'yellow': 2, 'green': 1 };
                                if (riskOrder[record.riskLevel] > riskOrder[maxRiskLevel]) {
                                    maxRiskLevel = record.riskLevel;
                                }
                            });
                            
                            let riskDisplay = maxRiskLevel === 'red' ? 'Á∫¢Ëâ≤È¢ÑË≠¶' : 
                                            maxRiskLevel === 'yellow' ? 'ÈªÑËâ≤ÂÖ≥Ê≥®' : 'ÁªøËâ≤Ê≠£Â∏∏';
                            let riskColor = maxRiskLevel === 'red' ? '#c62828' : 
                                          maxRiskLevel === 'yellow' ? '#f57f17' : '#2e7d32';
                            
                            // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
                            const punishments = student.punishments && student.punishments.length > 0 ? 
                                student.punishments.join('„ÄÅ') : 'Êó†';
                            
                            // Â≠¶Á±çÂºÇÂä®ÊòæÁ§∫
                            const statusChange = student.statusChange || 'Êó†';
                            
                            studentsHtml += `
                                <tr>
                                    <td>${student.name}</td>
                                    <td>${student.className}</td>
                                    <td><strong>${count}</strong></td>
                                    <td>${punishments}</td>
                                    <td>${statusChange}</td>
                                    <td style="color:${riskColor};font-weight:bold;">${riskDisplay}</td>
                                </tr>
                            `;
                        }
                    });
                    
                    studentsHtml += '</table>';
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">Âõõ„ÄÅÈ´òÈ¢ëË∞àËØùÂ≠¶Áîü</h2>
                            ${studentsHtml}
                        </div>
                    `;
                }
                
                // Êï∞ÊçÆÊ¥ûÂØüÊÄªÁªì
                if (insights.length > 0) {
                    let insightsHtml = '<div class="insight-list">';
                    insights.forEach(insight => {
                        insightsHtml += `<div class="insight-item">‚Ä¢ ${insight}</div>`;
                    });
                    insightsHtml += '</div>';
                    
                    reportContent += `
                        <div class="section">
                            <h2 class="section-title">‰∫î„ÄÅÂÖ≥ÈîÆÊ¥ûÂØü‰∏éÂª∫ËÆÆ</h2>
                            ${insightsHtml}
                            <p><strong>Â∑•‰ΩúÂª∫ËÆÆÔºö</strong></p>
                            <ul>
                                <li>ÁªßÁª≠Âä†Âº∫ÂØπÈ´òÈ£éÈô©Â≠¶ÁîüÁöÑÂÖ≥Ê≥®ÂíåÂÆöÊúüË∑üËøõ</li>
                                <li>ÈíàÂØπÈ´òÈ¢ëË∞àËØùÂ≠¶ÁîüÔºåÂàÜÊûêÂÖ∂Ê∑±Â±ÇÈúÄÊ±ÇÂπ∂Êèê‰æõÈíàÂØπÊÄßÂ∏ÆÂä©</li>
                                <li>Ê†πÊçÆ‰∏ªÈ¢òÂàÜÊûêÁªìÊûúÔºåÂºÄÂ±ïÁõ∏ÂÖ≥‰∏ªÈ¢òÁöÑÂõ¢‰ΩìËæÖÂØºÊ¥ªÂä®</li>
                                <li>ÂÆöÊúü‰∏éÂ≠¶ÁîüÂπ≤ÈÉ®Ê≤üÈÄöÔºå‰∫ÜËß£Áè≠Á∫ßÊï¥‰ΩìÂä®ÊÄÅ</li>
                                <li>ÁâπÂà´ÂÖ≥Ê≥®ÊúâÂ§ÑÂàÜËÆ∞ÂΩïÂíåÂ≠¶Á±çÂºÇÂä®ÁöÑÂ≠¶Áîü</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Êä•ÂëäÁªìÂ∞æ
                reportContent += `
                        <div class="footer">
                            <p>Êä•ÂëäÁîüÊàêÁ≥ªÁªüÔºöËæÖÂØºÂëòË∞àÂøÉË∞àËØùÁÆ°ÁêÜÁ≥ªÁªü</p>
                            <p>ÁîüÊàêÊó∂Èó¥Ôºö${dateStr}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // ÂàõÂª∫BlobÂØπË±°
                const blob = new Blob(['\ufeff', reportContent], {
                    type: 'application/msword'
                });
                
                // ‰ΩøÁî®FileSaver‰øùÂ≠òÊñá‰ª∂
                const dateStrFile = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                let fileName = `Ë∞àÂøÉË∞àËØùÂàÜÊûêÊä•Âëä_${dateStrFile}`;
                
                if (classFilter) {
                    fileName += `_${classFilter}`;
                }
                
                saveAs(blob, `${fileName}.doc`);
                
                showMessage('ÂàÜÊûêÊä•ÂëäÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
                
            } catch (error) {
                console.error('ÂØºÂá∫ÂàÜÊûêÊä•ÂëäÊó∂Âá∫ÈîôÔºö', error);
                showMessage('ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // Êõ¥Êñ∞ËÆ∞ÂΩïÁªüËÆ°
        function updateRecordStats() {
            // ‰ªélocalStorageÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            if (talkRecords.length === 0) {
                document.getElementById('recordStatsCard').style.display = 'none';
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // ËÆ°ÁÆó‰ªäÊó•Ë∞àËØùÊï∞
            const todayCount = talkRecords.filter(record => {
                const recordDate = new Date(record.talkTime);
                return recordDate >= today;
            }).length;
            
            // ËÆ°ÁÆóÊú¨Âë®Ë∞àËØùÊï∞
            const weekCount = talkRecords.filter(record => {
                const recordDate = new Date(record.talkTime);
                return recordDate >= weekAgo;
            }).length;
            
            // ËÆ°ÁÆóÊú¨ÊúàË∞àËØùÊï∞
            const monthCount = talkRecords.filter(record => {
                const recordDate = new Date(record.talkTime);
                return recordDate >= monthAgo;
            }).length;
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞Â≠ó
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('weekCount').textContent = weekCount;
            document.getElementById('monthCount').textContent = monthCount;
            
            // Êõ¥Êñ∞ËøëÊúüË∞àËØùÂ≠¶ÁîüÂàóË°®
            updateRecentStudentsList();
        }
        
        // Êõ¥Êñ∞ËøëÊúüË∞àËØùÂ≠¶ÁîüÂàóË°®
        function updateRecentStudentsList() {
            const monthAgo = new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000);
            const recentTalks = talkRecords.filter(record => {
                return new Date(record.talkTime) >= monthAgo;
            });
            
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
            const studentTalkCounts = {};
            recentTalks.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
            const recentStudentsList = document.getElementById('recentStudentsList');
            recentStudentsList.innerHTML = '';
            
            // Âè™ÊòæÁ§∫Ââç10‰∏™ÊúÄËøëË∞àËØùÁöÑÂ≠¶Áîü
            Object.entries(studentTalkCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .forEach(([studentId, count]) => {
                    const student = students.find(s => s.studentId === studentId);
                    if (student) {
                        const tag = document.createElement('div');
                        tag.className = 'student-tag';
                        tag.innerHTML = `
                            ${student.name}
                            <span class="talk-count">${count}</span>
                        `;
                        recentStudentsList.appendChild(tag);
                    }
                });
        }
        
      // ÁÆÄÂåñÁöÑÂ≠¶ÁîüÁªüËÆ°ÂäüËÉΩ
        function updateStudentStats(filteredStudents = null) {
            const statsContainer = document.getElementById('statsContainer');
            
            if (!statsContainer) return;
            
            // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÂ≠¶ÁîüÊï∞ÊçÆ
            const currentStudents = filteredStudents || students;
            const totalStudents = currentStudents.length;
            
            // ÁªüËÆ°ÂêÑÈ£éÈô©Á≠âÁ∫ß‰∫∫Êï∞
            const redCount = currentStudents.filter(s => s.riskLevel === 'red').length;
            const yellowCount = currentStudents.filter(s => s.riskLevel === 'yellow').length;
            const greenCount = currentStudents.filter(s => s.riskLevel === 'green').length;
            
            // ÁªüËÆ°ÊîøÊ≤ªÈù¢Ë≤å
            const partyMemberCount = currentStudents.filter(s => s.politicalStatus === '‰∏≠ÂÖ±ÂÖöÂëò' || s.politicalStatus === '‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò').length;
            const leagueMemberCount = currentStudents.filter(s => s.politicalStatus === 'ÂÖ±ÈùíÂõ¢Âëò').length;
            const massesCount = currentStudents.filter(s => s.politicalStatus === 'Áæ§‰ºó' || !s.politicalStatus).length;
            
            // ÁªüËÆ°Âõ∞ÈöæËÆ§ÂÆö
            const severeHardshipCount = currentStudents.filter(s => s.hardship === 'ÁâπÂà´Âõ∞Èöæ').length;
            const generalHardshipCount = currentStudents.filter(s => s.hardship === 'Âõ∞Èöæ').length;
            const mildHardshipCount = currentStudents.filter(s => s.hardship === '‰∏ÄËà¨Âõ∞Èöæ').length;
            
            // ÁªüËÆ°Â§ÑÂàÜËÆ∞ÂΩï
            const punishmentCount = currentStudents.filter(s => s.punishments && s.punishments.length > 0).length;
            
            // ÁªüËÆ°Â≠¶Á±çÂºÇÂä®
            const statusChangeCount = currentStudents.filter(s => s.statusChange && s.statusChange !== 'Êó†' && s.statusChange !== '').length;
            
            // ËÆ°ÁÆóÁôæÂàÜÊØî
            const redPercentage = totalStudents > 0 ? Math.round((redCount / totalStudents) * 100) : 0;
            const yellowPercentage = totalStudents > 0 ? Math.round((yellowCount / totalStudents) * 100) : 0;
            const greenPercentage = totalStudents > 0 ? Math.round((greenCount / totalStudents) * 100) : 0;
            const punishmentPercentage = totalStudents > 0 ? Math.round((punishmentCount / totalStudents) * 100) : 0;
            const statusChangePercentage = totalStudents > 0 ? Math.round((statusChangeCount / totalStudents) * 100) : 0;
            
            // ÁîüÊàêÁÆÄÂåñÁöÑÁªüËÆ°Âç°ÁâáHTML
            statsContainer.innerHTML = `
                <div class="stat-card total">
                    <div class="stat-value">
                        <span style="color: #3498db;">${totalStudents}</span>
                        <span style="font-size: 16px; color: #666;">‰∫∫</span>
                    </div>
                    <div class="stat-label">Â≠¶ÁîüÊÄªÊï∞</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-value">
                        <span style="color: #c62828;">${redCount}</span>
                        <span style="font-size: 16px; color: #666;">(${redPercentage}%)</span>
                    </div>
                    <div class="stat-label">Á∫¢Ëâ≤È¢ÑË≠¶</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-value">
                        <span style="color: #f57f17;">${yellowCount}</span>
                        <span style="font-size: 16px; color: #666;">(${yellowPercentage}%)</span>
                    </div>
                    <div class="stat-label">ÈªÑËâ≤ÂÖ≥Ê≥®</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-value">
                        <span style="color: #2e7d32;">${greenCount}</span>
                        <span style="font-size: 16px; color: #666;">(${greenPercentage}%)</span>
                    </div>
                    <div class="stat-label">ÁªøËâ≤Ê≠£Â∏∏</div>
                </div>
                <div class="stat-card" style="border-top-color: #c62828;">
                    <div class="stat-value">
                        <span style="color: #c62828;">${punishmentCount}</span>
                        <span style="font-size: 16px; color: #666;">(${punishmentPercentage}%)</span>
                    </div>
                    <div class="stat-label">ÊúâÂ§ÑÂàÜËÆ∞ÂΩï</div>
                </div>
                <div class="stat-card" style="border-top-color: #0277bd;">
                    <div class="stat-value">
                        <span style="color: #0277bd;">${statusChangeCount}</span>
                        <span style="font-size: 16px; color: #666;">(${statusChangePercentage}%)</span>
                    </div>
                    <div class="stat-label">Â≠¶Á±çÂºÇÂä®</div>
                </div>
            `;
        }
        
        // ÊâπÈáèÂà†Èô§ÂäüËÉΩ
        function toggleSelectAllStudents(checkbox) {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBatchActionState();
        }

        function updateBatchActionState() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            const selectedCount = checkboxes.length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchActionInfo = document.getElementById('batchActionInfo');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            if (selectedCount > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                batchActionInfo.style.display = 'block';
                selectedCountSpan.textContent = selectedCount;
            } else {
                batchDeleteBtn.style.display = 'none';
                batchActionInfo.style.display = 'none';
            }
        }

        function clearSelection() {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAllStudents').checked = false;
            updateBatchActionState();
        }

        function batchDeleteStudents() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showMessage('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂ≠¶ÁîüÔºÅ', 'error');
                return;
            }
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedIds.length} ‰∏™Â≠¶ÁîüÂêóÔºüÂà†Èô§ÂêéËøô‰∫õÂ≠¶ÁîüÁöÑÊâÄÊúâË∞àËØùËÆ∞ÂΩï‰πüÂ∞ÜË¢´Âà†Èô§ÔºÅ`)) {
                return;
            }
            
            try {
                // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂ≠¶Áîü
                students = students.filter(student => !selectedIds.includes(student.studentId));
                
                // Âà†Èô§Ëøô‰∫õÂ≠¶ÁîüÁöÑÊâÄÊúâË∞àËØùËÆ∞ÂΩï
                talkRecords = talkRecords.filter(record => !selectedIds.includes(record.studentId));
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                // Âà∑Êñ∞ÁïåÈù¢
                loadStudentsTable();
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                
                // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
                clearSelection();
                
                showMessage(`ÊàêÂäüÂà†Èô§ ${selectedIds.length} ‰∏™Â≠¶ÁîüÂèäÁõ∏ÂÖ≥ËÆ∞ÂΩïÔºÅ`, 'success');
                
            } catch (error) {
                console.error('ÊâπÈáèÂà†Èô§Â≠¶ÁîüÊó∂Âá∫ÈîôÔºö', error);
                showMessage('ÊâπÈáèÂà†Èô§Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
   // Ë∞àËØùËøΩË∏™ÁªüËÆ°ÂäüËÉΩ
        function updateTalkTrackingStats() {
            // ‰ªélocalStorageÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            const totalTalks = talkRecords.length;
            
            // ÁªüËÆ°Ê∂âÂèäÁöÑÂ≠¶ÁîüÊï∞
            const uniqueStudents = new Set();
            talkRecords.forEach(record => {
                if (record.studentId) {
                    uniqueStudents.add(record.studentId);
                }
            });
            
            // ÁªüËÆ°Á∫¢Ëâ≤È¢ÑË≠¶Ë∞àËØùÊï∞
            const redTalks = talkRecords.filter(record => record.riskLevel === 'red').length;
            
            // Êõ¥Êñ∞ÁªüËÆ°Êï∞Â≠ó
            document.getElementById('totalTalksCount').textContent = totalTalks;
            document.getElementById('uniqueStudentsCount').textContent = uniqueStudents.size;
            document.getElementById('redTalksCount').textContent = redTalks;
            
            // Êõ¥Êñ∞È´òÈ¢ëË∞àËØùÂ≠¶Áîü
            updateFrequentStudents();
            
            // Êõ¥Êñ∞ÊúàÂ∫¶ÁªüËÆ°
            updateMonthlyStats();
            
            // ÂàùÂßãÂåñÊúà‰ªΩÁ≠õÈÄâÂô®
            initMonthFilter();
        }
        
        // Êõ¥Êñ∞È´òÈ¢ëË∞àËØùÂ≠¶Áîü
        function updateFrequentStudents() {
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
            const studentTalkCounts = {};
            talkRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            // ÊâæÂá∫È´òÈ¢ëË∞àËØùÂ≠¶ÁîüÔºàË∞àËØùÊ¨°Êï∞>=3Ôºâ
            const frequentStudents = Object.entries(studentTalkCounts)
                .filter(([_, count]) => count >= 3)
                .sort(([,a], [,b]) => b - a);
            
            const frequentStudentsList = document.getElementById('frequentStudentsList');
            frequentStudentsList.innerHTML = '';
            
            if (frequentStudents.length > 0) {
                document.getElementById('frequentStudents').style.display = 'block';
                
                frequentStudents.forEach(([studentId, count]) => {
                    const student = students.find(s => s.studentId === studentId);
                    if (student) {
                        const tag = document.createElement('div');
                        tag.className = 'student-tag';
                        tag.innerHTML = `
                            ${student.name}
                            <span class="talk-count" style="background: #c62828;">${count}</span>
                        `;
                        frequentStudentsList.appendChild(tag);
                    }
                });
            } else {
                document.getElementById('frequentStudents').style.display = 'none';
            }
        }
        
        // Êõ¥Êñ∞ÊúàÂ∫¶ÁªüËÆ°ÔºàÂÆûÊó∂Êõ¥Êñ∞ÔºåÊÄªÊòØÊòæÁ§∫ÊúÄËøë6‰∏™ÊúàÔºâ
        function updateMonthlyStats() {
            const monthlyStats = document.getElementById('monthlyStats');
            monthlyStats.innerHTML = '';
            
            if (talkRecords.length === 0) {
                monthlyStats.style.display = 'none';
                return;
            }
            
            monthlyStats.style.display = 'grid';
            
            // Ëé∑ÂèñÊúÄËøë6‰∏™ÊúàÁöÑÊï∞ÊçÆÔºàÂåÖÂê´ÂΩìÂâçÊúàÔºâ
            const now = new Date();
            const months = [];
            
            // ËÆ°ÁÆóÊúÄËøë6‰∏™ÊúàÔºàÂΩìÂâçÊúà + Ââç5‰∏™ÊúàÔºâ
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`;
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÊúàÔºåÊ∑ªÂä†Ê†áËØÜ
                const isCurrentMonth = i === 0;
                const displayName = isCurrentMonth ? `${monthName}ÔºàÊú¨ÊúàÔºâ` : monthName;
                
                months.push({
                    year: date.getFullYear(),
                    month: date.getMonth() + 1,
                    name: monthName,
                    displayName: displayName,
                    isCurrent: isCurrentMonth
                });
            }
            
            // ÁªüËÆ°ÊØè‰∏™ÊúàÁöÑË∞àËØùÊï∞
            const monthCounts = {};
            months.forEach(m => {
                const key = `${m.year}-${m.month.toString().padStart(2, '0')}`;
                monthCounts[key] = 0;
            });
            
            talkRecords.forEach(record => {
                const recordDate = new Date(record.talkTime);
                const year = recordDate.getFullYear();
                const month = recordDate.getMonth() + 1;
                const key = `${year}-${month.toString().padStart(2, '0')}`;
                
                if (monthCounts.hasOwnProperty(key)) {
                    monthCounts[key]++;
                }
            });
            
            // ÁîüÊàêÊúàÂ∫¶ÁªüËÆ°È°π
            let totalCount = 0;
            months.forEach(m => {
                const key = `${m.year}-${m.month.toString().padStart(2, '0')}`;
                const count = monthCounts[key] || 0;
                totalCount += count;
                
                const statItem = document.createElement('div');
                statItem.className = 'month-stat-item';
                
                // Ê†πÊçÆÊòØÂê¶ÂΩìÂâçÊúàÊ∑ªÂä†‰∏çÂêåÊ†∑Âºè
                if (m.isCurrent) {
                    statItem.style.border = '2px solid #3498db';
                    statItem.style.boxShadow = '0 2px 5px rgba(52, 152, 219, 0.2)';
                }
                
                // Ê†πÊçÆË∞àËØùÊï∞ÈáèÊ∑ªÂä†È¢úËâ≤ÊèêÁ§∫
                let countColor = '#666';
                if (count >= 10) countColor = '#c62828';
                else if (count >= 5) countColor = '#f57f17';
                else if (count > 0) countColor = '#2e7d32';
                
                statItem.innerHTML = `
                    <div class="month-name">${m.displayName}</div>
                    <div class="month-count" style="color: ${countColor}">${count}</div>
                `;
                
                monthlyStats.appendChild(statItem);
            });
            
            // Ê∑ªÂä†ÊÄªËÆ°Âç°Áâá
            const totalCard = document.createElement('div');
            totalCard.className = 'month-stat-item';
            totalCard.style.gridColumn = '1 / -1'; // Ë∑®ÊâÄÊúâÂàó
            totalCard.style.textAlign = 'center';
            totalCard.style.background = '#f8f9fa';
            totalCard.innerHTML = `
                <div class="month-name" style="font-weight: bold;">ÊúÄËøë6‰∏™ÊúàÊÄªËÆ°</div>
                <div class="month-count" style="font-size: 24px; color: #3498db;">${totalCount}</div>
            `;
            monthlyStats.appendChild(totalCard);
        }
        
        // Êúà‰ªΩÁ≠õÈÄâÂäüËÉΩ
        function initMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            if (!monthFilter) return;
            
            monthFilter.innerHTML = '<option value="">ÊâÄÊúâÊúà‰ªΩ</option>';
            
            // Ëé∑ÂèñÊâÄÊúâË∞àËØùËÆ∞ÂΩï‰∏≠ÁöÑÊúà‰ªΩ
            const monthSet = new Set();
            talkRecords.forEach(record => {
                const date = new Date(record.talkTime);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const key = `${year}-${month.toString().padStart(2, '0')}`;
                monthSet.add(key);
            });
            
            // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊéíÂ∫èÔºàÊúÄËøëÁöÑÂú®ÂâçÔºâ
            const months = Array.from(monthSet).sort((a, b) => b.localeCompare(a));
            
            // Ê∑ªÂä†ÈÄâÈ°π
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const monthName = `${year}Âπ¥${parseInt(month)}Êúà`;
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = monthName;
                monthFilter.appendChild(option);
            });
        }

        // ÊåâÊúà‰ªΩÁ≠õÈÄâ
        function filterByMonth() {
            const monthFilter = document.getElementById('monthFilter');
            const selectedMonth = monthFilter.value;
            
            if (!selectedMonth) {
                // Â¶ÇÊûúÈÄâÊã©"ÊâÄÊúâÊúà‰ªΩ"ÔºåÂàô‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥Á≠õÈÄâÂô®
                loadTalkRecords();
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const dateFrom = new Date(year, month - 1, 1);
            const dateTo = new Date(year, month, 0, 23, 59, 59);
            
            // Â∫îÁî®Á≠õÈÄâ
            const filters = {
                dateFrom: dateFrom.toISOString().slice(0, 10),
                dateTo: dateTo.toISOString().slice(0, 10)
            };
            
            loadTalkRecords(filters);
        }
        
        // ÊåâÊó∂Èó¥Á≠õÈÄâËÆ∞ÂΩï
        function filterByTime(filterType) {
            currentTimeFilter = filterType;
            
            // Êõ¥Êñ∞Á≠õÈÄâÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ÈáçÁΩÆÊúà‰ªΩÁ≠õÈÄâ
            document.getElementById('monthFilter').value = '';
            
            // ÈáçÊñ∞Âä†ËΩΩËÆ∞ÂΩï
            searchTalkRecords();
        }
        
        // Ëé∑ÂèñÊó∂Èó¥Á≠õÈÄâÊù°‰ª∂
        function getTimeFilterRange(filterType) {
            const now = new Date();
            let dateFrom = null;
            let dateTo = null;
            
            switch(filterType) {
                case 'today':
                    dateFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    dateFrom = new Date(weekAgo.getFullYear(), weekAgo.getMonth(), weekAgo.getDate());
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    dateFrom = new Date(monthAgo.getFullYear(), monthAgo.getMonth(), monthAgo.getDate());
                    break;
                case 'quarter':
                    const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    dateFrom = new Date(quarterAgo.getFullYear(), quarterAgo.getMonth(), quarterAgo.getDate());
                    break;
            }
            
            return { dateFrom, dateTo };
        }
        
        // Â≠¶ÁîüÊêúÁ¥¢ÂäüËÉΩ
        function searchStudentsForSelect(searchTerm) {
            const resultsContainer = document.getElementById('studentSearchResults');
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = '';
            
            if (!searchTerm.trim()) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredStudents = students.filter(student => 
                student.name.includes(searchTerm) ||
                student.studentId.includes(searchTerm) ||
                student.className.includes(searchTerm)
            );
            
            if (filteredStudents.length === 0) {
                const noResult = document.createElement('div');
                noResult.className = 'search-select-item';
                noResult.textContent = 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂ≠¶Áîü';
                resultsContainer.appendChild(noResult);
            } else {
                filteredStudents.forEach(student => {
                    const item = document.createElement('div');
                    item.className = 'search-select-item';
                    
                    // Ëé∑ÂèñÂ≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
                    const talkCount = talkRecords.filter(r => r.studentId === student.studentId).length;
                    
                    // ÊîøÊ≤ªÈù¢Ë≤åÊ†áÁ≠æ
                    let politicalTag = '';
                    if (student.politicalStatus) {
                        politicalTag = `<span class="political-tag" style="font-size: 10px;">${student.politicalStatus}</span>`;
                    }
                    
                    // Âõ∞ÈöæËÆ§ÂÆöÊ†áÁ≠æ
                    let hardshipTag = '';
                    if (student.hardship && student.hardship !== 'Êó†') {
                        let hardshipClass = 'hardship-general';
                        if (student.hardship === 'ÁâπÂà´Âõ∞Èöæ') hardshipClass = 'hardship-severe';
                        else if (student.hardship === '‰∏ÄËà¨Âõ∞Èöæ') hardshipClass = 'hardship-none';
                        hardshipTag = `<span class="hardship-tag ${hardshipClass}" style="font-size: 10px;">${student.hardship}</span>`;
                    }
                    
                    // Â§ÑÂàÜËÆ∞ÂΩïÊ†áÁ≠æ
                    let punishmentTag = '';
                    if (student.punishments && student.punishments.length > 0) {
                        punishmentTag = `<span class="punishment-tag punishment-yes" style="font-size: 10px;">ÊúâÂ§ÑÂàÜ</span>`;
                    }
                    
                    // Â≠¶Á±çÂºÇÂä®Ê†áÁ≠æ
                    let statusChangeTag = '';
                    if (student.statusChange && student.statusChange !== 'Êó†') {
                        statusChangeTag = `<span class="status-change-tag status-change-yes" style="font-size: 10px;">${student.statusChange}</span>`;
                    }
                    
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 2px;">
                                    <strong>${student.name}</strong> (${student.studentId})
                                    ${politicalTag}
                                    ${hardshipTag}
                                    ${punishmentTag}
                                    ${statusChangeTag}
                                </div>
                                <small>${student.className} - ${student.dormitory || 'Êú™ÂàÜÈÖçÂÆøËàç'}</small>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                Ë∞àËØù${talkCount}Ê¨°
                            </div>
                        </div>
                    `;
                    item.onclick = () => selectStudent(student);
                    resultsContainer.appendChild(item);
                });
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function selectStudent(student) {
            document.getElementById('studentSearch').value = `${student.name} (${student.studentId})`;
            document.getElementById('studentId').value = student.studentId;
            document.getElementById('className').value = student.className;
            document.getElementById('dormitory').value = student.dormitory || '';
            document.getElementById('studentSearchResults').style.display = 'none';
            
            // ÊòæÁ§∫Â≠¶Áîü‰ø°ÊÅØÈù¢Êùø
            const panel = document.getElementById('studentInfoPanel');
            if (panel) {
                panel.style.display = 'block';
                
                // Ëé∑ÂèñÂ≠¶ÁîüÁöÑË∞àËØùËÆ∞ÂΩï
                const studentTalks = talkRecords.filter(r => r.studentId === student.studentId);
                const talkCount = studentTalks.length;
                
                // Ëé∑ÂèñÊúÄËøëË∞àËØùÊó∂Èó¥
                let lastTalk = 'Êó†ËÆ∞ÂΩï';
                if (studentTalks.length > 0) {
                    const latestTalk = studentTalks.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime))[0];
                    lastTalk = formatDate(latestTalk.talkTime);
                }
                
                // Êõ¥Êñ∞Â≠¶Áîü‰ø°ÊÅØ
                document.getElementById('infoTalkCount').textContent = `${talkCount}Ê¨°`;
                document.getElementById('infoLastTalk').textContent = lastTalk;
                document.getElementById('infoStatusChange').textContent = student.statusChange || 'Êó†';
                
                // Êõ¥Êñ∞È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
                const riskLevelElement = document.getElementById('infoRiskLevel');
                riskLevelElement.innerHTML = '';
                if (student.riskLevel) {
                    const riskSpan = document.createElement('span');
                    riskSpan.className = `risk-level ${student.riskLevel}`;
                    riskSpan.textContent = 
                        student.riskLevel === 'red' ? 'Á∫¢Ëâ≤È¢ÑË≠¶' :
                        student.riskLevel === 'yellow' ? 'ÈªÑËâ≤ÂÖ≥Ê≥®' : 'ÁªøËâ≤Ê≠£Â∏∏';
                    riskLevelElement.appendChild(riskSpan);
                }
            }
            
            // Ëá™Âä®Â°´ÂÜôÂ≠¶ÁîüËÉåÊôØ
            let background = `Â≠¶ÁîüÂü∫Êú¨‰ø°ÊÅØÔºö${student.name}Ôºå${student.className}Áè≠ÔºåÂÆøËàç${student.dormitory || 'Êú™ÂàÜÈÖç'}„ÄÇ`;
            
            // Â¶ÇÊûúÊúâÊâ©Â±ï‰ø°ÊÅØÔºåÊ∑ªÂä†Âà∞ËÉåÊôØ‰∏≠
            if (student.gender) background += ` ÊÄßÂà´Ôºö${student.gender}„ÄÇ`;
            if (student.politicalStatus) background += ` ÊîøÊ≤ªÈù¢Ë≤åÔºö${student.politicalStatus}„ÄÇ`;
            if (student.hardship && student.hardship !== 'Êó†') background += ` Âõ∞ÈöæËÆ§ÂÆöÔºö${student.hardship}„ÄÇ`;
            if (student.punishments && student.punishments.length > 0) {
                background += ` Â§ÑÂàÜËÆ∞ÂΩïÔºö${student.punishments.join('Ôºõ')}„ÄÇ`;
            }
            if (student.statusChange && student.statusChange !== 'Êó†') {
                background += ` Â≠¶Á±çÂºÇÂä®Ôºö${student.statusChange}„ÄÇ`;
            }
            
            // Â¶ÇÊûúÊúâÂéÜÂè≤Ë∞àËØùËÆ∞ÂΩïÔºåÊ∑ªÂä†Áõ∏ÂÖ≥‰ø°ÊÅØ
            const studentTalks = talkRecords.filter(r => r.studentId === student.studentId);
            if (studentTalks.length > 0) {
                const latestTalk = studentTalks.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime))[0];
                background += ` Â∑≤Êúâ${studentTalks.length}Ê¨°Ë∞àËØùËÆ∞ÂΩïÔºåÊúÄËøë‰∏ÄÊ¨°‰∏∫${formatDate(latestTalk.talkTime)}„ÄÇ`;
            }
            
            if (student.phone) background += ` ËÅîÁ≥ªÊñπÂºèÔºö${student.phone}„ÄÇ`;
            
            const backgroundElement = document.getElementById('studentBackground');
            if (backgroundElement) {
                backgroundElement.value = background;
            }
        }
        
        // ÂàáÊç¢ÂÖ∂‰ªñ‰∏ªÈ¢òËæìÂÖ•Ê°Ü
        function toggleOtherTopicInput() {
            const otherCheckbox = document.getElementById('otherTopicCheckbox');
            const otherInput = document.getElementById('otherTopicInput');
            
            if (otherCheckbox && otherInput) {
                if (otherCheckbox.checked) {
                    otherInput.style.display = 'block';
                } else {
                    otherInput.style.display = 'none';
                }
            }
        }
        
               // ‰øùÂ≠òË∞àËØùËÆ∞ÂΩï
        function saveTalkRecord() {
            try {
                console.log('ÂºÄÂßã‰øùÂ≠òË∞àËØùËÆ∞ÂΩï...');
                
                // Ëé∑ÂèñÁºñËæëID
                const editRecordId = document.getElementById('editRecordId').value;
                
                // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
                const studentId = document.getElementById('studentId').value;
                const studentSearch = document.getElementById('studentSearch').value;
                
                console.log('Â≠¶ÁîüID:', studentId);
                console.log('Â≠¶ÁîüÊêúÁ¥¢:', studentSearch);
                
                if (!studentId || !studentSearch) {
                    showMessage('ËØ∑ÂÖàÈÄâÊã©Â≠¶ÁîüÔºÅ', 'error');
                    return;
                }
                
                // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
                const selectedTopics = [];
                const topicCheckboxes = document.querySelectorAll('input[name="topic"]:checked');
                console.log('ÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢òÊï∞Èáè:', topicCheckboxes.length);
                
                topicCheckboxes.forEach(checkbox => {
                    if (checkbox.value === 'ÂÖ∂‰ªñ') {
                        const otherText = document.getElementById('otherTopicText')?.value;
                        if (otherText && otherText.trim()) {
                            selectedTopics.push(`ÂÖ∂‰ªñÔºö${otherText}`);
                        }
                    } else {
                        selectedTopics.push(checkbox.value);
                    }
                });
                
                console.log('ÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò:', selectedTopics);
                
                if (selectedTopics.length === 0) {
                    showMessage('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë∞àËØù‰∏ªÈ¢òÔºÅ', 'error');
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠"ÂÖ∂‰ªñ"‰ΩÜÊ≤°ËæìÂÖ•ÂÜÖÂÆπ
                const otherCheckbox = document.getElementById('otherTopicCheckbox');
                if (otherCheckbox && otherCheckbox.checked) {
                    const otherText = document.getElementById('otherTopicText')?.value;
                    if (!otherText || !otherText.trim()) {
                        showMessage('ËØ∑Â°´ÂÜôÂÖ∂‰ªñË∞àËØù‰∏ªÈ¢òÂÜÖÂÆπÔºÅ', 'error');
                        return;
                    }
                }
                
                // Ëé∑ÂèñÂàÜÁ∫ßÂª∫ËÆÆ
                const riskLevelRadio = document.querySelector('input[name="riskLevel"]:checked');
                if (!riskLevelRadio) {
                    showMessage('ËØ∑ÈÄâÊã©ÂàÜÁ∫ßÂª∫ËÆÆÔºÅ', 'error');
                    return;
                }
                const riskLevel = riskLevelRadio.value;
                console.log('È£éÈô©Á≠âÁ∫ß:', riskLevel);
                
                // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
const student = students.find(s => s.studentId === studentId);
if (!student) {
    // Â∞ùËØï‰ªéÂ≠¶ÁîüÊêúÁ¥¢Ê°Ü‰∏≠ÊèêÂèñÂ≠¶ÁîüÂßìÂêç
    const searchValue = document.getElementById('studentSearch').value;
    if (!searchValue) {
        showMessage('ËØ∑ÂÖàÈÄâÊã©Â≠¶ÁîüÔºÅ', 'error');
        return;
    }
    
    // ‰ªéÊêúÁ¥¢Ê°Ü‰∏≠ÊèêÂèñÂ≠¶ÁîüÂßìÂêçÔºàÊ†ºÂºèÔºöÂßìÂêç (Â≠¶Âè∑)Ôºâ
    let studentName = searchValue.split('(')[0].trim();
    if (!studentName) {
        studentName = 'Êú™Áü•Â≠¶Áîü';
    }
    
    // ‰ΩøÁî®‰ªéË°®Âçï‰∏≠Ëé∑ÂèñÁöÑ‰ø°ÊÅØ
    student = {
        studentId: studentId,
        name: studentName,
        className: document.getElementById('className').value,
        dormitory: document.getElementById('dormitory').value
    };
}
                
                console.log('ÊâæÂà∞Â≠¶Áîü:', student);
                
                // ÂàõÂª∫ËÆ∞ÂΩïÂØπË±°
                const record = {
                    id: editRecordId ? parseInt(editRecordId) : Date.now(),
                    studentId: studentId,
                    studentName: student.name,
                    className: document.getElementById('className').value,
                    dormitory: document.getElementById('dormitory').value,
                    talkTime: document.getElementById('talkTime').value,
                    talkLocation: document.getElementById('talkLocation').value,
                    topics: selectedTopics,
                    studentBackground: document.getElementById('studentBackground').value,
                    talkPurpose: document.getElementById('talkPurpose').value,
                    studentStatement: document.getElementById('studentStatement').value,
                    talkPoints: document.getElementById('talkPoints').value,
                    talkFeedback: document.getElementById('talkFeedback').value,
                    riskLevel: riskLevel,
                    followUpPlan: document.getElementById('followUpPlan')?.value || '',
                    generalRemark: document.getElementById('generalRemark')?.value || '',
                    studentSignature: document.getElementById('studentSignature')?.value || '',
                    ccounselorSignature: document.getElementById('counselorSignature')?.value || (currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò'),
                    createTime: editRecordId ? new Date().toISOString() : new Date().toISOString(),
                    updateTime: new Date().toISOString()
                };
                
                console.log('ÂàõÂª∫ÁöÑËÆ∞ÂΩï:', record);
                
                // ‰øùÂ≠òËÆ∞ÂΩï
                if (editRecordId) {
                    // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
                    const index = talkRecords.findIndex(r => r.id === parseInt(editRecordId));
                    if (index !== -1) {
                        talkRecords[index] = record;
                    }
                } else {
                    // Ê∑ªÂä†Êñ∞ËÆ∞ÂΩï
                    talkRecords.push(record);
                }
                
                console.log('‰øùÂ≠òÂâçÁöÑËÆ∞ÂΩïÊï∞Èáè:', talkRecords.length);
                
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                console.log('‰øùÂ≠òÂêéÁöÑlocalStorage:', localStorage.getItem('talkRecords'));
                
                showMessage(editRecordId ? 'ËÆ∞ÂΩïÊõ¥Êñ∞ÊàêÂäüÔºÅ' : 'ËÆ∞ÂΩï‰øùÂ≠òÊàêÂäüÔºÅ', 'success');

// Êõ¥Êñ∞Â≠¶ÁîüÈ£éÈô©Á≠âÁ∫ßÔºàÂ¶ÇÊûúÈÄâÊã©‰∫Ü‰∏çÂêåÁ≠âÁ∫ßÔºâ
if (student.riskLevel !== riskLevel) {
    student.riskLevel = riskLevel;
    localStorage.setItem('students', JSON.stringify(students));
}

// Á´ãÂç≥ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
talkRecords = JSON.parse(localStorage.getItem('talkRecords') || '[]');
students = JSON.parse(localStorage.getItem('students') || '[]');

// Ê∏ÖÁ©∫Ë°®Âçï
clearForm();

// Âà∑Êñ∞Áõ∏ÂÖ≥È°µÈù¢ÂíåÁªüËÆ°‰ø°ÊÅØ
loadStudentsTable();
loadTalkRecords();
loadExportList();
updateRecordStats();
updateTalkTrackingStats();
updateAnalysisData();  // Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÂàÜÊûêÊï∞ÊçÆ
                
                // Âà∑Êñ∞Áõ∏ÂÖ≥È°µÈù¢ÂíåÁªüËÆ°‰ø°ÊÅØ
                loadStudentsTable();
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                
                console.log('‰øùÂ≠òÂÆåÊàê');
                
                // ÁßªÈô§URL‰∏≠ÁöÑÁºñËæëÂèÇÊï∞
                if (editRecordId) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
            } catch (error) {
                console.error('‰øùÂ≠òË∞àËØùËÆ∞ÂΩïÊó∂Âá∫ÈîôÔºö', error);
                showMessage('‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // ‰øùÂ≠ò‰∏∫ËçâÁ®ø
        function saveAsDraft() {
            try {
                // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
                const draftData = {
                    id: Date.now(),
                    studentId: document.getElementById('studentId').value || '',
                    studentSearch: document.getElementById('studentSearch').value || '',
                    className: document.getElementById('className').value || '',
                    dormitory: document.getElementById('dormitory').value || '',
                    talkTime: document.getElementById('talkTime').value || getCurrentDateTime(),
                    talkLocation: document.getElementById('talkLocation').value || '',
                    topics: getSelectedTopics(),
                    studentBackground: document.getElementById('studentBackground').value || '',
                    talkPurpose: document.getElementById('talkPurpose').value || '',
                    studentStatement: document.getElementById('studentStatement').value || '',
                    talkPoints: document.getElementById('talkPoints').value || '',
                    talkFeedback: document.getElementById('talkFeedback').value || '',
                    riskLevel: document.querySelector('input[name="riskLevel"]:checked')?.value || 'green',
                    followUpPlan: document.getElementById('followUpPlan')?.value || '',
                    generalRemark: document.getElementById('generalRemark')?.value || '',
                    studentSignature: document.getElementById('studentSignature')?.value || '',
                    counselorSignature: document.getElementById('counselorSignature')?.value || '',
                    createTime: new Date().toISOString()
                };
                
                // Ê∑ªÂä†Âà∞ËçâÁ®øÂàóË°®
                drafts.push(draftData);
                localStorage.setItem('talkDrafts', JSON.stringify(drafts));
                
                showMessage('Â∑≤‰øùÂ≠ò‰∏∫ËçâÁ®øÔºÅ', 'success');
                
            } catch (error) {
                console.error('‰øùÂ≠òËçâÁ®øÊó∂Âá∫ÈîôÔºö', error);
                showMessage('‰øùÂ≠òËçâÁ®øÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        function getSelectedTopics() {
            const selectedTopics = [];
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]:checked');
            
            topicCheckboxes.forEach(checkbox => {
                if (checkbox.value === 'ÂÖ∂‰ªñ') {
                    const otherText = document.getElementById('otherTopicText')?.value;
                    if (otherText && otherText.trim()) {
                        selectedTopics.push(`ÂÖ∂‰ªñÔºö${otherText}`);
                    }
                } else {
                    selectedTopics.push(checkbox.value);
                }
            });
            
            return selectedTopics;
        }
        
        function clearForm() {
            const form = document.getElementById('talkForm');
            if (form) {
                form.reset();
                document.getElementById('studentSearch').value = '';
                document.getElementById('studentId').value = '';
                document.getElementById('editRecordId').value = '';
                document.getElementById('talkTime').value = getCurrentDateTime();
                document.getElementById('studentInfoPanel').style.display = 'none';
                document.getElementById('counselorSignature').value = currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò';
                document.querySelector('input[name="riskLevel"][value="green"]').checked = true;
                
                // ÈáçÁΩÆÊåâÈíÆÊñáÊú¨
                document.getElementById('saveRecordBtn').textContent = '‰øùÂ≠òËÆ∞ÂΩï';
                document.getElementById('saveDraftBtn').style.display = 'none';
                
                // ÈáçÁΩÆÂÖ∂‰ªñ‰∏ªÈ¢òËæìÂÖ•Ê°Ü
                const otherInput = document.getElementById('otherTopicInput');
                if (otherInput) {
                    otherInput.style.display = 'none';
                }
                const otherText = document.getElementById('otherTopicText');
                if (otherText) {
                    otherText.value = '';
                }
            }
        }
        
        // ÁºñËæëË∞àËØùËÆ∞ÂΩïÂäüËÉΩ
        function loadTalkRecordForEdit(recordId) {
            const record = talkRecords.find(r => r.id === recordId);
            if (!record) {
                showMessage('Êú™ÊâæÂà∞Ë¶ÅÁºñËæëÁöÑËÆ∞ÂΩïÔºÅ', 'error');
                return;
            }
            
            // ÂàáÊç¢Âà∞ËÆ∞ÂΩïÈ°µÈù¢
            switchTab('record');
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('editRecordId').value = record.id;
            
            // Êü•ÊâæÂ≠¶Áîü
            const student = students.find(s => s.studentId === record.studentId);
            if (student) {
                document.getElementById('studentSearch').value = `${student.name} (${student.studentId})`;
                document.getElementById('studentId').value = student.studentId;
                selectStudent(student);
            }
            
            document.getElementById('className').value = record.className;
            document.getElementById('dormitory').value = record.dormitory;
            document.getElementById('talkTime').value = record.talkTime.replace(' ', 'T');
            document.getElementById('talkLocation').value = record.talkLocation;
            
            // ËÆæÁΩÆË∞àËØù‰∏ªÈ¢ò
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]');
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            record.topics.forEach(topic => {
                if (topic.startsWith('ÂÖ∂‰ªñÔºö')) {
                    document.getElementById('otherTopicCheckbox').checked = true;
                    document.getElementById('otherTopicText').value = topic.replace('ÂÖ∂‰ªñÔºö', '');
                    document.getElementById('otherTopicInput').style.display = 'block';
                } else {
                    const checkbox = document.querySelector(`input[name="topic"][value="${topic}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                }
            });
            
            document.getElementById('studentBackground').value = record.studentBackground;
            document.getElementById('talkPurpose').value = record.talkPurpose;
            document.getElementById('studentStatement').value = record.studentStatement;
            document.getElementById('talkPoints').value = record.talkPoints;
            document.getElementById('talkFeedback').value = record.talkFeedback;
            
            // ËÆæÁΩÆÈ£éÈô©Á≠âÁ∫ß
            const riskLevelRadio = document.querySelector(`input[name="riskLevel"][value="${record.riskLevel}"]`);
            if (riskLevelRadio) {
                riskLevelRadio.checked = true;
            }
            
            document.getElementById('followUpPlan').value = record.followUpPlan || '';
            document.getElementById('generalRemark').value = record.generalRemark || '';
            document.getElementById('studentSignature').value = record.studentSignature || '';
            document.getElementById('counselorSignature').value = record.counselorSignature || (currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò');
            
            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
            document.getElementById('saveRecordBtn').textContent = 'Êõ¥Êñ∞ËÆ∞ÂΩï';
            document.getElementById('saveDraftBtn').style.display = 'inline-block';
            
            showMessage('Â∑≤Âä†ËΩΩË¶ÅÁºñËæëÁöÑËÆ∞ÂΩï', 'info');
        }
        
        function loadDraftForEdit(draftId) {
            const draft = drafts.find(d => d.id === parseInt(draftId));
            if (!draft) {
                showMessage('Êú™ÊâæÂà∞Ë¶ÅÁºñËæëÁöÑËçâÁ®øÔºÅ', 'error');
                return;
            }
            
            // ÂàáÊç¢Âà∞ËÆ∞ÂΩïÈ°µÈù¢
            switchTab('record');
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('editRecordId').value = draft.id;
            
            if (draft.studentId) {
                const student = students.find(s => s.studentId === draft.studentId);
                if (student) {
                    document.getElementById('studentSearch').value = draft.studentSearch;
                    document.getElementById('studentId').value = draft.studentId;
                    selectStudent(student);
                }
            }
            
            document.getElementById('className').value = draft.className;
            document.getElementById('dormitory').value = draft.dormitory;
            document.getElementById('talkTime').value = draft.talkTime;
            document.getElementById('talkLocation').value = draft.talkLocation;
            
            // ËÆæÁΩÆË∞àËØù‰∏ªÈ¢ò
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]');
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            if (draft.topics && draft.topics.length > 0) {
                draft.topics.forEach(topic => {
                    if (topic.startsWith('ÂÖ∂‰ªñÔºö')) {
                        document.getElementById('otherTopicCheckbox').checked = true;
                        document.getElementById('otherTopicText').value = topic.replace('ÂÖ∂‰ªñÔºö', '');
                        document.getElementById('otherTopicInput').style.display = 'block';
                    } else {
                        const checkbox = document.querySelector(`input[name="topic"][value="${topic}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    }
                });
            }
            
            document.getElementById('studentBackground').value = draft.studentBackground;
            document.getElementById('talkPurpose').value = draft.talkPurpose;
            document.getElementById('studentStatement').value = draft.studentStatement;
            document.getElementById('talkPoints').value = draft.talkPoints;
            document.getElementById('talkFeedback').value = draft.talkFeedback;
            
            // ËÆæÁΩÆÈ£éÈô©Á≠âÁ∫ß
            if (draft.riskLevel) {
                const riskLevelRadio = document.querySelector(`input[name="riskLevel"][value="${draft.riskLevel}"]`);
                if (riskLevelRadio) {
                    riskLevelRadio.checked = true;
                }
            }
            
            document.getElementById('followUpPlan').value = draft.followUpPlan || '';
            document.getElementById('generalRemark').value = draft.generalRemark || '';
            document.getElementById('studentSignature').value = draft.studentSignature || '';
            document.getElementById('counselorSignature').value = draft.counselorSignature || (currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò');
            
            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
            document.getElementById('saveRecordBtn').textContent = '‰øùÂ≠òËÆ∞ÂΩï';
            document.getElementById('saveDraftBtn').style.display = 'inline-block';
            
            showMessage('Â∑≤Âä†ËΩΩËçâÁ®ø', 'info');
        }
        
        // ÊòæÁ§∫DOCÈ¢ÑËßà
        function showDocPreview(recordId) {
            let record;
            
            if (recordId) {
                // Â¶ÇÊûúÊòØÊü•ÁúãÂéÜÂè≤ËÆ∞ÂΩï
                record = talkRecords.find(r => r.id === recordId);
            } else {
                // Â¶ÇÊûúÊòØÂΩìÂâçË°®Âçï
                if (!validateFormForExport()) {
                    return;
                }
                record = getFormDataForExport();
            }
            
            if (!record) {
                showMessage('Êú™ÊâæÂà∞ËÆ∞ÂΩïÔºÅ', 'error');
                return;
            }
            
            const previewHtml = generateDocHtml(record);
            document.getElementById('docPreview').innerHTML = previewHtml;
            document.getElementById('previewModal').style.display = 'flex';
        }
        
        // ÂÖ≥Èó≠È¢ÑËßàÊ®°ÊÄÅÊ°Ü
        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        // È™åËØÅË°®ÂçïÊï∞ÊçÆÔºàÁî®‰∫éÂØºÂá∫Ôºâ
        function validateFormForExport() {
            const studentName = document.getElementById('studentSearch').value;
            if (!studentName || studentName.trim() === '') {
                showMessage('ËØ∑ÂÖàÈÄâÊã©Â≠¶ÁîüÔºÅ', 'error');
                return false;
            }
            
            const topics = document.querySelectorAll('input[name="topic"]:checked');
            if (topics.length === 0) {
                showMessage('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë∞àËØù‰∏ªÈ¢òÔºÅ', 'error');
                return false;
            }
            
            return true;
        }
        
        // ‰ªéË°®ÂçïËé∑ÂèñÊï∞ÊçÆÔºàÁî®‰∫éÂØºÂá∫Ôºâ
        function getFormDataForExport() {
            // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
            const studentId = document.getElementById('studentId').value;
            const student = students.find(s => s.studentId === studentId);
            
            // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
            const selectedTopics = [];
            const topicCheckboxes = document.querySelectorAll('input[name="topic"]:checked');
            topicCheckboxes.forEach(checkbox => {
                if (checkbox.value === 'ÂÖ∂‰ªñ') {
                    const otherText = document.getElementById('otherTopicText')?.value;
                    if (otherText && otherText.trim()) {
                        selectedTopics.push(`ÂÖ∂‰ªñÔºö${otherText}`);
                    }
                } else {
                    selectedTopics.push(checkbox.value);
                }
            });
            
            // Ëé∑ÂèñÂàÜÁ∫ßÂª∫ËÆÆ
            const riskLevelRadio = document.querySelector('input[name="riskLevel"]:checked');
            const riskLevel = riskLevelRadio ? riskLevelRadio.value : 'green';
            
            // ÂàõÂª∫ËÆ∞ÂΩïÂØπË±°
            return {
                id: Date.now(),
                studentId: studentId,
                studentName: student ? student.name : document.getElementById('studentSearch').value.split('(')[0],
                className: document.getElementById('className').value,
                dormitory: document.getElementById('dormitory').value,
                talkTime: document.getElementById('talkTime').value,
                talkLocation: document.getElementById('talkLocation').value,
                topics: selectedTopics,
                studentBackground: document.getElementById('studentBackground').value,
                talkPurpose: document.getElementById('talkPurpose').value,
                studentStatement: document.getElementById('studentStatement').value,
                talkPoints: document.getElementById('talkPoints').value,
                talkFeedback: document.getElementById('talkFeedback').value,
                riskLevel: riskLevel,
                followUpPlan: document.getElementById('followUpPlan')?.value || '',
                generalRemark: document.getElementById('generalRemark')?.value || '',
                studentSignature: document.getElementById('studentSignature')?.value || '',
                counselorSignature: document.getElementById('counselorSignature')?.value || (currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò'),
                createTime: new Date().toISOString()
            };
        }
        
        // ÁîüÊàêDOCÊ†ºÂºèÁöÑHTML
        function generateDocHtml(record) {
            // Ê†ºÂºèÂåñÊó•Êúü
            const formatDate = (dateString) => {
                try {
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}Âπ¥${month}Êúà${day}Êó• ${hours}:${minutes}`;
                } catch (error) {
                    return dateString;
                }
            };
            
            // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
            const getRiskLevelText = (riskLevel) => {
                switch(riskLevel) {
                    case 'red': return 'Á∫¢Ëâ≤È¢ÑË≠¶';
                    case 'yellow': return 'ÈªÑËâ≤ÂÖ≥Ê≥®';
                    case 'green': return 'ÁªøËâ≤Ê≠£Â∏∏';
                    default: return 'Êú™ÂàÜÁ∫ß';
                }
            };
            
            // È£éÈô©Á≠âÁ∫ßÊ†∑Âºè
            const riskLevelStyle = (riskLevel) => {
                switch(riskLevel) {
                    case 'red': return 'color: #c62828; font-weight: bold;';
                    case 'yellow': return 'color: #f57f17; font-weight: bold;';
                    case 'green': return 'color: #2e7d32; font-weight: bold;';
                    default: return '';
                }
            };
            
            const riskLevelText = getRiskLevelText(record.riskLevel);
            const riskLevelStyleStr = riskLevelStyle(record.riskLevel);
            
            return `
                <div class="doc-content">
                    <div class="doc-header">
                        <h1>Âπø‰∏úÂ∑•ÂïÜËÅå‰∏öÊäÄÊúØÂ§ßÂ≠¶Ë¥¢ÁªèÊîøÊ≥ïÂ≠¶Èô¢</h1>
                        <h2>ËæÖÂØºÂëòË∞àÂøÉË∞àËØùËÆ∞ÂΩïË°®</h2>
                    </div>
                    
                    <table class="print-table">
                        <tr>
                            <th width="15%">Ë∞àËØùÂØπË±°</th>
                            <td width="35%">${record.studentName || ''}</td>
                            <th width="15%">Áè≠Á∫ß/ÂÆøËàç</th>
                            <td width="35%">${record.className || ''} / ${record.dormitory || ''}</td>
                        </tr>
                        <tr>
                            <th>Ë∞àËØùÊó∂Èó¥</th>
                            <td>${formatDate(record.talkTime)}</td>
                            <th>Ë∞àËØùÂú∞ÁÇπ</th>
                            <td>${record.talkLocation || ''}</td>
                        </tr>
                        <tr>
                            <th>Ë∞àËØù‰∏ªÈ¢ò</th>
                            <td colspan="3">${record.topics.join('„ÄÅ')}</td>
                        </tr>
                        <tr>
                            <th rowspan="3">Ë∞à<br>ËØù<br>Ë¶Å<br>ÁÇπ</th>
                            <td colspan="3">
                                <strong>Â≠¶ÁîüËÉåÊôØÔºö</strong><br>
                                ${record.studentBackground.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>Ë∞àËØùÁõÆÁöÑÔºö</strong><br>
                                ${record.talkPurpose.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>Â≠¶ÁîüËá™Ëø∞Ôºö</strong><br>
                                ${record.studentStatement.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <th>Â≠¶ÁîüÁ≠æÂêç</th>
                            <td>${record.studentSignature || ''}</td>
                            <th>ËæÖÂØºÂëòÁ≠æÂêç</th>
                            <td>${record.counselorSignature || ''}</td>
                        </tr>
                        <tr>
                            <th rowspan="3">Ë∞à<br>ËØù<br>Âèç<br>È¶à</th>
                            <td colspan="3">
                                ${record.talkFeedback.replace(/\n/g, '<br>')}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>ÂêéÁª≠Ë∑üËøõËÆ°ÂàíÔºö</strong><br>
                                ${record.followUpPlan ? record.followUpPlan.replace(/\n/g, '<br>') : 'Êó†'}
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <strong>ÂàÜÁ∫ßÂª∫ËÆÆÔºö</strong> 
                                <span style="${riskLevelStyleStr}">${riskLevelText}</span><br>
                                <strong>Â§áÊ≥®Ôºö</strong> ${record.generalRemark || 'Êó†'}
                            </td>
                        </tr>
                    </table>
                    
                    <div class="doc-footer">
                        <p>ËÆ∞ÂΩïÊó∂Èó¥Ôºö${formatDate(record.createTime)}</p>
                        <p>ËæÖÂØºÂëòÔºö${record.counselorSignature || (currentUser ? currentUser.fullname : 'ËæÖÂØºÂëò')}</p>
                    </div>
                </div>
            `;
        }
        
        // ÂØºÂá∫‰∏∫WordÊñáÊ°£
        function exportToWord() {
            try {
                const content = document.getElementById('docPreview').innerHTML;
                
                // ‰ªéÈ¢ÑËßàÂÜÖÂÆπ‰∏≠ÊèêÂèñÂ≠¶ÁîüÂßìÂêçÂíåÁè≠Á∫ß
                const previewContent = document.getElementById('docPreview').innerHTML;
                const studentNameMatch = previewContent.match(/Ë∞àËØùÂØπË±°<\/th>\s*<td[^>]*>([^<]+)</);
                const classNameMatch = previewContent.match(/Áè≠Á∫ß\/ÂÆøËàç<\/th>\s*<td[^>]*>([^<]+)/);
                
                let studentName = 'Êú™Áü•Â≠¶Áîü';
                let className = 'Êú™Áü•Áè≠Á∫ß';
                
                if (studentNameMatch && studentNameMatch[1]) {
                    studentName = studentNameMatch[1].trim();
                }
                
                if (classNameMatch && classNameMatch[1]) {
                    // ÊèêÂèñÁè≠Á∫ßÈÉ®ÂàÜÔºàÂéªÊéâÂÆøËàçÈÉ®ÂàÜÔºâ
                    const classAndDorm = classNameMatch[1].trim();
                    className = classAndDorm.split('/')[0].trim();
                }
                
                // ÂàõÂª∫ÂÆåÊï¥ÁöÑHTMLÊñáÊ°£
                const fullHtml = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Ë∞àÂøÉË∞àËØùËÆ∞ÂΩïË°®</title>
                        <style>
                            body {
                                font-family: "ÂÆã‰Ωì", "SimSun", serif;
                                margin: 2cm;
                                font-size: 12pt;
                            }
                            .print-table {
                                width: 100%;
                                border-collapse: collapse;
                                border: 2px solid #000;
                                margin: 20px 0;
                            }
                            .print-table th,
                            .print-table td {
                                border: 1px solid #000;
                                padding: 8px 12px;
                                vertical-align: top;
                            }
                            .print-table th {
                                background-color: #f0f0f0;
                                font-weight: bold;
                                text-align: center;
                            }
                            .doc-header {
                                text-align: center;
                                margin-bottom: 30px;
                                font-family: "Èªë‰Ωì", "SimHei", sans-serif;
                            }
                            .doc-header h1 {
                                font-size: 22pt;
                                margin-bottom: 10px;
                            }
                            .doc-header h2 {
                                font-size: 16pt;
                                margin-bottom: 20px;
                                color: #333;
                            }
                            .doc-footer {
                                margin-top: 50px;
                                text-align: right;
                                font-size: 11pt;
                                color: #666;
                            }
                            @page {
                                size: A4;
                                margin: 2cm;
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `;
                
                // ÂàõÂª∫BlobÂØπË±°
                const blob = new Blob(['\ufeff', fullHtml], {
                    type: 'application/msword'
                });
                
                // ‰ΩøÁî®FileSaver‰øùÂ≠òÊñá‰ª∂Ôºå‰ΩøÁî®Êñ∞ÁöÑÂëΩÂêçÊñπÂºè
                const fileName = `${studentName}_${className}_Ë∞àÂøÉË∞àËØùËÆ∞ÂΩï.doc`;
                saveAs(blob, fileName);
                
                showMessage('WordÊñáÊ°£ÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
                closePreviewModal();
                
            } catch (error) {
                console.error('ÂØºÂá∫WordÊñáÊ°£Êó∂Âá∫ÈîôÔºö', error);
                showMessage('ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // Áõ¥Êé•ÊâìÂç∞ÊñáÊ°£
        function printDocument() {
            window.print();
        }
        
        // ExcelÊâπÈáèÂØºÂÖ•ÂäüËÉΩ
        function showImportModal() {
            resetImport();
            document.getElementById('importModal').style.display = 'flex';
        }
        
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }
        
        function resetImport() {
            importData = [];
            importPreviewData = [];
            
            // ÈáçÁΩÆÊ≠•È™§ÊòæÁ§∫
            document.getElementById('uploadStep').style.display = 'block';
            document.getElementById('previewStep').style.display = 'none';
            document.getElementById('completeStep').style.display = 'none';
            
            // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
            document.getElementById('fileInput').value = '';
            
            // ÈáçÁΩÆÈ¢ÑËßàË°®Ê†º
            document.getElementById('previewTableContainer').innerHTML = '';
        }
        
        function initFileDrop() {
            const dropArea = document.getElementById('fileDropArea');
            
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });
            
            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
            });
            
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showMessage('ËØ∑ÈÄâÊã©ExcelÊñá‰ª∂Ôºà.xlsx Êàñ .xls Ê†ºÂºèÔºâ', 'error');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
            showMessage('Ê≠£Âú®ËØªÂèñExcelÊñá‰ª∂...', 'info');
            console.log('ÂºÄÂßãËØªÂèñÊñá‰ª∂:', file.name, 'Â§ßÂ∞è:', file.size);
            
            // ‰ΩøÁî®FileReaderËØªÂèñÊñá‰ª∂
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('Êñá‰ª∂ËØªÂèñÂÆåÊàêÔºåÂºÄÂßãËß£Êûê...');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    
                    console.log('Â∑•‰ΩúÁ∞ø‰ø°ÊÅØ:', workbook.SheetNames);
                    
                    // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™Â∑•‰ΩúË°®
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Â∞ÜÂ∑•‰ΩúË°®ËΩ¨Êç¢‰∏∫JSONÔºàÂåÖÂê´Á©∫ÂçïÂÖÉÊ†ºÔºâ
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                        header: 1, 
                        defval: '',
                        blankrows: true
                    });
                    
                    console.log('ÂéüÂßãExcelÊï∞ÊçÆ:', jsonData);
                    console.log('Êï∞ÊçÆË°åÊï∞:', jsonData.length);
                    
                    if (jsonData.length <= 1) {
                        showMessage('ExcelÊñá‰ª∂Ê≤°ÊúâÊï∞ÊçÆÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇËØ∑Á°Æ‰øùËá≥Â∞ëÊúâÊï∞ÊçÆË°å„ÄÇ', 'error');
                        return;
                    }
                    
                    // Â§ÑÁêÜExcelÊï∞ÊçÆ
                    processExcelData(jsonData);
                    
                } catch (error) {
                    console.error('ËØªÂèñExcelÊñá‰ª∂Êó∂Âá∫ÈîôÔºö', error);
                    showMessage(`ËØªÂèñExcelÊñá‰ª∂Â§±Ë¥•Ôºö${error.message}„ÄÇËØ∑Á°Æ‰øùÊñá‰ª∂Ê†ºÂºèÊ≠£Á°Æ„ÄÇ`, 'error');
                }
            };
            
            reader.onerror = function(e) {
                console.error('Êñá‰ª∂ËØªÂèñÈîôËØØÔºö', e);
                showMessage('ËØªÂèñÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            };
            
            // Ê∑ªÂä†ËøõÂ∫¶‰∫ã‰ª∂ÁõëÂê¨
            reader.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    console.log(`Êñá‰ª∂ËØªÂèñËøõÂ∫¶: ${percent}%`);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(jsonData) {
            // Ëé∑ÂèñË°®Â§¥Ë°å
            const headers = jsonData[0];
            
            // Ë∞ÉËØïÔºöÊâìÂç∞Ë°®Â§¥
            console.log('ExcelË°®Â§¥:', headers);
            
            // Ê†áÂáÜÂåñË°®Â§¥ÂêçÁß∞Êò†Â∞Ñ
            const headerMapping = {
                'Â≠¶Âè∑': ['Â≠¶Âè∑', 'Â≠¶ÁîüÂ≠¶Âè∑', 'student_id', 'StudentID', 'Â≠¶Âè∑'],
                'ÂßìÂêç': ['ÂßìÂêç', 'Â≠¶ÁîüÂßìÂêç', 'name', 'Name', 'ÂßìÂêç'],
                'Áè≠Á∫ß': ['Áè≠Á∫ß', '‰∏ì‰∏öÁè≠Á∫ß', 'class', 'Class', 'Áè≠Á∫ßÂêçÁß∞'],
                'ÂÆøËàç': ['ÂÆøËàç', 'ÂÆøËàçÂè∑', 'dormitory', 'Dorm', 'ÂØùÂÆ§'],
                'ÊÄßÂà´': ['ÊÄßÂà´', 'gender', 'Sex'],
                'ËÅîÁ≥ªÁîµËØù': ['ËÅîÁ≥ªÁîµËØù', 'ÁîµËØù', 'ÊâãÊú∫', 'phone', 'Phone', 'ËÅîÁ≥ªÁîµËØù'],
                'ÊîøÊ≤ªÈù¢Ë≤å': ['ÊîøÊ≤ªÈù¢Ë≤å', 'ÊîøÊ≤ª', 'Èù¢Ë≤å', 'political_status', 'Political'],
                'Âõ∞ÈöæËÆ§ÂÆö': ['Âõ∞ÈöæËÆ§ÂÆö', 'Âõ∞Èöæ', 'ËÆ§ÂÆö', 'hardship', 'Hardship'],
                'È£éÈô©Á≠âÁ∫ß': ['È£éÈô©Á≠âÁ∫ß', 'È£éÈô©', 'Á≠âÁ∫ß', 'risk_level', 'Risk'],
                'Â§ÑÂàÜËÆ∞ÂΩï': ['Â§ÑÂàÜËÆ∞ÂΩï', 'Â§ÑÂàÜ', 'punishment', 'Punishment'],
                'Â≠¶Á±çÂºÇÂä®': ['Â≠¶Á±çÂºÇÂä®', 'ÂºÇÂä®', 'status_change', 'StatusChange'],
                'Â§áÊ≥®': ['Â§áÊ≥®', 'ËØ¥Êòé', 'remark', 'Remark']
            };
            
            // ÂàõÂª∫ÂÆûÈôÖÂàóÁ¥¢ÂºïÊò†Â∞Ñ
            const headerMap = {};
            
            // Êü•ÊâæÂêÑÂàóÁ¥¢ÂºïÔºàÊîØÊåÅÂ§öÁßçË°®Â§¥ÂêçÁß∞Ôºâ
            headers.forEach((header, index) => {
                if (header) {
                    const headerStr = header.toString().trim();
                    
                    // ÈÅçÂéÜÊò†Â∞ÑË°®ÔºåÊâæÂà∞ÂåπÈÖçÁöÑÂàó
                    for (const [standardName, possibleNames] of Object.entries(headerMapping)) {
                        if (possibleNames.some(name => headerStr.includes(name) || name.includes(headerStr))) {
                            headerMap[standardName] = index;
                            console.log(`ÊâæÂà∞Âàó: ${standardName} -> Á¥¢Âºï: ${index} (ÂéüÂßã: ${headerStr})`);
                            break;
                        }
                    }
                }
            });
            
            // Ë∞ÉËØïÔºöÊâìÂç∞ÊâæÂà∞ÁöÑÂàóÊò†Â∞Ñ
            console.log('ÂàóÊò†Â∞Ñ:', headerMap);
            
            // Ê£ÄÊü•ÂøÖÈúÄÂàó
            const requiredColumns = ['Â≠¶Âè∑', 'ÂßìÂêç', 'Áè≠Á∫ß'];
            const missingColumns = requiredColumns.filter(col => headerMap[col] === undefined);
            
            if (missingColumns.length > 0) {
                showMessage(`ExcelÁº∫Â∞ëÂøÖÈúÄÂàóÔºö${missingColumns.join('„ÄÅ')}„ÄÇËØ∑‰∏ãËΩΩÊ®°ÊùøÂπ∂ÊåâÊ®°ÊùøÊ†ºÂºèÂ°´ÂÜô„ÄÇ`, 'error');
                console.error('Áº∫Â∞ëÂàó:', missingColumns);
                console.error('ÊâæÂà∞ÁöÑÂàó:', Object.keys(headerMap));
                return;
            }
            
            // Â§ÑÁêÜÊï∞ÊçÆË°å
            importData = [];
            let validCount = 0;
            let invalidCount = 0;
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // Ë∑≥ËøáÁ©∫Ë°å
                if (!row || row.length === 0 || row.every(cell => cell === null || cell === undefined || cell.toString().trim() === '')) {
                    continue;
                }
                
                // ÊèêÂèñÊï∞ÊçÆÔºà‰ΩøÁî®ÂÆâÂÖ®ÁöÑËÆøÈóÆÊñπÂºèÔºâ
                const getCellValue = (columnName) => {
                    const index = headerMap[columnName];
                    if (index !== undefined && row[index] !== undefined && row[index] !== null) {
                        return row[index].toString().trim();
                    }
                    return '';
                };
                
                const studentId = getCellValue('Â≠¶Âè∑');
                const name = getCellValue('ÂßìÂêç');
                const className = getCellValue('Áè≠Á∫ß');
                
                // Ë∞ÉËØïÔºöÊâìÂç∞ÊØè‰∏ÄË°åÊï∞ÊçÆ
                console.log(`Á¨¨${i+1}Ë°åÊï∞ÊçÆ:`, { studentId, name, className, row });
                
                // È™åËØÅÂøÖÈúÄÂ≠óÊÆµ
                if (!studentId || !name || !className) {
                    console.warn(`Á¨¨${i+1}Ë°åÊï∞ÊçÆÊó†Êïà:`, { studentId, name, className });
                    invalidCount++;
                    continue;
                }
                
                // ÊûÑÂª∫Â≠¶ÁîüÂØπË±°
                const student = {
                    studentId: studentId,
                    name: name,
                    className: className,
                    dormitory: getCellValue('ÂÆøËàç'),
                    gender: getCellValue('ÊÄßÂà´'),
                    phone: getCellValue('ËÅîÁ≥ªÁîµËØù'),
                    politicalStatus: getCellValue('ÊîøÊ≤ªÈù¢Ë≤å'),
                    hardship: getCellValue('Âõ∞ÈöæËÆ§ÂÆö'),
                    statusChange: getCellValue('Â≠¶Á±çÂºÇÂä®'),
                    generalRemark: getCellValue('Â§áÊ≥®')
                };
                
                // Â§ÑÁêÜÂ§ÑÂàÜËÆ∞ÂΩï
                const punishmentStr = getCellValue('Â§ÑÂàÜËÆ∞ÂΩï');
                if (punishmentStr) {
                    student.punishments = punishmentStr.split(/[;Ôºõ]/).map(p => p.trim()).filter(p => p);
                }
                
                // Â§ÑÁêÜÈ£éÈô©Á≠âÁ∫ß
                const riskLevelStr = getCellValue('È£éÈô©Á≠âÁ∫ß');
                if (riskLevelStr) {
                    const riskLower = riskLevelStr.toLowerCase();
                    if (riskLower.includes('Á∫¢') || riskLower.includes('red') || riskLower.includes('È¢ÑË≠¶')) {
                        student.riskLevel = 'red';
                    } else if (riskLower.includes('ÈªÑ') || riskLower.includes('yellow') || riskLower.includes('ÂÖ≥Ê≥®')) {
                        student.riskLevel = 'yellow';
                    } else if (riskLower.includes('Áªø') || riskLower.includes('green') || riskLower.includes('Ê≠£Â∏∏')) {
                        student.riskLevel = 'green';
                    } else {
                        student.riskLevel = 'green'; // ÈªòËÆ§ÂÄº
                    }
                } else {
                    student.riskLevel = 'green'; // ÈªòËÆ§ÂÄº
                }
                
                // È™åËØÅÂ≠¶Âè∑Ê†ºÂºèÔºàÂèØÈÄâÔºâ
                if (student.studentId.length < 3) {
                    console.warn(`Â≠¶Âè∑Ê†ºÂºèÂèØËÉΩ‰∏çÊ≠£Á°Æ: ${student.studentId}`);
                }
                
                importData.push(student);
                validCount++;
                console.log(`Á¨¨${i+1}Ë°åÊï∞ÊçÆÊúâÊïà:`, student);
            }
            
            if (importData.length === 0) {
                showMessage('ExcelÊñá‰ª∂‰∏≠Ê≤°ÊúâÊúâÊïàÁöÑÂ≠¶ÁîüÊï∞ÊçÆ„ÄÇËØ∑Á°Æ‰øùÊï∞ÊçÆÊ†ºÂºèÊ≠£Á°Æ„ÄÇ', 'error');
                return;
            }
            
            // ÁîüÊàêÈ¢ÑËßàÊï∞ÊçÆÔºàÊúÄÂ§ö10Ë°åÔºâ
            importPreviewData = importData.slice(0, 10);
            
            // Ê£ÄÊü•ÈáçÂ§çÊï∞ÊçÆ
            const existingIds = students.map(s => s.studentId);
            const duplicateCount = importData.filter(s => existingIds.includes(s.studentId)).length;
            
            // Êõ¥Êñ∞ÊëòË¶Å‰ø°ÊÅØ
            document.getElementById('validCount').textContent = validCount;
            document.getElementById('invalidCount').textContent = invalidCount;
            document.getElementById('duplicateCount').textContent = duplicateCount;
            
            // ÁîüÊàêÈ¢ÑËßàË°®Ê†º
            generatePreviewTable();
            
            // ÂàáÊç¢Âà∞È¢ÑËßàÊ≠•È™§
            document.getElementById('uploadStep').style.display = 'none';
            document.getElementById('previewStep').style.display = 'block';
            
            showMessage(`ÊàêÂäüËØªÂèñ ${validCount} Êù°ÊúâÊïàÊï∞ÊçÆÔºå${invalidCount} Êù°Êó†ÊïàÊï∞ÊçÆ`, 'success');
            console.log('ÊúÄÁªàÂØºÂÖ•Êï∞ÊçÆ:', importData);
        }
        
        function generatePreviewTable() {
            const container = document.getElementById('previewTableContainer');
            let html = '<table class="preview-table">';
            
            // Ë°®Â§¥
            html += '<thead><tr>';
            html += '<th>Â≠¶Âè∑</th>';
            html += '<th>ÂßìÂêç</th>';
            html += '<th>Áè≠Á∫ß</th>';
            html += '<th>ÂÆøËàç</th>';
            html += '<th>ÊîøÊ≤ªÈù¢Ë≤å</th>';
            html += '<th>Âõ∞ÈöæËÆ§ÂÆö</th>';
            html += '<th>È£éÈô©Á≠âÁ∫ß</th>';
            html += '<th>Â§ÑÂàÜËÆ∞ÂΩï</th>';
            html += '<th>Â≠¶Á±çÂºÇÂä®</th>';
            html += '<th>Áä∂ÊÄÅ</th>';
            html += '</tr></thead>';
            
            // Êï∞ÊçÆË°å
            html += '<tbody>';
            
            const existingIds = students.map(s => s.studentId);
            
            importPreviewData.forEach((student, index) => {
                const isDuplicate = existingIds.includes(student.studentId);
                const rowClass = isDuplicate ? 'invalid' : 'valid';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${student.studentId}</td>`;
                html += `<td>${student.name}</td>`;
                html += `<td>${student.className}</td>`;
                html += `<td>${student.dormitory || '-'}</td>`;
                html += `<td>${student.politicalStatus || '-'}</td>`;
                html += `<td>${student.hardship || '-'}</td>`;
                
                // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
                let riskLevelDisplay = '';
                if (student.riskLevel === 'red') {
                    riskLevelDisplay = '<span style="color:#c62828;font-weight:bold;">Á∫¢Ëâ≤È¢ÑË≠¶</span>';
                } else if (student.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span style="color:#f57f17;font-weight:bold;">ÈªÑËâ≤ÂÖ≥Ê≥®</span>';
                } else {
                    riskLevelDisplay = '<span style="color:#2e7d32;">ÁªøËâ≤Ê≠£Â∏∏</span>';
                }
                
                // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
                let punishmentsDisplay = '-';
                if (student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = '<span style="color:#c62828;font-weight:bold;">Êúâ</span>';
                }
                
                // Â≠¶Á±çÂºÇÂä®ÊòæÁ§∫
                let statusChangeDisplay = student.statusChange || '-';
                
                html += `<td>${riskLevelDisplay}</td>`;
                html += `<td>${punishmentsDisplay}</td>`;
                html += `<td>${statusChangeDisplay}</td>`;
                html += `<td>${isDuplicate ? '<span style="color:#c62828;">ÈáçÂ§ç</span>' : '<span style="color:#2e7d32;">ÊúâÊïà</span>'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // Ê∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØ
            if (importData.length > 10) {
                html += `<p style="text-align:center;color:#666;margin-top:10px;">‰ªÖÊòæÁ§∫Ââç10Ë°åÊï∞ÊçÆÔºåÂÖ± ${importData.length} Ë°åÊï∞ÊçÆ</p>`;
            }
            
            container.innerHTML = html;
        }
        
        function confirmImport() {
            const existingIds = students.map(s => s.studentId);
            let successCount = 0;
            let failCount = 0;
            
            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            document.getElementById('importProgress').style.display = 'block';
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // ÂàÜÊâπÂØºÂÖ•ÔºåÈÅøÂÖçUIÈòªÂ°û
            const batchSize = 50;
            const totalBatches = Math.ceil(importData.length / batchSize);
            let currentBatch = 0;
            
            function importBatch() {
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, importData.length);
                
                for (let i = start; i < end; i++) {
                    const student = importData[i];
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÈáçÂ§ç
                    if (!existingIds.includes(student.studentId)) {
                        students.push(student);
                        successCount++;
                    } else {
                        // Êõ¥Êñ∞Áé∞ÊúâÂ≠¶Áîü‰ø°ÊÅØ
                        const existingIndex = students.findIndex(s => s.studentId === student.studentId);
                        if (existingIndex >= 0) {
                            students[existingIndex] = { ...students[existingIndex], ...student };
                            successCount++;
                        } else {
                            failCount++;
                        }
                    }
                }
                
                // Êõ¥Êñ∞ËøõÂ∫¶
                currentBatch++;
                const progress = Math.round((currentBatch / totalBatches) * 100);
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${progress}% (${currentBatch * batchSize}/${importData.length})`;
                
                if (currentBatch < totalBatches) {
                    // ÁªßÁª≠‰∏ã‰∏ÄÊâπ
                    setTimeout(importBatch, 10);
                } else {
                    // ÂØºÂÖ•ÂÆåÊàê
                    localStorage.setItem('students', JSON.stringify(students));
                    
                    // Êõ¥Êñ∞ÂÆåÊàêÈ°µÈù¢
                    document.getElementById('successCount').textContent = successCount;
                    document.getElementById('failCount').textContent = failCount;
                    
                    // ÂàáÊç¢Âà∞ÂÆåÊàêÊ≠•È™§
                    document.getElementById('previewStep').style.display = 'none';
                    document.getElementById('completeStep').style.display = 'block';
                    
                    // Âà∑Êñ∞Â≠¶ÁîüË°®Ê†ºÂíåÁªüËÆ°‰ø°ÊÅØ
                    loadStudentsTable();
                    updateStudentStats();
                    
                    showMessage(`ÊàêÂäüÂØºÂÖ• ${successCount} Êù°Â≠¶ÁîüÊï∞ÊçÆ`, 'success');
                }
            }
            
            // ÂºÄÂßãÂØºÂÖ•
            importBatch();
        }
        
         // Â≠¶ÁîüÊï∞ÊçÆÂ∫ìÁÆ°ÁêÜ
        function loadStudentsTable(searchTerm = '', riskLevel = '', politicalStatus = '', hardship = '') {
            const tbody = document.getElementById('studentsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Ê∏ÖÁ©∫ÂÖ®ÈÄâÂ§çÈÄâÊ°Ü
            const selectAllCheckbox = document.getElementById('selectAllStudents');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            let filteredStudents = students;
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(student =>
                    student.name.includes(searchTerm) ||
                    student.studentId.includes(searchTerm) ||
                    student.className.includes(searchTerm)
                );
            }
            
            if (riskLevel) {
                filteredStudents = filteredStudents.filter(student => student.riskLevel === riskLevel);
            }
            
            if (politicalStatus) {
                filteredStudents = filteredStudents.filter(student => student.politicalStatus === politicalStatus);
            }
            
            if (hardship) {
                if (hardship === 'Êó†') {
                    filteredStudents = filteredStudents.filter(student => !student.hardship || student.hardship === 'Êó†');
                } else {
                    filteredStudents = filteredStudents.filter(student => student.hardship === hardship);
                }
            }
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px;">ÊöÇÊó†Â≠¶ÁîüÊï∞ÊçÆ</td></tr>';
                updateStudentStats(filteredStudents);
                updateBatchActionState();
                return;
            }
            
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
            const studentTalkCounts = {};
            talkRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            filteredStudents.forEach((student) => {
                const row = document.createElement('tr');
                
                // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
                let riskLevelDisplay = '';
                if (student.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">Á∫¢Ëâ≤È¢ÑË≠¶</span>';
                } else if (student.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ÁªøËâ≤Ê≠£Â∏∏</span>';
                }
                
                // ÊîøÊ≤ªÈù¢Ë≤åÊòæÁ§∫
                let politicalDisplay = student.politicalStatus || '-';
                if (student.politicalStatus) {
                    politicalDisplay = `<span class="political-tag">${student.politicalStatus}</span>`;
                }
                
                // Âõ∞ÈöæËÆ§ÂÆöÊòæÁ§∫
                let hardshipDisplay = student.hardship || '-';
                if (student.hardship && student.hardship !== 'Êó†') {
                    let hardshipClass = 'hardship-general';
                    if (student.hardship === 'ÁâπÂà´Âõ∞Èöæ') hardshipClass = 'hardship-severe';
                    else if (student.hardship === '‰∏ÄËà¨Âõ∞Èöæ') hardshipClass = 'hardship-none';
                    hardshipDisplay = `<span class="hardship-tag ${hardshipClass}">${student.hardship}</span>`;
                }
                
                // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
                let punishmentsDisplay = 'Êó†';
                if (student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = `<span class="punishment-tag punishment-yes">ÊúâÂ§ÑÂàÜ</span>`;
                }
                
                // Â≠¶Á±çÂºÇÂä®ÊòæÁ§∫
                let statusChangeDisplay = 'Êó†';
                if (student.statusChange && student.statusChange !== 'Êó†') {
                    statusChangeDisplay = `<span class="status-change-tag status-change-yes">${student.statusChange}</span>`;
                }
                
                // Ë∞àËØùÊ¨°Êï∞ÊòæÁ§∫
                const talkCount = studentTalkCounts[student.studentId] || 0;
                let talkCountDisplay = talkCount.toString();
                
                // Ê†πÊçÆË∞àËØùÊ¨°Êï∞Ê∑ªÂä†È¢ëÁéáÊ†áÁ≠æ
                if (talkCount >= 3) {
                    talkCountDisplay += ' <span class="frequency-badge frequency-high">È´òÈ¢ë</span>';
                } else if (talkCount >= 2) {
                    talkCountDisplay += ' <span class="frequency-badge frequency-medium">‰∏≠È¢ë</span>';
                } else if (talkCount === 0) {
                    talkCountDisplay += ' <span class="frequency-badge frequency-low">Êó†ËÆ∞ÂΩï</span>';
                }
                
                // Â≠¶ÁîüÁÖßÁâáÊòæÁ§∫
                let photoDisplay = '<div class="photo-placeholder" style="width: 40px; height: 50px; font-size: 10px;">Êó†</div>';
                if (student.photo) {
                    photoDisplay = `<img src="${student.photo}" class="student-photo-small" alt="${student.name}">`;
                }
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="student-checkbox" value="${student.studentId}" 
                               onchange="updateBatchActionState()">
                    </td>
                    <td>${photoDisplay}</td>
                    <td>${student.studentId}</td>
                    <td>
                        <div>${student.name}</div>
                        <div style="font-size: 11px; color: #666;">${student.gender || ''}</div>
                    </td>
                    <td>${student.className}</td>
                    <td>${student.dormitory || '-'}</td>
                    <td>${politicalDisplay}</td>
                    <td>${hardshipDisplay}</td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${statusChangeDisplay}</td>
                    <td>${talkCountDisplay}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="showStudentDetail('${student.studentId}')">Êü•Áúã</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="editStudent('${student.studentId}')">ÁºñËæë</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;" onclick="deleteStudent('${student.studentId}')">Âà†Èô§</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateBatchActionState();
            updateStudentStats(filteredStudents);
        }
        
        function searchStudents() {
            const searchTerm = document.getElementById('searchStudentsInput').value;
            const riskLevel = document.getElementById('riskLevelFilter').value;
            const politicalStatus = document.getElementById('politicalStatusFilter').value;
            const hardship = document.getElementById('hardshipFilter').value;
            loadStudentsTable(searchTerm, riskLevel, politicalStatus, hardship);
        }
        
        function clearStudentSearch() {
            document.getElementById('searchStudentsInput').value = '';
            document.getElementById('riskLevelFilter').value = '';
            document.getElementById('politicalStatusFilter').value = '';
            document.getElementById('hardshipFilter').value = '';
            loadStudentsTable();
        }
        
        function showAddStudentModal() {
            const modal = document.getElementById('studentModal');
            if (modal) {
                document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Â≠¶Áîü';
                document.getElementById('modalEditMode').value = 'false';
                document.getElementById('modalOriginalStudentId').value = '';
                document.getElementById('studentForm').reset();
                
                // Ê∏ÖÁ©∫Â§ÑÂàÜËÆ∞ÂΩï
                document.getElementById('punishmentContainer').innerHTML = '';
                
                // Ê∏ÖÁ©∫ÁÖßÁâáÈ¢ÑËßà
                document.getElementById('photoPreviewContainer').innerHTML = '<div class="photo-placeholder">ÁÇπÂáª‰∏ä‰º†ÁÖßÁâá</div>';
                document.getElementById('modalStudentPhoto').value = '';
                
                modal.style.display = 'flex';
            }
        }
        
        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Ê∑ªÂä†Â§ÑÂàÜËÆ∞ÂΩïÂ≠óÊÆµ
        function addPunishmentField(punishment = '') {
            const container = document.getElementById('punishmentContainer');
            const div = document.createElement('div');
            div.className = 'punishment-input-group';
            div.innerHTML = `
                <input type="text" class="form-control" value="${punishment}" placeholder="ËØ∑ËæìÂÖ•Â§ÑÂàÜËÆ∞ÂΩï...">
                <button type="button" class="btn" style="padding: 5px 10px; background: #e74c3c;" onclick="this.parentElement.remove()">Âà†Èô§</button>
            `;
            container.appendChild(div);
        }
        
        // Â§ÑÁêÜÂ≠¶ÁîüÁÖßÁâá‰∏ä‰º†
        function handleStudentPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.match('image.*')) {
                showMessage('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºÅ', 'error');
                return;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫2MBÔºâ
            if (file.size > 2 * 1024 * 1024) {
                showMessage('ÂõæÁâáÊñá‰ª∂Â§™Â§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é2MBÁöÑÂõæÁâáÔºÅ', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreviewContainer = document.getElementById('photoPreviewContainer');
                photoPreviewContainer.innerHTML = `<img src="${e.target.result}" class="photo-preview" alt="Â≠¶ÁîüÁÖßÁâá">`;
                document.getElementById('modalStudentPhoto').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function saveStudent() {
            try {
                const isEditMode = document.getElementById('modalEditMode').value === 'true';
                const originalStudentId = document.getElementById('modalOriginalStudentId').value;
                
                const student = {
                    studentId: document.getElementById('modalStudentId').value,
                    name: document.getElementById('modalStudentName').value,
                    className: document.getElementById('modalClassName').value,
                    dormitory: document.getElementById('modalDormitory').value,
                    gender: document.getElementById('modalGender').value,
                    phone: document.getElementById('modalPhone').value,
                    politicalStatus: document.getElementById('modalPoliticalStatus').value,
                    hardship: document.getElementById('modalHardship').value,
                    statusChange: document.getElementById('modalStatusChange').value || '',
                    riskLevel: document.querySelector('input[name="modalRiskLevel"]:checked')?.value || 'green',
                    photo: document.getElementById('modalStudentPhoto').value,
                    generalRemark: document.getElementById('modalGeneralRemark')?.value || ''
                };
                
                // Êî∂ÈõÜÂ§ÑÂàÜËÆ∞ÂΩï
                const punishmentInputs = document.querySelectorAll('#punishmentContainer input');
                const punishments = [];
                punishmentInputs.forEach(input => {
                    if (input.value.trim()) {
                        punishments.push(input.value.trim());
                    }
                });
                
                if (punishments.length > 0) {
                    student.punishments = punishments;
                }
                
                // Ê£ÄÊü•ÂøÖÈúÄÂ≠óÊÆµ
                if (!student.studentId || !student.name || !student.className) {
                    showMessage('Â≠¶Âè∑„ÄÅÂßìÂêçÂíåÁè≠Á∫ß‰∏∫ÂøÖÂ°´È°π', 'error');
                    return;
                }
                
                // Ê£ÄÊü•Â≠¶Âè∑ÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÂ¶ÇÊûúÊòØÊ∑ªÂä†Ê®°ÂºèÔºâ
                if (!isEditMode) {
                    const existingStudent = students.find(s => s.studentId === student.studentId);
                    if (existingStudent) {
                        showMessage('Â≠¶Âè∑Â∑≤Â≠òÂú®ÔºÅ', 'error');
                        return;
                    }
                }
                
                if (isEditMode && originalStudentId !== student.studentId) {
                    // Â¶ÇÊûúÂ≠¶Âè∑Ë¢´‰øÆÊîπÔºåÊ£ÄÊü•Êñ∞Â≠¶Âè∑ÊòØÂê¶Â∑≤Â≠òÂú®
                    const existingStudent = students.find(s => s.studentId === student.studentId && s.studentId !== originalStudentId);
                    if (existingStudent) {
                        showMessage('Â≠¶Âè∑Â∑≤Â≠òÂú®ÔºÅ', 'error');
                        return;
                    }
                }
                
                if (isEditMode) {
                    // Êõ¥Êñ∞Áé∞ÊúâÂ≠¶Áîü
                    const index = students.findIndex(s => s.studentId === originalStudentId);
                    if (index !== -1) {
                        students[index] = student;
                    }
                } else {
                    // Ê∑ªÂä†Êñ∞Â≠¶Áîü
                    students.push(student);
                }
                
                localStorage.setItem('students', JSON.stringify(students));
                loadStudentsTable();
                closeStudentModal();
                showMessage('Â≠¶Áîü‰ø°ÊÅØ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
                
            } catch (error) {
                console.error('‰øùÂ≠òÂ≠¶Áîü‰ø°ÊÅØÊó∂Âá∫ÈîôÔºö', error);
                showMessage('‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        function editStudent(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (student) {
                document.getElementById('modalTitle').textContent = 'ÁºñËæëÂ≠¶Áîü';
                document.getElementById('modalEditMode').value = 'true';
                document.getElementById('modalOriginalStudentId').value = student.studentId;
                document.getElementById('modalStudentId').value = student.studentId;
                document.getElementById('modalStudentName').value = student.name;
                document.getElementById('modalClassName').value = student.className;
                document.getElementById('modalDormitory').value = student.dormitory || '';
                document.getElementById('modalGender').value = student.gender || '';
                document.getElementById('modalPhone').value = student.phone || '';
                document.getElementById('modalPoliticalStatus').value = student.politicalStatus || '';
                document.getElementById('modalHardship').value = student.hardship || '';
                document.getElementById('modalStatusChange').value = student.statusChange || '';
                document.getElementById('modalGeneralRemark').value = student.generalRemark || '';
                document.getElementById('modalStudentPhoto').value = student.photo || '';
                
                // ËÆæÁΩÆÈ£éÈô©Á≠âÁ∫ß
                const riskLevel = student.riskLevel || 'green';
                document.querySelector(`input[name="modalRiskLevel"][value="${riskLevel}"]`).checked = true;
                
                // ËÆæÁΩÆÂ§ÑÂàÜËÆ∞ÂΩï
                const punishmentContainer = document.getElementById('punishmentContainer');
                punishmentContainer.innerHTML = '';
                if (student.punishments && student.punishments.length > 0) {
                    student.punishments.forEach(punishment => {
                        addPunishmentField(punishment);
                    });
                }
                
                // ËÆæÁΩÆÁÖßÁâáÈ¢ÑËßà
                const photoPreviewContainer = document.getElementById('photoPreviewContainer');
                if (student.photo) {
                    photoPreviewContainer.innerHTML = `<img src="${student.photo}" class="photo-preview" alt="Â≠¶ÁîüÁÖßÁâá">`;
                } else {
                    photoPreviewContainer.innerHTML = '<div class="photo-placeholder">ÁÇπÂáª‰∏ä‰º†ÁÖßÁâá</div>';
                }
                
                document.getElementById('studentModal').style.display = 'flex';
            }
        }
        
        // ÊòæÁ§∫Â≠¶ÁîüËØ¶ÊÉÖ
        function showStudentDetail(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (!student) return;
            
            // Ëé∑ÂèñÂ≠¶ÁîüÁöÑË∞àËØùËÆ∞ÂΩï
            const studentTalks = talkRecords.filter(r => r.studentId === studentId);
            const talkCount = studentTalks.length;
            
            // Ëé∑ÂèñÊúÄËøëË∞àËØùÊó∂Èó¥
            let lastTalk = 'Êó†ËÆ∞ÂΩï';
            if (studentTalks.length > 0) {
                const latestTalk = studentTalks.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime))[0];
                lastTalk = formatDate(latestTalk.talkTime);
            }
            
            // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
            let riskLevelDisplay = '';
            if (student.riskLevel === 'red') {
                riskLevelDisplay = '<span class="risk-level red">Á∫¢Ëâ≤È¢ÑË≠¶</span>';
            } else if (student.riskLevel === 'yellow') {
                riskLevelDisplay = '<span class="risk-level yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</span>';
            } else {
                riskLevelDisplay = '<span class="risk-level green">ÁªøËâ≤Ê≠£Â∏∏</span>';
            }
            
            // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
            let punishmentsDisplay = 'Êó†';
            if (student.punishments && student.punishments.length > 0) {
                punishmentsDisplay = student.punishments.map(p => `<div class="punishment-record">${p}</div>`).join('');
            }
            
            // Âõ∞ÈöæËÆ§ÂÆöÊòæÁ§∫
            let hardshipDisplay = student.hardship || 'Êú™ËÆ§ÂÆö';
            if (student.hardship && student.hardship !== 'Êó†') {
                let hardshipClass = 'hardship-general';
                if (student.hardship === 'ÁâπÂà´Âõ∞Èöæ') hardshipClass = 'hardship-severe';
                else if (student.hardship === '‰∏ÄËà¨Âõ∞Èöæ') hardshipClass = 'hardship-none';
                hardshipDisplay = `<span class="hardship-tag ${hardshipClass}">${student.hardship}</span>`;
            }
            
            // Â≠¶Á±çÂºÇÂä®ÊòæÁ§∫
            let statusChangeDisplay = student.statusChange || 'Êó†';
            if (student.statusChange && student.statusChange !== 'Êó†') {
                statusChangeDisplay = `<span class="status-change-tag status-change-yes">${student.statusChange}</span>`;
            }
            
            // ÁÖßÁâáÊòæÁ§∫
            let photoDisplay = '<div class="photo-placeholder">ÊöÇÊó†ÁÖßÁâá</div>';
            if (student.photo) {
                photoDisplay = `<img src="${student.photo}" class="photo-preview" alt="${student.name}">`;
            }
            
            const detailContent = `
                <div class="student-detail-grid">
                    <div class="student-photo-section">
                        ${photoDisplay}
                        <h4 style="margin-top: 10px;">${student.name}</h4>
                        <p style="font-size: 12px; color: #666;">${student.studentId}</p>
                    </div>
                    <div class="student-info-section">
                        <div class="student-detail-item">
                            <div class="student-detail-label">Áè≠Á∫ß</div>
                            <div class="student-detail-value">${student.className}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">ÂÆøËàç</div>
                            <div class="student-detail-value">${student.dormitory || 'Êú™ÂàÜÈÖç'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">ÊÄßÂà´</div>
                            <div class="student-detail-value">${student.gender || 'Êú™Â°´ÂÜô'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">ËÅîÁ≥ªÁîµËØù</div>
                            <div class="student-detail-value">${student.phone || 'Êú™Â°´ÂÜô'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">ÊîøÊ≤ªÈù¢Ë≤å</div>
                            <div class="student-detail-value">${student.politicalStatus || 'Êú™Â°´ÂÜô'}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">Âõ∞ÈöæËÆ§ÂÆö</div>
                            <div class="student-detail-value">${hardshipDisplay}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">È£éÈô©Á≠âÁ∫ß</div>
                            <div class="student-detail-value">${riskLevelDisplay}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">Â≠¶Á±çÂºÇÂä®</div>
                            <div class="student-detail-value">${statusChangeDisplay}</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">Ë∞àËØùÊ¨°Êï∞</div>
                            <div class="student-detail-value">${talkCount}Ê¨°</div>
                        </div>
                        <div class="student-detail-item">
                            <div class="student-detail-label">ÊúÄËøëË∞àËØùÊó∂Èó¥</div>
                            <div class="student-detail-value">${lastTalk}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Â§ÑÂàÜËÆ∞ÂΩï</h4>
                    <div id="punishmentList">${punishmentsDisplay}</div>
                </div>
                
                ${student.generalRemark ? `
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Â§áÊ≥®</h4>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${student.generalRemark}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('studentDetailContent').innerHTML = detailContent;
            document.getElementById('studentDetailModal').style.display = 'flex';
        }
        
        function closeStudentDetailModal() {
            document.getElementById('studentDetailModal').style.display = 'none';
        }
        
        function editStudentFromDetail() {
            const modal = document.getElementById('studentDetailModal');
            const studentId = document.querySelector('#studentDetailContent h4').textContent;
            const student = students.find(s => s.name === studentId);
            
            if (student) {
                closeStudentDetailModal();
                editStudent(student.studentId);
            }
        }
        
        function deleteStudent(studentId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â≠¶ÁîüÂêóÔºüÂà†Èô§ÂêéËØ•Â≠¶ÁîüÁöÑÊâÄÊúâË∞àËØùËÆ∞ÂΩï‰πüÂ∞ÜË¢´Âà†Èô§ÔºÅ')) {
                // Âà†Èô§Â≠¶Áîü
                students = students.filter(s => s.studentId !== studentId);
                
                // Âà†Èô§ËØ•Â≠¶ÁîüÁöÑÊâÄÊúâË∞àËØùËÆ∞ÂΩï
                talkRecords = talkRecords.filter(r => r.studentId !== studentId);
                
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                
                loadStudentsTable();
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                
                showMessage('Â≠¶ÁîüÂèäÁõ∏ÂÖ≥ËÆ∞ÂΩïÂà†Èô§ÊàêÂäüÔºÅ', 'success');
            }
        }
        
        function downloadExcelTemplate() {
            if (typeof XLSX === 'undefined') {
                showMessage('ExcelÂ§ÑÁêÜÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                return;
            }
            
            const templateData = [
                ['Â≠¶Âè∑', 'ÂßìÂêç', 'Áè≠Á∫ß', 'ÂÆøËàç', 'ÊÄßÂà´', 'ËÅîÁ≥ªÁîµËØù', 'ÊîøÊ≤ªÈù¢Ë≤å', 'Âõ∞ÈöæËÆ§ÂÆö', 'È£éÈô©Á≠âÁ∫ß', 'Â§ÑÂàÜËÆ∞ÂΩï', 'Â≠¶Á±çÂºÇÂä®', 'Â§áÊ≥®'],
                ['20200101', 'Âº†‰∏â', 'ËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ2001', 'Ê¢ÖÂõ≠1Ê†ã302', 'Áî∑', '13800138000', 'ÂÖ±ÈùíÂõ¢Âëò', '‰∏ÄËà¨Âõ∞Èöæ', 'ÁªøËâ≤Ê≠£Â∏∏', 'Êó†', 'Êó†', '‰ºòÁßÄÂ≠¶Áîü'],
                ['20200102', 'ÊùéÂõõ', 'ËΩØ‰ª∂Â∑•Á®ã2001', 'Ê¢ÖÂõ≠2Ê†ã401', 'Â•≥', '13800138001', '‰∏≠ÂÖ±ÂÖöÂëò', 'ÁâπÂà´Âõ∞Èöæ', 'ÈªÑËâ≤ÂÖ≥Ê≥®', 'Ë≠¶ÂëäÂ§ÑÂàÜ', 'Êó†', 'ÈúÄË¶ÅÂÖ≥Ê≥®Â≠¶‰π†ÊÉÖÂÜµ'],
                ['20200103', 'Áéã‰∫î', 'ÁΩëÁªúÂ∑•Á®ã2001', 'Á´πÂõ≠3Ê†ã201', 'Áî∑', '13800138002', 'Áæ§‰ºó', 'Êó†', 'Á∫¢Ëâ≤È¢ÑË≠¶', '‰∏•ÈáçË≠¶ÂëäÂ§ÑÂàÜ;ËÆ∞ËøáÂ§ÑÂàÜ', '‰ºëÂ≠¶‰∏ÄÂ≠¶Êúü', 'ÈáçÁÇπÂÖ≥Ê≥®ÂØπË±°'],
                ['20200104', 'ËµµÂÖ≠', '‰∫∫Â∑•Êô∫ËÉΩ2001', 'ÂÖ∞Âõ≠4Ê†ã101', 'Â•≥', '13800138003', 'ÂÖ±ÈùíÂõ¢Âëò', 'Âõ∞Èöæ', 'ÁªøËâ≤Ê≠£Â∏∏', 'Êó†', 'ËΩ¨‰∏ì‰∏ö', ''],
                ['20200105', 'Èí±‰∏É', 'Êï∞ÊçÆÁßëÂ≠¶2001', 'ËèäÂõ≠5Ê†ã202', 'Áî∑', '13800138004', '‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò', '‰∏ÄËà¨Âõ∞Èöæ', 'ÁªøËâ≤Ê≠£Â∏∏', 'Êó†', 'Â§çÂ≠¶', 'Áè≠Âπ≤ÈÉ®']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Â≠¶ÁîüÊï∞ÊçÆ');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Â≠¶ÁîüÊï∞ÊçÆÂØºÂÖ•Ê®°Êùø.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Ê®°Êùø‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
        }
        
        function exportStudentsToExcel() {
            if (typeof XLSX === 'undefined') {
                showMessage('ExcelÂ§ÑÁêÜÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                return;
            }
            
            if (students.length === 0) {
                showMessage('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂ≠¶ÁîüÊï∞ÊçÆÔºÅ', 'error');
                return;
            }
            
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
            const studentTalkCounts = {};
            talkRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            const exportData = [
                ['Â≠¶Âè∑', 'ÂßìÂêç', 'Áè≠Á∫ß', 'ÂÆøËàç', 'ÊÄßÂà´', 'ËÅîÁ≥ªÁîµËØù', 'ÊîøÊ≤ªÈù¢Ë≤å', 'Âõ∞ÈöæËÆ§ÂÆö', 'È£éÈô©Á≠âÁ∫ß', 'Â§ÑÂàÜËÆ∞ÂΩï', 'Â≠¶Á±çÂºÇÂä®', 'Ë∞àËØùÊ¨°Êï∞', 'Â§áÊ≥®']
            ];
            
            students.forEach(student => {
                // ËΩ¨Êç¢È£éÈô©Á≠âÁ∫ß‰∏∫‰∏≠Êñá
                let riskLevelText = 'ÁªøËâ≤Ê≠£Â∏∏';
                if (student.riskLevel === 'red') {
                    riskLevelText = 'Á∫¢Ëâ≤È¢ÑË≠¶';
                } else if (student.riskLevel === 'yellow') {
                    riskLevelText = 'ÈªÑËâ≤ÂÖ≥Ê≥®';
                } else {
                    riskLevelText = 'ÁªøËâ≤Ê≠£Â∏∏';
                }
                
                const talkCount = studentTalkCounts[student.studentId] || 0;
                const punishments = student.punishments ? student.punishments.join('Ôºõ') : 'Êó†';
                const statusChange = student.statusChange || 'Êó†';
                
                exportData.push([
                    student.studentId,
                    student.name,
                    student.className,
                    student.dormitory || '',
                    student.gender || '',
                    student.phone || '',
                    student.politicalStatus || '',
                    student.hardship || '',
                    riskLevelText,
                    punishments,
                    statusChange,
                    talkCount,
                    student.generalRemark || ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Â≠¶ÁîüÊï∞ÊçÆ');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Â≠¶ÁîüÊï∞ÊçÆÂ∫ì_${date}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`Â≠¶ÁîüÊï∞ÊçÆÂØºÂá∫ÊàêÂäüÔºåÂÖ±ÂØºÂá∫ ${students.length} Êù°ËÆ∞ÂΩï`, 'success');
        }
        
        // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜ
        function loadTalkRecords(filters = {}) {
            const tbody = document.getElementById('recordsList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ‰ªélocalStorageÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            console.log('Âä†ËΩΩË∞àËØùËÆ∞ÂΩïÔºåÊÄªÊï∞:', talkRecords.length);
            
            let filteredRecords = talkRecords;
            
            // Â∫îÁî®Êó∂Èó¥Á≠õÈÄâÂô®
            if (currentTimeFilter !== 'all') {
                const timeRange = getTimeFilterRange(currentTimeFilter);
                if (timeRange.dateFrom) {
                    filteredRecords = filteredRecords.filter(record =>
                        new Date(record.talkTime) >= timeRange.dateFrom
                    );
                }
            }
            
            if (filters.search) {
                filteredRecords = filteredRecords.filter(record =>
                    record.studentName.includes(filters.search) ||
                    (record.studentId && record.studentId.includes(filters.search)) ||
                    record.className.includes(filters.search)
                );
            }
            
            if (filters.riskLevel) {
                filteredRecords = filteredRecords.filter(record =>
                    record.riskLevel === filters.riskLevel
                );
            }
            
            if (filters.dateFrom) {
                filteredRecords = filteredRecords.filter(record =>
                    new Date(record.talkTime) >= new Date(filters.dateFrom)
                );
            }
            
            if (filters.dateTo) {
                filteredRecords = filteredRecords.filter(record =>
                    new Date(record.talkTime) <= new Date(filters.dateTo + 'T23:59:59')
                );
            }
            
            filteredRecords.sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime));
            
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
            const studentTalkCounts = {};
            filteredRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">ÊöÇÊó†Ë∞àËØùËÆ∞ÂΩï</td></tr>';
                return;
            }
            
            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
                let riskLevelDisplay = '';
                if (record.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">Á∫¢Ëâ≤È¢ÑË≠¶</span>';
                } else if (record.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ÁªøËâ≤Ê≠£Â∏∏</span>';
                }
                
                // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
                const student = students.find(s => s.studentId === record.studentId);
                
                // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
                let punishmentsDisplay = 'Êó†';
                if (student && student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = `<span class="punishment-tag punishment-yes">ÊúâÂ§ÑÂàÜ</span>`;
                }
                
                // Â≠¶Á±çÂºÇÂä®ÊòæÁ§∫
                let statusChangeDisplay = 'Êó†';
                if (student && student.statusChange && student.statusChange !== 'Êó†') {
                    statusChangeDisplay = `<span class="status-change-tag status-change-yes">${student.statusChange}</span>`;
                }
                
                // Ë∞àËØùÊ¨°Êï∞
                const talkCount = studentTalkCounts[record.studentId] || 0;
                let talkCountDisplay = talkCount.toString();
                
                // Ê†πÊçÆË∞àËØùÊ¨°Êï∞Ê∑ªÂä†Ê†∑Âºè
                if (talkCount >= 3) {
                    talkCountDisplay = `<strong style="color:#c62828;">${talkCount}</strong>`;
                } else if (talkCount >= 2) {
                    talkCountDisplay = `<strong style="color:#f57f17;">${talkCount}</strong>`;
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="talk-checkbox" value="${record.id}" onchange="updateBatchTalkActionState()"></td>
                    <td>${formatDate(record.talkTime)}</td>
                    <td>${record.studentName}</td>
                    <td>${record.className}</td>
                    <td>${record.topics.join(', ')}</td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${statusChangeDisplay}</td>
                    <td>${talkCountDisplay}</td>
                    <td>
                        <button class="edit-record-btn" onclick="editTalkRecord(${record.id})">ÁºñËæë</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #3498db;" onclick="showDocPreview(${record.id})">ÂØºÂá∫DOC</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;" onclick="deleteTalkRecord(${record.id})">Âà†Èô§</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÁä∂ÊÄÅ
            updateBatchTalkActionState();
        }
        
        function searchTalkRecords() {
            const filters = {
                search: document.getElementById('recordSearch').value,
                riskLevel: document.getElementById('riskLevelFilterHistory').value,
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value
            };
            loadTalkRecords(filters);
        }
        
        function clearSearch() {
            document.getElementById('recordSearch').value = '';
            document.getElementById('riskLevelFilterHistory').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            currentTimeFilter = 'all';
            
            // ÈáçÁΩÆÊó∂Èó¥Á≠õÈÄâÊåâÈíÆ
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.time-filter-btn').classList.add('active');
            
            loadTalkRecords();
        }
        
        function editTalkRecord(recordId) {
            // ÂàáÊç¢Âà∞ËÆ∞ÂΩïÈ°µÈù¢Âπ∂Âä†ËΩΩËÆ∞ÂΩï
            switchTab('record');
            loadTalkRecordForEdit(recordId);
        }
        
        function deleteTalkRecord(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ë∞àËØùËÆ∞ÂΩïÂêóÔºü')) {
                talkRecords = talkRecords.filter(r => r.id !== id);
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                loadTalkRecords();
                loadExportList();
                updateRecordStats();
                updateTalkTrackingStats();
                showMessage('ËÆ∞ÂΩïÂà†Èô§ÊàêÂäüÔºÅ', 'success');
            }
        }
        
        // Êï∞ÊçÆÂØºÂá∫ÂäüËÉΩ
        function loadExportList() {
            const tbody = document.getElementById('exportList');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ‰ªélocalStorageÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàó
            const sortedRecords = [...talkRecords].sort((a, b) => new Date(b.talkTime) - new Date(a.talkTime));
            
            // ÁªüËÆ°ÂØºÂá∫Êï∞ÊçÆ
            const totalCount = sortedRecords.length;
            const redCount = sortedRecords.filter(r => r.riskLevel === 'red').length;
            const yellowCount = sortedRecords.filter(r => r.riskLevel === 'yellow').length;
            const greenCount = sortedRecords.filter(r => r.riskLevel === 'green').length;
            
            // Êõ¥Êñ∞ÂØºÂá∫ÁªüËÆ°
            document.getElementById('totalExportCount').textContent = totalCount;
            document.getElementById('exportRedCount').textContent = redCount;
            document.getElementById('exportYellowCount').textContent = yellowCount;
            document.getElementById('exportGreenCount').textContent = greenCount;
            
            // ÁªüËÆ°ÊØè‰∏™Â≠¶ÁîüÁöÑË∞àËØùÊ¨°Êï∞
            const studentTalkCounts = {};
            sortedRecords.forEach(record => {
                const studentId = record.studentId;
                studentTalkCounts[studentId] = (studentTalkCounts[studentId] || 0) + 1;
            });
            
            if (sortedRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">ÊöÇÊó†Ë∞àËØùËÆ∞ÂΩï</td></tr>';
                return;
            }
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
                let riskLevelDisplay = '';
                if (record.riskLevel === 'red') {
                    riskLevelDisplay = '<span class="risk-level red">Á∫¢Ëâ≤È¢ÑË≠¶</span>';
                } else if (record.riskLevel === 'yellow') {
                    riskLevelDisplay = '<span class="risk-level yellow">ÈªÑËâ≤ÂÖ≥Ê≥®</span>';
                } else {
                    riskLevelDisplay = '<span class="risk-level green">ÁªøËâ≤Ê≠£Â∏∏</span>';
                }
                
                // Ëé∑ÂèñÂ≠¶Áîü‰ø°ÊÅØ
                const student = students.find(s => s.studentId === record.studentId);
                
                // Â§ÑÂàÜËÆ∞ÂΩïÊòæÁ§∫
                let punishmentsDisplay = 'Êó†';
                if (student && student.punishments && student.punishments.length > 0) {
                    punishmentsDisplay = 'ÊúâÂ§ÑÂàÜ';
                }
                
                // Ë∞àËØùÊ¨°Êï∞
                const talkCount = studentTalkCounts[record.studentId] || 0;
                
                row.innerHTML = `
                    <td><input type="checkbox" value="${record.id}" class="export-checkbox"></td>
                    <td>${formatDate(record.talkTime)}</td>
                    <td>${record.studentName}</td>
                    <td>${record.className}</td>
                    <td>${record.topics.join(', ')}</td>
                    <td>${riskLevelDisplay}</td>
                    <td>${punishmentsDisplay}</td>
                    <td>${talkCount}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function refreshExportList() {
            loadExportList();
            showMessage('ÂØºÂá∫ÂàóË°®Â∑≤Âà∑Êñ∞', 'success');
        }
        
        function toggleSelectAllExport(checkbox) {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        function exportData() {
            // ‰ªélocalStorageÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const storedRecords = localStorage.getItem('talkRecords');
            if (storedRecords) {
                talkRecords = JSON.parse(storedRecords);
            }
            
            if (talkRecords.length === 0) {
                showMessage('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑËÆ∞ÂΩïÔºÅ', 'error');
                return;
            }
            
            const exportFormat = document.getElementById('exportFormat').value;
            const exportRange = document.getElementById('exportRange').value;
            
            let recordsToExport = [];
            
            if (exportRange === 'all') {
                recordsToExport = talkRecords;
            } else if (exportRange === 'selected') {
                const checkboxes = document.querySelectorAll('.export-checkbox:checked');
                if (checkboxes.length === 0) {
                    showMessage('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÊù°ËÆ∞ÂΩïÔºÅ', 'error');
                    return;
                }
                
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                recordsToExport = talkRecords.filter(record => selectedIds.includes(record.id));
            } else if (exportRange === 'month') {
                const monthAgo = new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000);
                recordsToExport = talkRecords.filter(record => {
                    return new Date(record.talkTime) >= monthAgo;
                });
            } else if (exportRange === 'quarter') {
                const quarterAgo = new Date(new Date().getTime() - 90 * 24 * 60 * 60 * 1000);
                recordsToExport = talkRecords.filter(record => {
                    return new Date(record.talkTime) >= quarterAgo;
                });
            }
            
            if (recordsToExport.length === 0) {
                showMessage('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑËÆ∞ÂΩïÔºÅ', 'error');
                return;
            }
            
            showMessage(`ÂºÄÂßãÂØºÂá∫ ${recordsToExport.length} Êù°ËÆ∞ÂΩï...`, 'info');
            
            try {
                if (exportFormat === 'excel') {
                    exportToExcel(recordsToExport);
                } else if (exportFormat === 'word') {
                    // WordÊ†ºÂºèÂè™ÊîØÊåÅÂçïÊù°ËÆ∞ÂΩïÂØºÂá∫
                    if (recordsToExport.length > 1) {
                        showMessage('WordÊ†ºÂºèÂè™ÊîØÊåÅÂçïÊù°ËÆ∞ÂΩïÂØºÂá∫ÔºåËØ∑Âè™ÈÄâÊã©‰∏ÄÊù°ËÆ∞ÂΩïÔºÅ', 'error');
                        return;
                    }
                    showDocPreview(recordsToExport[0].id);
                } else if (exportFormat === 'analysis') {
                    exportAnalysisReport();
                }
            } catch (error) {
                showMessage('ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message, 'error');
                console.error('ÂØºÂá∫ÈîôËØØÔºö', error);
            }
        }
        
        // ÂØºÂá∫Âà∞ExcelÊñá‰ª∂
        function exportToExcel(records) {
            if (typeof XLSX === 'undefined') {
                showMessage('ExcelÂ§ÑÁêÜÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'error');
                return;
            }
            
            const exportData = [
                ['Â∫èÂè∑', 'Ë∞àËØùÊó∂Èó¥', 'Â≠¶ÁîüÂßìÂêç', 'Â≠¶Âè∑', 'Áè≠Á∫ß', 'ÂÆøËàç', 'Ë∞àËØùÂú∞ÁÇπ', 
                 'Ë∞àËØù‰∏ªÈ¢ò', 'È£éÈô©Á≠âÁ∫ß', 'Â≠¶ÁîüËÉåÊôØ', 'Ë∞àËØùÁõÆÁöÑ', 'Â≠¶ÁîüËá™Ëø∞', 'Ë∞àËØùË¶ÅÁÇπ', 
                 'Ë∞àËØùÂèçÈ¶à', 'ÂêéÁª≠Ë∑üËøõËÆ°Âàí', 'Â§áÊ≥®', 'Â≠¶ÁîüÁ≠æÂêç', 'ËæÖÂØºÂëòÁ≠æÂêç', 'ËÆ∞ÂΩïÊó∂Èó¥']
            ];
            
            records.forEach((record, index) => {
                const riskLevelText = getRiskLevelText(record.riskLevel);
                
                exportData.push([
                    index + 1,
                    formatDate(record.talkTime),
                    record.studentName,
                    record.studentId || '',
                    record.className,
                    record.dormitory,
                    record.talkLocation,
                    record.topics.join('„ÄÅ'),
                    riskLevelText,
                    record.studentBackground,
                    record.talkPurpose,
                    record.studentStatement,
                    record.talkPoints,
                    record.talkFeedback,
                    record.followUpPlan || '',
                    record.generalRemark || '',
                    record.studentSignature || '',
                    record.counselorSignature || '',
                    formatDate(record.createTime)
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ë∞àËØùËÆ∞ÂΩï');
            
            // ËÆæÁΩÆÂàóÂÆΩ
            const wscols = [
                {wch: 8},   // Â∫èÂè∑
                {wch: 20},  // Ë∞àËØùÊó∂Èó¥
                {wch: 10},  // Â≠¶ÁîüÂßìÂêç
                {wch: 12},  // Â≠¶Âè∑
                {wch: 20},  // Áè≠Á∫ß
                {wch: 10},  // ÂÆøËàç
                {wch: 15},  // Ë∞àËØùÂú∞ÁÇπ
                {wch: 25},  // Ë∞àËØù‰∏ªÈ¢ò
                {wch: 12},  // È£éÈô©Á≠âÁ∫ß
                {wch: 30},  // Â≠¶ÁîüËÉåÊôØ
                {wch: 30},  // Ë∞àËØùÁõÆÁöÑ
                {wch: 30},  // Â≠¶ÁîüËá™Ëø∞
                {wch: 30},  // Ë∞àËØùË¶ÅÁÇπ
                {wch: 30},  // Ë∞àËØùÂèçÈ¶à
                {wch: 30},  // ÂêéÁª≠Ë∑üËøõËÆ°Âàí
                {wch: 20},  // Â§áÊ≥®
                {wch: 15},  // Â≠¶ÁîüÁ≠æÂêç
                {wch: 15},  // ËæÖÂØºÂëòÁ≠æÂêç
                {wch: 20}   // ËÆ∞ÂΩïÊó∂Èó¥
            ];
            ws['!cols'] = wscols;
            
            // ÁîüÊàêÊñá‰ª∂
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            
            // ‰ΩøÁî®Êñ∞ÁöÑÂëΩÂêçÊñπÂºèÔºöÂßìÂêç_Áè≠Á∫ß_Ë∞àËØùËÆ∞ÂΩï.xlsx
            // Â¶ÇÊûúÊúâÂ§öÊù°ËÆ∞ÂΩïÔºå‰ΩøÁî®Á¨¨‰∏ÄÊù°ËÆ∞ÂΩïÁöÑÂ≠¶Áîü‰ø°ÊÅØ
            let fileName = 'Ë∞àÂøÉË∞àËØùËÆ∞ÂΩï';
            if (records.length > 0) {
                const studentName = records[0].studentName;
                const className = records[0].className;
                fileName = `${studentName}_${className}_Ë∞àÂøÉË∞àËØùËÆ∞ÂΩï`;
                
                // Â¶ÇÊûúÊúâÂ§öÊù°ËÆ∞ÂΩïÔºåÊ∑ªÂä†"Á≠â"Â≠ó
                if (records.length > 1) {
                    fileName = `${studentName}Á≠â${records.length}‰∫∫_Ë∞àÂøÉË∞àËØùËÆ∞ÂΩï`;
                }
            }
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('ExcelÊñá‰ª∂ÂØºÂá∫ÊàêÂäüÔºÅ', 'success');
        }
        
        // Ëé∑ÂèñÈ£éÈô©Á≠âÁ∫ßÊñáÊú¨
        function getRiskLevelText(riskLevel) {
            switch(riskLevel) {
                case 'red': return 'Á∫¢Ëâ≤È¢ÑË≠¶';
                case 'yellow': return 'ÈªÑËâ≤ÂÖ≥Ê≥®';
                case 'green': return 'ÁªøËâ≤Ê≠£Â∏∏';
                default: return 'Êú™ÂàÜÁ∫ß';
            }
        }
        
        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (error) {
                return dateString;
            }
        }
        
        // ÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ
        function initSampleData() {
            console.log('ÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ...');
            
            // Â¶ÇÊûúÊú¨Âú∞Â≠òÂÇ®‰∏≠Ê≤°ÊúâÂ≠¶ÁîüÊï∞ÊçÆÔºåÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ
            if (students.length === 0) {
                console.log('ÂàùÂßãÂåñÂ≠¶ÁîüÊï∞ÊçÆ...');
                students = [
                    {
                        studentId: '20200101',
                        name: 'Âº†‰∏â',
                        className: 'ËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ2001',
                        dormitory: 'Ê¢ÖÂõ≠1Ê†ã302',
                        gender: 'Áî∑',
                        phone: '13800138000',
                        politicalStatus: 'ÂÖ±ÈùíÂõ¢Âëò',
                        hardship: '‰∏ÄËà¨Âõ∞Èöæ',
                        riskLevel: 'green',
                        punishments: [],
                        statusChange: 'Êó†',
                        generalRemark: '‰ºòÁßÄÂ≠¶Áîü'
                    },
                    {
                        studentId: '20200102',
                        name: 'ÊùéÂõõ',
                        className: 'ËΩØ‰ª∂Â∑•Á®ã2001',
                        dormitory: 'Ê¢ÖÂõ≠2Ê†ã401',
                        gender: 'Â•≥',
                        phone: '13800138001',
                        politicalStatus: '‰∏≠ÂÖ±ÂÖöÂëò',
                        hardship: 'ÁâπÂà´Âõ∞Èöæ',
                        riskLevel: 'yellow',
                        punishments: ['Ë≠¶ÂëäÂ§ÑÂàÜ'],
                        statusChange: 'Êó†',
                        generalRemark: 'ÈúÄË¶ÅÂÖ≥Ê≥®Â≠¶‰π†ÊÉÖÂÜµ'
                    },
                    {
                        studentId: '20200103',
                        name: 'Áéã‰∫î',
                        className: 'ÁΩëÁªúÂ∑•Á®ã2001',
                        dormitory: 'Á´πÂõ≠3Ê†ã201',
                        gender: 'Áî∑',
                        phone: '13800138002',
                        politicalStatus: 'Áæ§‰ºó',
                        hardship: 'Êó†',
                        riskLevel: 'red',
                        punishments: ['‰∏•ÈáçË≠¶ÂëäÂ§ÑÂàÜ', 'ËÆ∞ËøáÂ§ÑÂàÜ'],
                        statusChange: '‰ºëÂ≠¶‰∏ÄÂ≠¶Êúü',
                        generalRemark: 'ÈáçÁÇπÂÖ≥Ê≥®ÂØπË±°'
                    },
                    {
                        studentId: '20200104',
                        name: 'ËµµÂÖ≠',
                        className: '‰∫∫Â∑•Êô∫ËÉΩ2001',
                        dormitory: 'ÂÖ∞Âõ≠4Ê†ã101',
                        gender: 'Â•≥',
                        phone: '13800138003',
                        politicalStatus: 'ÂÖ±ÈùíÂõ¢Âëò',
                        hardship: 'Âõ∞Èöæ',
                        riskLevel: 'green',
                        punishments: [],
                        statusChange: 'ËΩ¨‰∏ì‰∏ö',
                        generalRemark: 'Â≠¶‰π†ÂßîÂëò'
                    },
                    {
                        studentId: '20200105',
                        name: 'Èí±‰∏É',
                        className: 'Êï∞ÊçÆÁßëÂ≠¶2001',
                        dormitory: 'ËèäÂõ≠5Ê†ã202',
                        gender: 'Áî∑',
                        phone: '13800138004',
                        politicalStatus: '‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò',
                        hardship: '‰∏ÄËà¨Âõ∞Èöæ',
                        riskLevel: 'green',
                        punishments: [],
                        statusChange: 'Â§çÂ≠¶',
                        generalRemark: 'Áè≠Âπ≤ÈÉ®'
                    }
                ];
                localStorage.setItem('students', JSON.stringify(students));
                console.log('Â≠¶ÁîüÊï∞ÊçÆÂ∑≤‰øùÂ≠ò');
            }
            
            // Â¶ÇÊûúÊú¨Âú∞Â≠òÂÇ®‰∏≠Ê≤°ÊúâË∞àËØùËÆ∞ÂΩïÔºåÂàùÂßãÂåñÁ§∫‰æãÊï∞ÊçÆ
            if (talkRecords.length === 0) {
                console.log('ÂàùÂßãÂåñË∞àËØùËÆ∞ÂΩïÊï∞ÊçÆ...');
                
                // ÂàõÂª∫Á§∫‰æãË∞àËØùËÆ∞ÂΩï
                const sampleRecords = [
                    {
                        id: Date.now(),
                        studentId: '20200101',
                        studentName: 'Âº†‰∏â',
                        className: 'ËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ2001',
                        dormitory: 'Ê¢ÖÂõ≠1Ê†ã302',
                        talkTime: new Date('2024-01-15T10:30:00').toISOString().slice(0, 16),
                        talkLocation: 'ËæÖÂØºÂëòÂäûÂÖ¨ÂÆ§',
                        topics: ['Â≠¶‰∏ö', 'Â∞±‰∏ö'],
                        studentBackground: 'Â≠¶ÁîüÂü∫Êú¨‰ø°ÊÅØÔºöÂº†‰∏âÔºåËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ2001Áè≠ÔºåÂÆøËàçÊ¢ÖÂõ≠1Ê†ã302„ÄÇÊàêÁª©‰ºòÁßÄÔºåÁßØÊûÅÂèÇ‰∏éÁ§æÂõ¢Ê¥ªÂä®„ÄÇ',
                        talkPurpose: '‰∫ÜËß£Â≠¶ÁîüËøëÊúüÂ≠¶‰π†ÊÉÖÂÜµÂíåÂ∞±‰∏öËßÑÂàí',
                        studentStatement: 'ÊúÄËøëÂ≠¶‰π†ÂéãÂäõËæÉÂ§ßÔºåÂØπÊú™Êù•ÁöÑÂ∞±‰∏öÊñπÂêëÊÑüÂà∞Ëø∑Ëå´ÔºåÂ∏åÊúõÂæóÂà∞ÊåáÂØº„ÄÇ',
                        talkPoints: '1. ÂàÜÊûê‰∫ÜÂΩìÂâçÁöÑÂ≠¶‰π†ÊÉÖÂÜµÔºõ2. ËÆ®ËÆ∫‰∫ÜÂ∞±‰∏öÊñπÂêëÈÄâÊã©Ôºõ3. Âà∂ÂÆö‰∫ÜÂ≠¶‰π†ËÆ°ÂàíÔºõ4. Âª∫ËÆÆÂèÇÂä†ÂÆû‰π†ÁßØÁ¥ØÁªèÈ™å„ÄÇ',
                        talkFeedback: 'Â≠¶ÁîüË°®Á§∫‰ºöË∞ÉÊï¥Â≠¶‰π†Áä∂ÊÄÅÔºåÁßØÊûÅÂáÜÂ§áÂ∞±‰∏öÔºåÂØπË∞àËØùË°®Á§∫ÊÑüË∞¢„ÄÇ',
                        riskLevel: 'green',
                        followUpPlan: '‰∏Ä‰∏™ÊúàÂêéË∑üËøõÂ∞±‰∏öÂáÜÂ§áÊÉÖÂÜµ',
                        generalRemark: 'Â≠¶ÁîüÊÄÅÂ∫¶ÁßØÊûÅÔºåÈúÄË¶ÅÂÆöÊúüË∑üËøõÂ∞±‰∏öËøõÂ±ï„ÄÇ',
                        studentSignature: 'Âº†‰∏â',
                        counselorSignature: 'Èôà',
                        createTime: new Date('2024-01-15T10:30:00').toISOString(),
                        updateTime: new Date('2024-01-15T10:30:00').toISOString()
                    },
                    {
                        id: Date.now() + 1,
                        studentId: '20200102',
                        studentName: 'ÊùéÂõõ',
                        className: 'ËΩØ‰ª∂Â∑•Á®ã2001',
                        dormitory: 'Ê¢ÖÂõ≠2Ê†ã401',
                        talkTime: new Date('2024-02-20T14:00:00').toISOString().slice(0, 16),
                        talkLocation: 'ÂøÉÁêÜÂí®ËØ¢ÂÆ§',
                        topics: ['ÊÉÖÁª™/ÂÅ•Â∫∑', '‰∫∫ÈôÖÂÖ≥Á≥ª'],
                        studentBackground: 'Â≠¶ÁîüÂü∫Êú¨‰ø°ÊÅØÔºöÊùéÂõõÔºåËΩØ‰ª∂Â∑•Á®ã2001Áè≠ÔºåÂÆøËàçÊ¢ÖÂõ≠2Ê†ã401„ÄÇÂÆ∂Â∫≠ÁªèÊµéÂõ∞ÈöæÔºåÊÄßÊ†ºÂÜÖÂêë„ÄÇ',
                        talkPurpose: '‰∫ÜËß£Â≠¶ÁîüËøëÊúüÊÉÖÁª™Áä∂ÊÄÅÂíå‰∫∫ÈôÖÂÖ≥Á≥ª',
                        studentStatement: 'ÊúÄËøëÊÑüÂà∞ÁÑ¶ËôëÔºå‰∏éÂÆ§ÂèãÂÖ≥Á≥ªÁ¥ßÂº†ÔºåÁù°Áú†Ë¥®Èáè‰∏ãÈôç„ÄÇ',
                        talkPoints: '1. ÂÄæÂê¨Â≠¶ÁîüÊÉÖÁª™Ë°®ËææÔºõ2. ÂàÜÊûê‰∫Ü‰∫∫ÈôÖÂÖ≥Á≥ªÈóÆÈ¢òÔºõ3. Êèê‰æõ‰∫ÜÊÉÖÁª™Ë∞ÉËäÇÊñπÊ≥ïÔºõ4. Âª∫ËÆÆÂèÇÂä†ÂøÉÁêÜËæÖÂØº„ÄÇ',
                        talkFeedback: 'Â≠¶ÁîüÊÉÖÁª™ÊúâÊâÄÁºìËß£ÔºåÊÑøÊÑèÂ∞ùËØïÊîπÂñÑ‰∫∫ÈôÖÂÖ≥Á≥ª„ÄÇ',
                        riskLevel: 'yellow',
                        followUpPlan: '‰∏§Âë®ÂêéË∑üËøõÊÉÖÁª™Áä∂ÊÄÅ',
                        generalRemark: 'ÈúÄË¶ÅÊåÅÁª≠ÂÖ≥Ê≥®Â≠¶ÁîüÊÉÖÁª™ÂèòÂåñ„ÄÇ',
                        studentSignature: 'ÊùéÂõõ',
                        counselorSignature: 'Èôà',
                        createTime: new Date('2024-02-20T14:00:00').toISOString(),
                        updateTime: new Date('2024-02-20T14:00:00').toISOString()
                    },
                    {
                        id: Date.now() + 2,
                        studentId: '20200103',
                        studentName: 'Áéã‰∫î',
                        className: 'ÁΩëÁªúÂ∑•Á®ã2001',
                        dormitory: 'Á´πÂõ≠3Ê†ã201',
                        talkTime: new Date('2024-03-10T09:00:00').toISOString().slice(0, 16),
                        talkLocation: 'ËæÖÂØºÂëòÂäûÂÖ¨ÂÆ§',
                        topics: ['Ë≠¶Á§∫ÊïôËÇ≤', 'ÈÄÇÂ∫îÊÄß'],
                        studentBackground: 'Â≠¶ÁîüÂü∫Êú¨‰ø°ÊÅØÔºöÁéã‰∫îÔºåÁΩëÁªúÂ∑•Á®ã2001Áè≠ÔºåÂÆøËàçÁ´πÂõ≠3Ê†ã201„ÄÇÊúâÂ§ÑÂàÜËÆ∞ÂΩïÔºåÂ≠¶‰π†ÊÄÅÂ∫¶Ê∂àÊûÅ„ÄÇ',
                        talkPurpose: 'ËøõË°åË≠¶Á§∫ÊïôËÇ≤Ôºå‰∫ÜËß£Â≠¶ÁîüËøëÊúüË°®Áé∞',
                        studentStatement: 'ÊâøËÆ§‰πãÂâçÁöÑË°å‰∏∫‰∏çÂΩìÔºå‰ΩÜÁé∞Âú®Â∑≤ÁªèÊîπÊ≠£ÔºåÂ∏åÊúõÊúâÊú∫‰ºöËØÅÊòéËá™Â∑±„ÄÇ',
                        talkPoints: '1. Âº∫Ë∞É‰∫ÜÊ†°Á∫™Ê†°ËßÑÔºõ2. ‰∫ÜËß£‰∫ÜÂ≠¶ÁîüËøëÊúüË°®Áé∞Ôºõ3. ÈºìÂä±Â≠¶ÁîüÁßØÊûÅÊîπÊ≠£Ôºõ4. Âà∂ÂÆö‰∫ÜÊîπËøõËÆ°Âàí„ÄÇ',
                        talkFeedback: 'Â≠¶ÁîüÊÄÅÂ∫¶ËØöÊÅ≥ÔºåË°®Á§∫‰ºöÂä™ÂäõÊîπÊ≠£„ÄÇ',
                        riskLevel: 'red',
                        followUpPlan: 'ÊØèÂë®Ë∑üËøõÂ≠¶ÁîüË°®Áé∞',
                        generalRemark: 'È´òÈ£éÈô©Â≠¶ÁîüÔºåÈúÄË¶ÅÈáçÁÇπÁõëÊéß„ÄÇ',
                        studentSignature: 'Áéã‰∫î',
                        counselorSignature: 'Èôà',
                        createTime: new Date('2024-03-10T09:00:00').toISOString(),
                        updateTime: new Date('2024-03-10T09:00:00').toISOString()
                    },
                    {
                        id: Date.now() + 3,
                        studentId: '20200104',
                        studentName: 'ËµµÂÖ≠',
                        className: '‰∫∫Â∑•Êô∫ËÉΩ2001',
                        dormitory: 'ÂÖ∞Âõ≠4Ê†ã101',
                        talkTime: new Date('2024-03-25T15:30:00').toISOString().slice(0, 16),
                        talkLocation: 'Â≠¶ÁîüÊ¥ªÂä®‰∏≠ÂøÉ',
                        topics: ['Â≠¶‰∏ö', 'ÂÆ∂Â∫≠'],
                        studentBackground: 'Â≠¶ÁîüÂü∫Êú¨‰ø°ÊÅØÔºöËµµÂÖ≠Ôºå‰∫∫Â∑•Êô∫ËÉΩ2001Áè≠ÔºåÂÆøËàçÂÖ∞Âõ≠4Ê†ã101„ÄÇÂ≠¶‰π†ÂßîÂëòÔºåÂÆ∂Â∫≠ÁªèÊµéÂõ∞Èöæ„ÄÇ',
                        talkPurpose: '‰∫ÜËß£Â≠¶ÁîüÂ≠¶‰π†ÊÉÖÂÜµÂíåÂÆ∂Â∫≠Áä∂ÂÜµ',
                        studentStatement: 'Â≠¶‰π†ÊàêÁª©Á®≥ÂÆöÔºå‰ΩÜÂÆ∂Â∫≠ÁªèÊµéÂéãÂäõÂ§ßÔºåÊãÖÂøÉÂΩ±ÂìçÂêéÁª≠Â≠¶‰π†„ÄÇ',
                        talkPoints: '1. ‰∫ÜËß£‰∫ÜÂ≠¶ÁîüÂ≠¶‰π†ÊÉÖÂÜµÔºõ2. ËÆ®ËÆ∫‰∫ÜÂÆ∂Â∫≠ÁªèÊµéÂõ∞ÈöæÔºõ3. ‰ªãÁªç‰∫ÜÂ≠¶Ê†°ËµÑÂä©ÊîøÁ≠ñÔºõ4. Êèê‰æõ‰∫ÜÂ≠¶‰π†Âª∫ËÆÆ„ÄÇ',
                        talkFeedback: 'Â≠¶Áîü‰∫ÜËß£‰∫ÜËµÑÂä©ÊîøÁ≠ñÔºåÊÉÖÁª™Á®≥ÂÆö„ÄÇ',
                        riskLevel: 'green',
                        followUpPlan: 'ÂçèÂä©Áî≥ËØ∑ËµÑÂä©',
                        generalRemark: '‰ºòÁßÄÂ≠¶ÁîüÔºåÈúÄË¶ÅÂÖ≥Ê≥®ÂÆ∂Â∫≠ÁªèÊµéÁä∂ÂÜµ„ÄÇ',
                        studentSignature: 'ËµµÂÖ≠',
                        counselorSignature: 'Èôà',
                        createTime: new Date('2024-03-25T15:30:00').toISOString(),
                        updateTime: new Date('2024-03-25T15:30:00').toISOString()
                    }
                ];
                
                sampleRecords.forEach(record => {
                    talkRecords.push(record);
                });
                
                localStorage.setItem('talkRecords', JSON.stringify(talkRecords));
                console.log('Ë∞àËØùËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò');
            }
            
            console.log('ÂàùÂßãÂåñÂÆåÊàêÔºåÂ≠¶ÁîüÊï∞:', students.length, 'ÔºåËÆ∞ÂΩïÊï∞:', talkRecords.length);
        }
    </script>
</body>
</html>